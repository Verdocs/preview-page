/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpRequest } from '@angular/common/http';
import { EventTrackerService } from '@verdocs/event-tracker';
import { ReplaySubject, throwError, from, forkJoin, of } from 'rxjs';
import { catchError, map, delay, mergeMap } from 'rxjs/operators';
import { findIndex } from 'lodash';
import { VSDKConfigToken } from '../angular-api.module';
export class BuilderService {
    /**
     * @param {?} http
     * @param {?} injector
     * @param {?} eventTracker
     */
    constructor(http, injector, eventTracker) {
        this.http = http;
        this.injector = injector;
        this.eventTracker = eventTracker;
        this.saveStatusSubject = new ReplaySubject();
        this._config_token = this.injector.get(VSDKConfigToken);
        this._rForm_backend_url = this._config_token.rForm_backend_url;
    }
    /**
     * @param {?} template_body
     * @return {?}
     */
    createTemplate(template_body) {
        return this.http
            .post(this._rForm_backend_url + '/templates', template_body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            return res;
        })));
    }
    /**
     * @param {?} file
     * @param {?} template
     * @return {?}
     */
    uploadTemplateDocument(file, template) {
        /** @type {?} */
        const formdata = new FormData();
        formdata.append('document', file, file.name);
        /** @type {?} */
        const req = new HttpRequest('POST', `${this._rForm_backend_url}/templates/${template.id}/documents`, formdata, {
            reportProgress: true
        });
        return this.http.request(req)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        res => res)), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            return throwError(err);
        })));
    }
    /**
     * @param {?} document
     * @param {?} pageNum
     * @param {?} templateId
     * @return {?}
     */
    addTemplatePage(document, pageNum, templateId) {
        /** @type {?} */
        const body = {
            sequence: pageNum,
            page_number: pageNum,
            document_id: document.id
        };
        return this.http.post(`${this._rForm_backend_url}/templates/${templateId}/pages`, body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        (res) => res)), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            return throwError(err);
        })));
    }
    /**
     * @param {?} document
     * @param {?} pageNums
     * @param {?} templateId
     * @return {?}
     */
    addTemplatePages(document, pageNums, templateId) {
        return from(pageNums)
            .pipe(mergeMap((/**
         * @param {?} pageNum
         * @return {?}
         */
        pageNum => {
            /** @type {?} */
            const page = {
                sequence: pageNum,
                page_number: pageNum,
                document_id: document.id
            };
            return (/** @type {?} */ (this.http.post(`${this._rForm_backend_url}/templates/${templateId}/pages`, page).pipe(delay(200))));
        })));
    }
    /**
     * @param {?} newField
     * @param {?} i
     * @param {?} j
     * @param {?} template
     * @return {?}
     */
    addTemplateField(newField, i, j, template) {
        newField.name = newField.name.trim();
        return this.http
            .post(this._rForm_backend_url + '/templates/' + newField.template_id + '/fields', newField)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            this.eventTracker.createEvent({
                category: 'document',
                action: `document ${field.type} field added`,
                label: `document id: ${newField.template_id}`
            });
            template.pages[i].fields[j] = field;
            // this.checkForFields(template.roles);
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template.roles[roleIndex]['fields'].push(field);
            }
            // this.templateSubject.next(template);
            return template;
        })));
    }
    /**
     * @param {?} template
     * @param {?} fieldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    deleteTemplateField(template, fieldName, i, j) {
        return this.http
            .delete(`${this._rForm_backend_url}/templates/${template.id}/fields/${fieldName.trim()}`)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: fieldName });
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: template.pages[i].fields[fieldIndex].role_name });
            if (roleIndex > -1) {
                /** @type {?} */
                const roleFieldIndex = findIndex(template.roles[roleIndex].fields, { name: fieldName });
                if (roleFieldIndex > -1) {
                    template.roles[roleIndex].fields.splice(roleFieldIndex, 1);
                }
            }
            template.pages[i].fields.splice(fieldIndex, 1);
            // this.updateLocalTemplate(template);
            // this.saveStatusSubject.next('saved');
            // this.checkForFields(template.roles);
            return template;
        })));
    }
    /**
     * @param {?} template
     * @param {?} updated_field
     * @param {?} role_index
     * @param {?} old_name
     * @return {?}
     */
    updateRoleField(template, updated_field, role_index, old_name) {
        /** @type {?} */
        const field_index = findIndex(template.roles[role_index].fields, { name: old_name });
        if (field_index >= 0) {
            template.roles[role_index].fields[field_index] = updated_field;
        }
        else {
            template.roles[role_index].fields.push(updated_field);
        }
        return template;
    }
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    updateTemplateField(template, body, oldName, i, j) {
        oldName = oldName.trim();
        return this.http
            .put(this._rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            this.eventTracker.createEvent({
                category: 'document',
                action: `document ${field.type} field updated`,
                label: `document id: ${template.id}`
            });
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            if (field.page_sequence - 1 !== i) {
                template.pages[i].fields.splice(fieldIndex, 1);
                template.pages[field.page_sequence - 1].fields.push(field);
            }
            else {
                template.pages[i].fields[fieldIndex] = field;
            }
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template = this.updateRoleField(template, field, roleIndex, oldName);
            }
            // this.templateSubject.next(template);
            this.saveStatusSubject.next('saved');
            return template;
        })));
    }
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    updateDropdownField(template, body, oldName, i, j) {
        oldName = oldName.trim();
        return this.http
            .put(this._rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            template.pages[i].fields[fieldIndex] = field;
            // this.templateSubject.next(template);
            this.saveStatusSubject.next('saved');
            return template;
        })));
    }
    /**
     * @param {?} templateId
     * @param {?} fieldId
     * @param {?} roleId
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    addFieldRole(templateId, fieldId, roleId, i, j) {
        /** @type {?} */
        const fieldRoleInfo = JSON.stringify({
            field_id: fieldId,
            role_id: roleId
        });
        return this.http
            .post(this._rForm_backend_url + '/template/' + templateId + '/field_role', fieldRoleInfo).toPromise().then((/**
         * @param {?} fieldRole
         * @return {?}
         */
        fieldRole => {
            return fieldRole;
        }));
    }
    /**
     * @param {?} role
     * @param {?} template
     * @return {?}
     */
    addRole(role, template) {
        /** @type {?} */
        const templateBackend = this._rForm_backend_url + '/templates/' + template.id + '/roles';
        /** @type {?} */
        let roles = [];
        roles = roles.concat(role);
        /** @type {?} */
        const roleRequests = [];
        roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        role => {
            roleRequests.push(this.http.post(templateBackend, role));
        }));
        if (roles && roles.length > 0) {
            return forkJoin(roleRequests).pipe(map((/**
             * @param {?} savedRoles
             * @return {?}
             */
            savedRoles => {
                savedRoles.concat((/** @type {?} */ (savedRoles)));
                if (!template['roles']) {
                    template['roles'] = (/** @type {?} */ ([]));
                }
                /** @type {?} */
                const savedRolesWithFields = savedRoles.map((/**
                 * @param {?} newRole
                 * @return {?}
                 */
                newRole => {
                    newRole['fields'] = [];
                    return newRole;
                }));
                template['roles'] = template['roles'].concat(savedRolesWithFields);
                // this.recipients = this.sortRoles(template);
                // this.roles = this.recipients;
                // this.templateSubject.next(template);
                // this.recipientsSubject.next(this.recipients);
                // this.recipients;
                return template;
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.error(err);
                console.error('Couldn\'t save all the roles');
                return err;
            })));
        }
        else {
            return of(template);
        }
    }
    /**
     * @param {?} roleName
     * @param {?} template
     * @return {?}
     */
    deleteRole(roleName, template) {
        return this.http.delete(this._rForm_backend_url + '/templates/' + template.id + '/roles/' + roleName)
            .toPromise()
            .then((/**
         * @return {?}
         */
        () => {
            // remove(template.roles, (role: IRole) => {
            // this.recipients = this.sortRoles(template);
            // if (role.name === roleName) {
            //   const fields = role.fields;
            //   const fieldNames = [];
            //   for (const field of fields) {
            //     fieldNames.push(field.name);
            //   }
            //   this.deleteTemplateFields(fieldNames, template);
            // }
            // this.templateSubject.next(template);
            // this.recipientsSubject.next(this.recipients);
            //   return role.name === roleName
            // });
        }));
    }
    /**
     * @param {?} roleNames
     * @param {?} template
     * @return {?}
     */
    deleteRoles(roleNames, template) {
        /** @type {?} */
        const deleteCalls = [];
        roleNames.forEach((/**
         * @param {?} role_name
         * @return {?}
         */
        role_name => {
            template = Object.assign({}, template, { roles: template.roles.filter((/**
                 * @param {?} role
                 * @return {?}
                 */
                role => role.name !== role_name)) });
            deleteCalls.push(this.http.delete(this._rForm_backend_url + '/templates/' + template.id + '/roles/' + role_name));
        }));
        return forkJoin(deleteCalls).pipe(map((/**
         * @return {?}
         */
        () => {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        err => {
            console.error(err);
            console.error('Couldn\'t delete all the roles');
            return err;
        })));
    }
    /**
     * @param {?} roles
     * @param {?} template
     * @return {?}
     */
    updateRoles(roles, template) {
        /** @type {?} */
        const updateCalls = [];
        roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        role => {
            /** @type {?} */
            const body = {
                template_id: template.id,
                name: role.name.trim(),
                full_name: role.full_name,
                email: role.email,
                sequence: role.sequence,
                type: role.type,
                delegator: role.delegator,
                message: role.message,
                phone: role.phone
            };
            /** @type {?} */
            const role_index = findIndex(template.roles, { name: role.old_name });
            if (role_index >= 0) {
                template.roles[role_index] = Object.assign({}, template.roles[role_index], { template_id: template.id, name: role.name.trim(), full_name: role.full_name, email: role.email, sequence: role.sequence, type: role.type, delegator: role.delegator, message: role.message, phone: role.phone });
            }
            this.eventTracker.createEvent({
                category: 'document',
                action: 'document role updated',
                label: `document id: ${template.id}`
            });
            updateCalls.push(this.http.put(this._rForm_backend_url + '/templates/' + template.id + '/roles/' + role.old_name, body));
        }));
        return forkJoin(updateCalls)
            .pipe(map((/**
         * @return {?}
         */
        () => {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            console.error(err);
            console.error('Couldn\'t save all the roles');
            return err;
        })));
    }
}
BuilderService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BuilderService.ctorParameters = () => [
    { type: HttpClient },
    { type: Injector },
    { type: EventTrackerService }
];
if (false) {
    /** @type {?} */
    BuilderService.prototype.saveStatusSubject;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype._rForm_backend_url;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.eventTracker;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlcy9idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDN0QsT0FBTyxFQUFjLGFBQWEsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFbkMsT0FBTyxFQUFjLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBU3BFLE1BQU0sT0FBTyxjQUFjOzs7Ozs7SUFNekIsWUFDVSxJQUFnQixFQUNoQixRQUFrQixFQUNsQixZQUFpQztRQUZqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsaUJBQVksR0FBWixZQUFZLENBQXFCO1FBUnBDLHNCQUFpQixHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBVTVFLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUM7SUFDakUsQ0FBQzs7Ozs7SUFFRCxjQUFjLENBQUMsYUFBd0I7UUFDckMsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLElBQUksQ0FBWSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsWUFBWSxFQUFFLGFBQWEsQ0FBQzthQUN0RSxJQUFJLENBQ0gsR0FBRzs7OztRQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDVixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBQyxDQUNILENBQUM7SUFDTixDQUFDOzs7Ozs7SUFFRCxzQkFBc0IsQ0FBQyxJQUFVLEVBQUUsUUFBbUI7O2NBQzlDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRTtRQUMvQixRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOztjQUN2QyxHQUFHLEdBQUcsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixjQUFjLFFBQVEsQ0FBQyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUU7WUFDN0csY0FBYyxFQUFFLElBQUk7U0FDckIsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO2FBQzFCLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUMsRUFDZixVQUFVOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUU7WUFDZixPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLEVBQUMsQ0FDSCxDQUFBO0lBQ0wsQ0FBQzs7Ozs7OztJQUVELGVBQWUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVU7O2NBQ3JDLElBQUksR0FBRztZQUNYLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLFdBQVcsRUFBRSxPQUFPO1lBQ3BCLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRTtTQUN6QjtRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLGNBQWMsVUFBVSxRQUFRLEVBQUUsSUFBSSxDQUFDO2FBQzNGLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsQ0FBQyxHQUFVLEVBQUUsRUFBRSxDQUFDLEdBQUcsRUFBQyxFQUN4QixVQUFVOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUU7WUFDZixPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLEVBQUMsQ0FDSCxDQUFBO0lBQ0wsQ0FBQzs7Ozs7OztJQUVELGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFrQixFQUFFLFVBQWtCO1FBQy9ELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQzthQUNsQixJQUFJLENBQ0gsUUFBUTs7OztRQUFDLE9BQU8sQ0FBQyxFQUFFOztrQkFDWCxJQUFJLEdBQUc7Z0JBQ1gsUUFBUSxFQUFFLE9BQU87Z0JBQ2pCLFdBQVcsRUFBRSxPQUFPO2dCQUNwQixXQUFXLEVBQUUsUUFBUSxDQUFDLEVBQUU7YUFDekI7WUFDRCxPQUFPLG1CQUFtQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsY0FBYyxVQUFVLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUEsQ0FBQztRQUM5SCxDQUFDLEVBQUMsQ0FDSCxDQUFBO0lBQ0wsQ0FBQzs7Ozs7Ozs7SUFFRCxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBbUI7UUFDMUQsUUFBUSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixJQUFJLENBQVMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxHQUFHLFNBQVMsRUFBRSxRQUFRLENBQUM7YUFDbEcsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxLQUFLLENBQUMsRUFBRTtZQUNWLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLFlBQVksS0FBSyxDQUFDLElBQUksY0FBYztnQkFDNUMsS0FBSyxFQUFFLGdCQUFnQixRQUFRLENBQUMsV0FBVyxFQUFFO2FBQzlDLENBQUMsQ0FBQztZQUNILFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQzs7O2tCQUU5QixTQUFTLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3RFLElBQUksU0FBUyxJQUFJLENBQUMsRUFBRTtnQkFDbEIsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDakQ7WUFDRCx1Q0FBdUM7WUFDdkMsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7O0lBRUQsbUJBQW1CLENBQUMsUUFBbUIsRUFBRSxTQUFpQixFQUFFLENBQUMsRUFBRSxDQUFDO1FBQzlELE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixNQUFNLENBQU8sR0FBRyxJQUFJLENBQUMsa0JBQWtCLGNBQWMsUUFBUSxDQUFDLEVBQUUsV0FBVyxTQUFTLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQzthQUM5RixJQUFJLENBQ0gsR0FBRzs7OztRQUFDLEtBQUssQ0FBQyxFQUFFOztrQkFDSixVQUFVLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDOztrQkFDckUsU0FBUyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRXJHLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQyxFQUFFOztzQkFDWixjQUFjLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDO2dCQUN2RixJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDdkIsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDNUQ7YUFDRjtZQUNELFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDL0Msc0NBQXNDO1lBQ3RDLHdDQUF3QztZQUN4Qyx1Q0FBdUM7WUFDdkMsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7O0lBRUQsZUFBZSxDQUFDLFFBQW1CLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxRQUFROztjQUNoRSxXQUFXLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQ3BGLElBQUksV0FBVyxJQUFJLENBQUMsRUFBRTtZQUNwQixRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxhQUFhLENBQUM7U0FDaEU7YUFBTTtZQUNMLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN2RDtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Ozs7Ozs7OztJQUVELG1CQUFtQixDQUFDLFFBQW1CLEVBQUUsSUFBWSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNsRSxPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixHQUFHLENBQVMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGFBQWEsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFVBQVUsR0FBRyxPQUFPLEVBQUUsSUFBSSxDQUFDO2FBQy9GLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUU7WUFDVixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztnQkFDNUIsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLE1BQU0sRUFBRSxZQUFZLEtBQUssQ0FBQyxJQUFJLGdCQUFnQjtnQkFDOUMsS0FBSyxFQUFFLGdCQUFnQixRQUFRLENBQUMsRUFBRSxFQUFFO2FBQ3JDLENBQUMsQ0FBQzs7a0JBQ0csVUFBVSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQztZQUN6RSxJQUFJLEtBQUssQ0FBQyxhQUFhLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDakMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDL0MsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDNUQ7aUJBQU07Z0JBQ0wsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQzlDOztrQkFDSyxTQUFTLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3RFLElBQUksU0FBUyxJQUFJLENBQUMsRUFBRTtnQkFDbEIsUUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDdEU7WUFDRCx1Q0FBdUM7WUFDdkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyQyxPQUFPLFFBQVEsQ0FBQztRQUNsQixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7Ozs7Ozs7O0lBRUQsbUJBQW1CLENBQUMsUUFBbUIsRUFBRSxJQUFTLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQy9ELE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEdBQUcsQ0FBTSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsYUFBYSxHQUFHLFFBQVEsQ0FBQyxFQUFFLEdBQUcsVUFBVSxHQUFHLE9BQU8sRUFBRSxJQUFJLENBQUM7YUFDNUYsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxLQUFLLENBQUMsRUFBRTs7a0JBQ0osVUFBVSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQztZQUN6RSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDN0MsdUNBQXVDO1lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckMsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7OztJQUVELFlBQVksQ0FBQyxVQUFrQixFQUFFLE9BQWUsRUFBRSxNQUFjLEVBQUUsQ0FBQyxFQUFFLENBQUM7O2NBQzlELGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25DLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLE9BQU8sRUFBRSxNQUFNO1NBQ2hCLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsSUFBSSxDQUFZLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxZQUFZLEdBQUcsVUFBVSxHQUFHLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJOzs7O1FBQUMsU0FBUyxDQUFDLEVBQUU7WUFDaEksT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7SUFFRCxPQUFPLENBQUMsSUFBcUIsRUFBRSxRQUFtQjs7Y0FDMUMsZUFBZSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxRQUFROztZQUNwRixLQUFLLEdBQUcsRUFBRTtRQUNkLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDOztjQUNyQixZQUFZLEdBQUcsRUFBRTtRQUN2QixLQUFLLENBQUMsT0FBTzs7OztRQUFDLElBQUksQ0FBQyxFQUFFO1lBQ25CLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0QsQ0FBQyxFQUFDLENBQUE7UUFFRixJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM3QixPQUFPLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQ2hDLEdBQUc7Ozs7WUFBQyxVQUFVLENBQUMsRUFBRTtnQkFDZixVQUFVLENBQUMsTUFBTSxDQUFDLG1CQUFBLFVBQVUsRUFBVyxDQUFDLENBQUM7Z0JBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ3RCLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxtQkFBUyxFQUFFLEVBQUEsQ0FBQztpQkFDakM7O3NCQUNLLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxHQUFHOzs7O2dCQUFDLE9BQU8sQ0FBQyxFQUFFO29CQUNwRCxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDO29CQUN2QixPQUFPLE9BQU8sQ0FBQztnQkFDakIsQ0FBQyxFQUFDO2dCQUNGLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ25FLDhDQUE4QztnQkFDOUMsZ0NBQWdDO2dCQUNoQyx1Q0FBdUM7Z0JBQ3ZDLGdEQUFnRDtnQkFDaEQsbUJBQW1CO2dCQUNuQixPQUFPLFFBQVEsQ0FBQTtZQUNqQixDQUFDOzs7O1lBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7Z0JBQzlDLE9BQU8sR0FBRyxDQUFDO1lBQ2IsQ0FBQyxFQUFDLENBQ0gsQ0FBQztTQUNIO2FBQU07WUFDTCxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNyQjtJQUNILENBQUM7Ozs7OztJQUVELFVBQVUsQ0FBQyxRQUFRLEVBQUUsUUFBbUI7UUFDdEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsYUFBYSxHQUFHLFFBQVEsQ0FBQyxFQUFFLEdBQUcsU0FBUyxHQUFHLFFBQVEsQ0FBQzthQUNsRyxTQUFTLEVBQUU7YUFDWCxJQUFJOzs7UUFBQyxHQUFHLEVBQUU7WUFDVCw0Q0FBNEM7WUFDMUMsOENBQThDO1lBQzlDLGdDQUFnQztZQUNoQyxnQ0FBZ0M7WUFDaEMsMkJBQTJCO1lBQzNCLGtDQUFrQztZQUNsQyxtQ0FBbUM7WUFDbkMsTUFBTTtZQUNOLHFEQUFxRDtZQUNyRCxJQUFJO1lBQ0osdUNBQXVDO1lBQ3ZDLGdEQUFnRDtZQUNsRCxrQ0FBa0M7WUFDbEMsTUFBTTtRQUNSLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Ozs7O0lBRUQsV0FBVyxDQUFDLFNBQXdCLEVBQUUsUUFBbUI7O2NBQ2pELFdBQVcsR0FBRyxFQUFFO1FBQ3RCLFNBQVMsQ0FBQyxPQUFPOzs7O1FBQUMsU0FBUyxDQUFDLEVBQUU7WUFDNUIsUUFBUSxxQkFDSCxRQUFRLElBQ1gsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTTs7OztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFDLEdBQzlELENBQUE7WUFDRCxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUNuSCxDQUFDLEVBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDL0IsR0FBRzs7O1FBQUMsR0FBRyxFQUFFO1lBQ1AsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQzs7OztRQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ1AsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7WUFDaEQsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUMsQ0FDSCxDQUFBO0lBQ0gsQ0FBQzs7Ozs7O0lBRUQsV0FBVyxDQUFDLEtBQUssRUFBRSxRQUFtQjs7Y0FDOUIsV0FBVyxHQUFHLEVBQUU7UUFDdEIsS0FBSyxDQUFDLE9BQU87Ozs7UUFBQyxJQUFJLENBQUMsRUFBRTs7a0JBQ2IsSUFBSSxHQUFHO2dCQUNYLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRTtnQkFDeEIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUN0QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3pCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO2dCQUN2QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzthQUNsQjs7a0JBRUssVUFBVSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNyRSxJQUFJLFVBQVUsSUFBSSxDQUFDLEVBQUU7Z0JBQ25CLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLHFCQUNyQixRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUM3QixXQUFXLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFDeEIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQ3RCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQ2xCLENBQUE7YUFDRjtZQUNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsS0FBSyxFQUFFLGdCQUFnQixRQUFRLENBQUMsRUFBRSxFQUFFO2FBQ3JDLENBQUMsQ0FBQztZQUNILFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGFBQWEsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0gsQ0FBQyxFQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7YUFDekIsSUFBSSxDQUNILEdBQUc7OztRQUFDLEdBQUcsRUFBRTtZQUNQLE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUM7Ozs7UUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7WUFDOUMsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7O1lBblRGLFVBQVU7Ozs7WUFkRixVQUFVO1lBREUsUUFBUTtZQUVwQixtQkFBbUI7Ozs7SUFlMUIsMkNBQThFOzs7OztJQUU5RSx1Q0FBa0M7Ozs7O0lBQ2xDLDRDQUFtQzs7Ozs7SUFHakMsOEJBQXdCOzs7OztJQUN4QixrQ0FBMEI7Ozs7O0lBQzFCLHNDQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEV2ZW50VHJhY2tlclNlcnZpY2UgfSBmcm9tICdAdmVyZG9jcy9ldmVudC10cmFja2VyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIHRocm93RXJyb3IsIGZyb20sIGZvcmtKb2luLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBkZWxheSwgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBmaW5kSW5kZXggfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBWU0RLQ29uZmlnLCBWU0RLQ29uZmlnVG9rZW4gfSBmcm9tICcuLi9hbmd1bGFyLWFwaS5tb2R1bGUnO1xuXG5pbXBvcnQgeyBJVGVtcGxhdGUgfSBmcm9tICcuLi9tb2RlbHMvdGVtcGxhdGUubW9kZWwnO1xuaW1wb3J0IHsgSVBhZ2UgfSBmcm9tICcuLi9tb2RlbHMvcGFnZS5tb2RlbCc7XG5pbXBvcnQgeyBJUm9sZSB9IGZyb20gJy4uL21vZGVscy9yb2xlLm1vZGVsJztcbmltcG9ydCB7IElGaWVsZCB9IGZyb20gJy4uL21vZGVscy9maWVsZC5tb2RlbCc7XG5pbXBvcnQgeyBGaWVsZFJvbGUgfSBmcm9tICcuLi9tb2RlbHMvZmllbGQtcm9sZS5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCdWlsZGVyU2VydmljZSB7XG4gIHB1YmxpYyBzYXZlU3RhdHVzU3ViamVjdDogUmVwbGF5U3ViamVjdDxzdHJpbmc+ID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nPigpO1xuXG4gIHByaXZhdGUgX2NvbmZpZ190b2tlbjogVlNES0NvbmZpZztcbiAgcHJpdmF0ZSBfckZvcm1fYmFja2VuZF91cmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBldmVudFRyYWNrZXI6IEV2ZW50VHJhY2tlclNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5fY29uZmlnX3Rva2VuID0gdGhpcy5pbmplY3Rvci5nZXQoVlNES0NvbmZpZ1Rva2VuKTtcbiAgICB0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCA9IHRoaXMuX2NvbmZpZ190b2tlbi5yRm9ybV9iYWNrZW5kX3VybDtcbiAgfVxuXG4gIGNyZWF0ZVRlbXBsYXRlKHRlbXBsYXRlX2JvZHk6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8SVRlbXBsYXRlPih0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzJywgdGVtcGxhdGVfYm9keSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHJlcykgPT4ge1xuICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgdXBsb2FkVGVtcGxhdGVEb2N1bWVudChmaWxlOiBGaWxlLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKSB7XG4gICAgY29uc3QgZm9ybWRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBmb3JtZGF0YS5hcHBlbmQoJ2RvY3VtZW50JywgZmlsZSwgZmlsZS5uYW1lKTtcbiAgICBjb25zdCByZXEgPSBuZXcgSHR0cFJlcXVlc3QoJ1BPU1QnLCBgJHt0aGlzLl9yRm9ybV9iYWNrZW5kX3VybH0vdGVtcGxhdGVzLyR7dGVtcGxhdGUuaWR9L2RvY3VtZW50c2AsIGZvcm1kYXRhLCB7XG4gICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZVxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmh0dHAucmVxdWVzdChyZXEpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHJlcyA9PiByZXMpLFxuICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG4gIGFkZFRlbXBsYXRlUGFnZShkb2N1bWVudCwgcGFnZU51bSwgdGVtcGxhdGVJZCkge1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBzZXF1ZW5jZTogcGFnZU51bSxcbiAgICAgIHBhZ2VfbnVtYmVyOiBwYWdlTnVtLFxuICAgICAgZG9jdW1lbnRfaWQ6IGRvY3VtZW50LmlkXG4gICAgfVxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxJUGFnZT4oYCR7dGhpcy5fckZvcm1fYmFja2VuZF91cmx9L3RlbXBsYXRlcy8ke3RlbXBsYXRlSWR9L3BhZ2VzYCwgYm9keSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHJlczogSVBhZ2UpID0+IHJlcyksXG4gICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnIpO1xuICAgICAgICB9KVxuICAgICAgKVxuICB9XG5cbiAgYWRkVGVtcGxhdGVQYWdlcyhkb2N1bWVudCwgcGFnZU51bXM6IG51bWJlcltdLCB0ZW1wbGF0ZUlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnJvbShwYWdlTnVtcylcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcChwYWdlTnVtID0+IHtcbiAgICAgICAgICBjb25zdCBwYWdlID0ge1xuICAgICAgICAgICAgc2VxdWVuY2U6IHBhZ2VOdW0sXG4gICAgICAgICAgICBwYWdlX251bWJlcjogcGFnZU51bSxcbiAgICAgICAgICAgIGRvY3VtZW50X2lkOiBkb2N1bWVudC5pZFxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIDxPYnNlcnZhYmxlPElQYWdlPj50aGlzLmh0dHAucG9zdChgJHt0aGlzLl9yRm9ybV9iYWNrZW5kX3VybH0vdGVtcGxhdGVzLyR7dGVtcGxhdGVJZH0vcGFnZXNgLCBwYWdlKS5waXBlKGRlbGF5KDIwMCkpO1xuICAgICAgICB9KVxuICAgICAgKVxuICB9XG5cbiAgYWRkVGVtcGxhdGVGaWVsZChuZXdGaWVsZDogSUZpZWxkLCBpLCBqLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBuZXdGaWVsZC5uYW1lID0gbmV3RmllbGQubmFtZS50cmltKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8SUZpZWxkPih0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyBuZXdGaWVsZC50ZW1wbGF0ZV9pZCArICcvZmllbGRzJywgbmV3RmllbGQpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZpZWxkID0+IHtcbiAgICAgICAgICB0aGlzLmV2ZW50VHJhY2tlci5jcmVhdGVFdmVudCh7XG4gICAgICAgICAgICBjYXRlZ29yeTogJ2RvY3VtZW50JyxcbiAgICAgICAgICAgIGFjdGlvbjogYGRvY3VtZW50ICR7ZmllbGQudHlwZX0gZmllbGQgYWRkZWRgLFxuICAgICAgICAgICAgbGFiZWw6IGBkb2N1bWVudCBpZDogJHtuZXdGaWVsZC50ZW1wbGF0ZV9pZH1gXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2pdID0gZmllbGQ7XG4gICAgICAgICAgLy8gdGhpcy5jaGVja0ZvckZpZWxkcyh0ZW1wbGF0ZS5yb2xlcyk7XG4gICAgICAgICAgY29uc3Qgcm9sZUluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzLCB7IG5hbWU6IGZpZWxkLnJvbGVfbmFtZSB9KTtcbiAgICAgICAgICBpZiAocm9sZUluZGV4ID49IDApIHtcbiAgICAgICAgICAgIHRlbXBsYXRlLnJvbGVzW3JvbGVJbmRleF1bJ2ZpZWxkcyddLnB1c2goZmllbGQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgZGVsZXRlVGVtcGxhdGVGaWVsZCh0ZW1wbGF0ZTogSVRlbXBsYXRlLCBmaWVsZE5hbWU6IHN0cmluZywgaSwgaik6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmRlbGV0ZTx2b2lkPihgJHt0aGlzLl9yRm9ybV9iYWNrZW5kX3VybH0vdGVtcGxhdGVzLyR7dGVtcGxhdGUuaWR9L2ZpZWxkcy8ke2ZpZWxkTmFtZS50cmltKCl9YClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmllbGQgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLCB7IG5hbWU6IGZpZWxkTmFtZSB9KTtcbiAgICAgICAgICBjb25zdCByb2xlSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2ZpZWxkSW5kZXhdLnJvbGVfbmFtZSB9KTtcblxuICAgICAgICAgIGlmIChyb2xlSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgY29uc3Qgcm9sZUZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXNbcm9sZUluZGV4XS5maWVsZHMsIHsgbmFtZTogZmllbGROYW1lIH0pO1xuICAgICAgICAgICAgaWYgKHJvbGVGaWVsZEluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZUluZGV4XS5maWVsZHMuc3BsaWNlKHJvbGVGaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLnNwbGljZShmaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICAvLyB0aGlzLnVwZGF0ZUxvY2FsVGVtcGxhdGUodGVtcGxhdGUpO1xuICAgICAgICAgIC8vIHRoaXMuc2F2ZVN0YXR1c1N1YmplY3QubmV4dCgnc2F2ZWQnKTtcbiAgICAgICAgICAvLyB0aGlzLmNoZWNrRm9yRmllbGRzKHRlbXBsYXRlLnJvbGVzKTtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgdXBkYXRlUm9sZUZpZWxkKHRlbXBsYXRlOiBJVGVtcGxhdGUsIHVwZGF0ZWRfZmllbGQsIHJvbGVfaW5kZXgsIG9sZF9uYW1lKSB7XG4gICAgY29uc3QgZmllbGRfaW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0uZmllbGRzLCB7IG5hbWU6IG9sZF9uYW1lIH0pO1xuICAgIGlmIChmaWVsZF9pbmRleCA+PSAwKSB7XG4gICAgICB0ZW1wbGF0ZS5yb2xlc1tyb2xlX2luZGV4XS5maWVsZHNbZmllbGRfaW5kZXhdID0gdXBkYXRlZF9maWVsZDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0uZmllbGRzLnB1c2godXBkYXRlZF9maWVsZCk7XG4gICAgfVxuICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgfVxuXG4gIHVwZGF0ZVRlbXBsYXRlRmllbGQodGVtcGxhdGU6IElUZW1wbGF0ZSwgYm9keTogSUZpZWxkLCBvbGROYW1lLCBpLCBqKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBvbGROYW1lID0gb2xkTmFtZS50cmltKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnB1dDxJRmllbGQ+KHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlLmlkICsgJy9maWVsZHMvJyArIG9sZE5hbWUsIGJvZHkpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZpZWxkID0+IHtcbiAgICAgICAgICB0aGlzLmV2ZW50VHJhY2tlci5jcmVhdGVFdmVudCh7XG4gICAgICAgICAgICBjYXRlZ29yeTogJ2RvY3VtZW50JyxcbiAgICAgICAgICAgIGFjdGlvbjogYGRvY3VtZW50ICR7ZmllbGQudHlwZX0gZmllbGQgdXBkYXRlZGAsXG4gICAgICAgICAgICBsYWJlbDogYGRvY3VtZW50IGlkOiAke3RlbXBsYXRlLmlkfWBcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCBmaWVsZEluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcywgeyBuYW1lOiBvbGROYW1lIH0pO1xuICAgICAgICAgIGlmIChmaWVsZC5wYWdlX3NlcXVlbmNlIC0gMSAhPT0gaSkge1xuICAgICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLnNwbGljZShmaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ZpZWxkLnBhZ2Vfc2VxdWVuY2UgLSAxXS5maWVsZHMucHVzaChmaWVsZCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkc1tmaWVsZEluZGV4XSA9IGZpZWxkO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCByb2xlSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogZmllbGQucm9sZV9uYW1lIH0pO1xuICAgICAgICAgIGlmIChyb2xlSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGVtcGxhdGUgPSB0aGlzLnVwZGF0ZVJvbGVGaWVsZCh0ZW1wbGF0ZSwgZmllbGQsIHJvbGVJbmRleCwgb2xkTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIHRoaXMudGVtcGxhdGVTdWJqZWN0Lm5leHQodGVtcGxhdGUpO1xuICAgICAgICAgIHRoaXMuc2F2ZVN0YXR1c1N1YmplY3QubmV4dCgnc2F2ZWQnKTtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgdXBkYXRlRHJvcGRvd25GaWVsZCh0ZW1wbGF0ZTogSVRlbXBsYXRlLCBib2R5OiBhbnksIG9sZE5hbWUsIGksIGopOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIG9sZE5hbWUgPSBvbGROYW1lLnRyaW0oKTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucHV0PGFueT4odGhpcy5fckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL2ZpZWxkcy8nICsgb2xkTmFtZSwgYm9keSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmllbGQgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLCB7IG5hbWU6IG9sZE5hbWUgfSk7XG4gICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2ZpZWxkSW5kZXhdID0gZmllbGQ7XG4gICAgICAgICAgLy8gdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgdGhpcy5zYXZlU3RhdHVzU3ViamVjdC5uZXh0KCdzYXZlZCcpO1xuICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBhZGRGaWVsZFJvbGUodGVtcGxhdGVJZDogc3RyaW5nLCBmaWVsZElkOiBzdHJpbmcsIHJvbGVJZDogc3RyaW5nLCBpLCBqKTogUHJvbWlzZTxGaWVsZFJvbGU+IHtcbiAgICBjb25zdCBmaWVsZFJvbGVJbmZvID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZmllbGRfaWQ6IGZpZWxkSWQsXG4gICAgICByb2xlX2lkOiByb2xlSWRcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucG9zdDxGaWVsZFJvbGU+KHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZS8nICsgdGVtcGxhdGVJZCArICcvZmllbGRfcm9sZScsIGZpZWxkUm9sZUluZm8pLnRvUHJvbWlzZSgpLnRoZW4oZmllbGRSb2xlID0+IHtcbiAgICAgICAgcmV0dXJuIGZpZWxkUm9sZTtcbiAgICAgIH0pO1xuICB9XG5cbiAgYWRkUm9sZShyb2xlOiBJUm9sZSB8IElSb2xlW10sIHRlbXBsYXRlOiBJVGVtcGxhdGUpOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlQmFja2VuZCA9IHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlLmlkICsgJy9yb2xlcyc7XG4gICAgbGV0IHJvbGVzID0gW107XG4gICAgcm9sZXMgPSByb2xlcy5jb25jYXQocm9sZSk7XG4gICAgY29uc3Qgcm9sZVJlcXVlc3RzID0gW107XG4gICAgcm9sZXMuZm9yRWFjaChyb2xlID0+IHtcbiAgICAgIHJvbGVSZXF1ZXN0cy5wdXNoKHRoaXMuaHR0cC5wb3N0KHRlbXBsYXRlQmFja2VuZCwgcm9sZSkpO1xuICAgIH0pXG5cbiAgICBpZiAocm9sZXMgJiYgcm9sZXMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIGZvcmtKb2luKHJvbGVSZXF1ZXN0cykucGlwZShcbiAgICAgICAgbWFwKHNhdmVkUm9sZXMgPT4ge1xuICAgICAgICAgIHNhdmVkUm9sZXMuY29uY2F0KHNhdmVkUm9sZXMgYXMgSVJvbGVbXSk7XG4gICAgICAgICAgaWYgKCF0ZW1wbGF0ZVsncm9sZXMnXSkge1xuICAgICAgICAgICAgdGVtcGxhdGVbJ3JvbGVzJ10gPSA8SVJvbGVbXT5bXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgc2F2ZWRSb2xlc1dpdGhGaWVsZHMgPSBzYXZlZFJvbGVzLm1hcChuZXdSb2xlID0+IHtcbiAgICAgICAgICAgIG5ld1JvbGVbJ2ZpZWxkcyddID0gW107XG4gICAgICAgICAgICByZXR1cm4gbmV3Um9sZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0ZW1wbGF0ZVsncm9sZXMnXSA9IHRlbXBsYXRlWydyb2xlcyddLmNvbmNhdChzYXZlZFJvbGVzV2l0aEZpZWxkcyk7XG4gICAgICAgICAgLy8gdGhpcy5yZWNpcGllbnRzID0gdGhpcy5zb3J0Um9sZXModGVtcGxhdGUpO1xuICAgICAgICAgIC8vIHRoaXMucm9sZXMgPSB0aGlzLnJlY2lwaWVudHM7XG4gICAgICAgICAgLy8gdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgLy8gdGhpcy5yZWNpcGllbnRzU3ViamVjdC5uZXh0KHRoaXMucmVjaXBpZW50cyk7XG4gICAgICAgICAgLy8gdGhpcy5yZWNpcGllbnRzO1xuICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZVxuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkblxcJ3Qgc2F2ZSBhbGwgdGhlIHJvbGVzJyk7XG4gICAgICAgICAgcmV0dXJuIGVycjtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvZih0ZW1wbGF0ZSk7XG4gICAgfVxuICB9XG5cbiAgZGVsZXRlUm9sZShyb2xlTmFtZSwgdGVtcGxhdGU6IElUZW1wbGF0ZSkge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlKHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlLmlkICsgJy9yb2xlcy8nICsgcm9sZU5hbWUpXG4gICAgICAudG9Qcm9taXNlKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgLy8gcmVtb3ZlKHRlbXBsYXRlLnJvbGVzLCAocm9sZTogSVJvbGUpID0+IHtcbiAgICAgICAgICAvLyB0aGlzLnJlY2lwaWVudHMgPSB0aGlzLnNvcnRSb2xlcyh0ZW1wbGF0ZSk7XG4gICAgICAgICAgLy8gaWYgKHJvbGUubmFtZSA9PT0gcm9sZU5hbWUpIHtcbiAgICAgICAgICAvLyAgIGNvbnN0IGZpZWxkcyA9IHJvbGUuZmllbGRzO1xuICAgICAgICAgIC8vICAgY29uc3QgZmllbGROYW1lcyA9IFtdO1xuICAgICAgICAgIC8vICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgICAgICAvLyAgICAgZmllbGROYW1lcy5wdXNoKGZpZWxkLm5hbWUpO1xuICAgICAgICAgIC8vICAgfVxuICAgICAgICAgIC8vICAgdGhpcy5kZWxldGVUZW1wbGF0ZUZpZWxkcyhmaWVsZE5hbWVzLCB0ZW1wbGF0ZSk7XG4gICAgICAgICAgLy8gfVxuICAgICAgICAgIC8vIHRoaXMudGVtcGxhdGVTdWJqZWN0Lm5leHQodGVtcGxhdGUpO1xuICAgICAgICAgIC8vIHRoaXMucmVjaXBpZW50c1N1YmplY3QubmV4dCh0aGlzLnJlY2lwaWVudHMpO1xuICAgICAgICAvLyAgIHJldHVybiByb2xlLm5hbWUgPT09IHJvbGVOYW1lXG4gICAgICAgIC8vIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICBkZWxldGVSb2xlcyhyb2xlTmFtZXM6IEFycmF5PHN0cmluZz4sIHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICBjb25zdCBkZWxldGVDYWxscyA9IFtdO1xuICAgIHJvbGVOYW1lcy5mb3JFYWNoKHJvbGVfbmFtZSA9PiB7XG4gICAgICB0ZW1wbGF0ZSA9IHtcbiAgICAgICAgLi4udGVtcGxhdGUsXG4gICAgICAgIHJvbGVzOiB0ZW1wbGF0ZS5yb2xlcy5maWx0ZXIocm9sZSA9PiByb2xlLm5hbWUgIT09IHJvbGVfbmFtZSlcbiAgICAgIH1cbiAgICAgIGRlbGV0ZUNhbGxzLnB1c2godGhpcy5odHRwLmRlbGV0ZSh0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvcm9sZXMvJyArIHJvbGVfbmFtZSkpXG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcmtKb2luKGRlbGV0ZUNhbGxzKS5waXBlKFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdDb3VsZG5cXCd0IGRlbGV0ZSBhbGwgdGhlIHJvbGVzJyk7XG4gICAgICAgIHJldHVybiBlcnI7XG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIHVwZGF0ZVJvbGVzKHJvbGVzLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBjb25zdCB1cGRhdGVDYWxscyA9IFtdO1xuICAgIHJvbGVzLmZvckVhY2gocm9sZSA9PiB7XG4gICAgICBjb25zdCBib2R5ID0ge1xuICAgICAgICB0ZW1wbGF0ZV9pZDogdGVtcGxhdGUuaWQsXG4gICAgICAgIG5hbWU6IHJvbGUubmFtZS50cmltKCksXG4gICAgICAgIGZ1bGxfbmFtZTogcm9sZS5mdWxsX25hbWUsXG4gICAgICAgIGVtYWlsOiByb2xlLmVtYWlsLFxuICAgICAgICBzZXF1ZW5jZTogcm9sZS5zZXF1ZW5jZSxcbiAgICAgICAgdHlwZTogcm9sZS50eXBlLFxuICAgICAgICBkZWxlZ2F0b3I6IHJvbGUuZGVsZWdhdG9yLFxuICAgICAgICBtZXNzYWdlOiByb2xlLm1lc3NhZ2UsXG4gICAgICAgIHBob25lOiByb2xlLnBob25lXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJvbGVfaW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogcm9sZS5vbGRfbmFtZSB9KTtcbiAgICAgIGlmIChyb2xlX2luZGV4ID49IDApIHtcbiAgICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0gPSB7XG4gICAgICAgICAgLi4udGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0sXG4gICAgICAgICAgdGVtcGxhdGVfaWQ6IHRlbXBsYXRlLmlkLFxuICAgICAgICAgIG5hbWU6IHJvbGUubmFtZS50cmltKCksXG4gICAgICAgICAgZnVsbF9uYW1lOiByb2xlLmZ1bGxfbmFtZSxcbiAgICAgICAgICBlbWFpbDogcm9sZS5lbWFpbCxcbiAgICAgICAgICBzZXF1ZW5jZTogcm9sZS5zZXF1ZW5jZSxcbiAgICAgICAgICB0eXBlOiByb2xlLnR5cGUsXG4gICAgICAgICAgZGVsZWdhdG9yOiByb2xlLmRlbGVnYXRvcixcbiAgICAgICAgICBtZXNzYWdlOiByb2xlLm1lc3NhZ2UsXG4gICAgICAgICAgcGhvbmU6IHJvbGUucGhvbmVcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5ldmVudFRyYWNrZXIuY3JlYXRlRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogJ2RvY3VtZW50JyxcbiAgICAgICAgYWN0aW9uOiAnZG9jdW1lbnQgcm9sZSB1cGRhdGVkJyxcbiAgICAgICAgbGFiZWw6IGBkb2N1bWVudCBpZDogJHt0ZW1wbGF0ZS5pZH1gXG4gICAgICB9KTtcbiAgICAgIHVwZGF0ZUNhbGxzLnB1c2godGhpcy5odHRwLnB1dCh0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvcm9sZXMvJyArIHJvbGUub2xkX25hbWUsIGJvZHkpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZm9ya0pvaW4odXBkYXRlQ2FsbHMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignQ291bGRuXFwndCBzYXZlIGFsbCB0aGUgcm9sZXMnKTtcbiAgICAgICAgICByZXR1cm4gZXJyO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxufSJdfQ==