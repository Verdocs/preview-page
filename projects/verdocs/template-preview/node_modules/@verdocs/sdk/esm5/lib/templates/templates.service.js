/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Inject, Injector, PLATFORM_ID } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { HttpClient, HttpResponse, HttpRequest } from '@angular/common/http';
// import { MatDialog } from '@angular/material/dialog'
import { catchError, map } from 'rxjs/operators';
import { Subject, Observable, EMPTY, of } from 'rxjs';
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { filter } from 'lodash';
// import { environment } from '../../../environments/environment';
import { TemplatesGuardService } from './templates.guard';
import { TemplateActions } from '../definitions/template.enums';
import { VSDKConfigToken } from '../angular-api.module';
var TemplatesService = /** @class */ (function () {
    function TemplatesService(http, vTokenObjectService, templateGuard, injector, platform) {
        this.http = http;
        this.vTokenObjectService = vTokenObjectService;
        this.templateGuard = templateGuard;
        this.injector = injector;
        this.platform = platform;
        this.templates = new Subject();
        this.template = new Subject();
        this.loadingStatus = new Subject();
        this._config_token = this.injector.get(VSDKConfigToken);
        this.rForm_backend_url = this._config_token.rForm_backend_url;
    }
    /**
     * @param {?} err
     * @return {?}
     */
    TemplatesService.prototype.errorMessageNotVerified = /**
     * @param {?} err
     * @return {?}
     */
    function (err) {
        return err.error.error === 'email is not verified' && err.error.code === 401;
    };
    /**
     * @param {?=} filter
     * @return {?}
     */
    TemplatesService.prototype.getTemplates = /**
     * @param {?=} filter
     * @return {?}
     */
    function (filter) {
        var _this = this;
        this.loadingStatus.next(true);
        this.templates.next([]);
        /** @type {?} */
        var query = null;
        if (filter) {
            switch (filter) {
                case 'creator':
                    query = '?is_creator=true';
                    break;
                case 'organization':
                    query = '?is_organization=true';
                    break;
                case 'starred':
                    query = '?is_starred=true';
                    break;
                default:
                    query = '';
                    break;
            }
        }
        /** @type {?} */
        var requestUrl = this.rForm_backend_url + '/templates' + (query ? query : '');
        return this.http.request(new HttpRequest('GET', requestUrl, {}, { reportProgress: true })).pipe(map((/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event instanceof HttpResponse) {
                /** @type {?} */
                var template = (/** @type {?} */ (event.body));
                _this.templates.next(template);
                _this.loadingStatus.next(false);
                return (/** @type {?} */ (event));
            }
            return event;
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            if (err && err.status === 401 && !_this.errorMessageNotVerified(err)) {
                // const errorDialog = this.dialog.open(FourOhOneDialog, {
                //   panelClass: 'error__dialog',
                //   disableClose: true
                // })
                // errorDialog.componentInstance.error = err;
            }
            _this.loadingStatus.next(false);
            return Observable.throw(err);
        })));
    };
    // Move this to another service
    // Move this to another service
    /**
     * @param {?} id
     * @param {?=} thumbnail
     * @return {?}
     */
    TemplatesService.prototype.getTemplateObservable = 
    // Move this to another service
    /**
     * @param {?} id
     * @param {?=} thumbnail
     * @return {?}
     */
    function (id, thumbnail) {
        var _this = this;
        this.loadingStatus.next(true);
        /** @type {?} */
        var templateUrl = this.rForm_backend_url + '/templates/' + id;
        if (thumbnail === true) {
            templateUrl += '?thumbnail=true';
        }
        return this.http.get(templateUrl)
            .pipe(map((/**
         * @param {?} template
         * @return {?}
         */
        function (template) {
            _this.loadingStatus.next(false);
            return template;
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            _this.loadingStatus.next(false);
            if (err && err.status === 401 && !_this.errorMessageNotVerified(err)) {
                // const errorDialog = this.dialog.open(FourOhOneDialog, {
                //   panelClass: 'error__dialog',
                //   disableClose: true
                // })
                // errorDialog.componentInstance.error = err;
                return of(err);
            }
            return EMPTY;
        })));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    TemplatesService.prototype.starTemplate = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        return this.http.post(this.rForm_backend_url + ("/templates/" + id + "/stars"), {}).pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        function (res) { return res; })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            if (err && err.status === 401 && _this.errorMessageNotVerified(err)) {
                // const errorDialog = this.dialog.open(FourOhOneDialog, {
                //   panelClass: 'error__dialog',
                //   disableClose: true
                // })
                // errorDialog.componentInstance.error = err;
                return of(err);
            }
            return Observable.throw(err);
        })));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    TemplatesService.prototype.unstarTemplate = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        return this.http.delete(this.rForm_backend_url + ("/templates/" + id + "/stars")).pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            if (err && err.status === 401 && _this.errorMessageNotVerified(err)) {
                // const errorDialog = this.dialog.open(FourOhOneDialog, {
                //   panelClass: 'error__dialog',
                //   disableClose: true
                // })
                // errorDialog.componentInstance.error = err;
                return of(err);
            }
            return Observable.throw((/** @type {?} */ (err)));
        })));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    TemplatesService.prototype.getTemplate = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        return this.getTemplateObservable(id).pipe(map((/**
         * @param {?} template
         * @return {?}
         */
        function (template) {
            _this.template.next(template);
            return template;
        })));
    };
    /**
     * @return {?}
     */
    TemplatesService.prototype.getCreatorTemplates = /**
     * @return {?}
     */
    function () {
        return this.getTemplates('creator');
    };
    /**
     * @return {?}
     */
    TemplatesService.prototype.getOrganizationTemplates = /**
     * @return {?}
     */
    function () {
        return this.getTemplates('organization');
    };
    /**
     * @return {?}
     */
    TemplatesService.prototype.getStarredTemplates = /**
     * @return {?}
     */
    function () {
        return this.getTemplates('starred');
    };
    /**
     * @return {?}
     */
    TemplatesService.prototype.getPermissions = /**
     * @return {?}
     */
    function () {
        return this.vTokenObjectService.getPermissions();
    };
    /**
     * @param {?} id
     * @return {?}
     */
    TemplatesService.prototype.getTemplateOwnerInfo = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.http.get(this.rForm_backend_url + "/templates/" + id + "?owner_info=true")
            .toPromise().then((/**
         * @param {?} res
         * @return {?}
         */
        function (res) {
            return res;
        }));
    };
    /**
     * @param {?} template_id
     * @param {?} template_document
     * @return {?}
     */
    TemplatesService.prototype.getTemplateDocumentPDFObservable = /**
     * @param {?} template_id
     * @param {?} template_document
     * @return {?}
     */
    function (template_id, template_document) {
        return this.http.get(this.rForm_backend_url + '/templates/' + template_id + '/documents/' +
            template_document.id + '?file=true', { responseType: 'blob' });
    };
    /**
     * @param {?} templateId
     * @param {?} templateDocument
     * @return {?}
     */
    TemplatesService.prototype.getTemplateDocument = /**
     * @param {?} templateId
     * @param {?} templateDocument
     * @return {?}
     */
    function (templateId, templateDocument) {
        return this.getTemplateDocumentPDFObservable(templateId, templateDocument).toPromise();
    };
    /**
     * @param {?} templateId
     * @param {?} templateDocumentId
     * @return {?}
     */
    TemplatesService.prototype.getTemplateThumbnail = /**
     * @param {?} templateId
     * @param {?} templateDocumentId
     * @return {?}
     */
    function (templateId, templateDocumentId) {
        return this.http.get(this.rForm_backend_url + '/templates/' + templateId + '/documents/' +
            templateDocumentId + '?thumbnail=true', { responseType: 'blob' }).toPromise();
    };
    /**
     * @param {?} templateId
     * @return {?}
     */
    TemplatesService.prototype.getAllTemplateDocumentsObservable = /**
     * @param {?} templateId
     * @return {?}
     */
    function (templateId) {
        return this.http.get(this.rForm_backend_url + '/templates/' + templateId + '/documents');
    };
    /**
     * @param {?} templateId
     * @return {?}
     */
    TemplatesService.prototype.getAllTemplateDocuments = /**
     * @param {?} templateId
     * @return {?}
     */
    function (templateId) {
        return this.http.get(this.rForm_backend_url + '/templates/' + templateId + '/documents')
            .toPromise();
    };
    /**
     * @param {?} template
     * @return {?}
     */
    TemplatesService.prototype.downloadTemplateDocument = /**
     * @param {?} template
     * @return {?}
     */
    function (template) {
        var _this = this;
        if ((isPlatformBrowser(this.platform))) {
            this.getTemplateDocument(template.id, template.template_documents[0]).then((/**
             * @param {?} template_file
             * @return {?}
             */
            function (template_file) {
                _this.prepareSave(template, template_file);
            }));
        }
    };
    /**
     * @param {?} template
     * @param {?} template_file
     * @return {?}
     */
    TemplatesService.prototype.prepareSave = /**
     * @param {?} template
     * @param {?} template_file
     * @return {?}
     */
    function (template, template_file) {
        if (window && window.URL) {
            /** @type {?} */
            var fileUrl = URL.createObjectURL(template_file);
            // saveAs(fileUrl, template.template_documents[0].name + '.pdf');
        }
    };
    /**
     * @param {?} searchParams
     * @return {?}
     */
    TemplatesService.prototype.searchTemplates = /**
     * @param {?} searchParams
     * @return {?}
     */
    function (searchParams) {
        for (var key in searchParams) {
            if (searchParams.hasOwnProperty(key)) {
                if (searchParams[key] === null) {
                    delete searchParams[key];
                }
            }
        }
        return this.http.request(new HttpRequest('POST', this.rForm_backend_url + '/templates/search', searchParams, {
            reportProgress: true,
            responseType: 'json'
        })).pipe(map((/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            return event;
        })));
    };
    /**
     * @param {?} templateId
     * @param {?} body
     * @return {?}
     */
    TemplatesService.prototype.updateTemplateObservable = /**
     * @param {?} templateId
     * @param {?} body
     * @return {?}
     */
    function (templateId, body) {
        return this.http.put(this.rForm_backend_url + '/templates/' + templateId, body);
    };
    /**
     * @param {?} templateId
     * @param {?} body
     * @return {?}
     */
    TemplatesService.prototype.updateTemplate = /**
     * @param {?} templateId
     * @param {?} body
     * @return {?}
     */
    function (templateId, body) {
        return this.updateTemplateObservable(templateId, body)
            .toPromise().then((/**
         * @param {?} template
         * @return {?}
         */
        function (template) { return template; }));
    };
    /**
     * @param {?} templateId
     * @return {?}
     */
    TemplatesService.prototype.deleteTemplate = /**
     * @param {?} templateId
     * @return {?}
     */
    function (templateId) {
        return this.http.delete(this.rForm_backend_url + '/templates/' + templateId);
    };
    /**
     * @param {?} templateId
     * @param {?} sequence_number
     * @return {?}
     */
    TemplatesService.prototype.deleteSequence = /**
     * @param {?} templateId
     * @param {?} sequence_number
     * @return {?}
     */
    function (templateId, sequence_number) {
        return this.http.delete(this.rForm_backend_url + '/templates/' + templateId + '/roles?sequence=' + sequence_number).toPromise();
    };
    /**
     * @param {?} templates
     * @return {?}
     */
    TemplatesService.prototype.updateTemplates = /**
     * @param {?} templates
     * @return {?}
     */
    function (templates) {
        this.templates.next(templates);
    };
    /**
     * @param {?} template
     * @return {?}
     */
    TemplatesService.prototype.canSendEnvelope = /**
     * @param {?} template
     * @return {?}
     */
    function (template) {
        var e_1, _a;
        if (template) {
            /** @type {?} */
            var signers = filter(template.roles, { type: 'signer' });
            /** @type {?} */
            var hasSigner = signers.length > 0;
            /** @type {?} */
            var signersHaveFields = false;
            if (hasSigner) {
                try {
                    for (var signers_1 = tslib_1.__values(signers), signers_1_1 = signers_1.next(); !signers_1_1.done; signers_1_1 = signers_1.next()) {
                        var signer = signers_1_1.value;
                        signersHaveFields = signer['fields'] && signer['fields'].length > 0;
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (signers_1_1 && !signers_1_1.done && (_a = signers_1.return)) _a.call(signers_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
            /** @type {?} */
            var hasAccessToTemplate = this.templateGuard.canPerformAction(TemplateActions.READ, template).canPerform;
            return hasAccessToTemplate && hasSigner && signersHaveFields && this.templateGuard.canBeSender(template);
        }
        else {
            return false;
        }
    };
    TemplatesService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    TemplatesService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: VerdocsTokenObjectService },
        { type: TemplatesGuardService },
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
    ]; };
    return TemplatesService;
}());
export { TemplatesService };
if (false) {
    /** @type {?} */
    TemplatesService.prototype.templates;
    /** @type {?} */
    TemplatesService.prototype.template;
    /** @type {?} */
    TemplatesService.prototype.loadingStatus;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.rForm_backend_url;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.vTokenObjectService;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.templateGuard;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    TemplatesService.prototype.platform;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdmVyZG9jcy9zZGsvIiwic291cmNlcyI6WyJsaWIvdGVtcGxhdGVzL3RlbXBsYXRlcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQWdDLE1BQU0sc0JBQXNCLENBQUM7O0FBRTNHLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sUUFBUSxDQUFDOztBQUtoQyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFHaEUsT0FBTyxFQUFjLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXBFO0lBU0UsMEJBQ1UsSUFBZ0IsRUFDaEIsbUJBQThDLEVBQzlDLGFBQW9DLEVBRXBDLFFBQWtCLEVBQ0csUUFBUTtRQUw3QixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBMkI7UUFDOUMsa0JBQWEsR0FBYixhQUFhLENBQXVCO1FBRXBDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDRyxhQUFRLEdBQVIsUUFBUSxDQUFBO1FBYmhDLGNBQVMsR0FBeUIs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Z0JBQWdCLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxVQUFVO1lBQzFHLE9BQU8sbUJBQW1CLElBQUksU0FBUyxJQUFJLGlCQUFpQixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzFHO2FBQU07WUFDTCxPQUFPLEtBQUssQ0FBQztTQUNkO0lBQ0gsQ0FBQzs7Z0JBMVFGLFVBQVU7Ozs7Z0JBaEJGLFVBQVU7Z0JBSVYseUJBQXlCO2dCQU16QixxQkFBcUI7Z0JBWkQsUUFBUTtnREFpQ2hDLE1BQU0sU0FBQyxXQUFXOztJQTRQdkIsdUJBQUM7Q0FBQSxBQTNRRCxJQTJRQztTQTFRWSxnQkFBZ0I7OztJQUMzQixxQ0FBb0U7O0lBQ3BFLG9DQUFvRTs7SUFDcEUseUNBQThDOzs7OztJQUU5Qyx5Q0FBa0M7Ozs7O0lBQ2xDLDZDQUFrQzs7Ozs7SUFHaEMsZ0NBQXdCOzs7OztJQUN4QiwrQ0FBc0Q7Ozs7O0lBQ3RELHlDQUE0Qzs7Ozs7SUFFNUMsb0NBQTBCOzs7OztJQUMxQixvQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIEluamVjdG9yLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFJlc3BvbnNlLCBIdHRwUmVxdWVzdCwgSHR0cEV2ZW50LCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbi8vIGltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZydcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIEVNUFRZLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZSB9IGZyb20gJ0B2ZXJkb2NzL3Rva2Vucyc7XG5pbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdsb2Rhc2gnO1xuLy8gaW1wb3J0IHsgc2F2ZUFzIH0gZnJvbSAnZmlsZS1zYXZlcic7XG5cbmltcG9ydCB7IElUZW1wbGF0ZSwgSVN0YXJUZW1wbGF0ZSB9IGZyb20gJy4uL21vZGVscy90ZW1wbGF0ZS5tb2RlbCdcbi8vIGltcG9ydCB7IGVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vLi4vZW52aXJvbm1lbnRzL2Vudmlyb25tZW50JztcbmltcG9ydCB7IFRlbXBsYXRlc0d1YXJkU2VydmljZSB9IGZyb20gJy4vdGVtcGxhdGVzLmd1YXJkJztcbmltcG9ydCB7IFRlbXBsYXRlQWN0aW9ucyB9IGZyb20gJy4uL2RlZmluaXRpb25zL3RlbXBsYXRlLmVudW1zJztcbi8vIGltcG9ydCB7IEZvdXJPaE9uZURpYWxvZyB9IGZyb20gJy4uLy4uL3NoYXJlZC9kaWFsb2dzL2Vycm9yLWRpYWxvZ3MvZm91ci1vaC1vbmUuZGlhbG9nJztcbmltcG9ydCB7IElUZW1wbGF0ZVNlYXJjaFBhcmFtcyB9IGZyb20gJy4uL21vZGVscy90ZW1wbGF0ZV9zZWFyY2gubW9kZWwnO1xuaW1wb3J0IHsgVlNES0NvbmZpZywgVlNES0NvbmZpZ1Rva2VuIH0gZnJvbSAnLi4vYW5ndWxhci1hcGkubW9kdWxlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRlbXBsYXRlc1NlcnZpY2Uge1xuICBwdWJsaWMgdGVtcGxhdGVzOiBTdWJqZWN0PElUZW1wbGF0ZVtdPiA9IG5ldyBTdWJqZWN0PElUZW1wbGF0ZVtdPigpO1xuICBwdWJsaWMgdGVtcGxhdGU6IFN1YmplY3Q8SVRlbXBsYXRlIHwge30+ID0gbmV3IFN1YmplY3Q8SVRlbXBsYXRlPigpO1xuICBwdWJsaWMgbG9hZGluZ1N0YXR1cyA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgcHJpdmF0ZSBfY29uZmlnX3Rva2VuOiBWU0RLQ29uZmlnO1xuICBwcml2YXRlIHJGb3JtX2JhY2tlbmRfdXJsOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgdlRva2VuT2JqZWN0U2VydmljZTogVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZSxcbiAgICBwcml2YXRlIHRlbXBsYXRlR3VhcmQ6IFRlbXBsYXRlc0d1YXJkU2VydmljZSxcbiAgICAvLyBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1cbiAgKSB7XG4gICAgdGhpcy5fY29uZmlnX3Rva2VuID0gdGhpcy5pbmplY3Rvci5nZXQoVlNES0NvbmZpZ1Rva2VuKTtcbiAgICB0aGlzLnJGb3JtX2JhY2tlbmRfdXJsID0gdGhpcy5fY29uZmlnX3Rva2VuLnJGb3JtX2JhY2tlbmRfdXJsO1xuICB9XG5cbiAgZXJyb3JNZXNzYWdlTm90VmVyaWZpZWQoZXJyKSB7XG4gICAgcmV0dXJuIGVyci5lcnJvci5lcnJvciA9PT0gJ2VtYWlsIGlzIG5vdCB2ZXJpZmllZCcgJiYgZXJyLmVycm9yLmNvZGUgPT09IDQwMTtcbiAgfVxuXG4gIGdldFRlbXBsYXRlcyhmaWx0ZXI/OiAnY3JlYXRvcicgfCAnb3JnYW5pemF0aW9uJyB8ICdzdGFycmVkJyk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4gfCBJVGVtcGxhdGVbXSB8IEh0dHBFcnJvclJlc3BvbnNlPiB7XG4gICAgdGhpcy5sb2FkaW5nU3RhdHVzLm5leHQodHJ1ZSk7XG4gICAgdGhpcy50ZW1wbGF0ZXMubmV4dChbXSk7XG4gICAgbGV0IHF1ZXJ5ID0gbnVsbDtcbiAgICBpZiAoZmlsdGVyKSB7XG4gICAgICBzd2l0Y2ggKGZpbHRlcikge1xuICAgICAgICBjYXNlICdjcmVhdG9yJzpcbiAgICAgICAgICBxdWVyeSA9ICc/aXNfY3JlYXRvcj10cnVlJztcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnb3JnYW5pemF0aW9uJzpcbiAgICAgICAgICBxdWVyeSA9ICc/aXNfb3JnYW5pemF0aW9uPXRydWUnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdzdGFycmVkJzpcbiAgICAgICAgICBxdWVyeSA9ICc/aXNfc3RhcnJlZD10cnVlJztcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBxdWVyeSA9ICcnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0VXJsID0gdGhpcy5yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzJyArIChxdWVyeSA/IHF1ZXJ5IDogJycpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucmVxdWVzdChuZXcgSHR0cFJlcXVlc3QoXG4gICAgICAnR0VUJyxcbiAgICAgIHJlcXVlc3RVcmwsXG4gICAgICB7fSxcbiAgICAgIHsgcmVwb3J0UHJvZ3Jlc3M6IHRydWUgfVxuICAgICkpLnBpcGUoXG4gICAgICBtYXAoKGV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gPElUZW1wbGF0ZVtdPmV2ZW50LmJvZHk7XG4gICAgICAgICAgdGhpcy50ZW1wbGF0ZXMubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU3RhdHVzLm5leHQoZmFsc2UpO1xuICAgICAgICAgIHJldHVybiBldmVudCBhcyBIdHRwUmVzcG9uc2U8SVRlbXBsYXRlW10+O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBldmVudDtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT09IDQwMSAmJiAhdGhpcy5lcnJvck1lc3NhZ2VOb3RWZXJpZmllZChlcnIpKSB7XG4gICAgICAgICAgLy8gY29uc3QgZXJyb3JEaWFsb2cgPSB0aGlzLmRpYWxvZy5vcGVuKEZvdXJPaE9uZURpYWxvZywge1xuICAgICAgICAgIC8vICAgcGFuZWxDbGFzczogJ2Vycm9yX19kaWFsb2cnLFxuICAgICAgICAgIC8vICAgZGlzYWJsZUNsb3NlOiB0cnVlXG4gICAgICAgICAgLy8gfSlcbiAgICAgICAgICAvLyBlcnJvckRpYWxvZy5jb21wb25lbnRJbnN0YW5jZS5lcnJvciA9IGVycjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxvYWRpbmdTdGF0dXMubmV4dChmYWxzZSk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycilcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8vIE1vdmUgdGhpcyB0byBhbm90aGVyIHNlcnZpY2VcbiAgZ2V0VGVtcGxhdGVPYnNlcnZhYmxlKGlkOiBzdHJpbmcsIHRodW1ibmFpbD86IGJvb2xlYW4pOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIHRoaXMubG9hZGluZ1N0YXR1cy5uZXh0KHRydWUpO1xuICAgIGxldCB0ZW1wbGF0ZVVybCA9IHRoaXMuckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgaWQ7XG4gICAgaWYgKHRodW1ibmFpbCA9PT0gdHJ1ZSkge1xuICAgICAgdGVtcGxhdGVVcmwgKz0gJz90aHVtYm5haWw9dHJ1ZSc7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PElUZW1wbGF0ZT4odGVtcGxhdGVVcmwpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHRlbXBsYXRlID0+IHtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTdGF0dXMubmV4dChmYWxzZSk7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1N0YXR1cy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT09IDQwMSAmJiAhdGhpcy5lcnJvck1lc3NhZ2VOb3RWZXJpZmllZChlcnIpKSB7XG4gICAgICAgICAgICAvLyBjb25zdCBlcnJvckRpYWxvZyA9IHRoaXMuZGlhbG9nLm9wZW4oRm91ck9oT25lRGlhbG9nLCB7XG4gICAgICAgICAgICAvLyAgIHBhbmVsQ2xhc3M6ICdlcnJvcl9fZGlhbG9nJyxcbiAgICAgICAgICAgIC8vICAgZGlzYWJsZUNsb3NlOiB0cnVlXG4gICAgICAgICAgICAvLyB9KVxuICAgICAgICAgICAgLy8gZXJyb3JEaWFsb2cuY29tcG9uZW50SW5zdGFuY2UuZXJyb3IgPSBlcnI7XG4gICAgICAgICAgICByZXR1cm4gb2YoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gRU1QVFlcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBzdGFyVGVtcGxhdGUoaWQpOiBPYnNlcnZhYmxlPElTdGFyVGVtcGxhdGUgfCBIdHRwRXJyb3JSZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh0aGlzLnJGb3JtX2JhY2tlbmRfdXJsICsgYC90ZW1wbGF0ZXMvJHtpZH0vc3RhcnNgLCB7fSkucGlwZShcbiAgICAgIG1hcCgocmVzOiBJU3RhclRlbXBsYXRlKSA9PiByZXMpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT09IDQwMSAmJiB0aGlzLmVycm9yTWVzc2FnZU5vdFZlcmlmaWVkKGVycikpIHtcbiAgICAgICAgICAvLyBjb25zdCBlcnJvckRpYWxvZyA9IHRoaXMuZGlhbG9nLm9wZW4oRm91ck9oT25lRGlhbG9nLCB7XG4gICAgICAgICAgLy8gICBwYW5lbENsYXNzOiAnZXJyb3JfX2RpYWxvZycsXG4gICAgICAgICAgLy8gICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgICAvLyB9KVxuICAgICAgICAgIC8vIGVycm9yRGlhbG9nLmNvbXBvbmVudEluc3RhbmNlLmVycm9yID0gZXJyO1xuICAgICAgICAgIHJldHVybiBvZihlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICB1bnN0YXJUZW1wbGF0ZShpZCkge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlKHRoaXMuckZvcm1fYmFja2VuZF91cmwrIGAvdGVtcGxhdGVzLyR7aWR9L3N0YXJzYCkucGlwZShcbiAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcbiAgICAgICAgaWYgKGVyciAmJiBlcnIuc3RhdHVzID09PSA0MDEgJiYgdGhpcy5lcnJvck1lc3NhZ2VOb3RWZXJpZmllZChlcnIpKSB7XG4gICAgICAgICAgLy8gY29uc3QgZXJyb3JEaWFsb2cgPSB0aGlzLmRpYWxvZy5vcGVuKEZvdXJPaE9uZURpYWxvZywge1xuICAgICAgICAgIC8vICAgcGFuZWxDbGFzczogJ2Vycm9yX19kaWFsb2cnLFxuICAgICAgICAgIC8vICAgZGlzYWJsZUNsb3NlOiB0cnVlXG4gICAgICAgICAgLy8gfSlcbiAgICAgICAgICAvLyBlcnJvckRpYWxvZy5jb21wb25lbnRJbnN0YW5jZS5lcnJvciA9IGVycjtcbiAgICAgICAgICByZXR1cm4gb2YoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnIgYXMgSHR0cEVycm9yUmVzcG9uc2UpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0VGVtcGxhdGUoaWQpOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLmdldFRlbXBsYXRlT2JzZXJ2YWJsZShpZCkucGlwZShcbiAgICAgIG1hcCgodGVtcGxhdGU6IElUZW1wbGF0ZSkgPT4ge1xuICAgICAgICB0aGlzLnRlbXBsYXRlLm5leHQodGVtcGxhdGUpO1xuICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRDcmVhdG9yVGVtcGxhdGVzKCkge1xuICAgIHJldHVybiB0aGlzLmdldFRlbXBsYXRlcygnY3JlYXRvcicpO1xuICB9XG5cbiAgZ2V0T3JnYW5pemF0aW9uVGVtcGxhdGVzKCkge1xuICAgIHJldHVybiB0aGlzLmdldFRlbXBsYXRlcygnb3JnYW5pemF0aW9uJyk7XG4gIH1cblxuICBnZXRTdGFycmVkVGVtcGxhdGVzKCkge1xuICAgIHJldHVybiB0aGlzLmdldFRlbXBsYXRlcygnc3RhcnJlZCcpO1xuICB9XG5cbiAgZ2V0UGVybWlzc2lvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQZXJtaXNzaW9ucygpO1xuICB9XG5cblxuICBnZXRUZW1wbGF0ZU93bmVySW5mbyhpZDogc3RyaW5nKTogUHJvbWlzZTx7IHByb2ZpbGVfaWQ6IHN0cmluZywgZW1haWw6IHN0cmluZywgbmFtZTogc3RyaW5nIH0+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDx7IHByb2ZpbGVfaWQ6IHN0cmluZywgZW1haWw6IHN0cmluZywgbmFtZTogc3RyaW5nIH0+KGAke3RoaXMuckZvcm1fYmFja2VuZF91cmx9L3RlbXBsYXRlcy8ke2lkfT9vd25lcl9pbmZvPXRydWVgKVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgIH0pO1xuICB9XG5cbiAgZ2V0VGVtcGxhdGVEb2N1bWVudFBERk9ic2VydmFibGUodGVtcGxhdGVfaWQsIHRlbXBsYXRlX2RvY3VtZW50KSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZV9pZCArICcvZG9jdW1lbnRzLycgK1xuICAgICAgdGVtcGxhdGVfZG9jdW1lbnQuaWQgKyAnP2ZpbGU9dHJ1ZScsIHsgcmVzcG9uc2VUeXBlOiAnYmxvYicgfSlcbiAgfVxuXG4gIGdldFRlbXBsYXRlRG9jdW1lbnQodGVtcGxhdGVJZCwgdGVtcGxhdGVEb2N1bWVudCkge1xuICAgIHJldHVybiB0aGlzLmdldFRlbXBsYXRlRG9jdW1lbnRQREZPYnNlcnZhYmxlKHRlbXBsYXRlSWQsIHRlbXBsYXRlRG9jdW1lbnQpLnRvUHJvbWlzZSgpO1xuICB9XG5cbiAgZ2V0VGVtcGxhdGVUaHVtYm5haWwodGVtcGxhdGVJZCwgdGVtcGxhdGVEb2N1bWVudElkKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZUlkICsgJy9kb2N1bWVudHMvJyArXG4gICAgICB0ZW1wbGF0ZURvY3VtZW50SWQgKyAnP3RodW1ibmFpbD10cnVlJywgeyByZXNwb25zZVR5cGU6ICdibG9iJyB9KS50b1Byb21pc2UoKTtcbiAgfVxuXG4gIGdldEFsbFRlbXBsYXRlRG9jdW1lbnRzT2JzZXJ2YWJsZSh0ZW1wbGF0ZUlkKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZUlkICsgJy9kb2N1bWVudHMnKVxuICB9XG5cbiAgZ2V0QWxsVGVtcGxhdGVEb2N1bWVudHModGVtcGxhdGVJZCkge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMuckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGVJZCArICcvZG9jdW1lbnRzJylcbiAgICAgIC50b1Byb21pc2UoKVxuICB9XG5cbiAgZG93bmxvYWRUZW1wbGF0ZURvY3VtZW50KHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICBpZiAoKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSkge1xuICAgICAgdGhpcy5nZXRUZW1wbGF0ZURvY3VtZW50KHRlbXBsYXRlLmlkLCB0ZW1wbGF0ZS50ZW1wbGF0ZV9kb2N1bWVudHNbMF0pLnRoZW4odGVtcGxhdGVfZmlsZSA9PiB7XG4gICAgICAgIHRoaXMucHJlcGFyZVNhdmUodGVtcGxhdGUsIHRlbXBsYXRlX2ZpbGUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJlcGFyZVNhdmUodGVtcGxhdGUsIHRlbXBsYXRlX2ZpbGUpIHtcbiAgICBpZiAod2luZG93ICYmIHdpbmRvdy5VUkwpIHtcbiAgICAgIGNvbnN0IGZpbGVVcmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHRlbXBsYXRlX2ZpbGUpO1xuICAgICAgLy8gc2F2ZUFzKGZpbGVVcmwsIHRlbXBsYXRlLnRlbXBsYXRlX2RvY3VtZW50c1swXS5uYW1lICsgJy5wZGYnKTtcbiAgICB9XG4gIH1cblxuICBzZWFyY2hUZW1wbGF0ZXMoc2VhcmNoUGFyYW1zOiBJVGVtcGxhdGVTZWFyY2hQYXJhbXMpIHtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBzZWFyY2hQYXJhbXMpIHtcbiAgICAgIGlmIChzZWFyY2hQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBpZiAoc2VhcmNoUGFyYW1zW2tleV0gPT09IG51bGwpIHtcbiAgICAgICAgICBkZWxldGUgc2VhcmNoUGFyYW1zW2tleV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5yZXF1ZXN0KG5ldyBIdHRwUmVxdWVzdChcbiAgICAgICdQT1NUJyxcbiAgICAgIHRoaXMuckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy9zZWFyY2gnLFxuICAgICAgc2VhcmNoUGFyYW1zLFxuICAgICAge1xuICAgICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZSxcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAnanNvbidcbiAgICAgIH1cbiAgICApKS5waXBlKFxuICAgICAgbWFwKGV2ZW50ID0+IHtcbiAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgdXBkYXRlVGVtcGxhdGVPYnNlcnZhYmxlKHRlbXBsYXRlSWQ6IHN0cmluZywgYm9keSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQ8SVRlbXBsYXRlPih0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGVJZCwgYm9keSk7XG4gIH1cblxuICB1cGRhdGVUZW1wbGF0ZSh0ZW1wbGF0ZUlkOiBzdHJpbmcsIGJvZHkpOiBQcm9taXNlPElUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVRlbXBsYXRlT2JzZXJ2YWJsZSh0ZW1wbGF0ZUlkLCBib2R5KVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4odGVtcGxhdGUgPT4gdGVtcGxhdGUpO1xuICB9XG5cbiAgZGVsZXRlVGVtcGxhdGUodGVtcGxhdGVJZCkge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlKHRoaXMuckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGVJZCk7XG4gIH1cblxuICBkZWxldGVTZXF1ZW5jZSh0ZW1wbGF0ZUlkLCBzZXF1ZW5jZV9udW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZSh0aGlzLnJGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlSWQgKyAnL3JvbGVzP3NlcXVlbmNlPScgKyBzZXF1ZW5jZV9udW1iZXIpLnRvUHJvbWlzZSgpXG4gIH1cblxuICB1cGRhdGVUZW1wbGF0ZXModGVtcGxhdGVzKSB7XG4gICAgdGhpcy50ZW1wbGF0ZXMubmV4dCh0ZW1wbGF0ZXMpO1xuICB9XG5cbiAgY2FuU2VuZEVudmVsb3BlKHRlbXBsYXRlKSB7XG4gICAgaWYgKHRlbXBsYXRlKSB7XG4gICAgICBjb25zdCBzaWduZXJzID0gZmlsdGVyKHRlbXBsYXRlLnJvbGVzLCB7IHR5cGU6ICdzaWduZXInIH0pO1xuICAgICAgY29uc3QgaGFzU2lnbmVyID0gc2lnbmVycy5sZW5ndGggPiAwO1xuICAgICAgbGV0IHNpZ25lcnNIYXZlRmllbGRzID0gZmFsc2U7XG4gICAgICBpZiAoaGFzU2lnbmVyKSB7XG4gICAgICAgIGZvciAoY29uc3Qgc2lnbmVyIG9mIHNpZ25lcnMpIHtcbiAgICAgICAgICBzaWduZXJzSGF2ZUZpZWxkcyA9IHNpZ25lclsnZmllbGRzJ10gJiYgc2lnbmVyWydmaWVsZHMnXS5sZW5ndGggPiAwXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IGhhc0FjY2Vzc1RvVGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlR3VhcmQuY2FuUGVyZm9ybUFjdGlvbihUZW1wbGF0ZUFjdGlvbnMuUkVBRCwgdGVtcGxhdGUpLmNhblBlcmZvcm07XG4gICAgICByZXR1cm4gaGFzQWNjZXNzVG9UZW1wbGF0ZSAmJiBoYXNTaWduZXIgJiYgc2lnbmVyc0hhdmVGaWVsZHMgJiYgdGhpcy50ZW1wbGF0ZUd1YXJkLmNhbkJlU2VuZGVyKHRlbXBsYXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxufVxuIl19