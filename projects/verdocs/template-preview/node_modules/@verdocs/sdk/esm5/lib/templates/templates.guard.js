/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { intersection } from 'lodash';
import { Injectable } from '@angular/core';
import { TemplateActions, TemplatePermissions, TemplateSenderTypes } from '../definitions/template.enums';
var TemplatesGuardService = /** @class */ (function () {
    function TemplatesGuardService(vTokenObjectService) {
        this.vTokenObjectService = vTokenObjectService;
    }
    /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    TemplatesGuardService.prototype.canPerformAction = /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    function (action, template) {
        try {
            /** @type {?} */
            var canPerform = false;
            /** @type {?} */
            var message = null;
            /** @type {?} */
            var neededPermissions = [];
            if (!template && !action.includes('create')) {
                throw {
                    error: 'You need to provide template object'
                };
            }
            /** @type {?} */
            var userProfile = this.vTokenObjectService.getProfile();
            /** @type {?} */
            var isCreator = userProfile ? template && template.profile_id === userProfile.id : false;
            /** @type {?} */
            var isSameOrg = userProfile ? template && template.organization_id === userProfile.organization_id : false;
            /** @type {?} */
            var isPersonal = template ? template.is_personal : null;
            /** @type {?} */
            var isPublic = template ? template.is_public : null;
            switch (action) {
                case TemplateActions.CREATE_PERSONAL:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                    break;
                case TemplateActions.CREATE_ORG:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                    break;
                case TemplateActions.CREATE_PUBLIC:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                    break;
                case TemplateActions.READ:
                    if (!isCreator) {
                        if ((!isPersonal && isSameOrg) || !isPublic) {
                            neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        }
                    }
                    break;
                case TemplateActions.WRITE:
                    if (!isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_WRITE);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PERSONAL:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_ORG:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PUBLIC:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.DELETE:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_DELETE);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_DELETE);
                    }
                    break;
                default:
                    throw {
                        error: 'Action is not defined'
                    };
            }
            if (this.hasPermissions(neededPermissions)) {
                canPerform = true;
            }
            else {
                message = "Insufficient access to perform '" + action + "'. Needed permissions: " + neededPermissions.toString();
            }
            return {
                canPerform: canPerform,
                message: message
            };
        }
        catch (err) {
            console.error({
                message: "Failed to check whether action (" + action + ") can be done, in TemplateGuardService",
                err: err
            });
        }
    };
    /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    TemplatesGuardService.prototype.hasPermissions = /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    function (requiredPermissions) {
        /** @type {?} */
        var userPermissions = this.vTokenObjectService.getPermissions();
        /** @type {?} */
        var hasPermissions = intersection(userPermissions, requiredPermissions).length === requiredPermissions.length;
        return hasPermissions;
    };
    /**
     * @param {?} template
     * @return {?}
     */
    TemplatesGuardService.prototype.canBeSender = /**
     * @param {?} template
     * @return {?}
     */
    function (template) {
        /** @type {?} */
        var userProfile = this.vTokenObjectService.getProfile();
        if (!userProfile) {
            return false;
        }
        switch (template.sender) {
            case TemplateSenderTypes.CREATOR:
                return userProfile.id === template.profile_id;
            case TemplateSenderTypes.ORGANIZATION_MEMBER:
            case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                return userProfile.id === template.profile_id || template.organization_id === userProfile.organization_id;
            default:
                return true;
        }
    };
    /**
     * @return {?}
     */
    TemplatesGuardService.prototype.canUserCreateTemplate = /**
     * @return {?}
     */
    function () {
        return this.canPerformAction(TemplateActions.CREATE_PERSONAL, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_ORG, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_PUBLIC, null)['canPerform'];
    };
    TemplatesGuardService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    TemplatesGuardService.ctorParameters = function () { return [
        { type: VerdocsTokenObjectService }
    ]; };
    return TemplatesGuardService;
}());
export { TemplatesGuardService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TemplatesGuardService.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLmd1YXJkLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlcy90ZW1wbGF0ZXMuZ3VhcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFHMUc7SUFJRSwrQkFDVSxtQkFBOEM7UUFBOUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUEyQjtJQUNwRCxDQUFDOzs7Ozs7SUFHRSxnREFBZ0I7Ozs7O0lBQXZCLFVBQXdCLE1BQXVCLEVBQUUsUUFBbUI7UUFDbEUsSUFBSTs7Z0JBQ0UsVUFBVSxHQUFHLEtBQUs7O2dCQUNsQixPQUFPLEdBQUcsSUFBSTs7Z0JBQ1osaUJBQWlCLEdBQUcsRUFBRTtZQUM1QixJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDM0MsTUFBTTtvQkFDSixLQUFLLEVBQ0gscUNBQXFDO2lCQUN4QyxDQUFBO2FBQ0Y7O2dCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFOztnQkFDbkQsU0FBUyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSzs7Z0JBQ3BGLFNBQVMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsZUFBZSxLQUFLLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FB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VyxDQUFDLGVBQWUsQ0FBQztZQUM1RztnQkFDRSxPQUFPLElBQUksQ0FBQztTQUNmO0lBQ0gsQ0FBQzs7OztJQUVELHFEQUFxQjs7O0lBQXJCO1FBQ0UsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUM7ZUFDNUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDO2VBQ3JFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFBO0lBQy9FLENBQUM7O2dCQS9IRixVQUFVOzs7O2dCQVBGLHlCQUF5Qjs7SUF3SWxDLDRCQUFDO0NBQUEsQUFqSUQsSUFpSUM7U0FoSVkscUJBQXFCOzs7Ozs7SUFJOUIsb0RBQXNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZSB9IGZyb20gJ0B2ZXJkb2NzL3Rva2Vucyc7XG5pbXBvcnQgeyBpbnRlcnNlY3Rpb24gfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUZW1wbGF0ZUFjdGlvbnMsIFRlbXBsYXRlUGVybWlzc2lvbnMsIFRlbXBsYXRlU2VuZGVyVHlwZXMgfSBmcm9tICcuLi9kZWZpbml0aW9ucy90ZW1wbGF0ZS5lbnVtcyc7XG5pbXBvcnQgeyBJVGVtcGxhdGUgfSBmcm9tICcuLi9tb2RlbHMvdGVtcGxhdGUubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGVtcGxhdGVzR3VhcmRTZXJ2aWNlIHtcblxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdlRva2VuT2JqZWN0U2VydmljZTogVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZVxuICApIHsgfVxuXG5cbiAgcHVibGljIGNhblBlcmZvcm1BY3Rpb24oYWN0aW9uOiBUZW1wbGF0ZUFjdGlvbnMsIHRlbXBsYXRlOiBJVGVtcGxhdGUpOiB7IGNhblBlcmZvcm06IGJvb2xlYW4sIG1lc3NhZ2U6IHN0cmluZyB9IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNhblBlcmZvcm0gPSBmYWxzZTtcbiAgICAgIGxldCBtZXNzYWdlID0gbnVsbDtcbiAgICAgIGNvbnN0IG5lZWRlZFBlcm1pc3Npb25zID0gW107XG4gICAgICBpZiAoIXRlbXBsYXRlICYmICFhY3Rpb24uaW5jbHVkZXMoJ2NyZWF0ZScpKSB7XG4gICAgICAgIHRocm93IHtcbiAgICAgICAgICBlcnJvcjpcbiAgICAgICAgICAgICdZb3UgbmVlZCB0byBwcm92aWRlIHRlbXBsYXRlIG9iamVjdCdcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgdXNlclByb2ZpbGUgPSB0aGlzLnZUb2tlbk9iamVjdFNlcnZpY2UuZ2V0UHJvZmlsZSgpO1xuICAgICAgY29uc3QgaXNDcmVhdG9yID0gdXNlclByb2ZpbGUgPyB0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZS5wcm9maWxlX2lkID09PSB1c2VyUHJvZmlsZS5pZCA6IGZhbHNlO1xuICAgICAgY29uc3QgaXNTYW1lT3JnID0gdXNlclByb2ZpbGUgPyB0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZS5vcmdhbml6YXRpb25faWQgPT09IHVzZXJQcm9maWxlLm9yZ2FuaXphdGlvbl9pZCA6IGZhbHNlO1xuICAgICAgY29uc3QgaXNQZXJzb25hbCA9IHRlbXBsYXRlID8gdGVtcGxhdGUuaXNfcGVyc29uYWwgOiBudWxsO1xuICAgICAgY29uc3QgaXNQdWJsaWMgPSB0ZW1wbGF0ZSA/IHRlbXBsYXRlLmlzX3B1YmxpYyA6IG51bGw7XG4gICAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfUEVSU09OQUw6XG4gICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX1BFUlNPTkFMKVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfT1JHOlxuICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9PUkcpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfUFVCTElDOlxuICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9QVUJMSUMpXG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLlJFQUQ6XG4gICAgICAgICAgaWYgKCFpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIGlmICgoIWlzUGVyc29uYWwgJiYgaXNTYW1lT3JnKSB8fCAhaXNQdWJsaWMpIHtcbiAgICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9SRUFEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLldSSVRFOlxuICAgICAgICAgIGlmICghaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1JFQUQpO1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9XUklURSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DSEFOR0VfVklTSUJJTElUWV9QRVJTT05BTDpcbiAgICAgICAgICBpZiAoaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUEVSU09OQUwpO1xuICAgICAgICAgICAgLy8gbmVlZGVkUGVybWlzc2lvbi5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNIQU5HRV9WSVNJQklMSVRZX09SRzpcbiAgICAgICAgICBpZiAoaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfT1JHKTtcbiAgICAgICAgICAgIC8vIG5lZWRlZFBlcm1pc3Npb24ucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfVklTSUJJTElUWSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfVklTSUJJTElUWSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DSEFOR0VfVklTSUJJTElUWV9QVUJMSUM6XG4gICAgICAgICAgaWYgKGlzQ3JlYXRvcikge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX1BVQkxJQyk7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkRFTEVURTpcbiAgICAgICAgICBpZiAoaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9ERUxFVEUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX0RFTEVURSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IHtcbiAgICAgICAgICAgIGVycm9yOiAnQWN0aW9uIGlzIG5vdCBkZWZpbmVkJ1xuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmhhc1Blcm1pc3Npb25zKG5lZWRlZFBlcm1pc3Npb25zKSkge1xuICAgICAgICBjYW5QZXJmb3JtID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1lc3NhZ2UgPSBgSW5zdWZmaWNpZW50IGFjY2VzcyB0byBwZXJmb3JtICcke2FjdGlvbn0nLiBOZWVkZWQgcGVybWlzc2lvbnM6ICR7bmVlZGVkUGVybWlzc2lvbnMudG9TdHJpbmcoKX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY2FuUGVyZm9ybSxcbiAgICAgICAgbWVzc2FnZVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcih7XG4gICAgICAgIG1lc3NhZ2U6IGBGYWlsZWQgdG8gY2hlY2sgd2hldGhlciBhY3Rpb24gKCR7YWN0aW9ufSkgY2FuIGJlIGRvbmUsIGluIFRlbXBsYXRlR3VhcmRTZXJ2aWNlYCxcbiAgICAgICAgZXJyOiBlcnJcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzUGVybWlzc2lvbnMocmVxdWlyZWRQZXJtaXNzaW9uczogc3RyaW5nW10pIHtcbiAgICBjb25zdCB1c2VyUGVybWlzc2lvbnMgPSB0aGlzLnZUb2tlbk9iamVjdFNlcnZpY2UuZ2V0UGVybWlzc2lvbnMoKTtcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9ucyA9IGludGVyc2VjdGlvbih1c2VyUGVybWlzc2lvbnMsIHJlcXVpcmVkUGVybWlzc2lvbnMpLmxlbmd0aCA9PT0gcmVxdWlyZWRQZXJtaXNzaW9ucy5sZW5ndGg7XG4gICAgcmV0dXJuIGhhc1Blcm1pc3Npb25zO1xuICB9XG5cbiAgcHVibGljIGNhbkJlU2VuZGVyKHRlbXBsYXRlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdXNlclByb2ZpbGUgPSB0aGlzLnZUb2tlbk9iamVjdFNlcnZpY2UuZ2V0UHJvZmlsZSgpO1xuICAgIGlmICghdXNlclByb2ZpbGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgc3dpdGNoICh0ZW1wbGF0ZS5zZW5kZXIpIHtcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5DUkVBVE9SOlxuICAgICAgICByZXR1cm4gdXNlclByb2ZpbGUuaWQgPT09IHRlbXBsYXRlLnByb2ZpbGVfaWQ7XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuT1JHQU5JWkFUSU9OX01FTUJFUjpcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5PUkdBTklaQVRJT05fTUVNQkVSX0FTX0NSRUFUT1I6XG4gICAgICAgIHJldHVybiB1c2VyUHJvZmlsZS5pZCA9PT0gdGVtcGxhdGUucHJvZmlsZV9pZCB8fCB0ZW1wbGF0ZS5vcmdhbml6YXRpb25faWQgPT09IHVzZXJQcm9maWxlLm9yZ2FuaXphdGlvbl9pZDtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIGNhblVzZXJDcmVhdGVUZW1wbGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jYW5QZXJmb3JtQWN0aW9uKFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfUEVSU09OQUwsIG51bGwpWydjYW5QZXJmb3JtJ11cbiAgICAgIHx8IHRoaXMuY2FuUGVyZm9ybUFjdGlvbihUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX09SRywgbnVsbClbJ2NhblBlcmZvcm0nXVxuICAgICAgfHwgdGhpcy5jYW5QZXJmb3JtQWN0aW9uKFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfUFVCTElDLCBudWxsKVsnY2FuUGVyZm9ybSddXG4gIH1cblxufVxuIl19