/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpRequest } from '@angular/common/http';
import { EventTrackerService } from '@verdocs/event-tracker';
import { ReplaySubject, throwError, from, forkJoin, of } from 'rxjs';
import { catchError, map, delay, mergeMap } from 'rxjs/operators';
import { findIndex } from 'lodash';
import { VSDKConfigToken } from '../angular-api.module';
var BuilderService = /** @class */ (function () {
    function BuilderService(http, injector, eventTracker) {
        this.http = http;
        this.injector = injector;
        this.eventTracker = eventTracker;
        this.saveStatusSubject = new ReplaySubject();
        this._config_token = this.injector.get(VSDKConfigToken);
        this._rForm_backend_url = this._config_token.rForm_backend_url;
    }
    /**
     * @param {?} template_body
     * @return {?}
     */
    BuilderService.prototype.createTemplate = /**
     * @param {?} template_body
     * @return {?}
     */
    function (template_body) {
        return this.http
            .post(this._rForm_backend_url + '/templates', template_body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        function (res) {
            return res;
        })));
    };
    /**
     * @param {?} file
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.uploadTemplateDocument = /**
     * @param {?} file
     * @param {?} template
     * @return {?}
     */
    function (file, template) {
        /** @type {?} */
        var formdata = new FormData();
        formdata.append('document', file, file.name);
        /** @type {?} */
        var req = new HttpRequest('POST', this._rForm_backend_url + "/templates/" + template.id + "/documents", formdata, {
            reportProgress: true
        });
        return this.http.request(req)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        function (res) { return res; })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            return throwError(err);
        })));
    };
    /**
     * @param {?} document
     * @param {?} pageNum
     * @param {?} templateId
     * @return {?}
     */
    BuilderService.prototype.addTemplatePage = /**
     * @param {?} document
     * @param {?} pageNum
     * @param {?} templateId
     * @return {?}
     */
    function (document, pageNum, templateId) {
        /** @type {?} */
        var body = {
            sequence: pageNum,
            page_number: pageNum,
            document_id: document.id
        };
        return this.http.post(this._rForm_backend_url + "/templates/" + templateId + "/pages", body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        function (res) { return res; })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            return throwError(err);
        })));
    };
    /**
     * @param {?} document
     * @param {?} pageNums
     * @param {?} templateId
     * @return {?}
     */
    BuilderService.prototype.addTemplatePages = /**
     * @param {?} document
     * @param {?} pageNums
     * @param {?} templateId
     * @return {?}
     */
    function (document, pageNums, templateId) {
        var _this = this;
        return from(pageNums)
            .pipe(mergeMap((/**
         * @param {?} pageNum
         * @return {?}
         */
        function (pageNum) {
            /** @type {?} */
            var page = {
                sequence: pageNum,
                page_number: pageNum,
                document_id: document.id
            };
            return (/** @type {?} */ (_this.http.post(_this._rForm_backend_url + "/templates/" + templateId + "/pages", page).pipe(delay(200))));
        })));
    };
    /**
     * @param {?} newField
     * @param {?} i
     * @param {?} j
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.addTemplateField = /**
     * @param {?} newField
     * @param {?} i
     * @param {?} j
     * @param {?} template
     * @return {?}
     */
    function (newField, i, j, template) {
        var _this = this;
        newField.name = newField.name.trim();
        return this.http
            .post(this._rForm_backend_url + '/templates/' + newField.template_id + '/fields', newField)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            _this.eventTracker.createEvent({
                category: 'document',
                action: "document " + field.type + " field added",
                label: "document id: " + newField.template_id
            });
            template.pages[i].fields[j] = field;
            // this.checkForFields(template.roles);
            /** @type {?} */
            var roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template.roles[roleIndex]['fields'].push(field);
            }
            // this.templateSubject.next(template);
            return template;
        })));
    };
    /**
     * @param {?} template
     * @param {?} fieldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    BuilderService.prototype.deleteTemplateField = /**
     * @param {?} template
     * @param {?} fieldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    function (template, fieldName, i, j) {
        return this.http
            .delete(this._rForm_backend_url + "/templates/" + template.id + "/fields/" + fieldName.trim())
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            /** @type {?} */
            var fieldIndex = findIndex(template.pages[i].fields, { name: fieldName });
            /** @type {?} */
            var roleIndex = findIndex(template.roles, { name: template.pages[i].fields[fieldIndex].role_name });
            if (roleIndex > -1) {
                /** @type {?} */
                var roleFieldIndex = findIndex(template.roles[roleIndex].fields, { name: fieldName });
                if (roleFieldIndex > -1) {
                    template.roles[roleIndex].fields.splice(roleFieldIndex, 1);
                }
            }
            template.pages[i].fields.splice(fieldIndex, 1);
            // this.updateLocalTemplate(template);
            // this.saveStatusSubject.next('saved');
            // this.checkForFields(template.roles);
            return template;
        })));
    };
    /**
     * @param {?} template
     * @param {?} updated_field
     * @param {?} role_index
     * @param {?} old_name
     * @return {?}
     */
    BuilderService.prototype.updateRoleField = /**
     * @param {?} template
     * @param {?} updated_field
     * @param {?} role_index
     * @param {?} old_name
     * @return {?}
     */
    function (template, updated_field, role_index, old_name) {
        /** @type {?} */
        var field_index = findIndex(template.roles[role_index].fields, { name: old_name });
        if (field_index >= 0) {
            template.roles[role_index].fields[field_index] = updated_field;
        }
        else {
            template.roles[role_index].fields.push(updated_field);
        }
        return template;
    };
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    BuilderService.prototype.updateTemplateField = /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    function (template, body, oldName, i, j) {
        var _this = this;
        oldName = oldName.trim();
        return this.http
            .put(this._rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            _this.eventTracker.createEvent({
                category: 'document',
                action: "document " + field.type + " field updated",
                label: "document id: " + template.id
            });
            /** @type {?} */
            var fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            if (field.page_sequence - 1 !== i) {
                template.pages[i].fields.splice(fieldIndex, 1);
                template.pages[field.page_sequence - 1].fields.push(field);
            }
            else {
                template.pages[i].fields[fieldIndex] = field;
            }
            /** @type {?} */
            var roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template = _this.updateRoleField(template, field, roleIndex, oldName);
            }
            // this.templateSubject.next(template);
            _this.saveStatusSubject.next('saved');
            return template;
        })));
    };
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    BuilderService.prototype.updateDropdownField = /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    function (template, body, oldName, i, j) {
        var _this = this;
        oldName = oldName.trim();
        return this.http
            .put(this._rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            /** @type {?} */
            var fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            template.pages[i].fields[fieldIndex] = field;
            // this.templateSubject.next(template);
            _this.saveStatusSubject.next('saved');
            return template;
        })));
    };
    /**
     * @param {?} templateId
     * @param {?} fieldId
     * @param {?} roleId
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    BuilderService.prototype.addFieldRole = /**
     * @param {?} templateId
     * @param {?} fieldId
     * @param {?} roleId
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    function (templateId, fieldId, roleId, i, j) {
        /** @type {?} */
        var fieldRoleInfo = JSON.stringify({
            field_id: fieldId,
            role_id: roleId
        });
        return this.http
            .post(this._rForm_backend_url + '/template/' + templateId + '/field_role', fieldRoleInfo).toPromise().then((/**
         * @param {?} fieldRole
         * @return {?}
         */
        function (fieldRole) {
            return fieldRole;
        }));
    };
    /**
     * @param {?} role
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.addRole = /**
     * @param {?} role
     * @param {?} template
     * @return {?}
     */
    function (role, template) {
        var _this = this;
        /** @type {?} */
        var templateBackend = this._rForm_backend_url + '/templates/' + template.id + '/roles';
        /** @type {?} */
        var roles = [];
        roles = roles.concat(role);
        /** @type {?} */
        var roleRequests = [];
        roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        function (role) {
            roleRequests.push(_this.http.post(templateBackend, role));
        }));
        if (roles && roles.length > 0) {
            return forkJoin(roleRequests).pipe(map((/**
             * @param {?} savedRoles
             * @return {?}
             */
            function (savedRoles) {
                savedRoles.concat((/** @type {?} */ (savedRoles)));
                if (!template['roles']) {
                    template['roles'] = (/** @type {?} */ ([]));
                }
                /** @type {?} */
                var savedRolesWithFields = savedRoles.map((/**
                 * @param {?} newRole
                 * @return {?}
                 */
                function (newRole) {
                    newRole['fields'] = [];
                    return newRole;
                }));
                template['roles'] = template['roles'].concat(savedRolesWithFields);
                // this.recipients = this.sortRoles(template);
                // this.roles = this.recipients;
                // this.templateSubject.next(template);
                // this.recipientsSubject.next(this.recipients);
                // this.recipients;
                return template;
            }), (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                console.error(err);
                console.error('Couldn\'t save all the roles');
                return err;
            })));
        }
        else {
            return of(template);
        }
    };
    /**
     * @param {?} roleName
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.deleteRole = /**
     * @param {?} roleName
     * @param {?} template
     * @return {?}
     */
    function (roleName, template) {
        return this.http.delete(this._rForm_backend_url + '/templates/' + template.id + '/roles/' + roleName)
            .toPromise()
            .then((/**
         * @return {?}
         */
        function () {
            // remove(template.roles, (role: IRole) => {
            // this.recipients = this.sortRoles(template);
            // if (role.name === roleName) {
            //   const fields = role.fields;
            //   const fieldNames = [];
            //   for (const field of fields) {
            //     fieldNames.push(field.name);
            //   }
            //   this.deleteTemplateFields(fieldNames, template);
            // }
            // this.templateSubject.next(template);
            // this.recipientsSubject.next(this.recipients);
            //   return role.name === roleName
            // });
        }));
    };
    /**
     * @param {?} roleNames
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.deleteRoles = /**
     * @param {?} roleNames
     * @param {?} template
     * @return {?}
     */
    function (roleNames, template) {
        var _this = this;
        /** @type {?} */
        var deleteCalls = [];
        roleNames.forEach((/**
         * @param {?} role_name
         * @return {?}
         */
        function (role_name) {
            template = tslib_1.__assign({}, template, { roles: template.roles.filter((/**
                 * @param {?} role
                 * @return {?}
                 */
                function (role) { return role.name !== role_name; })) });
            deleteCalls.push(_this.http.delete(_this._rForm_backend_url + '/templates/' + template.id + '/roles/' + role_name));
        }));
        return forkJoin(deleteCalls).pipe(map((/**
         * @return {?}
         */
        function () {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            console.error(err);
            console.error('Couldn\'t delete all the roles');
            return err;
        })));
    };
    /**
     * @param {?} roles
     * @param {?} template
     * @return {?}
     */
    BuilderService.prototype.updateRoles = /**
     * @param {?} roles
     * @param {?} template
     * @return {?}
     */
    function (roles, template) {
        var _this = this;
        /** @type {?} */
        var updateCalls = [];
        roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        function (role) {
            /** @type {?} */
            var body = {
                template_id: template.id,
                name: role.name.trim(),
                full_name: role.full_name,
                email: role.email,
                sequence: role.sequence,
                type: role.type,
                delegator: role.delegator,
                message: role.message,
                phone: role.phone
            };
            /** @type {?} */
            var role_index = findIndex(template.roles, { name: role.old_name });
            if (role_index >= 0) {
                template.roles[role_index] = tslib_1.__assign({}, template.roles[role_index], { template_id: template.id, name: role.name.trim(), full_name: role.full_name, email: role.email, sequence: role.sequence, type: role.type, delegator: role.delegator, message: role.message, phone: role.phone });
            }
            _this.eventTracker.createEvent({
                category: 'document',
                action: 'document role updated',
                label: "document id: " + template.id
            });
            updateCalls.push(_this.http.put(_this._rForm_backend_url + '/templates/' + template.id + '/roles/' + role.old_name, body));
        }));
        return forkJoin(updateCalls)
            .pipe(map((/**
         * @return {?}
         */
        function () {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            console.error(err);
            console.error('Couldn\'t save all the roles');
            return err;
        })));
    };
    BuilderService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BuilderService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: Injector },
        { type: EventTrackerService }
    ]; };
    return BuilderService;
}());
export { BuilderService };
if (false) {
    /** @type {?} */
    BuilderService.prototype.saveStatusSubject;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype._rForm_backend_url;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    BuilderService.prototype.eventTracker;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlcy9idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzdELE9BQU8sRUFBYyxhQUFhLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRW5DLE9BQU8sRUFBYyxlQUFlLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQVFwRTtJQU9FLHdCQUNVLElBQWdCLEVBQ2hCLFFBQWtCLEVBQ2xCLFlBQWlDO1FBRmpDLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFScEMsc0JBQWlCLEdBQTBCLElBQUksYUFBYSxFQUFVLENBQUM7UUFVNUUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQztJQUNqRSxDQUFDOzs7OztJQUVELHVDQUFjOzs7O0lBQWQsVUFBZSxhQUF3QjtRQUNyQyxPQUFPLElBQUksQ0FBQyxJ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Q0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsS0FBSyxFQUFFLGtCQUFnQixRQUFRLENBQUMsRUFBSTthQUNyQyxDQUFDLENBQUM7WUFDSCxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUksQ0FBQyxrQkFBa0IsR0FBRyxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzNILENBQUMsRUFBQyxDQUFDO1FBQ0gsT0FBTyxRQUFRLENBQUMsV0FBVyxDQUFDO2FBQ3pCLElBQUksQ0FDSCxHQUFHOzs7UUFBQztZQUNGLE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUM7Ozs7UUFBRSxVQUFDLEdBQUc7WUFDTCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztZQUM5QyxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBQyxDQUNILENBQUM7SUFDTixDQUFDOztnQkFuVEYsVUFBVTs7OztnQkFkRixVQUFVO2dCQURFLFFBQVE7Z0JBRXBCLG1CQUFtQjs7SUFpVTVCLHFCQUFDO0NBQUEsQUFwVEQsSUFvVEM7U0FuVFksY0FBYzs7O0lBQ3pCLDJDQUE4RTs7Ozs7SUFFOUUsdUNBQWtDOzs7OztJQUNsQyw0Q0FBbUM7Ozs7O0lBR2pDLDhCQUF3Qjs7Ozs7SUFDeEIsa0NBQTBCOzs7OztJQUMxQixzQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFJlcXVlc3QgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBFdmVudFRyYWNrZXJTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvZXZlbnQtdHJhY2tlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0LCB0aHJvd0Vycm9yLCBmcm9tLCBmb3JrSm9pbiwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgZGVsYXksIG1lcmdlTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZmluZEluZGV4IH0gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgVlNES0NvbmZpZywgVlNES0NvbmZpZ1Rva2VuIH0gZnJvbSAnLi4vYW5ndWxhci1hcGkubW9kdWxlJztcblxuaW1wb3J0IHsgSVRlbXBsYXRlIH0gZnJvbSAnLi4vbW9kZWxzL3RlbXBsYXRlLm1vZGVsJztcbmltcG9ydCB7IElQYWdlIH0gZnJvbSAnLi4vbW9kZWxzL3BhZ2UubW9kZWwnO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tICcuLi9tb2RlbHMvcm9sZS5tb2RlbCc7XG5pbXBvcnQgeyBJRmllbGQgfSBmcm9tICcuLi9tb2RlbHMvZmllbGQubW9kZWwnO1xuaW1wb3J0IHsgRmllbGRSb2xlIH0gZnJvbSAnLi4vbW9kZWxzL2ZpZWxkLXJvbGUubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQnVpbGRlclNlcnZpY2Uge1xuICBwdWJsaWMgc2F2ZVN0YXR1c1N1YmplY3Q6IFJlcGxheVN1YmplY3Q8c3RyaW5nPiA9IG5ldyBSZXBsYXlTdWJqZWN0PHN0cmluZz4oKTtcblxuICBwcml2YXRlIF9jb25maWdfdG9rZW46IFZTREtDb25maWc7XG4gIHByaXZhdGUgX3JGb3JtX2JhY2tlbmRfdXJsOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgZXZlbnRUcmFja2VyOiBFdmVudFRyYWNrZXJTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuX2NvbmZpZ190b2tlbiA9IHRoaXMuaW5qZWN0b3IuZ2V0KFZTREtDb25maWdUb2tlbik7XG4gICAgdGhpcy5fckZvcm1fYmFja2VuZF91cmwgPSB0aGlzLl9jb25maWdfdG9rZW4uckZvcm1fYmFja2VuZF91cmw7XG4gIH1cblxuICBjcmVhdGVUZW1wbGF0ZSh0ZW1wbGF0ZV9ib2R5OiBJVGVtcGxhdGUpOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wb3N0PElUZW1wbGF0ZT4odGhpcy5fckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcycsIHRlbXBsYXRlX2JvZHkpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChyZXMpID0+IHtcbiAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHVwbG9hZFRlbXBsYXRlRG9jdW1lbnQoZmlsZTogRmlsZSwgdGVtcGxhdGU6IElUZW1wbGF0ZSkge1xuICAgIGNvbnN0IGZvcm1kYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybWRhdGEuYXBwZW5kKCdkb2N1bWVudCcsIGZpbGUsIGZpbGUubmFtZSk7XG4gICAgY29uc3QgcmVxID0gbmV3IEh0dHBSZXF1ZXN0KCdQT1NUJywgYCR7dGhpcy5fckZvcm1fYmFja2VuZF91cmx9L3RlbXBsYXRlcy8ke3RlbXBsYXRlLmlkfS9kb2N1bWVudHNgLCBmb3JtZGF0YSwge1xuICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWVcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnJlcXVlc3QocmVxKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChyZXMgPT4gcmVzKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycik7XG4gICAgICAgIH0pXG4gICAgICApXG4gIH1cblxuICBhZGRUZW1wbGF0ZVBhZ2UoZG9jdW1lbnQsIHBhZ2VOdW0sIHRlbXBsYXRlSWQpIHtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgc2VxdWVuY2U6IHBhZ2VOdW0sXG4gICAgICBwYWdlX251bWJlcjogcGFnZU51bSxcbiAgICAgIGRvY3VtZW50X2lkOiBkb2N1bWVudC5pZFxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8SVBhZ2U+KGAke3RoaXMuX3JGb3JtX2JhY2tlbmRfdXJsfS90ZW1wbGF0ZXMvJHt0ZW1wbGF0ZUlkfS9wYWdlc2AsIGJvZHkpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChyZXM6IElQYWdlKSA9PiByZXMpLFxuICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG4gIGFkZFRlbXBsYXRlUGFnZXMoZG9jdW1lbnQsIHBhZ2VOdW1zOiBudW1iZXJbXSwgdGVtcGxhdGVJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZyb20ocGFnZU51bXMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWVyZ2VNYXAocGFnZU51bSA9PiB7XG4gICAgICAgICAgY29uc3QgcGFnZSA9IHtcbiAgICAgICAgICAgIHNlcXVlbmNlOiBwYWdlTnVtLFxuICAgICAgICAgICAgcGFnZV9udW1iZXI6IHBhZ2VOdW0sXG4gICAgICAgICAgICBkb2N1bWVudF9pZDogZG9jdW1lbnQuaWRcbiAgICAgICAgICB9O1xuICAgICAgICAgIHJldHVybiA8T2JzZXJ2YWJsZTxJUGFnZT4+dGhpcy5odHRwLnBvc3QoYCR7dGhpcy5fckZvcm1fYmFja2VuZF91cmx9L3RlbXBsYXRlcy8ke3RlbXBsYXRlSWR9L3BhZ2VzYCwgcGFnZSkucGlwZShkZWxheSgyMDApKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG4gIGFkZFRlbXBsYXRlRmllbGQobmV3RmllbGQ6IElGaWVsZCwgaSwgaiwgdGVtcGxhdGU6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgbmV3RmllbGQubmFtZSA9IG5ld0ZpZWxkLm5hbWUudHJpbSgpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wb3N0PElGaWVsZD4odGhpcy5fckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgbmV3RmllbGQudGVtcGxhdGVfaWQgKyAnL2ZpZWxkcycsIG5ld0ZpZWxkKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChmaWVsZCA9PiB7XG4gICAgICAgICAgdGhpcy5ldmVudFRyYWNrZXIuY3JlYXRlRXZlbnQoe1xuICAgICAgICAgICAgY2F0ZWdvcnk6ICdkb2N1bWVudCcsXG4gICAgICAgICAgICBhY3Rpb246IGBkb2N1bWVudCAke2ZpZWxkLnR5cGV9IGZpZWxkIGFkZGVkYCxcbiAgICAgICAgICAgIGxhYmVsOiBgZG9jdW1lbnQgaWQ6ICR7bmV3RmllbGQudGVtcGxhdGVfaWR9YFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkc1tqXSA9IGZpZWxkO1xuICAgICAgICAgIC8vIHRoaXMuY2hlY2tGb3JGaWVsZHModGVtcGxhdGUucm9sZXMpO1xuICAgICAgICAgIGNvbnN0IHJvbGVJbmRleCA9IGZpbmRJbmRleCh0ZW1wbGF0ZS5yb2xlcywgeyBuYW1lOiBmaWVsZC5yb2xlX25hbWUgfSk7XG4gICAgICAgICAgaWYgKHJvbGVJbmRleCA+PSAwKSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5yb2xlc1tyb2xlSW5kZXhdWydmaWVsZHMnXS5wdXNoKGZpZWxkKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIGRlbGV0ZVRlbXBsYXRlRmllbGQodGVtcGxhdGU6IElUZW1wbGF0ZSwgZmllbGROYW1lOiBzdHJpbmcsIGksIGopOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5kZWxldGU8dm9pZD4oYCR7dGhpcy5fckZvcm1fYmFja2VuZF91cmx9L3RlbXBsYXRlcy8ke3RlbXBsYXRlLmlkfS9maWVsZHMvJHtmaWVsZE5hbWUudHJpbSgpfWApXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZpZWxkID0+IHtcbiAgICAgICAgICBjb25zdCBmaWVsZEluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcywgeyBuYW1lOiBmaWVsZE5hbWUgfSk7XG4gICAgICAgICAgY29uc3Qgcm9sZUluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzLCB7IG5hbWU6IHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkc1tmaWVsZEluZGV4XS5yb2xlX25hbWUgfSk7XG5cbiAgICAgICAgICBpZiAocm9sZUluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIGNvbnN0IHJvbGVGaWVsZEluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzW3JvbGVJbmRleF0uZmllbGRzLCB7IG5hbWU6IGZpZWxkTmFtZSB9KTtcbiAgICAgICAgICAgIGlmIChyb2xlRmllbGRJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICAgIHRlbXBsYXRlLnJvbGVzW3JvbGVJbmRleF0uZmllbGRzLnNwbGljZShyb2xlRmllbGRJbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcy5zcGxpY2UoZmllbGRJbmRleCwgMSk7XG4gICAgICAgICAgLy8gdGhpcy51cGRhdGVMb2NhbFRlbXBsYXRlKHRlbXBsYXRlKTtcbiAgICAgICAgICAvLyB0aGlzLnNhdmVTdGF0dXNTdWJqZWN0Lm5leHQoJ3NhdmVkJyk7XG4gICAgICAgICAgLy8gdGhpcy5jaGVja0ZvckZpZWxkcyh0ZW1wbGF0ZS5yb2xlcyk7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHVwZGF0ZVJvbGVGaWVsZCh0ZW1wbGF0ZTogSVRlbXBsYXRlLCB1cGRhdGVkX2ZpZWxkLCByb2xlX2luZGV4LCBvbGRfbmFtZSkge1xuICAgIGNvbnN0IGZpZWxkX2luZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdLmZpZWxkcywgeyBuYW1lOiBvbGRfbmFtZSB9KTtcbiAgICBpZiAoZmllbGRfaW5kZXggPj0gMCkge1xuICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0uZmllbGRzW2ZpZWxkX2luZGV4XSA9IHVwZGF0ZWRfZmllbGQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdLmZpZWxkcy5wdXNoKHVwZGF0ZWRfZmllbGQpO1xuICAgIH1cbiAgICByZXR1cm4gdGVtcGxhdGU7XG4gIH1cblxuICB1cGRhdGVUZW1wbGF0ZUZpZWxkKHRlbXBsYXRlOiBJVGVtcGxhdGUsIGJvZHk6IElGaWVsZCwgb2xkTmFtZSwgaSwgaik6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgb2xkTmFtZSA9IG9sZE5hbWUudHJpbSgpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wdXQ8SUZpZWxkPih0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvZmllbGRzLycgKyBvbGROYW1lLCBib2R5KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChmaWVsZCA9PiB7XG4gICAgICAgICAgdGhpcy5ldmVudFRyYWNrZXIuY3JlYXRlRXZlbnQoe1xuICAgICAgICAgICAgY2F0ZWdvcnk6ICdkb2N1bWVudCcsXG4gICAgICAgICAgICBhY3Rpb246IGBkb2N1bWVudCAke2ZpZWxkLnR5cGV9IGZpZWxkIHVwZGF0ZWRgLFxuICAgICAgICAgICAgbGFiZWw6IGBkb2N1bWVudCBpZDogJHt0ZW1wbGF0ZS5pZH1gXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgZmllbGRJbmRleCA9IGZpbmRJbmRleCh0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHMsIHsgbmFtZTogb2xkTmFtZSB9KTtcbiAgICAgICAgICBpZiAoZmllbGQucGFnZV9zZXF1ZW5jZSAtIDEgIT09IGkpIHtcbiAgICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcy5zcGxpY2UoZmllbGRJbmRleCwgMSk7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tmaWVsZC5wYWdlX3NlcXVlbmNlIC0gMV0uZmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbZmllbGRJbmRleF0gPSBmaWVsZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgcm9sZUluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzLCB7IG5hbWU6IGZpZWxkLnJvbGVfbmFtZSB9KTtcbiAgICAgICAgICBpZiAocm9sZUluZGV4ID49IDApIHtcbiAgICAgICAgICAgIHRlbXBsYXRlID0gdGhpcy51cGRhdGVSb2xlRmllbGQodGVtcGxhdGUsIGZpZWxkLCByb2xlSW5kZXgsIG9sZE5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICB0aGlzLnNhdmVTdGF0dXNTdWJqZWN0Lm5leHQoJ3NhdmVkJyk7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHVwZGF0ZURyb3Bkb3duRmllbGQodGVtcGxhdGU6IElUZW1wbGF0ZSwgYm9keTogYW55LCBvbGROYW1lLCBpLCBqKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBvbGROYW1lID0gb2xkTmFtZS50cmltKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnB1dDxhbnk+KHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlLmlkICsgJy9maWVsZHMvJyArIG9sZE5hbWUsIGJvZHkpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZpZWxkID0+IHtcbiAgICAgICAgICBjb25zdCBmaWVsZEluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcywgeyBuYW1lOiBvbGROYW1lIH0pO1xuICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkc1tmaWVsZEluZGV4XSA9IGZpZWxkO1xuICAgICAgICAgIC8vIHRoaXMudGVtcGxhdGVTdWJqZWN0Lm5leHQodGVtcGxhdGUpO1xuICAgICAgICAgIHRoaXMuc2F2ZVN0YXR1c1N1YmplY3QubmV4dCgnc2F2ZWQnKTtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgYWRkRmllbGRSb2xlKHRlbXBsYXRlSWQ6IHN0cmluZywgZmllbGRJZDogc3RyaW5nLCByb2xlSWQ6IHN0cmluZywgaSwgaik6IFByb21pc2U8RmllbGRSb2xlPiB7XG4gICAgY29uc3QgZmllbGRSb2xlSW5mbyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGZpZWxkX2lkOiBmaWVsZElkLFxuICAgICAgcm9sZV9pZDogcm9sZUlkXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8RmllbGRSb2xlPih0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGUvJyArIHRlbXBsYXRlSWQgKyAnL2ZpZWxkX3JvbGUnLCBmaWVsZFJvbGVJbmZvKS50b1Byb21pc2UoKS50aGVuKGZpZWxkUm9sZSA9PiB7XG4gICAgICAgIHJldHVybiBmaWVsZFJvbGU7XG4gICAgICB9KTtcbiAgfVxuXG4gIGFkZFJvbGUocm9sZTogSVJvbGUgfCBJUm9sZVtdLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZUJhY2tlbmQgPSB0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvcm9sZXMnO1xuICAgIGxldCByb2xlcyA9IFtdO1xuICAgIHJvbGVzID0gcm9sZXMuY29uY2F0KHJvbGUpO1xuICAgIGNvbnN0IHJvbGVSZXF1ZXN0cyA9IFtdO1xuICAgIHJvbGVzLmZvckVhY2gocm9sZSA9PiB7XG4gICAgICByb2xlUmVxdWVzdHMucHVzaCh0aGlzLmh0dHAucG9zdCh0ZW1wbGF0ZUJhY2tlbmQsIHJvbGUpKTtcbiAgICB9KVxuXG4gICAgaWYgKHJvbGVzICYmIHJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBmb3JrSm9pbihyb2xlUmVxdWVzdHMpLnBpcGUoXG4gICAgICAgIG1hcChzYXZlZFJvbGVzID0+IHtcbiAgICAgICAgICBzYXZlZFJvbGVzLmNvbmNhdChzYXZlZFJvbGVzIGFzIElSb2xlW10pO1xuICAgICAgICAgIGlmICghdGVtcGxhdGVbJ3JvbGVzJ10pIHtcbiAgICAgICAgICAgIHRlbXBsYXRlWydyb2xlcyddID0gPElSb2xlW10+W107XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHNhdmVkUm9sZXNXaXRoRmllbGRzID0gc2F2ZWRSb2xlcy5tYXAobmV3Um9sZSA9PiB7XG4gICAgICAgICAgICBuZXdSb2xlWydmaWVsZHMnXSA9IFtdO1xuICAgICAgICAgICAgcmV0dXJuIG5ld1JvbGU7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGVtcGxhdGVbJ3JvbGVzJ10gPSB0ZW1wbGF0ZVsncm9sZXMnXS5jb25jYXQoc2F2ZWRSb2xlc1dpdGhGaWVsZHMpO1xuICAgICAgICAgIC8vIHRoaXMucmVjaXBpZW50cyA9IHRoaXMuc29ydFJvbGVzKHRlbXBsYXRlKTtcbiAgICAgICAgICAvLyB0aGlzLnJvbGVzID0gdGhpcy5yZWNpcGllbnRzO1xuICAgICAgICAgIC8vIHRoaXMudGVtcGxhdGVTdWJqZWN0Lm5leHQodGVtcGxhdGUpO1xuICAgICAgICAgIC8vIHRoaXMucmVjaXBpZW50c1N1YmplY3QubmV4dCh0aGlzLnJlY2lwaWVudHMpO1xuICAgICAgICAgIC8vIHRoaXMucmVjaXBpZW50cztcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGVcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdDb3VsZG5cXCd0IHNhdmUgYWxsIHRoZSByb2xlcycpO1xuICAgICAgICAgIHJldHVybiBlcnI7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gb2YodGVtcGxhdGUpO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZVJvbGUocm9sZU5hbWUsIHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZSh0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvcm9sZXMvJyArIHJvbGVOYW1lKVxuICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIC8vIHJlbW92ZSh0ZW1wbGF0ZS5yb2xlcywgKHJvbGU6IElSb2xlKSA9PiB7XG4gICAgICAgICAgLy8gdGhpcy5yZWNpcGllbnRzID0gdGhpcy5zb3J0Um9sZXModGVtcGxhdGUpO1xuICAgICAgICAgIC8vIGlmIChyb2xlLm5hbWUgPT09IHJvbGVOYW1lKSB7XG4gICAgICAgICAgLy8gICBjb25zdCBmaWVsZHMgPSByb2xlLmZpZWxkcztcbiAgICAgICAgICAvLyAgIGNvbnN0IGZpZWxkTmFtZXMgPSBbXTtcbiAgICAgICAgICAvLyAgIGZvciAoY29uc3QgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICAgICAgLy8gICAgIGZpZWxkTmFtZXMucHVzaChmaWVsZC5uYW1lKTtcbiAgICAgICAgICAvLyAgIH1cbiAgICAgICAgICAvLyAgIHRoaXMuZGVsZXRlVGVtcGxhdGVGaWVsZHMoZmllbGROYW1lcywgdGVtcGxhdGUpO1xuICAgICAgICAgIC8vIH1cbiAgICAgICAgICAvLyB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICAvLyB0aGlzLnJlY2lwaWVudHNTdWJqZWN0Lm5leHQodGhpcy5yZWNpcGllbnRzKTtcbiAgICAgICAgLy8gICByZXR1cm4gcm9sZS5uYW1lID09PSByb2xlTmFtZVxuICAgICAgICAvLyB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZGVsZXRlUm9sZXMocm9sZU5hbWVzOiBBcnJheTxzdHJpbmc+LCB0ZW1wbGF0ZTogSVRlbXBsYXRlKSB7XG4gICAgY29uc3QgZGVsZXRlQ2FsbHMgPSBbXTtcbiAgICByb2xlTmFtZXMuZm9yRWFjaChyb2xlX25hbWUgPT4ge1xuICAgICAgdGVtcGxhdGUgPSB7XG4gICAgICAgIC4uLnRlbXBsYXRlLFxuICAgICAgICByb2xlczogdGVtcGxhdGUucm9sZXMuZmlsdGVyKHJvbGUgPT4gcm9sZS5uYW1lICE9PSByb2xlX25hbWUpXG4gICAgICB9XG4gICAgICBkZWxldGVDYWxscy5wdXNoKHRoaXMuaHR0cC5kZWxldGUodGhpcy5fckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL3JvbGVzLycgKyByb2xlX25hbWUpKVxuICAgIH0pO1xuICAgIHJldHVybiBmb3JrSm9pbihkZWxldGVDYWxscykucGlwZShcbiAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgICAgIH0sIGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgY29uc29sZS5lcnJvcignQ291bGRuXFwndCBkZWxldGUgYWxsIHRoZSByb2xlcycpO1xuICAgICAgICByZXR1cm4gZXJyO1xuICAgICAgfSlcbiAgICApXG4gIH1cblxuICB1cGRhdGVSb2xlcyhyb2xlcywgdGVtcGxhdGU6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgY29uc3QgdXBkYXRlQ2FsbHMgPSBbXTtcbiAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4ge1xuICAgICAgY29uc3QgYm9keSA9IHtcbiAgICAgICAgdGVtcGxhdGVfaWQ6IHRlbXBsYXRlLmlkLFxuICAgICAgICBuYW1lOiByb2xlLm5hbWUudHJpbSgpLFxuICAgICAgICBmdWxsX25hbWU6IHJvbGUuZnVsbF9uYW1lLFxuICAgICAgICBlbWFpbDogcm9sZS5lbWFpbCxcbiAgICAgICAgc2VxdWVuY2U6IHJvbGUuc2VxdWVuY2UsXG4gICAgICAgIHR5cGU6IHJvbGUudHlwZSxcbiAgICAgICAgZGVsZWdhdG9yOiByb2xlLmRlbGVnYXRvcixcbiAgICAgICAgbWVzc2FnZTogcm9sZS5tZXNzYWdlLFxuICAgICAgICBwaG9uZTogcm9sZS5waG9uZVxuICAgICAgfVxuXG4gICAgICBjb25zdCByb2xlX2luZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzLCB7IG5hbWU6IHJvbGUub2xkX25hbWUgfSk7XG4gICAgICBpZiAocm9sZV9pbmRleCA+PSAwKSB7XG4gICAgICAgIHRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdID0ge1xuICAgICAgICAgIC4uLnRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdLFxuICAgICAgICAgIHRlbXBsYXRlX2lkOiB0ZW1wbGF0ZS5pZCxcbiAgICAgICAgICBuYW1lOiByb2xlLm5hbWUudHJpbSgpLFxuICAgICAgICAgIGZ1bGxfbmFtZTogcm9sZS5mdWxsX25hbWUsXG4gICAgICAgICAgZW1haWw6IHJvbGUuZW1haWwsXG4gICAgICAgICAgc2VxdWVuY2U6IHJvbGUuc2VxdWVuY2UsXG4gICAgICAgICAgdHlwZTogcm9sZS50eXBlLFxuICAgICAgICAgIGRlbGVnYXRvcjogcm9sZS5kZWxlZ2F0b3IsXG4gICAgICAgICAgbWVzc2FnZTogcm9sZS5tZXNzYWdlLFxuICAgICAgICAgIHBob25lOiByb2xlLnBob25lXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuZXZlbnRUcmFja2VyLmNyZWF0ZUV2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6ICdkb2N1bWVudCcsXG4gICAgICAgIGFjdGlvbjogJ2RvY3VtZW50IHJvbGUgdXBkYXRlZCcsXG4gICAgICAgIGxhYmVsOiBgZG9jdW1lbnQgaWQ6ICR7dGVtcGxhdGUuaWR9YFxuICAgICAgfSk7XG4gICAgICB1cGRhdGVDYWxscy5wdXNoKHRoaXMuaHR0cC5wdXQodGhpcy5fckZvcm1fYmFja2VuZF91cmwgKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL3JvbGVzLycgKyByb2xlLm9sZF9uYW1lLCBib2R5KSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcmtKb2luKHVwZGF0ZUNhbGxzKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkblxcJ3Qgc2F2ZSBhbGwgdGhlIHJvbGVzJyk7XG4gICAgICAgICAgcmV0dXJuIGVycjtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cbn0iXX0=