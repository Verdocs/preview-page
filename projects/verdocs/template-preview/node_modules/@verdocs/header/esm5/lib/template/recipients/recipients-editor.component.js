/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { VerdocsHeaderService } from '../../services/header.service';
import { TemplateSenderTypes } from '../../models/verdocs.model';
var RecipientEditorComponent = /** @class */ (function () {
    function RecipientEditorComponent(verdocsHeaderService, vTokenObjectService) {
        this.verdocsHeaderService = verdocsHeaderService;
        this.vTokenObjectService = vTokenObjectService;
        this.roles = [];
        this.sender = 'creator';
        this.sender_name = '';
    }
    /**
     * @return {?}
     */
    RecipientEditorComponent.prototype.ngOnChanges = /**
     * @return {?}
     */
    function () {
        this.prepareSender();
        this.prepareExistingRoles();
    };
    /**
     * @return {?}
     */
    RecipientEditorComponent.prototype.prepareSender = /**
     * @return {?}
     */
    function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.sender = this.template.sender || 'creator';
                        return [4 /*yield*/, this.updateSenderName()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @return {?}
     */
    RecipientEditorComponent.prototype.updateSenderName = /**
     * @return {?}
     */
    function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var profile, ownerInfo;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        profile = this.vTokenObjectService.getProfile();
                        return [4 /*yield*/, this.verdocsHeaderService.getTemplateOwnerInfo(this.template.id)];
                    case 1:
                        ownerInfo = _a.sent();
                        switch (this.sender) {
                            case TemplateSenderTypes.ORGANIZATION_MEMBER:
                                this.sender_name = 'Anyone at ' + (profile ? profile.organization.name : 'organization');
                                break;
                            case TemplateSenderTypes.EVERYONE:
                                this.sender_name = 'Anyone';
                                break;
                            case TemplateSenderTypes.EVERYONE_AS_CREATOR:
                            case TemplateSenderTypes.CREATOR:
                            case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                                if (profile && this.template.profile_id === profile.id) {
                                    this.sender_name = profile.first_name + ' ' + profile.last_name + ' (me)';
                                }
                                else {
                                    this.sender_name = ownerInfo.name + ' (creator)';
                                }
                                break;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @param {?=} recipients
     * @return {?}
     */
    RecipientEditorComponent.prototype.prepareExistingRoles = /**
     * @param {?=} recipients
     * @return {?}
     */
    function (recipients) {
        /** @type {?} */
        var roles = [];
        if (recipients && recipients.length > 0) {
            roles = recipients;
        }
        else {
            roles = this.template.roles.sort((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            function (a, b) {
                return a.sequence - b.sequence;
            })).slice();
        }
        roles = this.setStyles(roles);
        this.roles = [];
        for (var roleIndex = 0; roleIndex < roles.length; roleIndex++) {
            if (roles[roleIndex]) {
                /** @type {?} */
                var sequenceIndex = roles[roleIndex].sequence - 1;
                if (!roles[roleIndex]['status']) {
                    roles[roleIndex]['status'] = null;
                }
                if (!roles[roleIndex]['old_name']) {
                    roles[roleIndex]['old_name'] = roles[roleIndex].name;
                }
                if (this.roles[sequenceIndex] === undefined) {
                    this.roles[sequenceIndex] = [roles[roleIndex]];
                }
                else {
                    this.roles[sequenceIndex].push(roles[roleIndex]);
                }
            }
        }
        if (this.roles && this.roles.length === 0 && !this.roles[0]) {
            this.roles = [];
            this.roles[0] = [];
        }
    };
    /**
     * @param {?} roles
     * @return {?}
     */
    RecipientEditorComponent.prototype.setStyles = /**
     * @param {?} roles
     * @return {?}
     */
    function (roles) {
        var _this = this;
        roles.forEach((/**
         * @param {?} role
         * @param {?} index
         * @return {?}
         */
        function (role, index) {
            if (role) {
                if (role.full_name && role.email) {
                    role['style'] = {
                        'border': '1px solid ' + _this.verdocsHeaderService.getRGBA(index),
                        'background-color': 'transparent'
                    };
                }
                else {
                    role['style'] = {
                        'background': _this.verdocsHeaderService.getRGBA(index),
                        'border': '1px solid getRGBA(index)'
                    };
                }
            }
        }));
        return roles;
    };
    RecipientEditorComponent.decorators = [
        { type: Component, args: [{
                    selector: 'app-recipient-editor',
                    template: "<div class=\"template-recipients__container\" *ngIf=\"template\">\n  <div class=\"template-recipients__wrapper\">\n    <div class=\"template-recipients__body\">\n      <div class=\"template-recipients__sender\">\n        <div class=\"template-recipients__icon\">\n          <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Sender\" [matTooltipPosition]=\"'below'\">trip_origin</mat-icon>\n        </div>\n        <div class=\"template-recipients__dots\"></div>\n        <div class=\"template-recipients__chips sender\">\n          <mat-chip class=\"template-recipients__chip-sender\">\n            <span>\n              {{sender_name}}\n            </span>\n          </mat-chip>\n        </div>\n      </div>\n      <div class=\"template-recipients__roles\" *ngIf=\"roles && roles.length > 0\">\n        <div class=\"template-recipients__role\" *ngFor=\"let sequence of roles; let sequenceIndex = index;\">\n          <div class=\"template-recipients__icon\">\n            <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Sequence\" [matTooltipPosition]=\"'below'\">place</mat-icon>\n          </div>\n          <div class=\"template-recipients__dots\"></div>\n          <div class=\"template-recipients__chips\">\n            <div class=\"template-recipients__field\">\n              <mat-chip-list class=\"template-recipients__chip-list\" #roleChipList aria-label=\"roles\">\n                <div class=\"template-recipients__chip-wrapper\">\n                  <mat-chip class=\"template-recipients__chip-recipient\" *ngFor=\"let role of sequence\"\n                    [ngStyle]=\"role.style\" [removable]=\"false\" [ngClass]=\"{hidden: role.status === 'delete'}\">\n                    {{role.full_name && role.email ? role.full_name : role.name}}\n                  </mat-chip>\n                </div>\n              </mat-chip-list>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"template-recipients__sender\">\n        <div class=\"template-recipients__icon\">\n          <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Verdco complete\" [matTooltipPosition]=\"'below'\">done_all</mat-icon>\n        </div>\n        <div class=\"template-recipients__chips sender\">\n          <mat-chip class=\"template-recipients__chip-sender no-border\">\n            <span>\n              Complete\n            </span>\n          </mat-chip>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>",
                    styles: [".template-recipients__wrapper{position:relative;margin:0 auto;width:100%;max-width:600px}.template-recipients__body{position:relative}.template-recipients__sender{position:relative;min-height:48px}.template-recipients__sender:after{content:\"\";display:table;clear:both}.template-recipients__sender-text{margin-top:8px;margin-bottom:8px;font-size:12px;line-height:12px;color:rgba(0,0,0,.54)}.template-recipients__sender-radio{display:flex;align-items:center;height:40px}.template-recipients__roles{position:relative;min-height:48px}.template-recipients__roles:after{content:\"\";display:table;clear:both}.template-recipients__role{position:relative;min-height:48px}.template-recipients__role:after{content:\"\";display:table;clear:both}.template-recipients__icon{position:absolute;top:12px;left:16px;display:inline-block;width:24px;height:24px;z-index:10;background-color:#fff;border-radius:100%}.template-recipients__icon-icon{color:rgba(0,0,0,.54)}.template-recipients__dots{position:absolute;top:24px;left:25.7px;height:100%;border-left:4px dotted #9b9b9b;z-index:1}.template-recipients__chips{position:relative;min-height:48px;margin-left:64px;display:flex;align-items:center;border-bottom:1px solid #d1d5da}.template-recipients__chips.sender,.template-recipients__chips.sequence{display:flex;align-items:center}.template-recipients__chip-list{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center}.template-recipients__chip-wrapper{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;width:100%;min-height:40px}.template-recipients__chip-recipient.no-border,.template-recipients__chip-sender.no-border{padding-left:0;border:none;pointer-events:none}.template-recipients__chip-recipient.hidden,.template-recipients__chip-sender.hidden{display:none}.template-recipients__chip-recipient.icon-right,.template-recipients__chip-sender.icon-right{padding-right:8px}.template-recipients__chip-recipient:hover,.template-recipients__chip-sender:hover{cursor:pointer}.template-recipients__chip-recipient.cdk-drag-placeholder{background:#ccc;border:3px dotted #999;border-radius:16px;opacity:1;height:32px;transition:transform 250ms cubic-bezier(0,0,.2,1)}.template-recipients__chip-sender{background-color:transparent;border:1px solid rgba(98,113,123,.2)}.template-recipients__chip-add{border:1px dashed #979797;background-color:transparent}.template-recipients__chip-add.icon-left{padding-left:8px}.template-recipients__chip-add:hover{cursor:pointer}.template-recipients__chip-edit{width:18px;height:18px;color:rgba(0,0,0,.87);font-size:18px;margin-left:8px}.template-recipients__chip-icon--left{width:18px;height:18px;color:rgba(0,0,0,.87);font-size:18px;margin-right:8px}"]
                }] }
    ];
    /** @nocollapse */
    RecipientEditorComponent.ctorParameters = function () { return [
        { type: VerdocsHeaderService },
        { type: VerdocsTokenObjectService }
    ]; };
    RecipientEditorComponent.propDecorators = {
        template: [{ type: Input }]
    };
    return RecipientEditorComponent;
}());
export { RecipientEditorComponent };
if (false) {
    /** @type {?} */
    RecipientEditorComponent.prototype.roles;
    /** @type {?} */
    RecipientEditorComponent.prototype.sender;
    /** @type {?} */
    RecipientEditorComponent.prototype.sender_name;
    /** @type {?} */
    RecipientEditorComponent.prototype.template;
    /**
     * @type {?}
     * @private
     */
    RecipientEditorComponent.prototype.verdocsHeaderService;
    /**
     * @type {?}
     * @private
     */
    RecipientEditorComponent.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3MvaGVhZGVyLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlL3JlY2lwaWVudHMvcmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDNUQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFNUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDckUsT0FBTyxFQUFhLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFNUU7SUFZRSxrQ0FDVSxvQkFBMEMsRUFDMUMsbUJBQThDO1FBRDlDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUEyQjtRQVJqRCxVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsV0FBTSxHQUFHLFNBQVMsQ0FBQztRQUNuQixnQkFBVyxHQUFHLEVBQUUsQ0FBQztJQU9yQixDQUFDOzs7O0lBRUosOENBQVc7OztJQUFYO1FBQ0UsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQzlCLENBQUM7Ozs7SUFFSyxnREFBYTs7O0lBQW5COzs7Ozt3QkFDRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLFNBQVMsQ0FBQzt3QkFDaEQscUJBQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLEVBQUE7O3dCQUE3QixTQUE2QixDQUFDOzs7OztLQUMvQjs7OztJQUVLLG1EQUFnQjs7O0lBQXRCOzs7Ozs7d0JBQ1EsT0FBTyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLEVBQUU7d0JBQ25D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bEIsMENBQTBCOztJQUMxQiwrQ0FBd0I7O0lBRXhCLDRDQUE2Qjs7Ozs7SUFHM0Isd0RBQWtEOzs7OztJQUNsRCx1REFBc0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFZlcmRvY3NUb2tlbk9iamVjdFNlcnZpY2UgfSBmcm9tICdAdmVyZG9jcy90b2tlbnMnO1xuXG5pbXBvcnQgeyBWZXJkb2NzSGVhZGVyU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2hlYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IElUZW1wbGF0ZSwgVGVtcGxhdGVTZW5kZXJUeXBlcyB9IGZyb20gJy4uLy4uL21vZGVscy92ZXJkb2NzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYXBwLXJlY2lwaWVudC1lZGl0b3InLFxuICB0ZW1wbGF0ZVVybDogJy4vcmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9yZWNpcGllbnRzLWVkaXRvci5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFJlY2lwaWVudEVkaXRvckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlc3tcbiAgcHVibGljIHJvbGVzID0gW107XG4gIHB1YmxpYyBzZW5kZXIgPSAnY3JlYXRvcic7XG4gIHB1YmxpYyBzZW5kZXJfbmFtZSA9ICcnO1xuXG4gIEBJbnB1dCgpIHRlbXBsYXRlOiBJVGVtcGxhdGU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2ZXJkb2NzSGVhZGVyU2VydmljZTogVmVyZG9jc0hlYWRlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSB2VG9rZW5PYmplY3RTZXJ2aWNlOiBWZXJkb2NzVG9rZW5PYmplY3RTZXJ2aWNlXG4gICkge31cblxuICBuZ09uQ2hhbmdlcygpIHtcbiAgICB0aGlzLnByZXBhcmVTZW5kZXIoKTtcbiAgICB0aGlzLnByZXBhcmVFeGlzdGluZ1JvbGVzKCk7XG4gIH1cblxuICBhc3luYyBwcmVwYXJlU2VuZGVyKCkge1xuICAgIHRoaXMuc2VuZGVyID0gdGhpcy50ZW1wbGF0ZS5zZW5kZXIgfHwgJ2NyZWF0b3InO1xuICAgIGF3YWl0IHRoaXMudXBkYXRlU2VuZGVyTmFtZSgpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2VuZGVyTmFtZSgpIHtcbiAgICBjb25zdCBwcm9maWxlID0gdGhpcy52VG9rZW5PYmplY3RTZXJ2aWNlLmdldFByb2ZpbGUoKTtcbiAgICBjb25zdCBvd25lckluZm8gPSBhd2FpdCB0aGlzLnZlcmRvY3NIZWFkZXJTZXJ2aWNlLmdldFRlbXBsYXRlT3duZXJJbmZvKHRoaXMudGVtcGxhdGUuaWQpO1xuICAgIHN3aXRjaCAodGhpcy5zZW5kZXIpIHtcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5PUkdBTklaQVRJT05fTUVNQkVSOlxuICAgICAgICB0aGlzLnNlbmRlcl9uYW1lID0gJ0FueW9uZSBhdCAnICsgKHByb2ZpbGUgPyBwcm9maWxlLm9yZ2FuaXphdGlvbi5uYW1lIDogJ29yZ2FuaXphdGlvbicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5FVkVSWU9ORTpcbiAgICAgICAgdGhpcy5zZW5kZXJfbmFtZSA9ICdBbnlvbmUnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5FVkVSWU9ORV9BU19DUkVBVE9SOlxuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLkNSRUFUT1I6XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuT1JHQU5JWkFUSU9OX01FTUJFUl9BU19DUkVBVE9SOlxuICAgICAgICBpZiAocHJvZmlsZSAmJiB0aGlzLnRlbXBsYXRlLnByb2ZpbGVfaWQgPT09IHByb2ZpbGUuaWQpIHtcbiAgICAgICAgICB0aGlzLnNlbmRlcl9uYW1lID0gcHJvZmlsZS5maXJzdF9uYW1lICsgJyAnICsgcHJvZmlsZS5sYXN0X25hbWUgKyAnIChtZSknO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuc2VuZGVyX25hbWUgPSBvd25lckluZm8ubmFtZSArICcgKGNyZWF0b3IpJztcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcmVwYXJlRXhpc3RpbmdSb2xlcyhyZWNpcGllbnRzPykge1xuICAgIGxldCByb2xlcyA9IFtdXG4gICAgaWYgKHJlY2lwaWVudHMgJiYgcmVjaXBpZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICByb2xlcyA9IHJlY2lwaWVudHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJvbGVzID0gdGhpcy50ZW1wbGF0ZS5yb2xlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIHJldHVybiBhLnNlcXVlbmNlIC0gYi5zZXF1ZW5jZTtcbiAgICAgIH0pLnNsaWNlKCk7XG4gICAgfVxuXG4gICAgcm9sZXMgPSB0aGlzLnNldFN0eWxlcyhyb2xlcyk7XG4gICAgdGhpcy5yb2xlcyA9IFtdO1xuICAgIGZvciAobGV0IHJvbGVJbmRleCA9IDA7IHJvbGVJbmRleCA8IHJvbGVzLmxlbmd0aDsgcm9sZUluZGV4KyspIHtcbiAgICAgIGlmIChyb2xlc1tyb2xlSW5kZXhdKSB7XG4gICAgICAgIGNvbnN0IHNlcXVlbmNlSW5kZXggPSByb2xlc1tyb2xlSW5kZXhdLnNlcXVlbmNlIC0gMTtcbiAgICAgICAgaWYgKCFyb2xlc1tyb2xlSW5kZXhdWydzdGF0dXMnXSkge1xuICAgICAgICAgIHJvbGVzW3JvbGVJbmRleF1bJ3N0YXR1cyddID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXJvbGVzW3JvbGVJbmRleF1bJ29sZF9uYW1lJ10pIHtcbiAgICAgICAgICByb2xlc1tyb2xlSW5kZXhdWydvbGRfbmFtZSddID0gcm9sZXNbcm9sZUluZGV4XS5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnJvbGVzW3NlcXVlbmNlSW5kZXhdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aGlzLnJvbGVzW3NlcXVlbmNlSW5kZXhdID0gW3JvbGVzW3JvbGVJbmRleF1dO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucm9sZXNbc2VxdWVuY2VJbmRleF0ucHVzaChyb2xlc1tyb2xlSW5kZXhdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5yb2xlcyAmJiB0aGlzLnJvbGVzLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5yb2xlc1swXSkge1xuICAgICAgdGhpcy5yb2xlcyA9IFtdXG4gICAgICB0aGlzLnJvbGVzWzBdID0gW11cbiAgICB9XG4gIH1cblxuICBzZXRTdHlsZXMocm9sZXMpIHtcbiAgICByb2xlcy5mb3JFYWNoKChyb2xlLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKHJvbGUpIHtcbiAgICAgICAgaWYgKHJvbGUuZnVsbF9uYW1lICYmIHJvbGUuZW1haWwpIHtcbiAgICAgICAgICByb2xlWydzdHlsZSddID0ge1xuICAgICAgICAgICAgJ2JvcmRlcic6ICcxcHggc29saWQgJyArIHRoaXMudmVyZG9jc0hlYWRlclNlcnZpY2UuZ2V0UkdCQShpbmRleCksXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1jb2xvcic6ICd0cmFuc3BhcmVudCdcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcm9sZVsnc3R5bGUnXSA9IHtcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kJzogdGhpcy52ZXJkb2NzSGVhZGVyU2VydmljZS5nZXRSR0JBKGluZGV4KSxcbiAgICAgICAgICAgICdib3JkZXInOiAnMXB4IHNvbGlkIGdldFJHQkEoaW5kZXgpJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByb2xlcztcbiAgfVxufVxuIl19