/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { intersection } from 'lodash';
import { Injectable } from '@angular/core';
import { TemplateActions, TemplatePermissions, TemplateSenderTypes } from '../models/verdocs.model';
var TemplatesGuardService = /** @class */ (function () {
    function TemplatesGuardService(vTokenObjectService) {
        this.vTokenObjectService = vTokenObjectService;
    }
    /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    TemplatesGuardService.prototype.canPerformAction = /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    function (action, template) {
        try {
            /** @type {?} */
            var canPerform = false;
            /** @type {?} */
            var message = null;
            /** @type {?} */
            var neededPermissions = [];
            if (!template && action && !action.includes('create')) {
                throw {
                    error: 'You need to provide template object'
                };
            }
            /** @type {?} */
            var userProfile = this.vTokenObjectService.getProfile();
            /** @type {?} */
            var isCreator = userProfile ? template && template.profile_id === userProfile.id : false;
            /** @type {?} */
            var isSameOrg = userProfile ? template && template.organization_id === userProfile.organization_id : false;
            /** @type {?} */
            var isPersonal = template ? template.is_personal : null;
            /** @type {?} */
            var isPublic = template ? template.is_public : null;
            switch (action) {
                case TemplateActions.CREATE_PERSONAL:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                    break;
                case TemplateActions.CREATE_ORG:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                    break;
                case TemplateActions.CREATE_PUBLIC:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                    break;
                case TemplateActions.READ:
                    if (!isCreator) {
                        if ((!isPersonal && isSameOrg) || !isPublic) {
                            neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        }
                    }
                    break;
                case TemplateActions.WRITE:
                    if (!isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_WRITE);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PERSONAL:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_ORG:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PUBLIC:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.DELETE:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_DELETE);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_DELETE);
                    }
                    break;
                default:
                    throw {
                        error: 'Action is not defined'
                    };
            }
            if (this.hasPermissions(neededPermissions)) {
                canPerform = true;
            }
            else {
                message = "Insufficient access to perform '" + action + "'. Needed permissions: " + neededPermissions.toString();
            }
            return {
                canPerform: canPerform,
                message: message
            };
        }
        catch (err) {
            console.error({
                message: "Failed to check whether action (" + action + ") can be done, in TemplateGuardService",
                err: err
            });
        }
    };
    /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    TemplatesGuardService.prototype.hasPermissions = /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    function (requiredPermissions) {
        /** @type {?} */
        var userPermissions = this.vTokenObjectService.getPermissions();
        /** @type {?} */
        var hasPermissions = intersection(userPermissions, requiredPermissions).length === requiredPermissions.length;
        return hasPermissions;
    };
    /**
     * @param {?} template
     * @return {?}
     */
    TemplatesGuardService.prototype.canBeSender = /**
     * @param {?} template
     * @return {?}
     */
    function (template) {
        /** @type {?} */
        var userProfile = this.vTokenObjectService.getProfile();
        if (!userProfile) {
            return false;
        }
        switch (template.sender) {
            case TemplateSenderTypes.CREATOR:
                return userProfile.id === template.profile_id;
            case TemplateSenderTypes.ORGANIZATION_MEMBER:
            case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                return userProfile.id === template.profile_id || template.organization_id === userProfile.organization_id;
            default:
                return true;
        }
    };
    /**
     * @return {?}
     */
    TemplatesGuardService.prototype.canUserCreateTemplate = /**
     * @return {?}
     */
    function () {
        return this.canPerformAction(TemplateActions.CREATE_PERSONAL, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_ORG, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_PUBLIC, null)['canPerform'];
    };
    TemplatesGuardService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    TemplatesGuardService.ctorParameters = function () { return [
        { type: VerdocsTokenObjectService }
    ]; };
    return TemplatesGuardService;
}());
export { TemplatesGuardService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TemplatesGuardService.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLmd1YXJkLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3MvaGVhZGVyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RlbXBsYXRlcy5ndWFyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUV0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYSxlQUFlLEVBQUUsbUJBQW1CLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUUvRztJQUlFLCtCQUNVLG1CQUE4QztRQUE5Qyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTJCO0lBQ3BELENBQUM7Ozs7OztJQUdFLGdEQUFnQjs7Ozs7SUFBdkIsVUFBd0IsTUFBdUIsRUFBRSxRQUFtQjtRQUNsRSxJQUFJOztnQkFDRSxVQUFVLEdBQUcsS0FBSzs7Z0JBQ2xCLE9BQU8sR0FBRyxJQUFJOztnQkFDWixpQkFBaUIsR0FBRyxFQUFFO1lBQzVCLElBQUksQ0FBQyxRQUFRLElBQUksTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDckQsTUFBTTtvQkFDSixLQUFLLEVBQ0gscUNBQXFDO2lCQUN4QyxDQUFBO2FBQ0Y7O2dCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFOztnQkFDbkQsU0FBUyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSzs7Z0JBQ3BGLFNBQVMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsZUFBZSxLQUFLLFdBQVcsQ0FBQyxl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QUFlLEtBQUssV0FBVyxDQUFDLGVBQWUsQ0FBQztZQUM1RztnQkFDRSxPQUFPLElBQUksQ0FBQztTQUNmO0lBQ0gsQ0FBQzs7OztJQUVELHFEQUFxQjs7O0lBQXJCO1FBQ0UsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUM7ZUFDNUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDO2VBQ3JFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFBO0lBQy9FLENBQUM7O2dCQS9IRixVQUFVOzs7O2dCQU5GLHlCQUF5Qjs7SUF1SWxDLDRCQUFDO0NBQUEsQUFqSUQsSUFpSUM7U0FoSVkscUJBQXFCOzs7Ozs7SUFJOUIsb0RBQXNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZSB9IGZyb20gJ0B2ZXJkb2NzL3Rva2Vucyc7XG5pbXBvcnQgeyBpbnRlcnNlY3Rpb24gfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJVGVtcGxhdGUsIFRlbXBsYXRlQWN0aW9ucywgVGVtcGxhdGVQZXJtaXNzaW9ucywgVGVtcGxhdGVTZW5kZXJUeXBlcyB9IGZyb20gJy4uL21vZGVscy92ZXJkb2NzLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRlbXBsYXRlc0d1YXJkU2VydmljZSB7XG5cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZUb2tlbk9iamVjdFNlcnZpY2U6IFZlcmRvY3NUb2tlbk9iamVjdFNlcnZpY2VcbiAgKSB7IH1cblxuXG4gIHB1YmxpYyBjYW5QZXJmb3JtQWN0aW9uKGFjdGlvbjogVGVtcGxhdGVBY3Rpb25zLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKTogeyBjYW5QZXJmb3JtOiBib29sZWFuLCBtZXNzYWdlOiBzdHJpbmcgfSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjYW5QZXJmb3JtID0gZmFsc2U7XG4gICAgICBsZXQgbWVzc2FnZSA9IG51bGw7XG4gICAgICBjb25zdCBuZWVkZWRQZXJtaXNzaW9ucyA9IFtdO1xuICAgICAgaWYgKCF0ZW1wbGF0ZSAmJiBhY3Rpb24gJiYgIWFjdGlvbi5pbmNsdWRlcygnY3JlYXRlJykpIHtcbiAgICAgICAgdGhyb3cge1xuICAgICAgICAgIGVycm9yOlxuICAgICAgICAgICAgJ1lvdSBuZWVkIHRvIHByb3ZpZGUgdGVtcGxhdGUgb2JqZWN0J1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCB1c2VyUHJvZmlsZSA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQcm9maWxlKCk7XG4gICAgICBjb25zdCBpc0NyZWF0b3IgPSB1c2VyUHJvZmlsZSA/IHRlbXBsYXRlICYmIHRlbXBsYXRlLnByb2ZpbGVfaWQgPT09IHVzZXJQcm9maWxlLmlkIDogZmFsc2U7XG4gICAgICBjb25zdCBpc1NhbWVPcmcgPSB1c2VyUHJvZmlsZSA/IHRlbXBsYXRlICYmIHRlbXBsYXRlLm9yZ2FuaXphdGlvbl9pZCA9PT0gdXNlclByb2ZpbGUub3JnYW5pemF0aW9uX2lkIDogZmFsc2U7XG4gICAgICBjb25zdCBpc1BlcnNvbmFsID0gdGVtcGxhdGUgPyB0ZW1wbGF0ZS5pc19wZXJzb25hbCA6IG51bGw7XG4gICAgICBjb25zdCBpc1B1YmxpYyA9IHRlbXBsYXRlID8gdGVtcGxhdGUuaXNfcHVibGljIDogbnVsbDtcbiAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QRVJTT05BTDpcbiAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUEVSU09OQUwpXG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9PUkc6XG4gICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX09SRyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QVUJMSUM6XG4gICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX1BVQkxJQylcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuUkVBRDpcbiAgICAgICAgICBpZiAoIWlzQ3JlYXRvcikge1xuICAgICAgICAgICAgaWYgKCghaXNQZXJzb25hbCAmJiBpc1NhbWVPcmcpIHx8ICFpc1B1YmxpYykge1xuICAgICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1JFQUQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuV1JJVEU6XG4gICAgICAgICAgaWYgKCFpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfUkVBRCk7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1dSSVRFKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNIQU5HRV9WSVNJQklMSVRZX1BFUlNPTkFMOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9QRVJTT05BTCk7XG4gICAgICAgICAgICAvLyBuZWVkZWRQZXJtaXNzaW9uLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ0hBTkdFX1ZJU0lCSUxJVFlfT1JHOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9PUkcpO1xuICAgICAgICAgICAgLy8gbmVlZGVkUGVybWlzc2lvbi5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNIQU5HRV9WSVNJQklMSVRZX1BVQkxJQzpcbiAgICAgICAgICBpZiAoaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUFVCTElDKTtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuREVMRVRFOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0RFTEVURSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfREVMRVRFKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cge1xuICAgICAgICAgICAgZXJyb3I6ICdBY3Rpb24gaXMgbm90IGRlZmluZWQnXG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuaGFzUGVybWlzc2lvbnMobmVlZGVkUGVybWlzc2lvbnMpKSB7XG4gICAgICAgIGNhblBlcmZvcm0gPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IGBJbnN1ZmZpY2llbnQgYWNjZXNzIHRvIHBlcmZvcm0gJyR7YWN0aW9ufScuIE5lZWRlZCBwZXJtaXNzaW9uczogJHtuZWVkZWRQZXJtaXNzaW9ucy50b1N0cmluZygpfWA7XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjYW5QZXJmb3JtLFxuICAgICAgICBtZXNzYWdlXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKHtcbiAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byBjaGVjayB3aGV0aGVyIGFjdGlvbiAoJHthY3Rpb259KSBjYW4gYmUgZG9uZSwgaW4gVGVtcGxhdGVHdWFyZFNlcnZpY2VgLFxuICAgICAgICBlcnI6IGVyclxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNQZXJtaXNzaW9ucyhyZXF1aXJlZFBlcm1pc3Npb25zOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQZXJtaXNzaW9ucygpO1xuICAgIGNvbnN0IGhhc1Blcm1pc3Npb25zID0gaW50ZXJzZWN0aW9uKHVzZXJQZXJtaXNzaW9ucywgcmVxdWlyZWRQZXJtaXNzaW9ucykubGVuZ3RoID09PSByZXF1aXJlZFBlcm1pc3Npb25zLmxlbmd0aDtcbiAgICByZXR1cm4gaGFzUGVybWlzc2lvbnM7XG4gIH1cblxuICBwdWJsaWMgY2FuQmVTZW5kZXIodGVtcGxhdGUpOiBib29sZWFuIHtcbiAgICBjb25zdCB1c2VyUHJvZmlsZSA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQcm9maWxlKCk7XG4gICAgaWYgKCF1c2VyUHJvZmlsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBzd2l0Y2ggKHRlbXBsYXRlLnNlbmRlcikge1xuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLkNSRUFUT1I6XG4gICAgICAgIHJldHVybiB1c2VyUHJvZmlsZS5pZCA9PT0gdGVtcGxhdGUucHJvZmlsZV9pZDtcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5PUkdBTklaQVRJT05fTUVNQkVSOlxuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLk9SR0FOSVpBVElPTl9NRU1CRVJfQVNfQ1JFQVRPUjpcbiAgICAgICAgcmV0dXJuIHVzZXJQcm9maWxlLmlkID09PSB0ZW1wbGF0ZS5wcm9maWxlX2lkIHx8IHRlbXBsYXRlLm9yZ2FuaXphdGlvbl9pZCA9PT0gdXNlclByb2ZpbGUub3JnYW5pemF0aW9uX2lkO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgY2FuVXNlckNyZWF0ZVRlbXBsYXRlKCkge1xuICAgIHJldHVybiB0aGlzLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QRVJTT05BTCwgbnVsbClbJ2NhblBlcmZvcm0nXVxuICAgICAgfHwgdGhpcy5jYW5QZXJmb3JtQWN0aW9uKFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfT1JHLCBudWxsKVsnY2FuUGVyZm9ybSddXG4gICAgICB8fCB0aGlzLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QVUJMSUMsIG51bGwpWydjYW5QZXJmb3JtJ11cbiAgfVxuXG59XG4iXX0=