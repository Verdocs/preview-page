/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { intersection } from 'lodash';
import { Injectable } from '@angular/core';
import { TemplateActions, TemplatePermissions, TemplateSenderTypes } from '../models/verdocs.model';
export class TemplatesGuardService {
    /**
     * @param {?} vTokenObjectService
     */
    constructor(vTokenObjectService) {
        this.vTokenObjectService = vTokenObjectService;
    }
    /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    canPerformAction(action, template) {
        try {
            /** @type {?} */
            let canPerform = false;
            /** @type {?} */
            let message = null;
            /** @type {?} */
            const neededPermissions = [];
            if (!template && action && !action.includes('create')) {
                throw {
                    error: 'You need to provide template object'
                };
            }
            /** @type {?} */
            const userProfile = this.vTokenObjectService.getProfile();
            /** @type {?} */
            const isCreator = userProfile ? template && template.profile_id === userProfile.id : false;
            /** @type {?} */
            const isSameOrg = userProfile ? template && template.organization_id === userProfile.organization_id : false;
            /** @type {?} */
            const isPersonal = template ? template.is_personal : null;
            /** @type {?} */
            const isPublic = template ? template.is_public : null;
            switch (action) {
                case TemplateActions.CREATE_PERSONAL:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                    break;
                case TemplateActions.CREATE_ORG:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                    break;
                case TemplateActions.CREATE_PUBLIC:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                    break;
                case TemplateActions.READ:
                    if (!isCreator) {
                        if ((!isPersonal && isSameOrg) || !isPublic) {
                            neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        }
                    }
                    break;
                case TemplateActions.WRITE:
                    if (!isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_WRITE);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PERSONAL:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_ORG:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PUBLIC:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.DELETE:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_DELETE);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_DELETE);
                    }
                    break;
                default:
                    throw {
                        error: 'Action is not defined'
                    };
            }
            if (this.hasPermissions(neededPermissions)) {
                canPerform = true;
            }
            else {
                message = `Insufficient access to perform '${action}'. Needed permissions: ${neededPermissions.toString()}`;
            }
            return {
                canPerform,
                message
            };
        }
        catch (err) {
            console.error({
                message: `Failed to check whether action (${action}) can be done, in TemplateGuardService`,
                err: err
            });
        }
    }
    /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    hasPermissions(requiredPermissions) {
        /** @type {?} */
        const userPermissions = this.vTokenObjectService.getPermissions();
        /** @type {?} */
        const hasPermissions = intersection(userPermissions, requiredPermissions).length === requiredPermissions.length;
        return hasPermissions;
    }
    /**
     * @param {?} template
     * @return {?}
     */
    canBeSender(template) {
        /** @type {?} */
        const userProfile = this.vTokenObjectService.getProfile();
        if (!userProfile) {
            return false;
        }
        switch (template.sender) {
            case TemplateSenderTypes.CREATOR:
                return userProfile.id === template.profile_id;
            case TemplateSenderTypes.ORGANIZATION_MEMBER:
            case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                return userProfile.id === template.profile_id || template.organization_id === userProfile.organization_id;
            default:
                return true;
        }
    }
    /**
     * @return {?}
     */
    canUserCreateTemplate() {
        return this.canPerformAction(TemplateActions.CREATE_PERSONAL, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_ORG, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_PUBLIC, null)['canPerform'];
    }
}
TemplatesGuardService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
TemplatesGuardService.ctorParameters = () => [
    { type: VerdocsTokenObjectService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    TemplatesGuardService.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLmd1YXJkLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3MvaGVhZGVyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RlbXBsYXRlcy5ndWFyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUV0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYSxlQUFlLEVBQUUsbUJBQW1CLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUcvRyxNQUFNLE9BQU8scUJBQXFCOzs7O0lBR2hDLFlBQ1UsbUJBQThDO1FBQTlDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBMkI7SUFDcEQsQ0FBQzs7Ozs7O0lBR0UsZ0JBQWdCLENBQUMsTUFBdUIsRUFBRSxRQUFtQjtRQUNsRSxJQUFJOztnQkFDRSxVQUFVLEdBQUcsS0FBSzs7Z0JBQ2xCLE9BQU8sR0FBRyxJQUFJOztrQkFDWixpQkFBaUIsR0FBRyxFQUFFO1lBQzVCLElBQUksQ0FBQyxRQUFRLElBQUksTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDckQsTUFBTTtvQkFDSixLQUFLLEVBQ0gscUNBQXFDO2lCQUN4QyxDQUFBO2FBQ0Y7O2tCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFOztrQkFDbkQsU0FBUyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSzs7a0JBQ3BGLFNBQVMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsZUFBZSxLQUFLLFdB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ZUFBZSxDQUFDO1lBQzVHO2dCQUNFLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7SUFDSCxDQUFDOzs7O0lBRUQscUJBQXFCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDO2VBQzVFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQztlQUNyRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUMvRSxDQUFDOzs7WUEvSEYsVUFBVTs7OztZQU5GLHlCQUF5Qjs7Ozs7OztJQVc5QixvREFBc0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWZXJkb2NzVG9rZW5PYmplY3RTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvdG9rZW5zJztcbmltcG9ydCB7IGludGVyc2VjdGlvbiB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElUZW1wbGF0ZSwgVGVtcGxhdGVBY3Rpb25zLCBUZW1wbGF0ZVBlcm1pc3Npb25zLCBUZW1wbGF0ZVNlbmRlclR5cGVzIH0gZnJvbSAnLi4vbW9kZWxzL3ZlcmRvY3MubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGVtcGxhdGVzR3VhcmRTZXJ2aWNlIHtcblxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdlRva2VuT2JqZWN0U2VydmljZTogVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZVxuICApIHsgfVxuXG5cbiAgcHVibGljIGNhblBlcmZvcm1BY3Rpb24oYWN0aW9uOiBUZW1wbGF0ZUFjdGlvbnMsIHRlbXBsYXRlOiBJVGVtcGxhdGUpOiB7IGNhblBlcmZvcm06IGJvb2xlYW4sIG1lc3NhZ2U6IHN0cmluZyB9IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNhblBlcmZvcm0gPSBmYWxzZTtcbiAgICAgIGxldCBtZXNzYWdlID0gbnVsbDtcbiAgICAgIGNvbnN0IG5lZWRlZFBlcm1pc3Npb25zID0gW107XG4gICAgICBpZiAoIXRlbXBsYXRlICYmIGFjdGlvbiAmJiAhYWN0aW9uLmluY2x1ZGVzKCdjcmVhdGUnKSkge1xuICAgICAgICB0aHJvdyB7XG4gICAgICAgICAgZXJyb3I6XG4gICAgICAgICAgICAnWW91IG5lZWQgdG8gcHJvdmlkZSB0ZW1wbGF0ZSBvYmplY3QnXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHVzZXJQcm9maWxlID0gdGhpcy52VG9rZW5PYmplY3RTZXJ2aWNlLmdldFByb2ZpbGUoKTtcbiAgICAgIGNvbnN0IGlzQ3JlYXRvciA9IHVzZXJQcm9maWxlID8gdGVtcGxhdGUgJiYgdGVtcGxhdGUucHJvZmlsZV9pZCA9PT0gdXNlclByb2ZpbGUuaWQgOiBmYWxzZTtcbiAgICAgIGNvbnN0IGlzU2FtZU9yZyA9IHVzZXJQcm9maWxlID8gdGVtcGxhdGUgJiYgdGVtcGxhdGUub3JnYW5pemF0aW9uX2lkID09PSB1c2VyUHJvZmlsZS5vcmdhbml6YXRpb25faWQgOiBmYWxzZTtcbiAgICAgIGNvbnN0IGlzUGVyc29uYWwgPSB0ZW1wbGF0ZSA/IHRlbXBsYXRlLmlzX3BlcnNvbmFsIDogbnVsbDtcbiAgICAgIGNvbnN0IGlzUHVibGljID0gdGVtcGxhdGUgPyB0ZW1wbGF0ZS5pc19wdWJsaWMgOiBudWxsO1xuICAgICAgc3dpdGNoIChhY3Rpb24pIHtcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX1BFUlNPTkFMOlxuICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9QRVJTT05BTClcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX09SRzpcbiAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfT1JHKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX1BVQkxJQzpcbiAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUFVCTElDKVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5SRUFEOlxuICAgICAgICAgIGlmICghaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBpZiAoKCFpc1BlcnNvbmFsICYmIGlzU2FtZU9yZykgfHwgIWlzUHVibGljKSB7XG4gICAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfUkVBRCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5XUklURTpcbiAgICAgICAgICBpZiAoIWlzQ3JlYXRvcikge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9SRUFEKTtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfV1JJVEUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ0hBTkdFX1ZJU0lCSUxJVFlfUEVSU09OQUw6XG4gICAgICAgICAgaWYgKGlzQ3JlYXRvcikge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX1BFUlNPTkFMKTtcbiAgICAgICAgICAgIC8vIG5lZWRlZFBlcm1pc3Npb24ucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfVklTSUJJTElUWSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfVklTSUJJTElUWSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5DSEFOR0VfVklTSUJJTElUWV9PUkc6XG4gICAgICAgICAgaWYgKGlzQ3JlYXRvcikge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX09SRyk7XG4gICAgICAgICAgICAvLyBuZWVkZWRQZXJtaXNzaW9uLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ0hBTkdFX1ZJU0lCSUxJVFlfUFVCTElDOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9QVUJMSUMpO1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfVklTSUJJTElUWSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfVklTSUJJTElUWSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRlbXBsYXRlQWN0aW9ucy5ERUxFVEU6XG4gICAgICAgICAgaWYgKGlzQ3JlYXRvcikge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfREVMRVRFKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9ERUxFVEUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyB7XG4gICAgICAgICAgICBlcnJvcjogJ0FjdGlvbiBpcyBub3QgZGVmaW5lZCdcbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5oYXNQZXJtaXNzaW9ucyhuZWVkZWRQZXJtaXNzaW9ucykpIHtcbiAgICAgICAgY2FuUGVyZm9ybSA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNzYWdlID0gYEluc3VmZmljaWVudCBhY2Nlc3MgdG8gcGVyZm9ybSAnJHthY3Rpb259Jy4gTmVlZGVkIHBlcm1pc3Npb25zOiAke25lZWRlZFBlcm1pc3Npb25zLnRvU3RyaW5nKCl9YDtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNhblBlcmZvcm0sXG4gICAgICAgIG1lc3NhZ2VcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3Ioe1xuICAgICAgICBtZXNzYWdlOiBgRmFpbGVkIHRvIGNoZWNrIHdoZXRoZXIgYWN0aW9uICgke2FjdGlvbn0pIGNhbiBiZSBkb25lLCBpbiBUZW1wbGF0ZUd1YXJkU2VydmljZWAsXG4gICAgICAgIGVycjogZXJyXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhc1Blcm1pc3Npb25zKHJlcXVpcmVkUGVybWlzc2lvbnM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgdXNlclBlcm1pc3Npb25zID0gdGhpcy52VG9rZW5PYmplY3RTZXJ2aWNlLmdldFBlcm1pc3Npb25zKCk7XG4gICAgY29uc3QgaGFzUGVybWlzc2lvbnMgPSBpbnRlcnNlY3Rpb24odXNlclBlcm1pc3Npb25zLCByZXF1aXJlZFBlcm1pc3Npb25zKS5sZW5ndGggPT09IHJlcXVpcmVkUGVybWlzc2lvbnMubGVuZ3RoO1xuICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucztcbiAgfVxuXG4gIHB1YmxpYyBjYW5CZVNlbmRlcih0ZW1wbGF0ZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHVzZXJQcm9maWxlID0gdGhpcy52VG9rZW5PYmplY3RTZXJ2aWNlLmdldFByb2ZpbGUoKTtcbiAgICBpZiAoIXVzZXJQcm9maWxlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHN3aXRjaCAodGVtcGxhdGUuc2VuZGVyKSB7XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuQ1JFQVRPUjpcbiAgICAgICAgcmV0dXJuIHVzZXJQcm9maWxlLmlkID09PSB0ZW1wbGF0ZS5wcm9maWxlX2lkO1xuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLk9SR0FOSVpBVElPTl9NRU1CRVI6XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuT1JHQU5JWkFUSU9OX01FTUJFUl9BU19DUkVBVE9SOlxuICAgICAgICByZXR1cm4gdXNlclByb2ZpbGUuaWQgPT09IHRlbXBsYXRlLnByb2ZpbGVfaWQgfHwgdGVtcGxhdGUub3JnYW5pemF0aW9uX2lkID09PSB1c2VyUHJvZmlsZS5vcmdhbml6YXRpb25faWQ7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBjYW5Vc2VyQ3JlYXRlVGVtcGxhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FuUGVyZm9ybUFjdGlvbihUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX1BFUlNPTkFMLCBudWxsKVsnY2FuUGVyZm9ybSddXG4gICAgICB8fCB0aGlzLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9PUkcsIG51bGwpWydjYW5QZXJmb3JtJ11cbiAgICAgIHx8IHRoaXMuY2FuUGVyZm9ybUFjdGlvbihUZW1wbGF0ZUFjdGlvbnMuQ1JFQVRFX1BVQkxJQywgbnVsbClbJ2NhblBlcmZvcm0nXVxuICB9XG5cbn1cbiJdfQ==