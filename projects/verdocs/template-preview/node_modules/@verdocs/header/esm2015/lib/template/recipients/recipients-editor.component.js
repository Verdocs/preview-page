/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { VerdocsHeaderService } from '../../services/header.service';
import { TemplateSenderTypes } from '../../models/verdocs.model';
export class RecipientEditorComponent {
    /**
     * @param {?} verdocsHeaderService
     * @param {?} vTokenObjectService
     */
    constructor(verdocsHeaderService, vTokenObjectService) {
        this.verdocsHeaderService = verdocsHeaderService;
        this.vTokenObjectService = vTokenObjectService;
        this.roles = [];
        this.sender = 'creator';
        this.sender_name = '';
    }
    /**
     * @return {?}
     */
    ngOnChanges() {
        this.prepareSender();
        this.prepareExistingRoles();
    }
    /**
     * @return {?}
     */
    prepareSender() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.sender = this.template.sender || 'creator';
            yield this.updateSenderName();
        });
    }
    /**
     * @return {?}
     */
    updateSenderName() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const profile = this.vTokenObjectService.getProfile();
            /** @type {?} */
            const ownerInfo = yield this.verdocsHeaderService.getTemplateOwnerInfo(this.template.id);
            switch (this.sender) {
                case TemplateSenderTypes.ORGANIZATION_MEMBER:
                    this.sender_name = 'Anyone at ' + (profile ? profile.organization.name : 'organization');
                    break;
                case TemplateSenderTypes.EVERYONE:
                    this.sender_name = 'Anyone';
                    break;
                case TemplateSenderTypes.EVERYONE_AS_CREATOR:
                case TemplateSenderTypes.CREATOR:
                case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                    if (profile && this.template.profile_id === profile.id) {
                        this.sender_name = profile.first_name + ' ' + profile.last_name + ' (me)';
                    }
                    else {
                        this.sender_name = ownerInfo.name + ' (creator)';
                    }
                    break;
            }
        });
    }
    /**
     * @param {?=} recipients
     * @return {?}
     */
    prepareExistingRoles(recipients) {
        /** @type {?} */
        let roles = [];
        if (recipients && recipients.length > 0) {
            roles = recipients;
        }
        else {
            roles = this.template.roles.sort((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                return a.sequence - b.sequence;
            })).slice();
        }
        roles = this.setStyles(roles);
        this.roles = [];
        for (let roleIndex = 0; roleIndex < roles.length; roleIndex++) {
            if (roles[roleIndex]) {
                /** @type {?} */
                const sequenceIndex = roles[roleIndex].sequence - 1;
                if (!roles[roleIndex]['status']) {
                    roles[roleIndex]['status'] = null;
                }
                if (!roles[roleIndex]['old_name']) {
                    roles[roleIndex]['old_name'] = roles[roleIndex].name;
                }
                if (this.roles[sequenceIndex] === undefined) {
                    this.roles[sequenceIndex] = [roles[roleIndex]];
                }
                else {
                    this.roles[sequenceIndex].push(roles[roleIndex]);
                }
            }
        }
        if (this.roles && this.roles.length === 0 && !this.roles[0]) {
            this.roles = [];
            this.roles[0] = [];
        }
    }
    /**
     * @param {?} roles
     * @return {?}
     */
    setStyles(roles) {
        roles.forEach((/**
         * @param {?} role
         * @param {?} index
         * @return {?}
         */
        (role, index) => {
            if (role) {
                if (role.full_name && role.email) {
                    role['style'] = {
                        'border': '1px solid ' + this.verdocsHeaderService.getRGBA(index),
                        'background-color': 'transparent'
                    };
                }
                else {
                    role['style'] = {
                        'background': this.verdocsHeaderService.getRGBA(index),
                        'border': '1px solid getRGBA(index)'
                    };
                }
            }
        }));
        return roles;
    }
}
RecipientEditorComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-recipient-editor',
                template: "<div class=\"template-recipients__container\" *ngIf=\"template\">\n  <div class=\"template-recipients__wrapper\">\n    <div class=\"template-recipients__body\">\n      <div class=\"template-recipients__sender\">\n        <div class=\"template-recipients__icon\">\n          <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Sender\" [matTooltipPosition]=\"'below'\">trip_origin</mat-icon>\n        </div>\n        <div class=\"template-recipients__dots\"></div>\n        <div class=\"template-recipients__chips sender\">\n          <mat-chip class=\"template-recipients__chip-sender\">\n            <span>\n              {{sender_name}}\n            </span>\n          </mat-chip>\n        </div>\n      </div>\n      <div class=\"template-recipients__roles\" *ngIf=\"roles && roles.length > 0\">\n        <div class=\"template-recipients__role\" *ngFor=\"let sequence of roles; let sequenceIndex = index;\">\n          <div class=\"template-recipients__icon\">\n            <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Sequence\" [matTooltipPosition]=\"'below'\">place</mat-icon>\n          </div>\n          <div class=\"template-recipients__dots\"></div>\n          <div class=\"template-recipients__chips\">\n            <div class=\"template-recipients__field\">\n              <mat-chip-list class=\"template-recipients__chip-list\" #roleChipList aria-label=\"roles\">\n                <div class=\"template-recipients__chip-wrapper\">\n                  <mat-chip class=\"template-recipients__chip-recipient\" *ngFor=\"let role of sequence\"\n                    [ngStyle]=\"role.style\" [removable]=\"false\" [ngClass]=\"{hidden: role.status === 'delete'}\">\n                    {{role.full_name && role.email ? role.full_name : role.name}}\n                  </mat-chip>\n                </div>\n              </mat-chip-list>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"template-recipients__sender\">\n        <div class=\"template-recipients__icon\">\n          <mat-icon class=\"template-recipients__icon-icon\" matTooltip=\"Verdco complete\" [matTooltipPosition]=\"'below'\">done_all</mat-icon>\n        </div>\n        <div class=\"template-recipients__chips sender\">\n          <mat-chip class=\"template-recipients__chip-sender no-border\">\n            <span>\n              Complete\n            </span>\n          </mat-chip>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>",
                styles: [".template-recipients__wrapper{position:relative;margin:0 auto;width:100%;max-width:600px}.template-recipients__body{position:relative}.template-recipients__sender{position:relative;min-height:48px}.template-recipients__sender:after{content:\"\";display:table;clear:both}.template-recipients__sender-text{margin-top:8px;margin-bottom:8px;font-size:12px;line-height:12px;color:rgba(0,0,0,.54)}.template-recipients__sender-radio{display:flex;align-items:center;height:40px}.template-recipients__roles{position:relative;min-height:48px}.template-recipients__roles:after{content:\"\";display:table;clear:both}.template-recipients__role{position:relative;min-height:48px}.template-recipients__role:after{content:\"\";display:table;clear:both}.template-recipients__icon{position:absolute;top:12px;left:16px;display:inline-block;width:24px;height:24px;z-index:10;background-color:#fff;border-radius:100%}.template-recipients__icon-icon{color:rgba(0,0,0,.54)}.template-recipients__dots{position:absolute;top:24px;left:25.7px;height:100%;border-left:4px dotted #9b9b9b;z-index:1}.template-recipients__chips{position:relative;min-height:48px;margin-left:64px;display:flex;align-items:center;border-bottom:1px solid #d1d5da}.template-recipients__chips.sender,.template-recipients__chips.sequence{display:flex;align-items:center}.template-recipients__chip-list{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center}.template-recipients__chip-wrapper{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;width:100%;min-height:40px}.template-recipients__chip-recipient.no-border,.template-recipients__chip-sender.no-border{padding-left:0;border:none;pointer-events:none}.template-recipients__chip-recipient.hidden,.template-recipients__chip-sender.hidden{display:none}.template-recipients__chip-recipient.icon-right,.template-recipients__chip-sender.icon-right{padding-right:8px}.template-recipients__chip-recipient:hover,.template-recipients__chip-sender:hover{cursor:pointer}.template-recipients__chip-recipient.cdk-drag-placeholder{background:#ccc;border:3px dotted #999;border-radius:16px;opacity:1;height:32px;transition:transform 250ms cubic-bezier(0,0,.2,1)}.template-recipients__chip-sender{background-color:transparent;border:1px solid rgba(98,113,123,.2)}.template-recipients__chip-add{border:1px dashed #979797;background-color:transparent}.template-recipients__chip-add.icon-left{padding-left:8px}.template-recipients__chip-add:hover{cursor:pointer}.template-recipients__chip-edit{width:18px;height:18px;color:rgba(0,0,0,.87);font-size:18px;margin-left:8px}.template-recipients__chip-icon--left{width:18px;height:18px;color:rgba(0,0,0,.87);font-size:18px;margin-right:8px}"]
            }] }
];
/** @nocollapse */
RecipientEditorComponent.ctorParameters = () => [
    { type: VerdocsHeaderService },
    { type: VerdocsTokenObjectService }
];
RecipientEditorComponent.propDecorators = {
    template: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    RecipientEditorComponent.prototype.roles;
    /** @type {?} */
    RecipientEditorComponent.prototype.sender;
    /** @type {?} */
    RecipientEditorComponent.prototype.sender_name;
    /** @type {?} */
    RecipientEditorComponent.prototype.template;
    /**
     * @type {?}
     * @private
     */
    RecipientEditorComponent.prototype.verdocsHeaderService;
    /**
     * @type {?}
     * @private
     */
    RecipientEditorComponent.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3MvaGVhZGVyLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlL3JlY2lwaWVudHMvcmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDNUQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFNUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDckUsT0FBTyxFQUFhLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFPNUUsTUFBTSxPQUFPLHdCQUF3Qjs7Ozs7SUFPbkMsWUFDVSxvQkFBMEMsRUFDMUMsbUJBQThDO1FBRDlDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUEyQjtRQVJqRCxVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsV0FBTSxHQUFHLFNBQVMsQ0FBQztRQUNuQixnQkFBVyxHQUFHLEVBQUUsQ0FBQztJQU9yQixDQUFDOzs7O0lBRUosV0FBVztRQUNULElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUM5QixDQUFDOzs7O0lBRUssYUFBYTs7WUFDakIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxTQUFTLENBQUM7WUFDaEQsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNoQyxDQUFDO0tBQUE7Ozs7SUFFSyxnQkFBZ0I7OztrQkFDZCxPQUFPLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRTs7a0JBQy9DLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FB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IHsgQ29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBWZXJkb2NzVG9rZW5PYmplY3RTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvdG9rZW5zJztcblxuaW1wb3J0IHsgVmVyZG9jc0hlYWRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9oZWFkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBJVGVtcGxhdGUsIFRlbXBsYXRlU2VuZGVyVHlwZXMgfSBmcm9tICcuLi8uLi9tb2RlbHMvdmVyZG9jcy5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2FwcC1yZWNpcGllbnQtZWRpdG9yJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3JlY2lwaWVudHMtZWRpdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vcmVjaXBpZW50cy1lZGl0b3IuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBSZWNpcGllbnRFZGl0b3JDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXN7XG4gIHB1YmxpYyByb2xlcyA9IFtdO1xuICBwdWJsaWMgc2VuZGVyID0gJ2NyZWF0b3InO1xuICBwdWJsaWMgc2VuZGVyX25hbWUgPSAnJztcblxuICBASW5wdXQoKSB0ZW1wbGF0ZTogSVRlbXBsYXRlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdmVyZG9jc0hlYWRlclNlcnZpY2U6IFZlcmRvY3NIZWFkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgdlRva2VuT2JqZWN0U2VydmljZTogVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZVxuICApIHt9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgdGhpcy5wcmVwYXJlU2VuZGVyKCk7XG4gICAgdGhpcy5wcmVwYXJlRXhpc3RpbmdSb2xlcygpO1xuICB9XG5cbiAgYXN5bmMgcHJlcGFyZVNlbmRlcigpIHtcbiAgICB0aGlzLnNlbmRlciA9IHRoaXMudGVtcGxhdGUuc2VuZGVyIHx8ICdjcmVhdG9yJztcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVNlbmRlck5hbWUoKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNlbmRlck5hbWUoKSB7XG4gICAgY29uc3QgcHJvZmlsZSA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQcm9maWxlKCk7XG4gICAgY29uc3Qgb3duZXJJbmZvID0gYXdhaXQgdGhpcy52ZXJkb2NzSGVhZGVyU2VydmljZS5nZXRUZW1wbGF0ZU93bmVySW5mbyh0aGlzLnRlbXBsYXRlLmlkKTtcbiAgICBzd2l0Y2ggKHRoaXMuc2VuZGVyKSB7XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuT1JHQU5JWkFUSU9OX01FTUJFUjpcbiAgICAgICAgdGhpcy5zZW5kZXJfbmFtZSA9ICdBbnlvbmUgYXQgJyArIChwcm9maWxlID8gcHJvZmlsZS5vcmdhbml6YXRpb24ubmFtZSA6ICdvcmdhbml6YXRpb24nKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuRVZFUllPTkU6XG4gICAgICAgIHRoaXMuc2VuZGVyX25hbWUgPSAnQW55b25lJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRlbXBsYXRlU2VuZGVyVHlwZXMuRVZFUllPTkVfQVNfQ1JFQVRPUjpcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5DUkVBVE9SOlxuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLk9SR0FOSVpBVElPTl9NRU1CRVJfQVNfQ1JFQVRPUjpcbiAgICAgICAgaWYgKHByb2ZpbGUgJiYgdGhpcy50ZW1wbGF0ZS5wcm9maWxlX2lkID09PSBwcm9maWxlLmlkKSB7XG4gICAgICAgICAgdGhpcy5zZW5kZXJfbmFtZSA9IHByb2ZpbGUuZmlyc3RfbmFtZSArICcgJyArIHByb2ZpbGUubGFzdF9uYW1lICsgJyAobWUpJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnNlbmRlcl9uYW1lID0gb3duZXJJbmZvLm5hbWUgKyAnIChjcmVhdG9yKSc7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcHJlcGFyZUV4aXN0aW5nUm9sZXMocmVjaXBpZW50cz8pIHtcbiAgICBsZXQgcm9sZXMgPSBbXVxuICAgIGlmIChyZWNpcGllbnRzICYmIHJlY2lwaWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgcm9sZXMgPSByZWNpcGllbnRzO1xuICAgIH0gZWxzZSB7XG4gICAgICByb2xlcyA9IHRoaXMudGVtcGxhdGUucm9sZXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICByZXR1cm4gYS5zZXF1ZW5jZSAtIGIuc2VxdWVuY2U7XG4gICAgICB9KS5zbGljZSgpO1xuICAgIH1cblxuICAgIHJvbGVzID0gdGhpcy5zZXRTdHlsZXMocm9sZXMpO1xuICAgIHRoaXMucm9sZXMgPSBbXTtcbiAgICBmb3IgKGxldCByb2xlSW5kZXggPSAwOyByb2xlSW5kZXggPCByb2xlcy5sZW5ndGg7IHJvbGVJbmRleCsrKSB7XG4gICAgICBpZiAocm9sZXNbcm9sZUluZGV4XSkge1xuICAgICAgICBjb25zdCBzZXF1ZW5jZUluZGV4ID0gcm9sZXNbcm9sZUluZGV4XS5zZXF1ZW5jZSAtIDE7XG4gICAgICAgIGlmICghcm9sZXNbcm9sZUluZGV4XVsnc3RhdHVzJ10pIHtcbiAgICAgICAgICByb2xlc1tyb2xlSW5kZXhdWydzdGF0dXMnXSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFyb2xlc1tyb2xlSW5kZXhdWydvbGRfbmFtZSddKSB7XG4gICAgICAgICAgcm9sZXNbcm9sZUluZGV4XVsnb2xkX25hbWUnXSA9IHJvbGVzW3JvbGVJbmRleF0ubmFtZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5yb2xlc1tzZXF1ZW5jZUluZGV4XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhpcy5yb2xlc1tzZXF1ZW5jZUluZGV4XSA9IFtyb2xlc1tyb2xlSW5kZXhdXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnJvbGVzW3NlcXVlbmNlSW5kZXhdLnB1c2gocm9sZXNbcm9sZUluZGV4XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMucm9sZXMgJiYgdGhpcy5yb2xlcy5sZW5ndGggPT09IDAgJiYgIXRoaXMucm9sZXNbMF0pIHtcbiAgICAgIHRoaXMucm9sZXMgPSBbXVxuICAgICAgdGhpcy5yb2xlc1swXSA9IFtdXG4gICAgfVxuICB9XG5cbiAgc2V0U3R5bGVzKHJvbGVzKSB7XG4gICAgcm9sZXMuZm9yRWFjaCgocm9sZSwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChyb2xlKSB7XG4gICAgICAgIGlmIChyb2xlLmZ1bGxfbmFtZSAmJiByb2xlLmVtYWlsKSB7XG4gICAgICAgICAgcm9sZVsnc3R5bGUnXSA9IHtcbiAgICAgICAgICAgICdib3JkZXInOiAnMXB4IHNvbGlkICcgKyB0aGlzLnZlcmRvY3NIZWFkZXJTZXJ2aWNlLmdldFJHQkEoaW5kZXgpLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtY29sb3InOiAndHJhbnNwYXJlbnQnXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJvbGVbJ3N0eWxlJ10gPSB7XG4gICAgICAgICAgICAnYmFja2dyb3VuZCc6IHRoaXMudmVyZG9jc0hlYWRlclNlcnZpY2UuZ2V0UkdCQShpbmRleCksXG4gICAgICAgICAgICAnYm9yZGVyJzogJzFweCBzb2xpZCBnZXRSR0JBKGluZGV4KSdcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcm9sZXM7XG4gIH1cbn1cbiJdfQ==