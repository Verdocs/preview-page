!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("ngx-cookie"),require("@auth0/angular-jwt"),require("rxjs"),require("rxjs/operators"),require("@angular/router"),require("@angular/material")):"function"==typeof define&&define.amd?define("@verdocs/tokens",["exports","@angular/core","@angular/common","@angular/common/http","ngx-cookie","@auth0/angular-jwt","rxjs","rxjs/operators","@angular/router","@angular/material"],t):t(((e=e||self).verdocs=e.verdocs||{},e.verdocs.tokens={}),e.ng.core,e.ng.common,e.ng.common.http,e.ngxCookie,e.angularJwt,e.rxjs,e.rxjs.operators,e.ng.router,e.ng.material)}(this,function(e,t,o,i,r,n,s,c,a,u){"use strict";function l(e){var t="function"==typeof Symbol&&e[Symbol.iterator],o=0;return t?t.call(e):{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}}}var h=new n.JwtHelperService,f=function(){function e(e,t,o,i){this.cookieService=e,this.http=t,this.injector=o,this.platform=i,this.timerActive=!1,this.cookieConfig={path:"/",domain:"localhost",secure:!1},this.accessList=[],this.decodedIdTokenSubject=new s.ReplaySubject,this.tokenConfig=this.injector.get(T),this.domain=this.tokenConfig.domain,this.init()}return e.prototype.init=function(){this.tokenConfig.loginURL&&(this.loginURL=this.tokenConfig.loginURL),this.tokenConfig.cookieName?this.cookieName=this.tokenConfig.cookieName:this.tokenConfig.origin&&(this.cookieName=this.tokenConfig.origin+e.COOKIE_NAME_SUFFIX),this.production=this.tokenConfig.production||!1,this.cookieConfig.domain=this.getDomain(),this.tokenConfig.production&&(this.cookieConfig.secure=!0),this.getAccessList()},e.prototype.getDomain=function(){if(this.production||"localhost"!==this.domain){var e=this.domain.split(".");return"."+e[e.length-2]+"."+e[e.length-1]}return"localhost"},e.prototype.watchAuthentication=function(){var t=this;o.isPlatformBrowser(this.platform)&&(this.timerActive||(this.timerActive=!0,this.authenticationWatcher=s.interval(15e3).subscribe(function(){t.getAccessList(),-1!==t.accessList.indexOf(e.RACCOUNT_COOKIE_NAME)&&-1!==t.accessList.indexOf(t.cookieName)||(t.cookieService.removeAll(),window.location.href=t.getLoginURL())})))},e.prototype.endWatchAuthentication=function(){this.authenticationWatcher.unsubscribe()},e.prototype.getAccountCookieObject=function(){if(o.isPlatformBrowser(this.platform)){var t=(this.tokenConfig.account_name||"rAccount")+e.COOKIE_NAME_SUFFIX;return this.getOtherCookieObject(t)}},e.prototype.getVerdocsCookieObject=function(){if(o.isPlatformBrowser(this.platform)){var t=(this.tokenConfig.verdocs_name||"rForm")+e.COOKIE_NAME_SUFFIX;return this.getOtherCookieObject(t)}},e.prototype.getAccessToken=function(){if(o.isPlatformBrowser(this.platform)&&this.cookieName){var t=this.getOtherCookieObject(this.cookieName);if(t&&t[e.ACCESS_TOKEN_NAME])return this.accessToken=t[e.ACCESS_TOKEN_NAME],this.accessToken}return null},e.prototype.getVerdocsAccessToken=function(){if(o.isPlatformBrowser(this.platform)){var t=this.getVerdocsCookieObject();if(t&&t[e.ACCESS_TOKEN_NAME])return this.accessToken=t[e.ACCESS_TOKEN_NAME],this.accessToken}},e.prototype.getAccountAccessToken=function(){if(o.isPlatformBrowser(this.platform)){var t=this.getAccountCookieObject();if(t&&t[e.ACCESS_TOKEN_NAME])return this.accessToken=t[e.ACCESS_TOKEN_NAME],this.accessToken}},e.prototype.getIDToken=function(){if(o.isPlatformBrowser(this.platform)){var t=this.getAccountCookieObject();if(t&&t[e.ID_TOKEN_NAME])return this.idToken=t[e.ID_TOKEN_NAME],this.decodedIdTokenSubject.next(h.decodeToken(this.idToken)),this.idToken}return null},e.prototype.getLoginURL=function(){return this.loginURL},e.prototype.setTimer=function(e){this.timerActive=e},e.prototype.getUserId=function(){var e=this.getIDToken();if(e){var t=this.tokenToObject(e);return t.sub?t.sub.replace("auth0|",""):null}},e.prototype.getAppUserId=function(t){if(o.isPlatformBrowser(this.platform)){t||(t=e.RACCOUNT_COOKIE_NAME);var i=this.cookieService.getObject(t),r=void 0;if(i&&i[e.ID_TOKEN_NAME]){r=i[e.ID_TOKEN_NAME];var n=this.tokenToObject(r);if(n.sub)return n.sub.replace("auth0|","")}return null}},e.prototype.updateCookie=function(t,i,r){if(o.isPlatformBrowser(this.platform)){var n=r||this.cookieName;this.cookieConfig.domain=this.getDomain(),window&&window.location&&"https:"===location.protocol&&(this.cookieConfig.secure=!0);var s=this.getrAccountCookieObject(),c=this.getOtherCookieObject(n),a=void 0;n&&t&&i&&(n===e.RACCOUNT_COOKIE_NAME&&s?(s[t]=i,a=s):c&&(c[t]=i,a=c),this.cookieService.putObject(n,a,this.cookieConfig))}},e.prototype.updateTokens=function(t){var i=this;if(o.isPlatformBrowser(this.platform))return this.getTokens(t).pipe(c.map(function(t){for(var o=0;o<t.length;o++)"rAccount"===t[o].clientName&&(i.updateCookie(e.ID_TOKEN_NAME,t[o].idToken,t[o].clientName+e.COOKIE_NAME_SUFFIX),i.decodedIdTokenSubject.next(h.decodeToken(t[o].idToken))),i.updateCookie(e.ACCESS_TOKEN_NAME,t[o].accessToken,t[o].clientName+e.COOKIE_NAME_SUFFIX);return t}))},e.prototype.hasCookie=function(){return!!this.cookieService.get(this.cookieName)},e.prototype.getAccessList=function(){if(o.isPlatformBrowser(this.platform)){for(var t in this.getAllCookies(),this.accessList=[],this.cookies)-1!==t.indexOf(e.COOKIE_NAME_SUFFIX)&&this.accessList.push(t);return this.accessList}},e.prototype.getEmailVerification=function(){if(o.isPlatformBrowser(this.platform)){var e=this.getIDToken();return!!e&&this.tokenToObject(e).email_verified}},e.prototype.hasAccessTo=function(e){return-1!==this.accessList.indexOf(e)},e.prototype.storeOtherCookie=function(e,t){o.isPlatformBrowser(this.platform)&&this.setCookie(e,t)},e.prototype.getOtherCookie=function(e){if(o.isPlatformBrowser(this.platform))try{return e?this.cookieService.getObject(e):null}catch(e){return console.error("Cannot return cookie:",e),null}},e.prototype.getRCookie=function(e){if(o.isPlatformBrowser(this.platform))return this.cookieService.get(e)},e.prototype.getOtherCookieObject=function(t){try{return t&&o.isPlatformBrowser(this.platform)?this.cookieService.getObject(t):null}catch(o){return t!==e.SIGNER_TOKEN_COOKIE_NAME&&console.error("Cannot get cookie: ",o),null}},e.prototype.removeRCookie=function(e){o.isPlatformBrowser(this.platform)&&this.cookieService.remove(e,this.cookieConfig)},e.prototype.removeRCookies=function(){var e,t;if(o.isPlatformBrowser(this.platform)&&this.accessList.length>0)try{for(var i=l(this.accessList),r=i.next();!r.done;r=i.next()){var n=r.value;this.removeRCookie(n)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}},e.prototype.removeIntercomCookie=function(){if(o.isPlatformBrowser(this.platform))for(var e in this.cookies)-1!==e.indexOf("intercom")&&this.removeRCookie(e)},e.prototype.setTokens=function(t){var i,r;if(o.isPlatformBrowser(this.platform)&&t&&t.length>0)try{for(var n=l(t),s=n.next();!s.done;s=n.next()){var c=s.value;"rAccount"===c.clientName&&(this.updateCookie(e.ID_TOKEN_NAME,c.idToken,c.clientName+e.COOKIE_NAME_SUFFIX),this.decodedIdTokenSubject.next(h.decodeToken(c.idToken))),this.updateCookie(e.ACCESS_TOKEN_NAME,c.accessToken,c.clientName+e.COOKIE_NAME_SUFFIX)}}catch(e){i={error:e}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}},e.prototype.getrAccountCookieObject=function(){if(o.isPlatformBrowser(this.platform))try{return this.cookieName&&this.cookieService.get(e.RACCOUNT_COOKIE_NAME)?this.cookieService.getObject(e.RACCOUNT_COOKIE_NAME):null}catch(e){return null}},e.prototype.getAllCookies=function(){o.isPlatformBrowser(this.platform)&&(this.cookies=this.cookieService.getAll())},e.prototype.tokenToObject=function(e){if(e){var t=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(t))}return null},e.prototype.setCookie=function(e,t){o.isPlatformBrowser(this.platform)&&this.cookieService.put(e,t,this.cookieConfig)},e.prototype.getTokens=function(e){return this.http.get(e+"/token")},e.prototype.getRAccountRoles=function(){if(o.isPlatformBrowser(this.platform)){var t=this.cookieService.getObject(e.RACCOUNT_COOKIE_NAME);if(!t)return null;try{var i=t[e.ACCESS_TOKEN_NAME];return this.tokenToObject(i)[e.TOKEN_NAMESPACE+"/roles"]}catch(e){console.error(e)}}},e.prototype.getPlans=function(){if(o.isPlatformBrowser(this.platform)){var t=this.cookieService.getObject(e.RACCOUNT_COOKIE_NAME);if(!t)return null;try{var i=t[e.ACCESS_TOKEN_NAME];return this.tokenToObject(i)[e.TOKEN_NAMESPACE+"/plans"]}catch(e){console.error(e)}}},e.RACCOUNT_COOKIE_NAME="rAccount_Verdocs",e.SIGNER_TOKEN_COOKIE_NAME="signer_token",e.COOKIE_NAME_SUFFIX="_Verdocs",e.ACCESS_TOKEN_NAME="accessToken",e.ID_TOKEN_NAME="idToken",e.TOKEN_NAMESPACE="https://verdocs.com",e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.CookieService},{type:i.HttpClient},{type:t.Injector},{type:void 0,decorators:[{type:t.Inject,args:[t.PLATFORM_ID]}]}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(r.CookieService),t.ɵɵinject(i.HttpClient),t.ɵɵinject(t.INJECTOR),t.ɵɵinject(t.PLATFORM_ID))},token:e,providedIn:"root"}),e}();var p=function(){function e(e){this.injector=e}return e.prototype.intercept=function(e,t){this.stateService=this.injector.get(f);var o=this.stateService.getAccessToken(),i=this.stateService.getIDToken(),r=this.stateService.getOtherCookieObject("signer_token"),n={Pragma:"no-cache","Cache-Control":"no-cache",Expires:"Sat, 01 Jan 2000 00:00:00 GMT","If-Modified-Since":"0"};return e.url.startsWith("assets/")?t.handle(e):(!e.headers.get("Authorization")&&o&&(n.Authorization="Bearer "+o),i&&(n.Authentication="Bearer "+i),r&&(n.Signer="Bearer "+r),e=e.clone({setHeaders:n}),t.handle(e))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.Injector}]},e}();var d=new n.JwtHelperService,g=function(){function e(e){this.stateService=e}return e.prototype.isAuthenticated=function(){var e=this.stateService.getIDToken();return!!e&&!d.isTokenExpired(e)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:f}]},e}();var k=function(){function e(e,t,o){this.authService=e,this.stateService=t,this.route=o,this.signOutRequestSubmitted=!1;this.route.snapshot}return e.prototype.checkLogin=function(){this.authService.isAuthenticated||this.stateService.getLoginURL()&&this.signOut(),this.stateService.watchAuthentication()},e.prototype.checkAuthentication=function(){this.authService.isAuthenticated()||this.signOut()},e.prototype.signOut=function(e){if(!this.signOutRequestSubmitted){this.signOutRequestSubmitted=!0,this.authService.isAuthenticated()||(e=window.location.href),this.stateService.removeRCookies(),this.stateService.removeIntercomCookie();var t=(this.stateService.getLoginURL()&&this.stateService.getLoginURL().includes("?")?"&":"?")+"redirect_url";window.location.href=this.stateService.getLoginURL()+(e?t+"="+e:"")}},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:g,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return g})]}]},{type:f,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return f})]}]},{type:a.ActivatedRoute}]},e}();var A=function(){function e(e,t){this.injector=e,this.platform=t}return e.prototype.intercept=function(e,t){var r=this;return t.handle(e).pipe(c.catchError(function(e){if(e instanceof i.HttpErrorResponse){if(403===e.status){r.stateService=r.injector.get(f);var t=void 0;o.isPlatformBrowser(r.platform)&&e.error&&"expired"===e.error.reason&&(t=window.location.href),r.authGuardService=r.injector.get(k),r.authGuardService.signOut(t)}return s.throwError(e)}}))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.Injector},{type:void 0,decorators:[{type:t.Inject,args:[t.PLATFORM_ID]}]}]},e}();var m=function(){function e(e){this.injector=e}return e.prototype.intercept=function(e,t){var o=this;return this.stateService=this.injector.get(f),t.handle(e).pipe(c.map(function(e){if(e.headers){var t=e.headers.get("x-access-token"),i=e.headers.get("x-id-token");t&&o.stateService.updateCookie("accessToken",t),i&&o.stateService.updateCookie("idToken",i)}return e}))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.Injector}]},e}();var v=function(){function e(e){this.stateService=e}return e.prototype.getAccessToken=function(){return this.tokenToObject(this.stateService.getAccessToken())},e.prototype.getIDToken=function(){return this.tokenToObject(this.stateService.getIDToken())},e.prototype.getAccountAccessToken=function(){return this.tokenToObject(this.stateService.getAccountAccessToken())},e.prototype.getVerdocsAccessToken=function(){return this.tokenToObject(this.stateService.getVerdocsAccessToken())},e.prototype.getProfile=function(){return this.getIDToken()?this.getIDToken()[e.TOKEN_NAMESPACE+"/profile"]:null},e.prototype.getPermissions=function(){return this.getAccessToken()?this.getAccessToken()[e.TOKEN_NAMESPACE+"/permissions"]:null},e.prototype.getAccountPermissions=function(){return this.getAccountAccessToken()?this.getAccountAccessToken()[e.TOKEN_NAMESPACE+"/permissions"]:null},e.prototype.getVerdocsPermissions=function(){return this.getVerdocsAccessToken()?this.getVerdocsAccessToken()[e.TOKEN_NAMESPACE+"/permissions"]:null},e.prototype.getPlans=function(){return this.getAccessToken()?this.getAccessToken()[e.TOKEN_NAMESPACE+"/plans"]:this.getAccountPlans()?this.getAccountPlans():this.getVerdocsPlans()?this.getVerdocsPlans():null},e.prototype.getOrganizationID=function(){return this.getAccountAccessToken()?this.getAccountAccessToken()[e.TOKEN_NAMESPACE+"/organization_id"]:null},e.prototype.getAccountPlans=function(){return this.getAccountAccessToken()?this.getAccountAccessToken()[e.TOKEN_NAMESPACE+"/plans"]:null},e.prototype.getVerdocsPlans=function(){return this.getVerdocsAccessToken()?this.getVerdocsAccessToken()[e.TOKEN_NAMESPACE+"/plans"]:null},e.prototype.getRoles=function(){return this.getAccessToken()?this.getAccessToken()[e.TOKEN_NAMESPACE+"/roles"]:this.getAccountRoles()?this.getAccountRoles():this.getVerdocsRoles()?this.getVerdocsRoles():null},e.prototype.getAccountRoles=function(){return this.getAccountAccessToken()?this.getAccountAccessToken()[e.TOKEN_NAMESPACE+"/roles"]:null},e.prototype.getVerdocsRoles=function(){return this.getVerdocsAccessToken()?this.getVerdocsAccessToken()[e.TOKEN_NAMESPACE+"/roles"]:null},e.prototype.getProfileID=function(){return this.getAccessToken()?this.getAccessToken()[e.TOKEN_NAMESPACE+"/profile_id"]:this.getAccountAccessToken()?this.getAccountAccessToken()[e.TOKEN_NAMESPACE+"/profile_id"]:this.getVerdocsAccessToken()?this.getVerdocsAccessToken()[e.TOKEN_NAMESPACE+"/profile_id"]:null},e.prototype.getUserID=function(){var e=(this.getAccessToken().sub||this.getAccountAccessToken().sub).indexOf("|")+1;return this.getAccessToken().sub.slice(e)},e.prototype.tokenToObject=function(e){if(e){var t=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(t))}return null},e.TOKEN_NAMESPACE="https://verdocs.com",e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:f}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(f))},token:e,providedIn:"root"}),e}();var E=function(){function e(e,t,o,i){this.dialogRef=e,this.vTokenAuthGuard=t,this.vTokenStateService=o,this.data=i}return e.prototype.ngOnInit=function(){var e=this;setInterval(function(){e.vTokenStateService.getEmailVerification()&&e.closeDialog()},1e4)},e.prototype.signOut=function(){this.vTokenAuthGuard.signOut(window.location.href)},e.prototype.resendEmailVerification=function(){this.data.resendEmailVerification()},e.prototype.closeDialog=function(){this.dialogRef.close()},e.decorators=[{type:t.Component,args:[{selector:"verdocs-verify-email-dialog.component",template:'<div class="verify-email__container">\n    <div class="verify-email__title">\n        Confirm your email address\n    </div>\n    <div class="verify-email__content">\n        We\'ve sent a confirmation email to you at:\n        <br>\n        <span class="verify-email__content-email">\n        {{data.emailAddress}}\n      </span>\n    </div>\n    <div class="verify-email__action">\n        <button mat-button class="verify-email__action-button" (click)="signOut()">LOGOUT</button>\n        <button mat-button class="verify-email__action-button" (click)="resendEmailVerification()">RESEND EMAIL</button>\n    </div>\n</div>\n',styles:[".verify-email__container{width:640px}@media only screen and (max-width:960px){.verify-email__container{width:auto}}.verify-email__title{padding:0 0 14px;color:rgba(0,0,0,.87);font-size:20px;font-weight:500}.verify-email__content{color:rgba(0,0,0,.54)}.verify-email__content-email{padding-top:32px;display:block}.verify-email__action{height:52px;padding-top:10.5px;margin:24px -24px -24px 0;text-align:right}.verify-email__action-button{color:#3f5894;text-transform:uppercase;margin-left:-8px}"]}]}],e.ctorParameters=function(){return[{type:u.MatDialogRef},{type:k,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return k})]}]},{type:f,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return f})]}]},{type:void 0,decorators:[{type:t.Inject,args:[u.MAT_DIALOG_DATA]}]}]},e}();var y=function(){function e(e,o,i,r,n){this.dialog=e,this.verdocsAuthGuard=o,this.verdocsStateService=i,this.verdocsAuthService=r,this.platform=n,this.verifyEmailDialogIsOpen=!1,this.idTokenSubscription=new s.Subscription,this.resendEmailVerificationEvent=new t.EventEmitter}return e.prototype.ngOnInit=function(){var e=this;this.idTokenSubscription=this.verdocsStateService.decodedIdTokenSubject.subscribe(function(t){e.emailAddress=t.email}),setInterval(function(){e.enforceAuthentication&&e.verdocsAuthGuard.checkAuthentication(),e.verdocsAuthService.isAuthenticated()&&e.checkEmailVerification()},5e3)},e.prototype.ngOnDestroy=function(){this.idTokenSubscription.unsubscribe()},e.prototype.checkEmailVerification=function(){var e=this;if(!this.verdocsStateService.getEmailVerification()&&!this.verifyEmailDialogIsOpen&&o.isPlatformBrowser(this.platform)){this.verifyEmailDialogIsOpen=!0;var t={resendEmailVerification:function(){return e.resendEmailVerification()},emailAddress:this.emailAddress};this.dialog.open(E,{data:t,disableClose:!0}).afterClosed().subscribe(function(){e.verifyEmailDialogIsOpen=!1,location.reload()})}},e.prototype.resendEmailVerification=function(){this.resendEmailVerificationEvent.emit()},e.decorators=[{type:t.Directive,args:[{selector:"[verdocs-guard]"}]}],e.ctorParameters=function(){return[{type:u.MatDialog},{type:k,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return k})]}]},{type:f,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return f})]}]},{type:g,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return g})]}]},{type:void 0,decorators:[{type:t.Inject,args:[t.PLATFORM_ID]}]}]},e.propDecorators={resendEmailVerificationEvent:[{type:t.Output}],enforceAuthentication:[{type:t.Input}]},e}();var T=new t.InjectionToken("VTokenConfig"),O=function(){function e(){}return e.initInterceptor=function(t){return{ngModule:e,providers:[{provide:T,useValue:t}]}},e.decorators=[{type:t.NgModule,args:[{imports:[r.CookieModule.forRoot(),u.MatButtonModule,u.MatDialogModule],declarations:[y,E],providers:[m,p,A,g,k,f,v],entryComponents:[E],exports:[y,E]}]}],e}();e.TokensModule=O,e.VTokenConfigToken=T,e.VerdocsAuthGuardService=k,e.VerdocsAuthService=g,e.VerdocsErrorInterceptor=A,e.VerdocsRequestInterceptor=p,e.VerdocsResponseInterceptor=m,e.VerdocsStateService=f,e.VerdocsTokenGuardDirective=y,e.VerdocsTokenObjectService=v,e.VerifyEmailDialogComponent=E,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=verdocs-tokens.umd.min.js.map