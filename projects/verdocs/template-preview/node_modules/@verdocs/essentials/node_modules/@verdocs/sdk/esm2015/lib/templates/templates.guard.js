/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerdocsTokenObjectService } from '@verdocs/tokens';
import { intersection } from 'lodash';
import { Injectable } from '@angular/core';
import { TemplateActions, TemplatePermissions, TemplateSenderTypes } from '../definitions/template.enums';
export class TemplatesGuardService {
    /**
     * @param {?} vTokenObjectService
     */
    constructor(vTokenObjectService) {
        this.vTokenObjectService = vTokenObjectService;
    }
    /**
     * @param {?} action
     * @param {?} template
     * @return {?}
     */
    canPerformAction(action, template) {
        try {
            /** @type {?} */
            let canPerform = false;
            /** @type {?} */
            let message = null;
            /** @type {?} */
            const neededPermissions = [];
            if (!template && !action.includes('create')) {
                throw {
                    error: 'You need to provide template object'
                };
            }
            /** @type {?} */
            const userProfile = this.vTokenObjectService.getProfile();
            /** @type {?} */
            const isCreator = userProfile ? template && template.profile_id === userProfile.id : false;
            /** @type {?} */
            const isSameOrg = userProfile ? template && template.organization_id === userProfile.organization_id : false;
            /** @type {?} */
            const isPersonal = template ? template.is_personal : null;
            /** @type {?} */
            const isPublic = template ? template.is_public : null;
            switch (action) {
                case TemplateActions.CREATE_PERSONAL:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                    break;
                case TemplateActions.CREATE_ORG:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                    break;
                case TemplateActions.CREATE_PUBLIC:
                    neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                    break;
                case TemplateActions.READ:
                    if (!isCreator) {
                        if ((!isPersonal && isSameOrg) || !isPublic) {
                            neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        }
                    }
                    break;
                case TemplateActions.WRITE:
                    if (!isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_READ);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_WRITE);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PERSONAL:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PERSONAL);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_ORG:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_ORG);
                        // neededPermission.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.CHANGE_VISIBILITY_PUBLIC:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_CREATE_PUBLIC);
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_VISIBILITY);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_VISIBILITY);
                    }
                    break;
                case TemplateActions.DELETE:
                    if (isCreator) {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_CREATOR_DELETE);
                    }
                    else {
                        neededPermissions.push(TemplatePermissions.TEMPLATE_MEMBER_DELETE);
                    }
                    break;
                default:
                    throw {
                        error: 'Action is not defined'
                    };
            }
            if (this.hasPermissions(neededPermissions)) {
                canPerform = true;
            }
            else {
                message = `Insufficient access to perform '${action}'. Needed permissions: ${neededPermissions.toString()}`;
            }
            return {
                canPerform,
                message
            };
        }
        catch (err) {
            console.error({
                message: `Failed to check whether action (${action}) can be done, in TemplateGuardService`,
                err: err
            });
        }
    }
    /**
     * @private
     * @param {?} requiredPermissions
     * @return {?}
     */
    hasPermissions(requiredPermissions) {
        /** @type {?} */
        const userPermissions = this.vTokenObjectService.getPermissions();
        /** @type {?} */
        const hasPermissions = intersection(userPermissions, requiredPermissions).length === requiredPermissions.length;
        return hasPermissions;
    }
    /**
     * @param {?} template
     * @return {?}
     */
    canBeSender(template) {
        /** @type {?} */
        const userProfile = this.vTokenObjectService.getProfile();
        if (!userProfile) {
            return false;
        }
        switch (template.sender) {
            case TemplateSenderTypes.CREATOR:
                return userProfile.id === template.profile_id;
            case TemplateSenderTypes.ORGANIZATION_MEMBER:
            case TemplateSenderTypes.ORGANIZATION_MEMBER_AS_CREATOR:
                return userProfile.id === template.profile_id || template.organization_id === userProfile.organization_id;
            default:
                return true;
        }
    }
    /**
     * @return {?}
     */
    canUserCreateTemplate() {
        return this.canPerformAction(TemplateActions.CREATE_PERSONAL, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_ORG, null)['canPerform']
            || this.canPerformAction(TemplateActions.CREATE_PUBLIC, null)['canPerform'];
    }
}
TemplatesGuardService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
TemplatesGuardService.ctorParameters = () => [
    { type: VerdocsTokenObjectService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    TemplatesGuardService.prototype.vTokenObjectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLmd1YXJkLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL3RlbXBsYXRlcy90ZW1wbGF0ZXMuZ3VhcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFJMUcsTUFBTSxPQUFPLHFCQUFxQjs7OztJQUdoQyxZQUNVLG1CQUE4QztRQUE5Qyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTJCO0lBQ3BELENBQUM7Ozs7OztJQUdFLGdCQUFnQixDQUFDLE1BQXVCLEVBQUUsUUFBbUI7UUFDbEUsSUFBSTs7Z0JBQ0UsVUFBVSxHQUFHLEtBQUs7O2dCQUNsQixPQUFPLEdBQUcsSUFBSTs7a0JBQ1osaUJBQWlCLEdBQUcsRUFBRTtZQUM1QixJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDM0MsTUFBTTtvQkFDSixLQUFLLEVBQ0gscUNBQXFDO2lCQUN4QyxDQUFBO2FBQ0Y7O2tCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFOztrQkFDbkQsU0FBUyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSzs7a0JBQ3BGLFNBQVMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsZUFBZSxLQUFLLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEtBQUs7O2tCQUN0RyxVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJOztrQkFDbkQsUUFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUNyRCxRQUFRLE1BQU0sRUFBRTtnQkFDZCxLQUFLLGVBQWUsQ0FBQyxlQUFlO29CQUNsQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0NBQWdDLENBQUMsQ0FBQTtvQkFDNUUsTUFBTTtnQkFDUixLQUFLLGVBQWUsQ0FBQyxVQUFVO29CQUM3QixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsMkJBQTJCLENBQUMsQ0FBQztvQkFDeEUsTUFBTTtnQkFDUixLQUFLLGVBQWUsQ0FBQyxhQUFhO29CQUNoQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsOEJBQThCLENBQUMsQ0FBQTtvQkFDMUUsTUFBTTtnQkFDUixLQUFLLGVBQWUsQ0FBQyxJQUFJO29CQUN2QixJQUFJLENBQUMsU0FBUyxFQUFFO3dCQUNkLElBQUksQ0FBQyxDQUFDLFVBQVUsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTs0QkFDM0MsaUJBQWlCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLG9CQUFvQixDQUFDLENBQUM7eUJBQ2xFO3FCQUNGO29CQUNELE1BQU07Z0JBQ1IsS0FBSyxlQUFlLENBQUMsS0FBSztvQkFDeEIsSUFBSSxDQUFDLFNBQVMsRUFBRTt3QkFDZCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsb0JBQW9CLENBQUMsQ0FBQzt3QkFDakUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLHFCQUFxQixDQUFDLENBQUM7cUJBQ25FO29CQUNELE1BQU07Z0JBQ1IsS0FBSyxlQUFlLENBQUMsMEJBQTBCO29CQUM3QyxJQUFJLFNBQVMsRUFBRTt3QkFDYixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzt3QkFDN0UsMEVBQTBFO3FCQUMzRTt5QkFBTTt3QkFDTCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsMEJBQTBCLENBQUMsQ0FBQztxQkFDeEU7b0JBQ0QsTUFBTTtnQkFDUixLQUFLLGVBQWUsQ0FBQyxxQkFBcUI7b0JBQ3hDLElBQUksU0FBUyxFQUFFO3dCQUNiLGlCQUFpQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO3dCQUN4RSwwRUFBMEU7cUJBQzNFO3lCQUFNO3dCQUNMLGlCQUFpQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO3FCQUN4RTtvQkFDRCxNQUFNO2dCQUNSLEtBQUssZUFBZSxDQUFDLHdCQUF3QjtvQkFDM0MsSUFBSSxTQUFTLEVBQUU7d0JBQ2IsaUJBQWlCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLDhCQUE4QixDQUFDLENBQUM7d0JBQzNFLGlCQUFpQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO3FCQUN6RTt5QkFBTTt3QkFDTCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsMEJBQTBCLENBQUMsQ0FBQztxQkFDeEU7b0JBQ0QsTUFBTTtnQkFDUixLQUFLLGVBQWUsQ0FBQyxNQUFNO29CQUN6QixJQUFJLFNBQVMsRUFBRTt3QkFDYixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsdUJBQXVCLENBQUMsQ0FBQztxQkFDckU7eUJBQU07d0JBQ0wsaUJBQWlCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLHNCQUFzQixDQUFDLENBQUM7cUJBQ3BFO29CQUNELE1BQU07Z0JBQ1I7b0JBQ0UsTUFBTTt3QkFDSixLQUFLLEVBQUUsdUJBQXVCO3FCQUMvQixDQUFBO2FBQ0o7WUFDRCxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsRUFBRTtnQkFDMUMsVUFBVSxHQUFHLElBQUksQ0FBQzthQUNuQjtpQkFBTTtnQkFDTCxPQUFPLEdBQUcsbUNBQW1DLE1BQU0sMEJBQTBCLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUM7YUFDN0c7WUFDRCxPQUFPO2dCQUNMLFVBQVU7Z0JBQ1YsT0FBTzthQUNSLENBQUE7U0FDRjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQztnQkFDWixPQUFPLEVBQUUsbUNBQW1DLE1BQU0sd0NBQXdDO2dCQUMxRixHQUFHLEVBQUUsR0FBRzthQUNULENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7Ozs7O0lBRU8sY0FBYyxDQUFDLG1CQUE2Qjs7Y0FDNUMsZUFBZSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLEVBQUU7O2NBQzNELGNBQWMsR0FBRyxZQUFZLENBQUMsZUFBZSxFQUFFLG1CQUFtQixDQUFDLENBQUMsTUFBTSxLQUFLLG1CQUFtQixDQUFDLE1BQU07UUFDL0csT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQzs7Ozs7SUFFTSxXQUFXLENBQUMsUUFBUTs7Y0FDbkIsV0FBVyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLEVBQUU7UUFDekQsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNoQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsUUFBUSxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLEtBQUssbUJBQW1CLENBQUMsT0FBTztnQkFDOUIsT0FBTyxXQUFXLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxVQUFVLENBQUM7WUFDaEQsS0FBSyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQztZQUM3QyxLQUFLLG1CQUFtQixDQUFDLDhCQUE4QjtnQkFDckQsT0FBTyxXQUFXLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxVQUFVLElBQUksUUFBUSxDQUFDLGVBQWUsS0FBSyxXQUFXLENBQUMsZUFBZSxDQUFDO1lBQzVHO2dCQUNFLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7SUFDSCxDQUFDOzs7O0lBRUQscUJBQXFCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDO2VBQzVFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQztlQUNyRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUMvRSxDQUFDOzs7WUEvSEYsVUFBVTs7OztZQVBGLHlCQUF5Qjs7Ozs7OztJQVk5QixvREFBc0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWZXJkb2NzVG9rZW5PYmplY3RTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvdG9rZW5zJztcbmltcG9ydCB7IGludGVyc2VjdGlvbiB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRlbXBsYXRlQWN0aW9ucywgVGVtcGxhdGVQZXJtaXNzaW9ucywgVGVtcGxhdGVTZW5kZXJUeXBlcyB9IGZyb20gJy4uL2RlZmluaXRpb25zL3RlbXBsYXRlLmVudW1zJztcbmltcG9ydCB7IElUZW1wbGF0ZSB9IGZyb20gJy4uL21vZGVscy90ZW1wbGF0ZS5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZXNHdWFyZFNlcnZpY2Uge1xuXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2VG9rZW5PYmplY3RTZXJ2aWNlOiBWZXJkb2NzVG9rZW5PYmplY3RTZXJ2aWNlXG4gICkgeyB9XG5cblxuICBwdWJsaWMgY2FuUGVyZm9ybUFjdGlvbihhY3Rpb246IFRlbXBsYXRlQWN0aW9ucywgdGVtcGxhdGU6IElUZW1wbGF0ZSk6IHsgY2FuUGVyZm9ybTogYm9vbGVhbiwgbWVzc2FnZTogc3RyaW5nIH0ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgY2FuUGVyZm9ybSA9IGZhbHNlO1xuICAgICAgbGV0IG1lc3NhZ2UgPSBudWxsO1xuICAgICAgY29uc3QgbmVlZGVkUGVybWlzc2lvbnMgPSBbXTtcbiAgICAgIGlmICghdGVtcGxhdGUgJiYgIWFjdGlvbi5pbmNsdWRlcygnY3JlYXRlJykpIHtcbiAgICAgICAgdGhyb3cge1xuICAgICAgICAgIGVycm9yOlxuICAgICAgICAgICAgJ1lvdSBuZWVkIHRvIHByb3ZpZGUgdGVtcGxhdGUgb2JqZWN0J1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCB1c2VyUHJvZmlsZSA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQcm9maWxlKCk7XG4gICAgICBjb25zdCBpc0NyZWF0b3IgPSB1c2VyUHJvZmlsZSA/IHRlbXBsYXRlICYmIHRlbXBsYXRlLnByb2ZpbGVfaWQgPT09IHVzZXJQcm9maWxlLmlkIDogZmFsc2U7XG4gICAgICBjb25zdCBpc1NhbWVPcmcgPSB1c2VyUHJvZmlsZSA/IHRlbXBsYXRlICYmIHRlbXBsYXRlLm9yZ2FuaXphdGlvbl9pZCA9PT0gdXNlclByb2ZpbGUub3JnYW5pemF0aW9uX2lkIDogZmFsc2U7XG4gICAgICBjb25zdCBpc1BlcnNvbmFsID0gdGVtcGxhdGUgPyB0ZW1wbGF0ZS5pc19wZXJzb25hbCA6IG51bGw7XG4gICAgICBjb25zdCBpc1B1YmxpYyA9IHRlbXBsYXRlID8gdGVtcGxhdGUuaXNfcHVibGljIDogbnVsbDtcbiAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QRVJTT05BTDpcbiAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUEVSU09OQUwpXG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9PUkc6XG4gICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX09SRyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QVUJMSUM6XG4gICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX0NSRUFUT1JfQ1JFQVRFX1BVQkxJQylcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuUkVBRDpcbiAgICAgICAgICBpZiAoIWlzQ3JlYXRvcikge1xuICAgICAgICAgICAgaWYgKCghaXNQZXJzb25hbCAmJiBpc1NhbWVPcmcpIHx8ICFpc1B1YmxpYykge1xuICAgICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1JFQUQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuV1JJVEU6XG4gICAgICAgICAgaWYgKCFpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfUkVBRCk7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1dSSVRFKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNIQU5HRV9WSVNJQklMSVRZX1BFUlNPTkFMOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9QRVJTT05BTCk7XG4gICAgICAgICAgICAvLyBuZWVkZWRQZXJtaXNzaW9uLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuQ0hBTkdFX1ZJU0lCSUxJVFlfT1JHOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0NSRUFURV9PUkcpO1xuICAgICAgICAgICAgLy8gbmVlZGVkUGVybWlzc2lvbi5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmVlZGVkUGVybWlzc2lvbnMucHVzaChUZW1wbGF0ZVBlcm1pc3Npb25zLlRFTVBMQVRFX01FTUJFUl9WSVNJQklMSVRZKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVGVtcGxhdGVBY3Rpb25zLkNIQU5HRV9WSVNJQklMSVRZX1BVQkxJQzpcbiAgICAgICAgICBpZiAoaXNDcmVhdG9yKSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfQ1JFQVRPUl9DUkVBVEVfUFVCTElDKTtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZWVkZWRQZXJtaXNzaW9ucy5wdXNoKFRlbXBsYXRlUGVybWlzc2lvbnMuVEVNUExBVEVfTUVNQkVSX1ZJU0lCSUxJVFkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUZW1wbGF0ZUFjdGlvbnMuREVMRVRFOlxuICAgICAgICAgIGlmIChpc0NyZWF0b3IpIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9DUkVBVE9SX0RFTEVURSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRlZFBlcm1pc3Npb25zLnB1c2goVGVtcGxhdGVQZXJtaXNzaW9ucy5URU1QTEFURV9NRU1CRVJfREVMRVRFKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cge1xuICAgICAgICAgICAgZXJyb3I6ICdBY3Rpb24gaXMgbm90IGRlZmluZWQnXG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuaGFzUGVybWlzc2lvbnMobmVlZGVkUGVybWlzc2lvbnMpKSB7XG4gICAgICAgIGNhblBlcmZvcm0gPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IGBJbnN1ZmZpY2llbnQgYWNjZXNzIHRvIHBlcmZvcm0gJyR7YWN0aW9ufScuIE5lZWRlZCBwZXJtaXNzaW9uczogJHtuZWVkZWRQZXJtaXNzaW9ucy50b1N0cmluZygpfWA7XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjYW5QZXJmb3JtLFxuICAgICAgICBtZXNzYWdlXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKHtcbiAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byBjaGVjayB3aGV0aGVyIGFjdGlvbiAoJHthY3Rpb259KSBjYW4gYmUgZG9uZSwgaW4gVGVtcGxhdGVHdWFyZFNlcnZpY2VgLFxuICAgICAgICBlcnI6IGVyclxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNQZXJtaXNzaW9ucyhyZXF1aXJlZFBlcm1pc3Npb25zOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQZXJtaXNzaW9ucygpO1xuICAgIGNvbnN0IGhhc1Blcm1pc3Npb25zID0gaW50ZXJzZWN0aW9uKHVzZXJQZXJtaXNzaW9ucywgcmVxdWlyZWRQZXJtaXNzaW9ucykubGVuZ3RoID09PSByZXF1aXJlZFBlcm1pc3Npb25zLmxlbmd0aDtcbiAgICByZXR1cm4gaGFzUGVybWlzc2lvbnM7XG4gIH1cblxuICBwdWJsaWMgY2FuQmVTZW5kZXIodGVtcGxhdGUpOiBib29sZWFuIHtcbiAgICBjb25zdCB1c2VyUHJvZmlsZSA9IHRoaXMudlRva2VuT2JqZWN0U2VydmljZS5nZXRQcm9maWxlKCk7XG4gICAgaWYgKCF1c2VyUHJvZmlsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBzd2l0Y2ggKHRlbXBsYXRlLnNlbmRlcikge1xuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLkNSRUFUT1I6XG4gICAgICAgIHJldHVybiB1c2VyUHJvZmlsZS5pZCA9PT0gdGVtcGxhdGUucHJvZmlsZV9pZDtcbiAgICAgIGNhc2UgVGVtcGxhdGVTZW5kZXJUeXBlcy5PUkdBTklaQVRJT05fTUVNQkVSOlxuICAgICAgY2FzZSBUZW1wbGF0ZVNlbmRlclR5cGVzLk9SR0FOSVpBVElPTl9NRU1CRVJfQVNfQ1JFQVRPUjpcbiAgICAgICAgcmV0dXJuIHVzZXJQcm9maWxlLmlkID09PSB0ZW1wbGF0ZS5wcm9maWxlX2lkIHx8IHRlbXBsYXRlLm9yZ2FuaXphdGlvbl9pZCA9PT0gdXNlclByb2ZpbGUub3JnYW5pemF0aW9uX2lkO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgY2FuVXNlckNyZWF0ZVRlbXBsYXRlKCkge1xuICAgIHJldHVybiB0aGlzLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QRVJTT05BTCwgbnVsbClbJ2NhblBlcmZvcm0nXVxuICAgICAgfHwgdGhpcy5jYW5QZXJmb3JtQWN0aW9uKFRlbXBsYXRlQWN0aW9ucy5DUkVBVEVfT1JHLCBudWxsKVsnY2FuUGVyZm9ybSddXG4gICAgICB8fCB0aGlzLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLkNSRUFURV9QVUJMSUMsIG51bGwpWydjYW5QZXJmb3JtJ11cbiAgfVxuXG59XG4iXX0=