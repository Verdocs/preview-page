/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpRequest } from '@angular/common/http';
import { DocumentsService, FieldData } from '@verdocs/sdk';
import { VerdocsStateService } from '@verdocs/tokens';
import { BehaviorSubject, ReplaySubject } from 'rxjs';
import { EssentialsConfigToken } from '../essentials.module';
import { dataURLtoBlob } from '../functions/utils';
export class SignatureService {
    /**
     * @param {?} httpClient
     * @param {?} injector
     * @param {?} envelopeSvc
     * @param {?} vTokenStateService
     */
    constructor(httpClient, injector, envelopeSvc, vTokenStateService) {
        this.httpClient = httpClient;
        this.injector = injector;
        this.envelopeSvc = envelopeSvc;
        this.vTokenStateService = vTokenStateService;
        this.workingField = new FieldData({ order: 0, fName: '' });
        this.fields = [];
        this._total = -1;
        this._fields = new ReplaySubject();
        this._recipient = new ReplaySubject();
        this._showSig = new ReplaySubject();
        this._signedFields = new BehaviorSubject({});
        this._envId = new ReplaySubject();
        this._rName = new ReplaySubject();
        this.signImgSubject = new ReplaySubject();
        this.initialImgSubject = new ReplaySubject();
        this.initialIdSubject = new ReplaySubject();
        this.signatureIdSubject = new ReplaySubject();
        this.signedFields = {};
        this.mode = '';
        this._config_token = this.injector.get(EssentialsConfigToken);
        this._rForm_backend_url = this._config_token.rForm_backend_url;
        this.envUrl = `${this._rForm_backend_url}/envelopes`;
    }
    /**
     * @param {?} payment
     * @return {?}
     */
    setWorkingPayment(payment) {
        this.workingPayment = payment;
    }
    /**
     * @param {?} fields
     * @return {?}
     */
    updateFields(fields) {
        this.fields = fields;
        this._fields.next(this.fields);
    }
    /**
     * @return {?}
     */
    postSignatureBlob() {
        /** @type {?} */
        const blobFile = this.signatureBlob;
        /** @type {?} */
        const formData = new FormData();
        formData.append('signature', blobFile, blobFile['name']);
        /** @type {?} */
        const request = new HttpRequest('POST', this._rForm_backend_url + '/signatures', formData);
        return this.httpClient.request(request)
            .toPromise()
            .then((/**
         * @param {?} response
         * @return {?}
         */
        response => {
            if (response && response['body']) {
                return response['body'];
            }
            else {
                console.error('Failed to upload signature image');
            }
        }));
    }
    /**
     * @return {?}
     */
    postInitialBlob() {
        /** @type {?} */
        const blobFile = this.initialBlob;
        /** @type {?} */
        const formData = new FormData();
        formData.append('initial', blobFile, blobFile['name']);
        /** @type {?} */
        const request = new HttpRequest('POST', this._rForm_backend_url + '/initials', formData);
        return this.httpClient.request(request)
            .toPromise()
            .then((/**
         * @param {?} response
         * @return {?}
         */
        response => {
            if (response && response['body']) {
                return response['body'];
            }
            else {
                console.error('Failed to upload Initial');
            }
        }));
    }
    /**
     * @param {?} bool
     * @return {?}
     */
    toggleSig(bool) {
        this._showSig.next(bool);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    setSigId(id) {
        this.signatureId = id;
        this.signatureIdSubject.next(id);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    setInitialId(id) {
        this.initialId = id;
        this.initialIdSubject.next(id);
    }
    /**
     * @param {?} url
     * @return {?}
     */
    setSignImg(url) {
        this.signImg = url;
        this.signImgSubject.next(this.signImg);
    }
    /**
     * @return {?}
     */
    getSignImg() {
        return this.signImg;
    }
    /**
     * @param {?} url
     * @return {?}
     */
    setInitialImg(url) {
        this.initialImg = url;
        this.initialImgSubject.next(this.initialImg);
    }
    /**
     * @return {?}
     */
    getInitialImg() {
        return this.initialImg;
    }
    /**
     * @param {?} envelopeId
     * @param {?} fieldName
     * @param {?} signatureId
     * @return {?}
     */
    putSignatureField(envelopeId, fieldName, signatureId) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const ipAddress = yield this.getPublicIp();
            this.httpClient
                .put(this.envUrl + `/${envelopeId}/fields/${fieldName}/signature/${signatureId}`, {
                ip_address: ipAddress
            }).toPromise().then((/**
             * @param {?} res
             * @return {?}
             */
            res => {
                return resolve(res);
            }));
        })));
    }
    /**
     * @param {?} envelopeId
     * @param {?} fieldName
     * @param {?} initialId
     * @return {?}
     */
    putInitialField(envelopeId, fieldName, initialId) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const ipAddress = yield this.getPublicIp();
            this.httpClient
                .put(this.envUrl + `/${envelopeId}/fields/${fieldName}/initial/${initialId}`, {
                ip_address: ipAddress
            }).toPromise().then((/**
             * @param {?} res
             * @return {?}
             */
            res => {
                return resolve(res);
            }));
        })));
    }
    // refactor it to 4 functions
    /**
     * @param {?} envelopeId
     * @param {?=} ifPrepared
     * @return {?}
     */
    updateEnvelopeField(envelopeId, ifPrepared) {
        if (this.workingField && this.workingField.type) {
            /** @type {?} */
            const result = this.getEnvelopeFieldValue(ifPrepared);
            this.putEnvelopeField(envelopeId, result);
        }
    }
    /**
     * @param {?=} isPrepared
     * @return {?}
     */
    getEnvelopeFieldValue(isPrepared) {
        if (this.workingField && this.workingField.type) {
            /** @type {?} */
            const result = {
                value: ''
            };
            if (typeof (isPrepared) === 'boolean') {
                result['prepared'] = isPrepared;
            }
            switch (this.workingField.type.toLowerCase()) {
                case 'textbox':
                case 'checkbox':
                case 'date':
                    result.value = this.workingField.value;
                    break;
                default:
                    break;
            }
            return result;
        }
        return null;
    }
    /**
     * @param {?} envelopeId
     * @param {?} result
     * @return {?}
     */
    putEnvelopeField(envelopeId, result) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.httpClient
                .put(this.envUrl + `/${envelopeId}/fields/${this.workingField.fName}`, result).toPromise().then((/**
             * @param {?} res
             * @return {?}
             */
            res => {
                return resolve(res);
            }));
        }));
    }
    /**
     * @param {?} envelopeId
     * @param {?} body
     * @param {?} fieldName
     * @param {?=} ifPrepared
     * @return {?}
     */
    updateGroupedField(envelopeId, body, fieldName, ifPrepared) {
        if (typeof (ifPrepared) === 'boolean') {
            body['prepared'] = ifPrepared;
        }
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.httpClient
                .put(this.envUrl + `/${envelopeId}/fields/${fieldName}`, body).toPromise().then((/**
             * @param {?} res
             * @return {?}
             */
            res => {
                return resolve(res);
            }));
        }));
    }
    /**
     * @param {?} envelopeId
     * @param {?} setPrepared
     * @return {?}
     */
    prepareEnvelopeField(envelopeId, setPrepared) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.workingField && this.workingField.type) {
                /** @type {?} */
                const fieldType = this.workingField.type.toLowerCase();
                if (fieldType !== 'textbox' && fieldType !== 'date' && fieldType !== 'checkbox') {
                    return false;
                }
                else {
                    /** @type {?} */
                    const fieldResponse = yield this.updateEnvelopeField(envelopeId, setPrepared);
                    if (fieldResponse) {
                        return fieldResponse.prepared;
                    }
                }
            }
            return false;
        });
    }
    /**
     * @private
     * @return {?}
     */
    getPublicIp() {
        /** @type {?} */
        const apiUrl = 'https://api.ipify.org?format=jsonp';
        /** @type {?} */
        const callback = 'callback=JSONP_CALLBACK';
        return this.httpClient
            .jsonp(apiUrl, callback)
            .toPromise()
            .then((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            return res['ip'];
        })).catch((/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            console.error('Failed to get ip', err);
            return 'ip_unavailable';
        }));
    }
    /**
     * @param {?} fName
     * @param {?} result
     * @param {?} vName
     * @param {?} pageNum
     * @param {?} id
     * @param {?} required
     * @param {?} order
     * @param {?} type
     * @return {?}
     */
    updateCurrentField(fName, result, vName, pageNum, id, required, order, type) {
        this.workingField.fName = fName;
        this.workingField.value = result;
        this.workingField.pageNum = pageNum;
        this.workingField.id = id;
        this.workingField.vName = vName;
        this.workingField.required = required;
        this.workingField.order = order;
        this.workingField.type = type;
    }
    /**
     * @param {?} fields
     * @return {?}
     */
    setCurrentFields(fields) {
        this.currentFields = fields;
    }
    /**
     * @return {?}
     */
    get currField() {
        return this.workingField;
    }
    /**
     * @param {?} pageNum
     * @param {?} id
     * @return {?}
     */
    errorMessages(pageNum, id) {
        return this.currentFields[pageNum][id]['error'];
    }
    /**
     * @param {?} id
     * @return {?}
     */
    setEnvId(id) {
        this._envId.next(id);
    }
    /**
     * @param {?} role
     * @return {?}
     */
    setrName(role) {
        this.rName = role;
        this._rName.next(role);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    getSignatureUrl(data) {
        if (data) {
            /** @type {?} */
            const blob = dataURLtoBlob(data);
            /** @type {?} */
            const url = URL.createObjectURL(blob);
            return url;
        }
        return null;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    setSignatureData(data) {
        /** @type {?} */
        const blob = dataURLtoBlob(data);
        /** @type {?} */
        const url = URL.createObjectURL(blob);
        this.signatureBlob = blob;
        this.setSignImg(url);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    setInitialData(data) {
        /** @type {?} */
        const blob = dataURLtoBlob(data);
        /** @type {?} */
        const url = URL.createObjectURL(blob);
        this.initialBlob = blob;
        this.setInitialImg(url);
    }
    /**
     * @param {?} fName
     * @param {?} result
     * @return {?}
     */
    updateSigned(fName, result) {
        this.workingField['value'] = 'signed';
        this.signedFields[fName] = result;
        this._signedFields.next(this.signedFields);
    }
    /**
     * @param {?} fName
     * @param {?} result
     * @return {?}
     */
    updateInitialed(fName, result) {
        this.workingField['value'] = 'initialed';
        this.signedFields[fName] = result;
        this._signedFields.next(this.signedFields);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    setSignatureId(id) {
        this.signatureId = id;
        this.signatureIdSubject.next(id);
    }
    /**
     * @param {?} recipient
     * @return {?}
     */
    setRecipient(recipient) {
        this._recipient.next(recipient);
    }
    /**
     * @param {?} t
     * @return {?}
     */
    setTotal(t) {
        this._total = t;
    }
}
SignatureService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SignatureService.ctorParameters = () => [
    { type: HttpClient },
    { type: Injector },
    { type: DocumentsService },
    { type: VerdocsStateService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.signatureId;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.initialId;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype._rForm_backend_url;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.envUrl;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.currentFields;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.workingField;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.signatureBlob;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.initialBlob;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.fields;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype._total;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.initialImg;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.workingPayment;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.rName;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.recipients;
    /** @type {?} */
    SignatureService.prototype._fields;
    /** @type {?} */
    SignatureService.prototype._recipient;
    /** @type {?} */
    SignatureService.prototype._showSig;
    /** @type {?} */
    SignatureService.prototype._signedFields;
    /** @type {?} */
    SignatureService.prototype._envId;
    /** @type {?} */
    SignatureService.prototype._rName;
    /** @type {?} */
    SignatureService.prototype.signImgSubject;
    /** @type {?} */
    SignatureService.prototype.initialImgSubject;
    /** @type {?} */
    SignatureService.prototype.initialIdSubject;
    /** @type {?} */
    SignatureService.prototype.signatureIdSubject;
    /** @type {?} */
    SignatureService.prototype.signedFields;
    /** @type {?} */
    SignatureService.prototype.signImg;
    /** @type {?} */
    SignatureService.prototype.mode;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.envelopeSvc;
    /**
     * @type {?}
     * @private
     */
    SignatureService.prototype.vTokenStateService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52ZWxvcGUtc2lnbmF0dXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdmVyZG9jcy9lc3NlbnRpYWxzLyIsInNvdXJjZXMiOlsibGliL2ZpZWxkcy9lbnZlbG9wZS1zaWduYXR1cmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMzRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV0RCxPQUFPLEVBQW9CLHFCQUFxQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR25ELE1BQU0sT0FBTyxnQkFBZ0I7Ozs7Ozs7SUErQjNCLFlBQ1UsVUFBc0IsRUFDdEIsUUFBa0IsRUFDbEIsV0FBNkIsRUFDN0Isa0JBQXVDO1FBSHZDLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixnQkFBVyxHQUFYLFdBQVcsQ0FBa0I7UUFDN0IsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFxQjtRQTVCekMsaUJBQVksR0FBbUIsSUFBSSxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBR3RFLFdBQU0sR0FBVSxFQUFFLENBQUM7UUFDbkIsV0FBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBTWIsWUFBTyxHQUFHLElBQUksYUFBYSxFQUFTLENBQUM7UUFDckMs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QUEwQjs7Ozs7SUFDMUIsa0NBQTJCOzs7OztJQUMzQixrQ0FBb0I7Ozs7O0lBQ3BCLHNDQUF3Qjs7Ozs7SUFDeEIsMENBQTRCOzs7OztJQUM1QixpQ0FBc0I7Ozs7O0lBQ3RCLHNDQUEwQjs7SUFFMUIsbUNBQTRDOztJQUM1QyxzQ0FBZ0Q7O0lBQ2hELG9DQUErQzs7SUFDL0MseUNBQW9EOztJQUNwRCxrQ0FBNEM7O0lBQzVDLGtDQUE0Qzs7SUFDNUMsMENBQWlEOztJQUNqRCw2Q0FBb0Q7O0lBQ3BELDRDQUFzRDs7SUFDdEQsOENBQXdEOztJQUN4RCx3Q0FBOEI7O0lBQzlCLG1DQUFvQjs7SUFDcEIsZ0NBQWlCOzs7OztJQUdmLHNDQUE4Qjs7Ozs7SUFDOUIsb0NBQTBCOzs7OztJQUMxQix1Q0FBcUM7Ozs7O0lBQ3JDLDhDQUErQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IERvY3VtZW50c1NlcnZpY2UsIEZpZWxkRGF0YSB9IGZyb20gJ0B2ZXJkb2NzL3Nkayc7XG5pbXBvcnQgeyBWZXJkb2NzU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvdG9rZW5zJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBFc3NlbnRpYWxzQ29uZmlnLCBFc3NlbnRpYWxzQ29uZmlnVG9rZW4gfSBmcm9tICcuLi9lc3NlbnRpYWxzLm1vZHVsZSc7XG5pbXBvcnQgeyBkYXRhVVJMdG9CbG9iIH0gZnJvbSAnLi4vZnVuY3Rpb25zL3V0aWxzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNpZ25hdHVyZVNlcnZpY2Uge1xuICBwcml2YXRlIF9jb25maWdfdG9rZW46IEVzc2VudGlhbHNDb25maWc7XG4gIHByaXZhdGUgc2lnbmF0dXJlSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBpbml0aWFsSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBfckZvcm1fYmFja2VuZF91cmw6IHN0cmluZztcbiAgcHJpdmF0ZSBlbnZVcmw6IHN0cmluZztcbiAgcHJpdmF0ZSBjdXJyZW50RmllbGRzOiBhbnlbXTtcbiAgcHJpdmF0ZSB3b3JraW5nRmllbGQ6IEZpZWxkRGF0YTxhbnk+ID0gbmV3IEZpZWxkRGF0YSh7IG9yZGVyOiAwLCBmTmFtZTogJycgfSk7XG4gIHByaXZhdGUgc2lnbmF0dXJlQmxvYjogQmxvYjtcbiAgcHJpdmF0ZSBpbml0aWFsQmxvYjogQmxvYjtcbiAgcHJpdmF0ZSBmaWVsZHM6IGFueVtdID0gW107XG4gIHByaXZhdGUgX3RvdGFsID0gLTE7XG4gIHByaXZhdGUgaW5pdGlhbEltZzogYW55O1xuICBwcml2YXRlIHdvcmtpbmdQYXltZW50OiBhbnk7XG4gIHByaXZhdGUgck5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWNpcGllbnRzOiBhbnlbXTtcblxuICBwdWJsaWMgX2ZpZWxkcyA9IG5ldyBSZXBsYXlTdWJqZWN0PGFueVtdPigpO1xuICBwdWJsaWMgX3JlY2lwaWVudCA9IG5ldyBSZXBsYXlTdWJqZWN0PHN0cmluZz4oKTtcbiAgcHVibGljIF9zaG93U2lnID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgcHVibGljIF9zaWduZWRGaWVsZHMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe30pO1xuICBwdWJsaWMgX2VudklkID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nPigpO1xuICBwdWJsaWMgX3JOYW1lID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nPigpO1xuICBwdWJsaWMgc2lnbkltZ1N1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxhbnk+KCk7XG4gIHB1YmxpYyBpbml0aWFsSW1nU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PGFueT4oKTtcbiAgcHVibGljIGluaXRpYWxJZFN1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBzaWduYXR1cmVJZFN1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBzaWduZWRGaWVsZHM6IGFueSA9IHt9O1xuICBwdWJsaWMgc2lnbkltZzogYW55O1xuICBwdWJsaWMgbW9kZSA9ICcnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcml2YXRlIGVudmVsb3BlU3ZjOiBEb2N1bWVudHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdlRva2VuU3RhdGVTZXJ2aWNlOiBWZXJkb2NzU3RhdGVTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuX2NvbmZpZ190b2tlbiA9IHRoaXMuaW5qZWN0b3IuZ2V0KEVzc2VudGlhbHNDb25maWdUb2tlbik7XG4gICAgdGhpcy5fckZvcm1fYmFja2VuZF91cmwgPSB0aGlzLl9jb25maWdfdG9rZW4uckZvcm1fYmFja2VuZF91cmw7XG4gICAgdGhpcy5lbnZVcmwgPSBgJHt0aGlzLl9yRm9ybV9iYWNrZW5kX3VybH0vZW52ZWxvcGVzYFxuICB9XG5cbiAgc2V0V29ya2luZ1BheW1lbnQocGF5bWVudDogYW55KSB7XG4gICAgdGhpcy53b3JraW5nUGF5bWVudCA9IHBheW1lbnQ7XG4gIH1cblxuICB1cGRhdGVGaWVsZHMoZmllbGRzOiBhbnlbXSk6IHZvaWQge1xuICAgIHRoaXMuZmllbGRzID0gZmllbGRzO1xuICAgIHRoaXMuX2ZpZWxkcy5uZXh0KHRoaXMuZmllbGRzKTtcbiAgfVxuXG4gIHBvc3RTaWduYXR1cmVCbG9iKCkge1xuICAgIGNvbnN0IGJsb2JGaWxlID0gdGhpcy5zaWduYXR1cmVCbG9iO1xuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdzaWduYXR1cmUnLCBibG9iRmlsZSwgYmxvYkZpbGVbJ25hbWUnXSk7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIHRoaXMuX3JGb3JtX2JhY2tlbmRfdXJsICsgJy9zaWduYXR1cmVzJywgZm9ybURhdGEpO1xuICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucmVxdWVzdChyZXF1ZXN0KVxuICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZVsnYm9keSddKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlWydib2R5J107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHVwbG9hZCBzaWduYXR1cmUgaW1hZ2UnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBwb3N0SW5pdGlhbEJsb2IoKSB7XG4gICAgY29uc3QgYmxvYkZpbGUgPSB0aGlzLmluaXRpYWxCbG9iO1xuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdpbml0aWFsJywgYmxvYkZpbGUsIGJsb2JGaWxlWyduYW1lJ10pO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3QoJ1BPU1QnLCB0aGlzLl9yRm9ybV9iYWNrZW5kX3VybCArICcvaW5pdGlhbHMnLCBmb3JtRGF0YSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5yZXF1ZXN0KHJlcXVlc3QpXG4gICAgICAudG9Qcm9taXNlKClcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlWydib2R5J10pIHtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2VbJ2JvZHknXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gdXBsb2FkIEluaXRpYWwnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB0b2dnbGVTaWcoYm9vbCk6IHZvaWQge1xuICAgIHRoaXMuX3Nob3dTaWcubmV4dChib29sKTtcbiAgfVxuXG4gIHNldFNpZ0lkKGlkKTogdm9pZCB7XG4gICAgdGhpcy5zaWduYXR1cmVJZCA9IGlkO1xuICAgIHRoaXMuc2lnbmF0dXJlSWRTdWJqZWN0Lm5leHQoaWQpO1xuICB9XG5cbiAgc2V0SW5pdGlhbElkKGlkKTogdm9pZCB7XG4gICAgdGhpcy5pbml0aWFsSWQgPSBpZDtcbiAgICB0aGlzLmluaXRpYWxJZFN1YmplY3QubmV4dChpZCk7XG4gIH1cblxuICBzZXRTaWduSW1nKHVybCkge1xuICAgIHRoaXMuc2lnbkltZyA9IHVybDtcbiAgICB0aGlzLnNpZ25JbWdTdWJqZWN0Lm5leHQodGhpcy5zaWduSW1nKTtcbiAgfVxuXG4gIGdldFNpZ25JbWcoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2lnbkltZztcbiAgfVxuXG4gIHNldEluaXRpYWxJbWcodXJsKSB7XG4gICAgdGhpcy5pbml0aWFsSW1nID0gdXJsO1xuICAgIHRoaXMuaW5pdGlhbEltZ1N1YmplY3QubmV4dCh0aGlzLmluaXRpYWxJbWcpO1xuICB9XG5cbiAgZ2V0SW5pdGlhbEltZygpIHtcbiAgICByZXR1cm4gdGhpcy5pbml0aWFsSW1nO1xuICB9XG5cbiAgcHV0U2lnbmF0dXJlRmllbGQoZW52ZWxvcGVJZCwgZmllbGROYW1lLCBzaWduYXR1cmVJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IGF3YWl0IHRoaXMuZ2V0UHVibGljSXAoKTtcbiAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAucHV0KHRoaXMuZW52VXJsICsgYC8ke2VudmVsb3BlSWR9L2ZpZWxkcy8ke2ZpZWxkTmFtZX0vc2lnbmF0dXJlLyR7c2lnbmF0dXJlSWR9YCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpcF9hZGRyZXNzOiBpcEFkZHJlc3NcbiAgICAgICAgICB9XG4gICAgICAgICkudG9Qcm9taXNlKCkudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlcyk7XG4gICAgICAgIH0pXG4gICAgfSk7XG4gIH1cblxuICBwdXRJbml0aWFsRmllbGQoZW52ZWxvcGVJZCwgZmllbGROYW1lLCBpbml0aWFsSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55Pihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBpcEFkZHJlc3MgPSBhd2FpdCB0aGlzLmdldFB1YmxpY0lwKCk7XG4gICAgICB0aGlzLmh0dHBDbGllbnRcbiAgICAgICAgLnB1dCh0aGlzLmVudlVybCArIGAvJHtlbnZlbG9wZUlkfS9maWVsZHMvJHtmaWVsZE5hbWV9L2luaXRpYWwvJHtpbml0aWFsSWR9YCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpcF9hZGRyZXNzOiBpcEFkZHJlc3NcbiAgICAgICAgICB9XG4gICAgICAgICkudG9Qcm9taXNlKCkudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlcyk7XG4gICAgICAgIH0pXG4gICAgfSk7XG4gIH1cblxuICAvLyByZWZhY3RvciBpdCB0byA0IGZ1bmN0aW9uc1xuICB1cGRhdGVFbnZlbG9wZUZpZWxkKGVudmVsb3BlSWQsIGlmUHJlcGFyZWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKHRoaXMud29ya2luZ0ZpZWxkICYmIHRoaXMud29ya2luZ0ZpZWxkLnR5cGUpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZ2V0RW52ZWxvcGVGaWVsZFZhbHVlKGlmUHJlcGFyZWQpO1xuICAgICAgdGhpcy5wdXRFbnZlbG9wZUZpZWxkKGVudmVsb3BlSWQsIHJlc3VsdCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0RW52ZWxvcGVGaWVsZFZhbHVlKGlzUHJlcGFyZWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKHRoaXMud29ya2luZ0ZpZWxkICYmIHRoaXMud29ya2luZ0ZpZWxkLnR5cGUpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgdmFsdWU6ICcnXG4gICAgICB9O1xuICAgICAgaWYgKHR5cGVvZiAoaXNQcmVwYXJlZCkgPT09ICdib29sZWFuJykge1xuICAgICAgICByZXN1bHRbJ3ByZXBhcmVkJ10gPSBpc1ByZXBhcmVkO1xuICAgICAgfVxuICAgICAgc3dpdGNoICh0aGlzLndvcmtpbmdGaWVsZC50eXBlLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgY2FzZSAndGV4dGJveCc6XG4gICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcbiAgICAgICAgY2FzZSAnZGF0ZSc6XG4gICAgICAgICAgcmVzdWx0LnZhbHVlID0gdGhpcy53b3JraW5nRmllbGQudmFsdWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1dEVudmVsb3BlRmllbGQoZW52ZWxvcGVJZCwgcmVzdWx0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgIC5wdXQodGhpcy5lbnZVcmwgKyBgLyR7ZW52ZWxvcGVJZH0vZmllbGRzLyR7dGhpcy53b3JraW5nRmllbGQuZk5hbWV9YCxcbiAgICAgICAgICByZXN1bHRcbiAgICAgICAgKS50b1Byb21pc2UoKS50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzKTtcbiAgICAgICAgfSlcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZUdyb3VwZWRGaWVsZChlbnZlbG9wZUlkLCBib2R5LCBmaWVsZE5hbWUsIGlmUHJlcGFyZWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKHR5cGVvZiAoaWZQcmVwYXJlZCkgPT09ICdib29sZWFuJykge1xuICAgICAgYm9keVsncHJlcGFyZWQnXSA9IGlmUHJlcGFyZWQ7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAucHV0KHRoaXMuZW52VXJsICsgYC8ke2VudmVsb3BlSWR9L2ZpZWxkcy8ke2ZpZWxkTmFtZX1gLFxuICAgICAgICAgIGJvZHlcbiAgICAgICAgKS50b1Byb21pc2UoKS50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzKTtcbiAgICAgICAgfSlcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHByZXBhcmVFbnZlbG9wZUZpZWxkKGVudmVsb3BlSWQsIHNldFByZXBhcmVkKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMud29ya2luZ0ZpZWxkICYmIHRoaXMud29ya2luZ0ZpZWxkLnR5cGUpIHtcbiAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHRoaXMud29ya2luZ0ZpZWxkLnR5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmIChmaWVsZFR5cGUgIT09ICd0ZXh0Ym94JyAmJiBmaWVsZFR5cGUgIT09ICdkYXRlJyAmJiBmaWVsZFR5cGUgIT09ICdjaGVja2JveCcpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZmllbGRSZXNwb25zZTogYW55ID0gYXdhaXQgdGhpcy51cGRhdGVFbnZlbG9wZUZpZWxkKGVudmVsb3BlSWQsIHNldFByZXBhcmVkKTtcbiAgICAgICAgaWYgKGZpZWxkUmVzcG9uc2UpIHtcbiAgICAgICAgICByZXR1cm4gZmllbGRSZXNwb25zZS5wcmVwYXJlZDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHVibGljSXAoKSB7XG4gICAgY29uc3QgYXBpVXJsID0gJ2h0dHBzOi8vYXBpLmlwaWZ5Lm9yZz9mb3JtYXQ9anNvbnAnO1xuICAgIGNvbnN0IGNhbGxiYWNrID0gJ2NhbGxiYWNrPUpTT05QX0NBTExCQUNLJztcbiAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50XG4gICAgICAuanNvbnAoYXBpVXJsLCBjYWxsYmFjaylcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICByZXR1cm4gcmVzWydpcCddXG4gICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgaXAnLCBlcnIpXG4gICAgICAgIHJldHVybiAnaXBfdW5hdmFpbGFibGUnXG4gICAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZUN1cnJlbnRGaWVsZChcbiAgICBmTmFtZTogc3RyaW5nLFxuICAgIHJlc3VsdDogc3RyaW5nLFxuICAgIHZOYW1lOiBzdHJpbmcsXG4gICAgcGFnZU51bTogbnVtYmVyLFxuICAgIGlkOiBudW1iZXIsXG4gICAgcmVxdWlyZWQ6IGJvb2xlYW4sXG4gICAgb3JkZXI6IG51bWJlcixcbiAgICB0eXBlOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy53b3JraW5nRmllbGQuZk5hbWUgPSBmTmFtZTtcbiAgICB0aGlzLndvcmtpbmdGaWVsZC52YWx1ZSA9IHJlc3VsdDtcbiAgICB0aGlzLndvcmtpbmdGaWVsZC5wYWdlTnVtID0gcGFnZU51bTtcbiAgICB0aGlzLndvcmtpbmdGaWVsZC5pZCA9IGlkO1xuICAgIHRoaXMud29ya2luZ0ZpZWxkLnZOYW1lID0gdk5hbWU7XG4gICAgdGhpcy53b3JraW5nRmllbGQucmVxdWlyZWQgPSByZXF1aXJlZDtcbiAgICB0aGlzLndvcmtpbmdGaWVsZC5vcmRlciA9IG9yZGVyO1xuICAgIHRoaXMud29ya2luZ0ZpZWxkLnR5cGUgPSB0eXBlO1xuICB9XG5cbiAgc2V0Q3VycmVudEZpZWxkcyhmaWVsZHM6IGFueVtdKSB7XG4gICAgdGhpcy5jdXJyZW50RmllbGRzID0gZmllbGRzO1xuICB9XG5cbiAgZ2V0IGN1cnJGaWVsZCgpIHtcbiAgICByZXR1cm4gdGhpcy53b3JraW5nRmllbGQ7XG4gIH1cblxuICBlcnJvck1lc3NhZ2VzKHBhZ2VOdW0sIGlkKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEZpZWxkc1twYWdlTnVtXVtpZF1bJ2Vycm9yJ107XG4gIH1cblxuICBzZXRFbnZJZChpZCk6IHZvaWQge1xuICAgIHRoaXMuX2VudklkLm5leHQoaWQpO1xuICB9XG5cbiAgc2V0ck5hbWUocm9sZSk6IHZvaWQge1xuICAgIHRoaXMuck5hbWUgPSByb2xlO1xuICAgIHRoaXMuX3JOYW1lLm5leHQocm9sZSk7XG4gIH1cblxuICBnZXRTaWduYXR1cmVVcmwoZGF0YSkge1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBjb25zdCBibG9iID0gZGF0YVVSTHRvQmxvYihkYXRhKTtcbiAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG4gICAgICByZXR1cm4gdXJsO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHNldFNpZ25hdHVyZURhdGEoZGF0YSkge1xuICAgIGNvbnN0IGJsb2IgPSBkYXRhVVJMdG9CbG9iKGRhdGEpO1xuICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG4gICAgdGhpcy5zaWduYXR1cmVCbG9iID0gYmxvYjtcbiAgICB0aGlzLnNldFNpZ25JbWcodXJsKTtcbiAgfVxuXG4gIHNldEluaXRpYWxEYXRhKGRhdGEpIHtcbiAgICBjb25zdCBibG9iID0gZGF0YVVSTHRvQmxvYihkYXRhKTtcbiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICAgIHRoaXMuaW5pdGlhbEJsb2IgPSBibG9iO1xuICAgIHRoaXMuc2V0SW5pdGlhbEltZyh1cmwpO1xuICB9XG5cbiAgdXBkYXRlU2lnbmVkKGZOYW1lLCByZXN1bHQpIHtcbiAgICB0aGlzLndvcmtpbmdGaWVsZFsndmFsdWUnXSA9ICdzaWduZWQnO1xuICAgIHRoaXMuc2lnbmVkRmllbGRzW2ZOYW1lXSA9IHJlc3VsdDtcbiAgICB0aGlzLl9zaWduZWRGaWVsZHMubmV4dCh0aGlzLnNpZ25lZEZpZWxkcyk7XG4gIH1cblxuICB1cGRhdGVJbml0aWFsZWQoZk5hbWUsIHJlc3VsdCkge1xuICAgIHRoaXMud29ya2luZ0ZpZWxkWyd2YWx1ZSddID0gJ2luaXRpYWxlZCc7XG4gICAgdGhpcy5zaWduZWRGaWVsZHNbZk5hbWVdID0gcmVzdWx0O1xuICAgIHRoaXMuX3NpZ25lZEZpZWxkcy5uZXh0KHRoaXMuc2lnbmVkRmllbGRzKTtcbiAgfVxuXG4gIHNldFNpZ25hdHVyZUlkKGlkKSB7XG4gICAgdGhpcy5zaWduYXR1cmVJZCA9IGlkO1xuICAgIHRoaXMuc2lnbmF0dXJlSWRTdWJqZWN0Lm5leHQoaWQpO1xuICB9XG5cbiAgc2V0UmVjaXBpZW50KHJlY2lwaWVudDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fcmVjaXBpZW50Lm5leHQocmVjaXBpZW50KTtcbiAgfVxuXG4gIHNldFRvdGFsKHQ6IG51bWJlcikge1xuICAgIHRoaXMuX3RvdGFsID0gdDtcbiAgfVxuXG59XG4iXX0=