/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, PLATFORM_ID, RendererFactory2, ViewEncapsulation, Injector } from '@angular/core';
import { isPlatformBrowser, DOCUMENT } from '@angular/common';
import { Title, Meta } from '@angular/platform-browser';
import { filter, map, switchMap } from 'rxjs/operators';
import { ActivatedRoute, Router, NavigationEnd } from '@angular/router';
import { VerdocsStateService, VerdocsTokenObjectService } from '@verdocs/tokens';
import { EssentialsConfigToken } from '../essentials.module';
/** @enum {string} */
const Robots = {
    Noindex: 'Noindex',
    Index: 'Index',
    Follow: 'Follow',
    Noimageindex: 'Noimageindex',
    None: 'None',
    Noarchive: 'Noarchive',
    Nocache: 'Nocache',
    Nosnippet: 'Nosnippet',
};
export class PageService {
    /**
     * @param {?} titleService
     * @param {?} injector
     * @param {?} meta
     * @param {?} rendererFactory
     * @param {?} activatedRoute
     * @param {?} router
     * @param {?} vTokenStateService
     * @param {?} tokenObject
     * @param {?} platform
     * @param {?} document
     */
    constructor(titleService, injector, meta, rendererFactory, activatedRoute, router, vTokenStateService, tokenObject, platform, document) {
        this.titleService = titleService;
        this.injector = injector;
        this.meta = meta;
        this.rendererFactory = rendererFactory;
        this.activatedRoute = activatedRoute;
        this.router = router;
        this.vTokenStateService = vTokenStateService;
        this.tokenObject = tokenObject;
        this.platform = platform;
        this.document = document;
        this.segmentIsInitialized = false;
        this.lazyTitle = false;
        this._config_token = this.injector.get(EssentialsConfigToken);
    }
    /**
     * @return {?}
     */
    inti() {
        this.initializeSegment();
        setTimeout((/**
         * @return {?}
         */
        () => {
            this.additionalSetupForWidgets();
        }), 500);
        this.router.events.pipe(filter((/**
         * @param {?} event
         * @return {?}
         */
        event => event instanceof NavigationEnd)), map((/**
         * @return {?}
         */
        () => this.activatedRoute)), map((/**
         * @param {?} route
         * @return {?}
         */
        route => {
            /** @type {?} */
            let targetRoute = route;
            while (targetRoute.firstChild) {
                targetRoute = targetRoute.firstChild;
            }
            return targetRoute;
        })), switchMap((/**
         * @param {?} route
         * @return {?}
         */
        route => route.data)), map((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.lazyTitle = data.lazyTitle;
            return data.title;
        }))).subscribe((/**
         * @param {?} title
         * @return {?}
         */
        (title) => {
            if (this.lazyTitle) {
                this.lazyTitle = false;
            }
            else {
                this.setTitleAndRecord(title);
            }
        }));
    }
    /**
     * @param {?} title
     * @param {?=} pageName
     * @return {?}
     */
    setTitleAndRecord(title, pageName) {
        /** @type {?} */
        let newTitle = 'Verdocs';
        if (isPlatformBrowser(this.platform)) {
            if (this.document.cookie.includes(this._config_token.rForm_cookie_name)) {
                newTitle = title ? title : 'Verdocs';
                window['analytics'].page(pageName || newTitle);
            }
        }
        else {
            newTitle = 'Verdocs' + (title ? ` | ${title}` : '');
        }
        this.titleService.setTitle(newTitle);
    }
    /**
     * @param {?} property
     * @param {?} content
     * @return {?}
     */
    setMetaProperty(property, content) {
        if (!!content) {
            if (!!this.getMetaTagProperty(property)) {
                this.meta.updateTag({ property, content }, `property="${property}"`);
            }
            else {
                this.meta.addTag({ property, content }, true);
            }
        }
        else {
            if (!!this.getMetaTagProperty(property)) {
                this.meta.removeTag(`property=“${property}”`);
            }
        }
    }
    /**
     * @param {?} property
     * @param {?} content
     * @return {?}
     */
    setMetaName(property, content) {
        if (!!content) {
            if (!!this.getMetaTagProperty(property)) {
                this.meta.updateTag({ property, content }, `name="${property}"`);
            }
            else {
                this.meta.addTag({ property, content }, true);
            }
        }
        else {
            if (!!this.getMetaTagProperty(property)) {
                this.meta.removeTag(`name=“${property}”`);
            }
        }
    }
    /**
     * @param {?} type
     * @param {?} title
     * @param {?} description
     * @param {?} image
     * @param {?} url
     * @return {?}
     */
    setOpenGraphMeta(type, title, description, image, url) {
        if (!!type) {
            this.setMetaProperty('og:type', type);
        }
        if (!!title) {
            this.setMetaProperty('og:title', title);
        }
        if (!!description) {
            this.setMetaProperty('og:description', description);
        }
        if (!!image) {
            this.setMetaProperty('og:image', image);
        }
        if (!!url) {
            this.setMetaProperty('og:url', url);
        }
        if (!!this.getMetaTagProperty('og:site_name')) {
            return;
        }
        else {
            this.meta.addTag({ property: 'og:site_name', content: 'Verdocs' });
        }
    }
    /**
     * @param {...?} robot_values
     * @return {?}
     */
    setRobotMeta(...robot_values) {
        /** @type {?} */
        let parameters = '';
        for (let x = 0; x < robot_values.length; x++) {
            if (robot_values[x]) {
                if (x === robot_values.length - 1) {
                    parameters += robot_values[x];
                }
                else {
                    parameters += robot_values[x] + ", ";
                }
            }
        }
        /** @type {?} */
        const robot_parameters = parameters;
        this.setMetaName('robots', robot_parameters);
    }
    /**
     * @param {?} tag
     * @return {?}
     */
    setCanonicalUrl(tag) {
        if (!tag.href) {
            tag['href'] = this.document.url;
        }
        this.addTag(tag);
    }
    /**
     * @param {?} content
     * @return {?}
     */
    setDescriptionMeta(content) {
        if (!!this.getMetaTag('description')) {
            if (content) {
                this.meta.updateTag({ name: 'description', content: content }, `name='description'`);
            }
            else {
                this.meta.removeTag(`name='description'`);
            }
        }
        else {
            if (content) {
                this.meta.addTag({ name: 'description', content: content }, true);
            }
        }
    }
    /**
     * @param {?} name
     * @return {?}
     */
    getMetaTag(name) {
        return this.meta.getTag(`name='${name}'`);
    }
    /**
     * @param {?} property
     * @return {?}
     */
    getMetaTagProperty(property) {
        return this.meta.getTag(`property='${property}'`);
    }
    /**
     * @private
     * @return {?}
     */
    initializeSegment() {
        if (isPlatformBrowser(this.platform)) {
            /** @type {?} */
            const analytics = window['analytics'];
            if (document.cookie.includes(this._config_token.rForm_cookie_name)) {
                /** @type {?} */
                const idTokenSubscription = this.vTokenStateService.decodedIdTokenSubject.subscribe((/**
                 * @param {?} decodedIdToken
                 * @return {?}
                 */
                decodedIdToken => {
                    idTokenSubscription.unsubscribe();
                    if (!this.segmentIsInitialized) {
                        this.segmentIsInitialized = true;
                        analytics.reset();
                        /** @type {?} */
                        const profile = this.tokenObject.getProfile();
                        analytics.identify(decodedIdToken.sub, {
                            userId: decodedIdToken.sub,
                            email: decodedIdToken.email,
                            name: decodedIdToken.name,
                            'Verdoc plan': this.planType('verdoc'),
                            'Organization plan': this.planType('organization'),
                            'Current Profile Id': this.tokenObject.getProfileID(),
                            'Current Company': profile.organization.name,
                            company: {
                                id: profile.organization_id,
                                name: profile.organization.name
                            }
                        }, {
                            Intercom: { hideDefaultLauncher: true }
                        });
                    }
                }));
            }
        }
    }
    /**
     * @return {?}
     */
    robotEnum() {
        return Robots;
    }
    /**
     * @private
     * @param {?} product
     * @return {?}
     */
    planType(product) {
        /** @type {?} */
        let productName = 'undefined';
        switch (product) {
            case 'verdoc':
                productName = 'env';
                break;
            case 'organization':
                productName = 'org';
                break;
        }
        /** @type {?} */
        const plan = this.tokenObject.getPlans().find((/**
         * @param {?} p
         * @return {?}
         */
        (p) => {
            return p.includes(productName);
        }));
        /** @type {?} */
        let planType = 'None';
        if (plan) {
            if (productName === 'env') {
                planType = plan.includes('pro') ? 'Pro' : 'Essential';
            }
            else {
                planType = plan.includes('premium') ? 'Premium' : 'Standard';
            }
        }
        return planType;
    }
    /**
     * @param {?} tag
     * @param {?=} forceCreation
     * @return {?}
     */
    addTag(tag, forceCreation) {
        /** @type {?} */
        const renderer = this.rendererFactory.createRenderer(this.document, {
            id: '-1',
            encapsulation: ViewEncapsulation.None,
            styles: [],
            data: {}
        });
        /** @type {?} */
        const link = renderer.createElement('link');
        /** @type {?} */
        const head = this.document.head;
        /** @type {?} */
        const selector = this._parseSelector(tag);
        Object.keys(tag).forEach((/**
         * @param {?} prop
         * @return {?}
         */
        (prop) => {
            return renderer.setAttribute(link, prop, tag[prop]);
        }));
        try {
            if (head === null) {
                throw new Error('<head> not found within DOCUMENT.');
            }
            /** @type {?} */
            const existingLink = renderer.selectRootElement(selector);
            if (!!existingLink) {
                renderer.removeAttribute(existingLink, 'href');
                renderer.setAttribute(existingLink, 'href', tag['href']);
            }
            else {
                renderer.appendChild(head, link);
            }
        }
        catch (e) {
            // console.error('Error within linkService : ', e);
            renderer.appendChild(head, link);
        }
    }
    /**
     * @private
     * @param {?} tag
     * @return {?}
     */
    _parseSelector(tag) {
        /** @type {?} */
        const attr = tag.rel ? 'rel' : 'hreflang';
        return `link[${attr}="${tag[attr]}"]`;
    }
    /**
     * @private
     * @return {?}
     */
    additionalSetupForWidgets() {
        if (isPlatformBrowser(this.platform)) {
            if (window['Intercom']) {
                window['Intercom']('onHide', (/**
                 * @return {?}
                 */
                function () {
                    window['intercomIsOpen'] = false;
                }));
                window['Intercom']('onShow', (/**
                 * @return {?}
                 */
                function () {
                    window['intercomIsOpen'] = true;
                }));
            }
            window['lunchIntercom'] = (/**
             * @return {?}
             */
            function () {
                if (window['Intercom']) {
                    if (window['intercomIsOpen'] && window['intercomIsOpen'] === true) {
                        window['Intercom']('hide');
                    }
                    else {
                        window['Intercom']('show');
                    }
                }
                else {
                    console.error('Intercom is not loaded!');
                }
            });
            window['lunchElevio'] = (/**
             * @return {?}
             */
            function () {
                if (window['_elev']) {
                    if (window['_elev'].widgetIsOpen()) {
                        window['_elev'].close();
                    }
                    else {
                        window['_elev'].open();
                    }
                }
                else {
                    console.error('Elevio is not loaded!');
                }
            });
        }
    }
}
/** @nocollapse */
PageService.ctorParameters = () => [
    { type: Title },
    { type: Injector },
    { type: Meta },
    { type: RendererFactory2 },
    { type: ActivatedRoute },
    { type: Router },
    { type: VerdocsStateService },
    { type: VerdocsTokenObjectService },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    PageService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.segmentIsInitialized;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.lazyTitle;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.titleService;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.meta;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.rendererFactory;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.activatedRoute;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.vTokenStateService;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.tokenObject;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.platform;
    /**
     * @type {?}
     * @private
     */
    PageService.prototype.document;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHZlcmRvY3MvZXNzZW50aWFscy8iLCJzb3VyY2VzIjpbImxpYi9maWVsZHMvcGFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkcsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlELE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakYsT0FBTyxFQUFvQixxQkFBcUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7SUFHN0UsU0FBVSxTQUFTO0lBQ25CLE9BQVEsT0FBTztJQUNmLFFBQVMsUUFBUTtJQUNqQixjQUFlLGNBQWM7SUFDN0IsTUFBTyxNQUFNO0lBQ2IsV0FBWSxXQUFXO0lBQ3ZCLFNBQVUsU0FBUztJQUNuQixXQUFZLFdBQVc7O0FBRXpCLE1BQU0sT0FBTyxXQUFXOzs7Ozs7Ozs7Ozs7O0lBS3RCLFlBQ1UsWUFBbUIsRUFDbkIsUUFBa0IsRUFDbEIsSUFBVSxFQUNWLGVBQWlDLEVBQ2pDLGNBQThCLEVBQzlCLE1BQWMsRUFDZCxrQkFBdUMsRUFDdkMsV0FBc0MsRUFDakIsUUFBUSxFQUNYLFFBQVE7UUFUMUIsaUJBQVksR0FBWixZQUFZLENBQU87UUFDbkIsYUFBUSxHQUFSLFFBQVEsQ0FB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WUFBRztnQkFDdEIsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ25CLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFO3dCQUNsQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUE7cUJBQ3hCO3lCQUFNO3dCQUNMLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtxQkFDdkI7aUJBQ0Y7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFBO2lCQUN2QztZQUNILENBQUMsQ0FBQSxDQUFBO1NBQ0Y7SUFDSCxDQUFDOzs7O1lBdFVNLEtBQUs7WUFGcUQsUUFBUTtZQUUzRCxJQUFJO1lBRlUsZ0JBQWdCO1lBSXJDLGNBQWM7WUFBRSxNQUFNO1lBQ3RCLG1CQUFtQjtZQUFFLHlCQUF5Qjs0Q0EyQmxELE1BQU0sU0FBQyxXQUFXOzRDQUNsQixNQUFNLFNBQUMsUUFBUTs7Ozs7OztJQWRsQixvQ0FBd0M7Ozs7O0lBQ3hDLDJDQUFxQzs7Ozs7SUFDckMsZ0NBQTBCOzs7OztJQUd4QixtQ0FBMkI7Ozs7O0lBQzNCLCtCQUEwQjs7Ozs7SUFDMUIsMkJBQWtCOzs7OztJQUNsQixzQ0FBeUM7Ozs7O0lBQ3pDLHFDQUFzQzs7Ozs7SUFDdEMsNkJBQXNCOzs7OztJQUN0Qix5Q0FBK0M7Ozs7O0lBQy9DLGtDQUE4Qzs7Ozs7SUFDOUMsK0JBQXFDOzs7OztJQUNyQywrQkFBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIFBMQVRGT1JNX0lELCBSZW5kZXJlckZhY3RvcnkyLCBWaWV3RW5jYXBzdWxhdGlvbiwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyLCBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBUaXRsZSwgTWV0YSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBSb3V0ZXIsIE5hdmlnYXRpb25FbmQgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgVmVyZG9jc1N0YXRlU2VydmljZSwgVmVyZG9jc1Rva2VuT2JqZWN0U2VydmljZSB9IGZyb20gJ0B2ZXJkb2NzL3Rva2Vucyc7XG5pbXBvcnQgeyBFc3NlbnRpYWxzQ29uZmlnLCBFc3NlbnRpYWxzQ29uZmlnVG9rZW4gfSBmcm9tICcuLi9lc3NlbnRpYWxzLm1vZHVsZSc7XG5cbmVudW0gUm9ib3RzIHtcbiAgTm9pbmRleCA9ICdOb2luZGV4JyxcbiAgSW5kZXggPSAnSW5kZXgnLFxuICBGb2xsb3cgPSAnRm9sbG93JyxcbiAgTm9pbWFnZWluZGV4ID0gJ05vaW1hZ2VpbmRleCcsXG4gIE5vbmUgPSAnTm9uZScsXG4gIE5vYXJjaGl2ZSA9ICdOb2FyY2hpdmUnLFxuICBOb2NhY2hlID0gJ05vY2FjaGUnLFxuICBOb3NuaXBwZXQgPSAnTm9zbmlwcGV0J1xufVxuZXhwb3J0IGNsYXNzIFBhZ2VTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBfY29uZmlnX3Rva2VuOiBFc3NlbnRpYWxzQ29uZmlnO1xuICBwcml2YXRlIHNlZ21lbnRJc0luaXRpYWxpemVkID0gZmFsc2U7XG4gIHByaXZhdGUgbGF6eVRpdGxlID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0aXRsZVNlcnZpY2U6IFRpdGxlLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgbWV0YTogTWV0YSxcbiAgICBwcml2YXRlIHJlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MixcbiAgICBwcml2YXRlIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgdlRva2VuU3RhdGVTZXJ2aWNlOiBWZXJkb2NzU3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgdG9rZW5PYmplY3Q6IFZlcmRvY3NUb2tlbk9iamVjdFNlcnZpY2UsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybSxcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50XG4gICkge1xuICAgIHRoaXMuX2NvbmZpZ190b2tlbiA9IHRoaXMuaW5qZWN0b3IuZ2V0KEVzc2VudGlhbHNDb25maWdUb2tlbik7XG4gIH1cblxuICBpbnRpKCkge1xuICAgIHRoaXMuaW5pdGlhbGl6ZVNlZ21lbnQoKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuYWRkaXRpb25hbFNldHVwRm9yV2lkZ2V0cygpO1xuICAgIH0sIDUwMCk7XG4gICAgdGhpcy5yb3V0ZXIuZXZlbnRzLnBpcGUoXG4gICAgICBmaWx0ZXIoZXZlbnQgPT4gZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSxcbiAgICAgIG1hcCgoKSA9PiB0aGlzLmFjdGl2YXRlZFJvdXRlKSxcbiAgICAgIG1hcChyb3V0ZSA9PiB7XG4gICAgICAgIGxldCB0YXJnZXRSb3V0ZSA9IHJvdXRlO1xuICAgICAgICB3aGlsZSAodGFyZ2V0Um91dGUuZmlyc3RDaGlsZCkge1xuICAgICAgICAgIHRhcmdldFJvdXRlID0gdGFyZ2V0Um91dGUuZmlyc3RDaGlsZDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGFyZ2V0Um91dGVcbiAgICAgIH0pLFxuICAgICAgc3dpdGNoTWFwKHJvdXRlID0+IHJvdXRlLmRhdGEpLFxuICAgICAgbWFwKChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMubGF6eVRpdGxlID0gZGF0YS5sYXp5VGl0bGU7XG4gICAgICAgIHJldHVybiBkYXRhLnRpdGxlO1xuICAgICAgfSlcbiAgICApLnN1YnNjcmliZSgodGl0bGUpID0+IHtcbiAgICAgIGlmICh0aGlzLmxhenlUaXRsZSkge1xuICAgICAgICB0aGlzLmxhenlUaXRsZSA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zZXRUaXRsZUFuZFJlY29yZCh0aXRsZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZXRUaXRsZUFuZFJlY29yZCh0aXRsZTogc3RyaW5nLCBwYWdlTmFtZT86IHN0cmluZykge1xuICAgIGxldCBuZXdUaXRsZSA9ICdWZXJkb2NzJztcbiAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybSkpIHtcbiAgICAgIGlmICh0aGlzLmRvY3VtZW50LmNvb2tpZS5pbmNsdWRlcyh0aGlzLl9jb25maWdfdG9rZW4uckZvcm1fY29va2llX25hbWUpKSB7XG4gICAgICAgIG5ld1RpdGxlID0gdGl0bGUgPyB0aXRsZSA6ICdWZXJkb2NzJ1xuICAgICAgICB3aW5kb3dbJ2FuYWx5dGljcyddLnBhZ2UocGFnZU5hbWUgfHwgbmV3VGl0bGUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdUaXRsZSA9ICdWZXJkb2NzJyArICh0aXRsZSA/IGAgfCAke3RpdGxlfWAgOiAnJylcbiAgICB9XG4gICAgdGhpcy50aXRsZVNlcnZpY2Uuc2V0VGl0bGUobmV3VGl0bGUpO1xuICB9XG5cbiAgc2V0TWV0YVByb3BlcnR5KHByb3BlcnR5LCBjb250ZW50KSB7XG4gICAgaWYgKCEhY29udGVudCkge1xuICAgICAgaWYgKCEhdGhpcy5nZXRNZXRhVGFnUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIHRoaXMubWV0YS51cGRhdGVUYWcoXG4gICAgICAgICAgeyBwcm9wZXJ0eSwgY29udGVudCB9LFxuICAgICAgICAgIGBwcm9wZXJ0eT1cIiR7cHJvcGVydHl9XCJgXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm1ldGEuYWRkVGFnKFxuICAgICAgICAgIHsgcHJvcGVydHksIGNvbnRlbnQgfSxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghIXRoaXMuZ2V0TWV0YVRhZ1Byb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICB0aGlzLm1ldGEucmVtb3ZlVGFnKGBwcm9wZXJ0eT3igJwke3Byb3BlcnR5feKAnWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldE1ldGFOYW1lKHByb3BlcnR5LCBjb250ZW50KSB7XG4gICAgaWYgKCEhY29udGVudCkge1xuICAgICAgaWYgKCEhdGhpcy5nZXRNZXRhVGFnUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIHRoaXMubWV0YS51cGRhdGVUYWcoXG4gICAgICAgICAgeyBwcm9wZXJ0eSwgY29udGVudCB9LFxuICAgICAgICAgIGBuYW1lPVwiJHtwcm9wZXJ0eX1cImBcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubWV0YS5hZGRUYWcoXG4gICAgICAgICAgeyBwcm9wZXJ0eSwgY29udGVudCB9LFxuICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCEhdGhpcy5nZXRNZXRhVGFnUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIHRoaXMubWV0YS5yZW1vdmVUYWcoYG5hbWU94oCcJHtwcm9wZXJ0eX3igJ1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXRPcGVuR3JhcGhNZXRhKHR5cGU6IHN0cmluZywgdGl0bGU6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZywgaW1hZ2U6IHN0cmluZywgdXJsOiBzdHJpbmcpIHtcbiAgICBpZiAoISF0eXBlKSB7XG4gICAgICB0aGlzLnNldE1ldGFQcm9wZXJ0eSgnb2c6dHlwZScsIHR5cGUpO1xuICAgIH1cbiAgICBpZiAoISF0aXRsZSkge1xuICAgICAgdGhpcy5zZXRNZXRhUHJvcGVydHkoJ29nOnRpdGxlJywgdGl0bGUpO1xuICAgIH1cbiAgICBpZiAoISFkZXNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zZXRNZXRhUHJvcGVydHkoJ29nOmRlc2NyaXB0aW9uJywgZGVzY3JpcHRpb24pO1xuICAgIH1cbiAgICBpZiAoISFpbWFnZSkge1xuICAgICAgdGhpcy5zZXRNZXRhUHJvcGVydHkoJ29nOmltYWdlJywgaW1hZ2UpO1xuICAgIH1cbiAgICBpZiAoISF1cmwpIHtcbiAgICAgIHRoaXMuc2V0TWV0YVByb3BlcnR5KCdvZzp1cmwnLCB1cmwpO1xuICAgIH1cbiAgICBpZiAoISF0aGlzLmdldE1ldGFUYWdQcm9wZXJ0eSgnb2c6c2l0ZV9uYW1lJykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tZXRhLmFkZFRhZyhcbiAgICAgICAgeyBwcm9wZXJ0eTogJ29nOnNpdGVfbmFtZScsIGNvbnRlbnQ6ICdWZXJkb2NzJyB9XG4gICAgICApXG4gICAgfVxuICB9XG4gIHNldFJvYm90TWV0YSguLi5yb2JvdF92YWx1ZXM6IHN0cmluZ1tdKSB7XG4gICAgbGV0IHBhcmFtZXRlcnMgPSAnJztcbiAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHJvYm90X3ZhbHVlcy5sZW5ndGg7IHgrKykge1xuICAgICAgaWYgKHJvYm90X3ZhbHVlc1t4XSkge1xuICAgICAgICBpZiAoeCA9PT0gcm9ib3RfdmFsdWVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBwYXJhbWV0ZXJzICs9IHJvYm90X3ZhbHVlc1t4XTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwYXJhbWV0ZXJzICs9IHJvYm90X3ZhbHVlc1t4XSArIFwiLCBcIlxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHJvYm90X3BhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzO1xuICAgIHRoaXMuc2V0TWV0YU5hbWUoJ3JvYm90cycsIHJvYm90X3BhcmFtZXRlcnMpO1xuICB9XG4gIHNldENhbm9uaWNhbFVybCh0YWc6IExpbmtEZWZpbml0aW9uKSB7XG4gICAgaWYgKCF0YWcuaHJlZikge1xuICAgICAgdGFnWydocmVmJ10gPSB0aGlzLmRvY3VtZW50LnVybDtcbiAgICB9XG4gICAgdGhpcy5hZGRUYWcodGFnKTtcbiAgfVxuICBzZXREZXNjcmlwdGlvbk1ldGEoY29udGVudDogc3RyaW5nKSB7XG4gICAgaWYgKCEhdGhpcy5nZXRNZXRhVGFnKCdkZXNjcmlwdGlvbicpKSB7XG4gICAgICBpZiAoY29udGVudCkge1xuICAgICAgICB0aGlzLm1ldGEudXBkYXRlVGFnKFxuICAgICAgICAgIHsgbmFtZTogJ2Rlc2NyaXB0aW9uJywgY29udGVudDogY29udGVudCB9LFxuICAgICAgICAgIGBuYW1lPSdkZXNjcmlwdGlvbidgXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm1ldGEucmVtb3ZlVGFnKGBuYW1lPSdkZXNjcmlwdGlvbidgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgdGhpcy5tZXRhLmFkZFRhZyhcbiAgICAgICAgICB7IG5hbWU6ICdkZXNjcmlwdGlvbicsIGNvbnRlbnQ6IGNvbnRlbnQgfSxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0TWV0YVRhZyhuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5tZXRhLmdldFRhZyhgbmFtZT0nJHtuYW1lfSdgKTtcbiAgfVxuXG4gIGdldE1ldGFUYWdQcm9wZXJ0eShwcm9wZXJ0eTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMubWV0YS5nZXRUYWcoYHByb3BlcnR5PScke3Byb3BlcnR5fSdgKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZVNlZ21lbnQoKSB7XG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSB7XG4gICAgICBjb25zdCBhbmFseXRpY3MgPSB3aW5kb3dbJ2FuYWx5dGljcyddO1xuICAgICAgaWYgKGRvY3VtZW50LmNvb2tpZS5pbmNsdWRlcyh0aGlzLl9jb25maWdfdG9rZW4uckZvcm1fY29va2llX25hbWUpKSB7XG4gICAgICAgIGNvbnN0IGlkVG9rZW5TdWJzY3JpcHRpb24gPSB0aGlzLnZUb2tlblN0YXRlU2VydmljZS5kZWNvZGVkSWRUb2tlblN1YmplY3Quc3Vic2NyaWJlKGRlY29kZWRJZFRva2VuID0+IHtcbiAgICAgICAgICBpZFRva2VuU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgaWYgKCF0aGlzLnNlZ21lbnRJc0luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICB0aGlzLnNlZ21lbnRJc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGFuYWx5dGljcy5yZXNldCgpO1xuICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMudG9rZW5PYmplY3QuZ2V0UHJvZmlsZSgpO1xuICAgICAgICAgICAgYW5hbHl0aWNzLmlkZW50aWZ5KGRlY29kZWRJZFRva2VuLnN1Yiwge1xuICAgICAgICAgICAgICB1c2VySWQ6IGRlY29kZWRJZFRva2VuLnN1YixcbiAgICAgICAgICAgICAgZW1haWw6IGRlY29kZWRJZFRva2VuLmVtYWlsLFxuICAgICAgICAgICAgICBuYW1lOiBkZWNvZGVkSWRUb2tlbi5uYW1lLFxuICAgICAgICAgICAgICAnVmVyZG9jIHBsYW4nOiB0aGlzLnBsYW5UeXBlKCd2ZXJkb2MnKSxcbiAgICAgICAgICAgICAgJ09yZ2FuaXphdGlvbiBwbGFuJzogdGhpcy5wbGFuVHlwZSgnb3JnYW5pemF0aW9uJyksXG4gICAgICAgICAgICAgICdDdXJyZW50IFByb2ZpbGUgSWQnOiB0aGlzLnRva2VuT2JqZWN0LmdldFByb2ZpbGVJRCgpLFxuICAgICAgICAgICAgICAnQ3VycmVudCBDb21wYW55JzogcHJvZmlsZS5vcmdhbml6YXRpb24ubmFtZSxcbiAgICAgICAgICAgICAgY29tcGFueToge1xuICAgICAgICAgICAgICAgIGlkOiBwcm9maWxlLm9yZ2FuaXphdGlvbl9pZCxcbiAgICAgICAgICAgICAgICBuYW1lOiBwcm9maWxlLm9yZ2FuaXphdGlvbi5uYW1lXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHtcbiAgICAgICAgICAgICAgSW50ZXJjb206IHsgaGlkZURlZmF1bHRMYXVuY2hlcjogdHJ1ZSB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJvYm90RW51bSgpIHtcbiAgICByZXR1cm4gUm9ib3RzO1xuICB9XG5cbiAgcHJpdmF0ZSBwbGFuVHlwZShwcm9kdWN0KSB7XG4gICAgbGV0IHByb2R1Y3ROYW1lID0gJ3VuZGVmaW5lZCc7XG4gICAgc3dpdGNoIChwcm9kdWN0KSB7XG4gICAgICBjYXNlICd2ZXJkb2MnOlxuICAgICAgICBwcm9kdWN0TmFtZSA9ICdlbnYnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ29yZ2FuaXphdGlvbic6XG4gICAgICAgIHByb2R1Y3ROYW1lID0gJ29yZydcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNvbnN0IHBsYW4gPSB0aGlzLnRva2VuT2JqZWN0LmdldFBsYW5zKCkuZmluZCgocCkgPT4ge1xuICAgICAgcmV0dXJuIHAuaW5jbHVkZXMocHJvZHVjdE5hbWUpO1xuICAgIH0pXG4gICAgbGV0IHBsYW5UeXBlID0gJ05vbmUnO1xuICAgIGlmIChwbGFuKSB7XG4gICAgICBpZiAocHJvZHVjdE5hbWUgPT09ICdlbnYnKSB7XG4gICAgICAgIHBsYW5UeXBlID0gcGxhbi5pbmNsdWRlcygncHJvJykgPyAnUHJvJyA6ICdFc3NlbnRpYWwnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcGxhblR5cGUgPSBwbGFuLmluY2x1ZGVzKCdwcmVtaXVtJykgPyAnUHJlbWl1bScgOiAnU3RhbmRhcmQnO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGxhblR5cGU7XG4gIH1cbiAgYWRkVGFnKHRhZzogTGlua0RlZmluaXRpb24sIGZvcmNlQ3JlYXRpb24/OiBib29sZWFuKSB7XG4gICAgXG4gICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLnJlbmRlcmVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlcih0aGlzLmRvY3VtZW50LCB7XG4gICAgICBpZDogJy0xJyxcbiAgICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gICAgICBzdHlsZXM6IFtdLFxuICAgICAgZGF0YToge31cbiAgICB9KTtcbiAgICBjb25zdCBsaW5rID0gcmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnbGluaycpO1xuICAgIGNvbnN0IGhlYWQgPSB0aGlzLmRvY3VtZW50LmhlYWQ7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSB0aGlzLl9wYXJzZVNlbGVjdG9yKHRhZyk7XG5cbiAgICBPYmplY3Qua2V5cyh0YWcpLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgcmV0dXJuIHJlbmRlcmVyLnNldEF0dHJpYnV0ZShsaW5rLCBwcm9wLCB0YWdbcHJvcF0pO1xuICAgIH0pO1xuICAgIHRyeSB7XG5cblxuICAgICAgaWYgKGhlYWQgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCc8aGVhZD4gbm90IGZvdW5kIHdpdGhpbiBET0NVTUVOVC4nKTtcbiAgICAgIH1cblxuXG4gICAgICBjb25zdCBleGlzdGluZ0xpbmsgPSByZW5kZXJlci5zZWxlY3RSb290RWxlbWVudChzZWxlY3RvcilcbiAgICAgIGlmICghIWV4aXN0aW5nTGluaykge1xuICAgICAgICByZW5kZXJlci5yZW1vdmVBdHRyaWJ1dGUoZXhpc3RpbmdMaW5rLCAnaHJlZicpO1xuICAgICAgICByZW5kZXJlci5zZXRBdHRyaWJ1dGUoZXhpc3RpbmdMaW5rLCAnaHJlZicsIHRhZ1snaHJlZiddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlbmRlcmVyLmFwcGVuZENoaWxkKGhlYWQsIGxpbmspO1xuICAgICAgfVxuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gY29uc29sZS5lcnJvcignRXJyb3Igd2l0aGluIGxpbmtTZXJ2aWNlIDogJywgZSk7XG4gICAgICByZW5kZXJlci5hcHBlbmRDaGlsZChoZWFkLCBsaW5rKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9wYXJzZVNlbGVjdG9yKHRhZzogTGlua0RlZmluaXRpb24pOiBzdHJpbmcge1xuICAgIGNvbnN0IGF0dHI6IHN0cmluZyA9IHRhZy5yZWwgPyAncmVsJyA6ICdocmVmbGFuZyc7XG4gICAgcmV0dXJuIGBsaW5rWyR7YXR0cn09XCIke3RhZ1thdHRyXX1cIl1gO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRpdGlvbmFsU2V0dXBGb3JXaWRnZXRzKCkge1xuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtKSkge1xuICAgICAgaWYgKHdpbmRvd1snSW50ZXJjb20nXSkge1xuICAgICAgICB3aW5kb3dbJ0ludGVyY29tJ10oJ29uSGlkZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB3aW5kb3dbJ2ludGVyY29tSXNPcGVuJ10gPSBmYWxzZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgd2luZG93WydJbnRlcmNvbSddKCdvblNob3cnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgd2luZG93WydpbnRlcmNvbUlzT3BlbiddID0gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHdpbmRvd1snbHVuY2hJbnRlcmNvbSddID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAod2luZG93WydJbnRlcmNvbSddKSB7XG4gICAgICAgICAgaWYgKHdpbmRvd1snaW50ZXJjb21Jc09wZW4nXSAmJiB3aW5kb3dbJ2ludGVyY29tSXNPcGVuJ10gPT09IHRydWUpIHtcbiAgICAgICAgICAgIHdpbmRvd1snSW50ZXJjb20nXSgnaGlkZScpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aW5kb3dbJ0ludGVyY29tJ10oJ3Nob3cnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignSW50ZXJjb20gaXMgbm90IGxvYWRlZCEnKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHdpbmRvd1snbHVuY2hFbGV2aW8nXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHdpbmRvd1snX2VsZXYnXSkge1xuICAgICAgICAgIGlmICh3aW5kb3dbJ19lbGV2J10ud2lkZ2V0SXNPcGVuKCkpIHtcbiAgICAgICAgICAgIHdpbmRvd1snX2VsZXYnXS5jbG9zZSgpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHdpbmRvd1snX2VsZXYnXS5vcGVuKClcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRWxldmlvIGlzIG5vdCBsb2FkZWQhJylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVjbGFyZSB0eXBlIExpbmtEZWZpbml0aW9uID0ge1xuICBjaGFyc2V0Pzogc3RyaW5nO1xuICBjcm9zc29yaWdpbj86IHN0cmluZztcbiAgaHJlZj86IHN0cmluZztcbiAgaHJlZmxhbmc/OiBzdHJpbmc7XG4gIG1lZGlhPzogc3RyaW5nO1xuICByZWw/OiBzdHJpbmc7XG4gIHJldj86IHN0cmluZztcbiAgc2l6ZXM/OiBzdHJpbmc7XG4gIHRhcmdldD86IHN0cmluZztcbiAgdHlwZT86IHN0cmluZztcbn0gJiB7XG4gIFtwcm9wOiBzdHJpbmddOiBzdHJpbmc7XG59O1xuIl19