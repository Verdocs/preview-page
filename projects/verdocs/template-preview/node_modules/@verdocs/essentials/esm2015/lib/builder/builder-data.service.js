/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpRequest } from '@angular/common/http';
import { Router } from '@angular/router';
import { TemplatesService, TemplatesGuardService, TemplateActions } from '@verdocs/sdk';
// import { MatSnackBar, MatSnackBarConfig } from '@angular/material/snack-bar';
import { throwError as observableThrowError, ReplaySubject, from, forkJoin, Subject, of } from 'rxjs';
import { catchError, map, delay, mergeMap } from 'rxjs/operators';
import { filter } from 'lodash';
import { findIndex, remove } from 'lodash';
import { nameToRGBA, getRGBA } from '@verdocs/sdk';
import { SnackbarService } from '../snackbar/snackbar.service';
import { EventTrackerService } from '@verdocs/event-tracker';
import { EssentialsConfigToken } from '../essentials.module';
export class BuilderDataService {
    /**
     * @param {?} http
     * @param {?} router
     * @param {?} templatesService
     * @param {?} templateGuard
     * @param {?} snackbarService
     * @param {?} eventTracker
     * @param {?} injector
     */
    constructor(http, router, templatesService, templateGuard, snackbarService, eventTracker, injector) {
        this.http = http;
        this.router = router;
        this.templatesService = templatesService;
        this.templateGuard = templateGuard;
        this.snackbarService = snackbarService;
        this.eventTracker = eventTracker;
        this.injector = injector;
        this.recipients = [];
        this.roles = [];
        this.templateSubject = new ReplaySubject(1, 500);
        this.hasFields = false;
        this.templateNameSubject = new ReplaySubject(1, 500);
        this.templatePagesSubject = new ReplaySubject(1, 500);
        this.recipientsSubject = new ReplaySubject();
        this.activeRecipientSubject = new ReplaySubject();
        this.scrollInfoSubject = new ReplaySubject();
        this.screenInfoSubject = new ReplaySubject();
        this.newTypeSubject = new Subject();
        this.newOptionSubject = new ReplaySubject(1, 100);
        this.duplicateFieldSubject = new ReplaySubject();
        this.saveStatusSubject = new ReplaySubject();
        this.renderedSubject = new ReplaySubject();
        this.activeFieldIndexSubject = new ReplaySubject(1, 100);
        this.numberOfRolesSubject = new ReplaySubject();
        this.numberOfSequenceSubject = new ReplaySubject();
        this.hasFieldsSubject = new ReplaySubject();
        this._config_token = this.injector.get(EssentialsConfigToken);
        this.rForm_backend_url = this._config_token.rForm_backend_url;
        /* Use NGRX to do the subscriptions */
        this.templateSubject.subscribe((/**
         * @param {?} template
         * @return {?}
         */
        template => {
            this.template = template;
            if (template && template.name) {
                this.templateNameSubject.next(template.name);
            }
        }));
        this.templateNameSubject.subscribe((/**
         * @param {?} name
         * @return {?}
         */
        name => {
            this.templateName = name;
        }));
        /* Remove above after refactoring */
    }
    /**
     * @param {?} template_body
     * @return {?}
     */
    createTemplate(template_body) {
        return this.http
            .post(this.rForm_backend_url + '/templates', template_body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            this.templateSubject.next(res);
            this.recipientsSubject.next([]);
            return res;
        })));
    }
    /**
     * @return {?}
     */
    updateLocalTemplateData() {
        this.templateName = this.template.name;
        this.templateNameSubject.next(this.templateName);
        this.templatePages = this.template.pages.length;
        this.templatePagesSubject.next(this.templatePages);
    }
    /**
     * @param {?} template_body
     * @return {?}
     */
    updateTemplate(template_body) {
        return this.templatesService.updateTemplateObservable(template_body.id, template_body).pipe(map((/**
         * @param {?} template
         * @return {?}
         */
        template => template)));
    }
    /**
     * @param {?} template
     * @param {?} name
     * @return {?}
     */
    updateTemplateName(template, name) {
        if (template && template.id) {
            return this.templatesService.updateTemplateObservable(template.id, { name: name })
                .pipe(map((/**
             * @param {?} res
             * @return {?}
             */
            res => {
                template.name = res.name;
                this.updateLocalTemplate(template);
                this.saveStatusSubject.next('saved');
                this.createSnackBar('Name Changed to: ' + name);
                return res.name;
            }), (/**
             * @param {?} err
             * @return {?}
             */
            err => {
                this.saveStatusSubject.next('Failed to save');
                this.createSnackBar('Failed to change Template name');
                return err;
            })));
        }
        else {
            this.templateNameSubject.next(name);
            this.saveStatusSubject.next('Name will be updated');
        }
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    getTemplateObservable(templateId) {
        return this.templatesService.getTemplateObservable(templateId);
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    getTemplate(templateId) {
        return this.templatesService.getTemplate(templateId).toPromise().then((/**
         * @param {?} template
         * @return {?}
         */
        template => {
            this.updateLocalTemplate(template);
            this.recipients = this.sortRoles(this.template);
            this.template.roles = this.recipients;
            this.roles = this.recipients;
            this.recipientsSubject.next(this.recipients);
            this.activeRecipientSubject.next(this.recipients[0]);
            return this.template;
        }));
    }
    /**
     * @return {?}
     */
    watchForUpdatedTemplate() {
        return this.templateSubject.pipe(map((/**
         * @param {?} template
         * @return {?}
         */
        template => template)));
    }
    /**
     * @param {?} template
     * @return {?}
     */
    updateLocalTemplate(template) {
        if (template) {
            this.template = template;
            if (this.template && this.template.pages) {
                this.template.pages = this.template.pages.sort((/**
                 * @param {?} a
                 * @param {?} b
                 * @return {?}
                 */
                (a, b) => {
                    return a.sequence - b.sequence;
                }));
            }
            if (this.template) {
                this.updateLocalTemplateData();
                this.checkForFields(this.template.roles);
            }
            this.recipientsSubject.next(this.template.roles.sort((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                return a.sequence - b.sequence;
            })));
            this.templateSubject.next(this.template);
        }
        else {
            this.templateNameSubject.next(null);
            this.templatePagesSubject.next(null);
            this.numberOfRolesSubject.next(null);
            this.numberOfSequenceSubject.next(null);
            this.hasFieldsSubject.next(false);
        }
    }
    /**
     * @param {?} file
     * @param {?} template
     * @return {?}
     */
    uploadTemplateDocument(file, template) {
        /** @type {?} */
        const formdata = new FormData();
        formdata.append('document', file, file.name);
        /** @type {?} */
        const req = new HttpRequest('POST', this.rForm_backend_url + '/templates/' + template.id + '/documents', formdata, {
            reportProgress: true
        });
        return this.http.request(req)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        res => res)), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            return observableThrowError(err);
        })));
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    getTemplateDocument(templateId) {
        this.templateDoc = this.templatesService.getAllTemplateDocumentsObservable(templateId).pipe(map((/**
         * @param {?} docs
         * @return {?}
         */
        (docs) => {
            this.templateDoc = docs[0];
            return this.templateDoc;
        })));
        return this.templateDoc;
    }
    /**
     * @param {?} templateId
     * @param {?} templateDoc
     * @return {?}
     */
    getTemplateDocumentFile(templateId, templateDoc) {
        if (templateId && templateDoc) {
            return this.templatesService.getTemplateDocumentPDFObservable(templateId, templateDoc).pipe(map((/**
             * @param {?} pdf
             * @return {?}
             */
            pdf => {
                /** @type {?} */
                const pdfUrl = URL.createObjectURL(pdf);
                return pdfUrl;
            })));
        }
    }
    /**
     * @param {?} templateDocument
     * @return {?}
     */
    setTemplateDocument(templateDocument) {
        this.templateDoc = templateDocument;
    }
    /**
     * @param {?} document
     * @param {?} pageNum
     * @param {?} templateId
     * @return {?}
     */
    addTemplatePage(document, pageNum, templateId) {
        /** @type {?} */
        const body = {
            sequence: pageNum,
            page_number: pageNum,
            document_id: document.id
        };
        return this.http.post(this.rForm_backend_url + `/templates/${templateId}/pages`, body)
            .pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        (res) => res)), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            return observableThrowError(err);
        })));
    }
    /**
     * @param {?} document
     * @param {?} pageNums
     * @param {?} templateId
     * @return {?}
     */
    addTemplatePages(document, pageNums, templateId) {
        return from(pageNums)
            .pipe(mergeMap((/**
         * @param {?} pageNum
         * @return {?}
         */
        pageNum => {
            /** @type {?} */
            const page = {
                sequence: pageNum,
                page_number: pageNum,
                document_id: document.id
            };
            return (/** @type {?} */ (this.http.post(this.rForm_backend_url + `/templates/${templateId}/pages`, page).pipe(delay(200))));
        })));
    }
    /**
     * @param {?} template
     * @param {?} fieldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    deleteTemplateField(template, fieldName, i, j) {
        return this.http
            .delete(this.rForm_backend_url + '/templates/' + template.id + '/fields/' + fieldName.trim())
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: fieldName });
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: template.pages[i].fields[fieldIndex].role_name });
            if (roleIndex > -1) {
                /** @type {?} */
                const roleFieldIndex = findIndex(template.roles[roleIndex].fields, { name: fieldName });
                if (roleFieldIndex > -1) {
                    template.roles[roleIndex].fields.splice(roleFieldIndex, 1);
                }
            }
            template.pages[i].fields.splice(fieldIndex, 1);
            this.updateLocalTemplate(template);
            this.saveStatusSubject.next('saved');
            this.checkForFields(template.roles);
            return template;
        })));
    }
    /**
     * @param {?} fieldNames
     * @param {?} template
     * @return {?}
     */
    deleteTemplateFields(fieldNames, template) {
        if (fieldNames && fieldNames.length > 0) {
            /** @type {?} */
            const pages = template.pages;
            for (const fieldName of fieldNames) {
                for (let x = 0; x < pages.length; x++) {
                    /** @type {?} */
                    const fieldIndex = findIndex(pages[x].fields, { name: fieldName });
                    if (fieldIndex >= 0) {
                        template.pages[x].fields.splice(fieldIndex, 1);
                    }
                }
            }
            this.checkForFields(template.roles);
        }
    }
    /**
     * @param {?} newField
     * @param {?} i
     * @param {?} j
     * @param {?} template
     * @return {?}
     */
    addTemplateField(newField, i, j, template) {
        newField.name = newField.name.trim();
        return this.http
            .post(this.rForm_backend_url + '/templates/' + newField.template_id + '/fields', newField)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            this.eventTracker.createEvent({
                category: 'document',
                action: `document ${field.type} field added`,
                label: `document id: ${newField.template_id}`
            });
            template.pages[i].fields[j] = field;
            this.checkForFields(template.roles);
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template.roles[roleIndex]['fields'].push(field);
            }
            this.templateSubject.next(template);
            return template;
        })));
    }
    /**
     * @param {?} id
     * @return {?}
     */
    getTemplateOwnerInfo(id) {
        return this.templatesService.getTemplateOwnerInfo(id);
    }
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    updateTemplateField(template, body, oldName, i, j) {
        oldName = oldName.trim();
        return this.http
            .put(this.rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            this.eventTracker.createEvent({
                category: 'document',
                action: `document ${field.type} field updated`,
                label: `document id: ${template.id}`
            });
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            if (field.page_sequence - 1 !== i) {
                template.pages[i].fields.splice(fieldIndex, 1);
                template.pages[field.page_sequence - 1].fields.push(field);
            }
            else {
                template.pages[i].fields[fieldIndex] = field;
            }
            /** @type {?} */
            const roleIndex = findIndex(template.roles, { name: field.role_name });
            if (roleIndex >= 0) {
                template = this.updateRoleField(template, field, roleIndex, oldName);
            }
            this.templateSubject.next(template);
            this.saveStatusSubject.next('saved');
            return template;
        })));
    }
    /**
     * @param {?} template
     * @param {?} updated_field
     * @param {?} role_index
     * @param {?} old_name
     * @return {?}
     */
    updateRoleField(template, updated_field, role_index, old_name) {
        /** @type {?} */
        const field_index = findIndex(template.roles[role_index].fields, { name: old_name });
        if (field_index >= 0) {
            template.roles[role_index].fields[field_index] = updated_field;
        }
        else {
            template.roles[role_index].fields.push(updated_field);
        }
        return template;
    }
    /**
     * @param {?} template
     * @param {?} body
     * @param {?} oldName
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    updateDropdownField(template, body, oldName, i, j) {
        oldName = oldName.trim();
        return this.http
            .put(this.rForm_backend_url + '/templates/' + template.id + '/fields/' + oldName, body)
            .pipe(map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            /** @type {?} */
            const fieldIndex = findIndex(template.pages[i].fields, { name: oldName });
            template.pages[i].fields[fieldIndex] = field;
            this.templateSubject.next(template);
            this.saveStatusSubject.next('saved');
            return template;
        })));
    }
    /**
     * @param {?} template_id
     * @param {?} sequence_number
     * @return {?}
     */
    deleteSequence(template_id, sequence_number) {
        return this.templatesService.deleteSequence(template_id, sequence_number);
    }
    /**
     * @param {?} field
     * @return {?}
     */
    prepareFieldDuplication(field) {
        this.duplicateFieldSubject.next(field);
    }
    ;
    /**
     * @param {?} roles
     * @return {?}
     */
    checkForFields(roles) {
        /** @type {?} */
        let hasFields = true;
        if (roles && roles.length > 0) {
            for (let role of roles) {
                if (role && role.type === 'signer' && role.fields.length === 0) {
                    hasFields = false;
                }
            }
        }
        else {
            hasFields = false;
        }
        this.hasFields = hasFields;
        this.hasFieldsSubject.next(this.hasFields);
    }
    /**
     * @param {?} title
     * @param {?=} buttonTitle
     * @return {?}
     */
    createSnackBar(title, buttonTitle = 'OK') {
        //   let snackbarConfig: MatSnackBarConfig
        //   if (window.innerWidth >= 920) {
        //     snackbarConfig = {
        //       verticalPosition: 'bottom',
        //       horizontalPosition: 'left',
        //       duration: 5000
        //     }
        //   } else {
        //     snackbarConfig = {
        //       verticalPosition: 'top',
        //       duration: 5000
        //     }
        //   }
        //   this.snackbar.open(title, buttonTitle, snackbarConfig);
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    editDocsUrl(templateId) {
        /** @type {?} */
        const editDocsPageUrl = `/builder/${templateId}/docs`;
        return editDocsPageUrl;
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    editRolesUrl(templateId) {
        /** @type {?} */
        const editRolesPageUrl = `/builder/${templateId}/roles`;
        return editRolesPageUrl;
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    editTemplateUrl(templateId) {
        /** @type {?} */
        const editPageUrl = `/builder/${templateId}/fields`;
        return editPageUrl;
    }
    /**
     * @param {?} templateId
     * @return {?}
     */
    previewTemplateUrl(templateId) {
        /** @type {?} */
        const reviewTemplateUrl = `/document/${templateId}`;
        return reviewTemplateUrl;
    }
    /**
     * @param {?} templateId
     * @param {?} fieldId
     * @param {?} roleId
     * @param {?} i
     * @param {?} j
     * @return {?}
     */
    addFieldRole(templateId, fieldId, roleId, i, j) {
        /** @type {?} */
        const fieldRoleInfo = JSON.stringify({
            field_id: fieldId,
            role_id: roleId
        });
        return this.http
            .post(this.rForm_backend_url + '/template/' + templateId + '/field_role', fieldRoleInfo).toPromise().then((/**
         * @param {?} fieldRole
         * @return {?}
         */
        fieldRole => {
            return fieldRole;
        }));
    }
    /**
     * @param {?} role
     * @param {?} template
     * @return {?}
     */
    addRole(role, template) {
        /** @type {?} */
        const templateBackend = this.rForm_backend_url + '/templates/' + template.id + '/roles';
        this.roles = [];
        this.roles = this.roles.concat(role);
        /** @type {?} */
        const roleRequests = [];
        this.roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        role => {
            roleRequests.push(this.http.post(templateBackend, role));
        }));
        if (this.roles && this.roles.length > 0) {
            return forkJoin(roleRequests).pipe(map((/**
             * @param {?} savedRoles
             * @return {?}
             */
            savedRoles => {
                savedRoles.concat((/** @type {?} */ (savedRoles)));
                if (!template['roles']) {
                    template['roles'] = (/** @type {?} */ ([]));
                }
                /** @type {?} */
                const savedRolesWithFields = savedRoles.map((/**
                 * @param {?} newRole
                 * @return {?}
                 */
                newRole => {
                    newRole['fields'] = [];
                    return newRole;
                }));
                template['roles'] = template['roles'].concat(savedRolesWithFields);
                this.recipients = this.sortRoles(template);
                this.roles = this.recipients;
                this.templateSubject.next(template);
                this.recipientsSubject.next(this.recipients);
                this.recipients;
                return template;
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.error(err);
                console.error('Couldn\'t save all the roles');
                return err;
            })));
        }
        else {
            return of(template);
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    addCheckboxGroup(field) {
        this.newOptionSubject.next({
            type: 'checkbox_group',
            page_sequence: field.page_sequence,
            field_name: field.name,
        });
    }
    /**
     * @param {?} field
     * @return {?}
     */
    addRadioGroup(field) {
        this.newOptionSubject.next({
            type: 'radio_button_group',
            page_sequence: field.page_sequence,
            field_name: field.name,
        });
    }
    /**
     * @param {?} roles
     * @return {?}
     */
    getRolesInSequence(roles) {
        /** @type {?} */
        const rolesInSequence = [];
        for (let roleIndex = 0; roleIndex < roles.length; roleIndex++) {
            /** @type {?} */
            const sequenceIndex = roles[roleIndex]['sequence'] - 1;
            /** @type {?} */
            const role = Object.assign({}, roles[roleIndex]);
            role['style'] = {
                backgroundColor: `${this.getRoleColor(role.name, roleIndex)}`
            };
            if (!rolesInSequence[sequenceIndex]) {
                rolesInSequence[sequenceIndex] = [role];
            }
            else {
                rolesInSequence[sequenceIndex].push(role);
            }
        }
        this.numberOfSequenceSubject.next(rolesInSequence.length);
        this.numberOfRolesSubject.next(roles.length);
        return rolesInSequence;
    }
    /**
     * @param {?} roleName
     * @param {?} template
     * @return {?}
     */
    deleteRole(roleName, template) {
        return this.http.delete(this.rForm_backend_url + '/templates/' + template.id + '/roles/' + roleName)
            .toPromise()
            .then((/**
         * @return {?}
         */
        () => {
            remove(template.roles, (/**
             * @param {?} role
             * @return {?}
             */
            (role) => {
                this.recipients = this.sortRoles(template);
                if (role.name === roleName) {
                    /** @type {?} */
                    const fields = role.fields;
                    /** @type {?} */
                    const fieldNames = [];
                    for (const field of fields) {
                        fieldNames.push(field.name);
                    }
                    this.deleteTemplateFields(fieldNames, template);
                }
                this.templateSubject.next(template);
                this.recipientsSubject.next(this.recipients);
                return role.name === roleName;
            }));
        }));
    }
    /**
     * @param {?} roleNames
     * @param {?} template
     * @return {?}
     */
    deleteRoles(roleNames, template) {
        /** @type {?} */
        const deleteCalls = [];
        roleNames.forEach((/**
         * @param {?} role_name
         * @return {?}
         */
        role_name => {
            template = Object.assign({}, template, { roles: template.roles.filter((/**
                 * @param {?} role
                 * @return {?}
                 */
                role => role.name !== role_name)) });
            deleteCalls.push(this.http.delete(this.rForm_backend_url + '/templates/' + template.id + '/roles/' + role_name));
        }));
        return forkJoin(deleteCalls).pipe(map((/**
         * @return {?}
         */
        () => {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        err => {
            console.error(err);
            console.error('Couldn\'t delete all the roles');
            return err;
        })));
    }
    /**
     * @param {?} roles
     * @param {?} template
     * @return {?}
     */
    updateRoles(roles, template) {
        /** @type {?} */
        const updateCalls = [];
        roles.forEach((/**
         * @param {?} role
         * @return {?}
         */
        role => {
            /** @type {?} */
            const body = {
                template_id: template.id,
                name: role.name.trim(),
                full_name: role.full_name,
                email: role.email,
                sequence: role.sequence,
                type: role.type,
                delegator: role.delegator,
                message: role.message,
                phone: role.phone
            };
            /** @type {?} */
            const role_index = findIndex(template.roles, { name: role.old_name });
            if (role_index >= 0) {
                template.roles[role_index] = Object.assign({}, template.roles[role_index], { template_id: template.id, name: role.name.trim(), full_name: role.full_name, email: role.email, sequence: role.sequence, type: role.type, delegator: role.delegator, message: role.message, phone: role.phone });
            }
            this.eventTracker.createEvent({
                category: 'document',
                action: 'document role updated',
                label: `document id: ${template.id}`
            });
            updateCalls.push(this.http.put(this.rForm_backend_url + '/templates/' + template.id + '/roles/' + role.old_name, body));
        }));
        return forkJoin(updateCalls)
            .pipe(map((/**
         * @return {?}
         */
        () => {
            return template;
        }), (/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            console.error(err);
            console.error('Couldn\'t save all the roles');
            return err;
        })));
    }
    /**
     * @param {?} template
     * @return {?}
     */
    sortRoles(template) {
        if (template.roles.length < 1) {
            return [];
        }
        /** @type {?} */
        const roles = template.roles.sort((/**
         * @param {?} a
         * @param {?} b
         * @return {?}
         */
        (a, b) => {
            if (a.sequence === b.sequence) {
                return a.name.toLowerCase() < b.name.toLowerCase() ? -1 : a.name.toLowerCase() > b.name.toLowerCase() ? 1 : 0;
            }
            return a.sequence - b.sequence;
        }));
        for (let x = 0; x < roles.length; x++) {
            roles[x]['rgba'] = getRGBA(x);
        }
        template.roles = roles;
        return roles;
    }
    /**
     * @param {?} name
     * @param {?=} index
     * @param {?=} template
     * @return {?}
     */
    getRoleColor(name, index, template) {
        if (index !== null && index > -1) {
            return getRGBA(index);
        }
        else if (template) {
            if (template.roles && template.roles.length > 0) {
                index = findIndex(template.roles, { name: name });
                if (index >= 0) {
                    return template.roles[index].rgba ? template.roles[index].rgba : getRGBA(index);
                }
            }
            else {
                return nameToRGBA(name);
            }
        }
        else {
            return nameToRGBA(name);
        }
    }
    /**
     * @param {?} role
     * @param {?} template
     * @return {?}
     */
    updateFullName(role, template) {
        for (let i = 0; i < template.pages.length; i++) {
            if (template.pages[i].fields.length > 0) {
                for (let j = 0; j < template.pages[i].fields.length; j++) {
                    if (template.pages[i].fields[j].type === 'placeholder' && template.pages[i].fields[j].setting['type'] === 'full_name') {
                        if (template.pages[i].fields[j].setting['result'] !== role.full_name &&
                            template.pages[i].fields[j].role_name === role.name) {
                            template.pages[i].fields[j].setting['result'] = role.full_name;
                            /** @type {?} */
                            const updatedField = Object.assign({}, template.pages[i].fields[j]);
                            this.updateTemplateField(template, updatedField, updatedField.name, i, j).toPromise().then((/**
                             * @return {?}
                             */
                            () => {
                                this.templateSubject.next(template);
                            }));
                        }
                    }
                }
            }
        }
    }
    /**
     * @param {?} activeFieldIndex
     * @return {?}
     */
    setActiveFieldIndex(activeFieldIndex) {
        this.activeFieldIndex = activeFieldIndex;
        this.activeFieldIndexSubject.next(this.activeFieldIndex);
    }
    /**
     * @param {?} template
     * @return {?}
     */
    autoAddSigner(template) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return new Promise((/**
             * @param {?} resolve
             * @param {?} reject
             * @return {?}
             */
            (resolve, reject) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                /** @type {?} */
                const recipients = yield this.addRole((/** @type {?} */ ({ name: 'Signer 1', type: 'signer', sequence: 1 })), template).toPromise();
                this.activeRecipientSubject.next(recipients[0]);
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    resolve();
                }), 500);
            })));
        });
    }
    /**
     * @param {?} template
     * @return {?}
     */
    openTemplate(template) {
        if (this.canUserPreview(template)) {
            this.router.navigate([`document/${template.id}`]);
        }
        else if (this.canUserEdit(template)) {
            this.router.navigate([`builder/${template.id}/fields`]);
        }
        else {
            this.snackbarService.open(`Template is in build mode, and not ready for use.  Please check back soon.`);
        }
    }
    /**
     * @param {?} template
     * @return {?}
     */
    canUserEdit(template) {
        /** @type {?} */
        const response = this.templateGuard.canPerformAction(TemplateActions.WRITE, template);
        return response['canPerform'];
    }
    /**
     * @param {?} template
     * @return {?}
     */
    canUserPreview(template) {
        /** @type {?} */
        const hasPermission = (this.templateGuard.canPerformAction(TemplateActions.READ, template)).canPerform;
        /** @type {?} */
        let canPreview;
        /** @type {?} */
        const signers = filter(template.roles, { type: 'signer' });
        canPreview = signers && signers.length > 0;
        for (const signer of signers) {
            canPreview = signer['fields'] && signer['fields'].length > 0;
        }
        return hasPermission && canPreview;
    }
}
BuilderDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BuilderDataService.ctorParameters = () => [
    { type: HttpClient },
    { type: Router },
    { type: TemplatesService },
    { type: TemplatesGuardService },
    { type: SnackbarService },
    { type: EventTrackerService },
    { type: Injector }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype._config_token;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.recipients;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.template;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templateDoc;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templatePages;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templateName;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.activeFieldIndex;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.roles;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templateSubject;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templateId;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.hasFields;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.rForm_backend_url;
    /** @type {?} */
    BuilderDataService.prototype.templateNameSubject;
    /** @type {?} */
    BuilderDataService.prototype.templatePagesSubject;
    /** @type {?} */
    BuilderDataService.prototype.recipientsSubject;
    /** @type {?} */
    BuilderDataService.prototype.activeRecipientSubject;
    /** @type {?} */
    BuilderDataService.prototype.scrollInfoSubject;
    /** @type {?} */
    BuilderDataService.prototype.screenInfoSubject;
    /** @type {?} */
    BuilderDataService.prototype.newTypeSubject;
    /** @type {?} */
    BuilderDataService.prototype.newOptionSubject;
    /** @type {?} */
    BuilderDataService.prototype.duplicateFieldSubject;
    /** @type {?} */
    BuilderDataService.prototype.saveStatusSubject;
    /** @type {?} */
    BuilderDataService.prototype.renderedSubject;
    /** @type {?} */
    BuilderDataService.prototype.activeFieldIndexSubject;
    /** @type {?} */
    BuilderDataService.prototype.numberOfRolesSubject;
    /** @type {?} */
    BuilderDataService.prototype.numberOfSequenceSubject;
    /** @type {?} */
    BuilderDataService.prototype.hasFieldsSubject;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templatesService;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.templateGuard;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.snackbarService;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.eventTracker;
    /**
     * @type {?}
     * @private
     */
    BuilderDataService.prototype.injector;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdmVyZG9jcy9lc3NlbnRpYWxzLyIsInNvdXJjZXMiOlsibGliL2J1aWxkZXIvYnVpbGRlci1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQ0wsZ0JBQWdCLEVBUWhCLHFCQUFxQixFQUNyQixlQUFlLEVBQ2hCLE1BQU0sY0FBYyxDQUFDOztBQUV0QixPQUFPLEVBQUUsVUFBVSxJQUFJLG9CQUFvQixFQUFFLGFBQWEsRUFBYyxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEgsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDaEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTdELE9BQU8sRUFBb0IscUJBQXFCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUcvRSxNQUFNLE9BQU8sa0JBQWtCOzs7Ozs7Ozs7O0lBOEI3QixZQUNVLElBQWdCLEVBQ2hCLE1BQWMsRUFDZCxnQkFBa0MsRUFFbEMsYUFBb0MsRUFDcEMsZUFBZ0MsRUFDaEMsWUFBaUMsRUFDakMsUUFBa0I7UUFQbEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUVsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBdUI7UUFDcEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQUNqQyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBcENwQixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBTWhCLFVBQUssR0FBWSxFQUFFLENBQUM7UUFDcEIsb0JBQWUsR0FBNkIsSUFBSSxhQUFhLENBQVksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRWpGLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFHbkIsd0JBQW1CLEdBQTBCLElBQUksYUFBYSxDQUFTLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvRSx5QkFBb0IsR0FBMEIsSUFBSSxhQUFhLENBQVMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2hGLHNCQUFpQixHQUEyQixJQUFJLGFBQWEsRUFBVyxDQUFDO1FBQ3pFLDJCQUFzQixHQUF5QixJQUFJLGFBQWEsRUFBUyxDQUFDO1FBQzFFLHNCQUFpQixHQUF1QixJQUFJLGFBQWEsRUFBTyxDQUFDO1FBQ2pFLHNCQUFpQixHQUF1QixJQUFJLGFBQWEsRUFBTyxDQUFDO1FBQ2pFLG1CQUFjLEdBQTJCLElBQUksT0FBTyxFQUFpQixDQUFDO1FBQ3RFLHFCQUFnQixHQUE4QixJQUFJLGFBQWEsQ0FBYSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDcEYsMEJBQXFCLEdBQTBCLElBQUksYUFBYSxFQUFVLENBQUM7UUFDM0Usc0JBQWlCLEdBQTBCLElBQUksYUFBYSxFQUFVLENBQUM7UUFDdkUsb0JBQWUsR0FBMEIsSUFBSSxhQUFhLEVBQVUsQ0FBQztRQUNyRSw0QkFBdUIsR0FBdUIsSUFBSSxhQUFhLENBQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzdFLHlCQUFvQixHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBQzFFLDRCQUF1QixHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBQzdFLHFCQUFnQixHQUEyQixJQUFJLGFBQWEsRUFBVyxDQUFDO1FBWTdFLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQztRQUM5RCxzQ0FBc0M7UUFDdEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTOzs7O1FBQUMsUUFBUSxDQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7WUFDekIsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLElBQUksRUFBRTtnQkFDN0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDOUM7UUFDSCxDQUFDLEVBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDM0IsQ0FBQyxFQUFDLENBQUM7UUFDSCxvQ0FBb0M7SUFDdEMsQ0FBQzs7Ozs7SUFFRCxjQUFjLENBQUMsYUFBd0I7UUFDckMsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLElBQUksQ0FBWSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsWUFBWSxFQUFFLGFBQWEsQ0FBQzthQUNyRSxJQUFJLENBQ0gsR0FBRzs7OztRQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDVixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7SUFFRCx1QkFBdUI7UUFDckIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUN2QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNoRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNyRCxDQUFDOzs7OztJQUVELGNBQWMsQ0FBQyxhQUF3QjtRQUNyQyxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FDekYsR0FBRzs7OztRQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFDLENBQzFCLENBQUM7SUFDSixDQUFDOzs7Ozs7SUFFRCxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsSUFBSTtRQUMvQixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHdCQUF3QixDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7aUJBQy9FLElBQUksQ0FDSCxHQUFHOzs7O1lBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ1IsUUFBUSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUN6QixJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLENBQUM7Z0JBQ2hELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNsQixDQUFDOzs7O1lBQ0MsR0FBRyxDQUFDLEVBQUU7Z0JBQ0osSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUM5QyxJQUFJLENBQUMsY0FBYyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7Z0JBQ3RELE9BQU8sR0FBRyxDQUFDO1lBQ2IsQ0FBQyxFQUFDLENBQ0wsQ0FBQTtTQUNKO2FBQU07WUFDTCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztTQUNyRDtJQUNILENBQUM7Ozs7O0lBRUQscUJBQXFCLENBQUMsVUFBa0I7UUFDdEMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakUsQ0FBQzs7Ozs7SUFFRCxXQUFXLENBQUMsVUFBa0I7UUFDNUIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUk7Ozs7UUFBQyxRQUFRLENBQUMsRUFBRTtZQUMvRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3RDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDdkIsQ0FBQyxFQUFDLENBQUE7SUFDSixDQUFDOzs7O0lBRUQsdUJBQXVCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDOzs7OztJQUVELG1CQUFtQixDQUFDLFFBQVE7UUFDMUIsSUFBSSxRQUFRLEVBQUU7WUFDWixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3hDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUk7Ozs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0RCxPQUFPLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQztnQkFDakMsQ0FBQyxFQUFDLENBQUM7YUFDSjtZQUNELElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7Z0JBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMxQztZQUNELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSTs7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDNUQsT0FBTyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDakMsQ0FBQyxFQUFDLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMxQzthQUFNO1lBQ0wsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQzs7Ozs7O0lBRUQsc0JBQXNCLENBQUMsSUFBVSxFQUFFLFFBQW1COztjQUM5QyxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUU7UUFDL0IsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7Y0FDdkMsR0FBRyxHQUFHLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsaUJBQWlCLEdBQUUsYUFBYSxHQUFHLFFBQVEsQ0FBQyxFQUFFLEdBQUcsWUFBWSxFQUFFLFFBQVEsRUFBRTtZQUNoSCxjQUFjLEVBQUUsSUFBSTtTQUNyQixDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7YUFDMUIsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBQyxFQUNmLFVBQVU7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRTtZQUNmLE9BQU8sb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkMsQ0FBQyxFQUFDLENBQ0gsQ0FBQTtJQUNMLENBQUM7Ozs7O0lBRUQsbUJBQW1CLENBQUMsVUFBVTtRQUM1QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxpQ0FBaUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQ3pGLEdBQUc7Ozs7UUFBQyxDQUFDLElBQThCLEVBQUUsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUE7UUFDekIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDOzs7Ozs7SUFFRCx1QkFBdUIsQ0FBQyxVQUFVLEVBQUUsV0FBVztRQUM3QyxJQUFJLFVBQVUsSUFBSSxXQUFXLEVBQUU7WUFDN0IsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0NBQWdDLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDekYsR0FBRzs7OztZQUFDLEdBQUcsQ0FBQyxFQUFFOztzQkFDRixNQUFNLEdBQUcsR0FBRyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUM7Z0JBQ3ZDLE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUMsRUFBQyxDQUFDLENBQUE7U0FDTjtJQUNILENBQUM7Ozs7O0lBRUQsbUJBQW1CLENBQUMsZ0JBQWdCO1FBQ2xDLElBQUksQ0FBQyxXQUFXLEdBQUcsZ0JBQWdCLENBQUM7SUFDdEMsQ0FBQzs7Ozs7OztJQUVELGVBQWUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVU7O2NBQ3JDLElBQUksR0FBRztZQUNYLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLFdBQVcsRUFBRSxPQUFPO1lBQ3BCLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRTtTQUN6QjtRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQVEsSUFBSSxDQUFDLGlCQUFpQixHQUFFLGNBQWMsVUFBVSxRQUFRLEVBQUUsSUFBSSxDQUFDO2FBQ3pGLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsQ0FBQyxHQUFVLEVBQUUsRUFBRSxDQUFDLEdBQUcsRUFBQyxFQUN4QixVQUFVOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUU7WUFDZixPQUFPLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLENBQUMsRUFBQyxDQUNILENBQUE7SUFDTCxDQUFDOzs7Ozs7O0lBRUQsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFFBQWtCLEVBQUUsVUFBa0I7UUFDL0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO2FBQ2xCLElBQUksQ0FDSCxRQUFROzs7O1FBQUMsT0FBTyxDQUFDLEVBQUU7O2tCQUNYLElBQUksR0FBRztnQkFDWCxRQUFRLEVBQUUsT0FBTztnQkFDakIsV0FBVyxFQUFFLE9BQU87Z0JBQ3BCLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRTthQUN6QjtZQUNELE9BQU8sbUJBQW1CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxjQUFjLFVBQVUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBQSxDQUFDO1FBQzVILENBQUMsRUFBQyxDQUNILENBQUE7SUFDTCxDQUFDOzs7Ozs7OztJQUVELG1CQUFtQixDQUFDLFFBQW1CLEVBQUUsU0FBaUIsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUM5RCxPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsTUFBTSxDQUFPLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxVQUFVLEdBQUcsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ2pHLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUU7O2tCQUNKLFVBQVUsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUM7O2tCQUNyRSxTQUFTLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7WUFFckcsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUU7O3NCQUNaLGNBQWMsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUM7Z0JBQ3ZGLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQyxFQUFFO29CQUN2QixRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUM1RDthQUNGO1lBQ0QsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwQyxPQUFPLFFBQVEsQ0FBQztRQUNsQixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7Ozs7O0lBRUQsb0JBQW9CLENBQUMsVUFBb0IsRUFBRSxRQUFtQjtRQUM1RCxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7a0JBQ2pDLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSztZQUM1QixLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRTtnQkFDbEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7OzBCQUMvQixVQUFVLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUM7b0JBQ2xFLElBQUksVUFBVSxJQUFJLENBQUMsRUFBRTt3QkFDbkIsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztxQkFDaEQ7aUJBQ0Y7YUFDRjtZQUNELElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3JDO0lBQ0gsQ0FBQzs7Ozs7Ozs7SUFFRCxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBbUI7UUFDMUQsUUFBUSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixJQUFJLENBQVMsSUFBSSxDQUFDLGlCQUFpQixHQUFFLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxHQUFHLFNBQVMsRUFBRSxRQUFRLENBQUM7YUFDaEcsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxLQUFLLENBQUMsRUFBRTtZQUNWLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLFlBQVksS0FBSyxDQUFDLElBQUksY0FBYztnQkFDNUMsS0FBSyxFQUFFLGdCQUFnQixRQUFRLENBQUMsV0FBVyxFQUFFO2FBQzlDLENBQUMsQ0FBQztZQUNILFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNwQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7a0JBQzlCLFNBQVMsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDdEUsSUFBSSxTQUFTLElBQUksQ0FBQyxFQUFFO2dCQUNsQixRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNqRDtZQUNELElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUMsRUFBQyxDQUNILENBQUM7SUFDTixDQUFDOzs7OztJQUVELG9CQUFvQixDQUFDLEVBQVU7UUFDN0IsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQzs7Ozs7Ozs7O0lBRUQsbUJBQW1CLENBQUMsUUFBbUIsRUFBRSxJQUFZLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ2xFLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEdBQUcsQ0FBUyxJQUFJLENBQUMsaUJBQWlCLEdBQUUsYUFBYSxHQUFHLFFBQVEsQ0FBQyxFQUFFLEdBQUcsVUFBVSxHQUFHLE9BQU8sRUFBRSxJQUFJLENBQUM7YUFDN0YsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxLQUFLLENBQUMsRUFBRTtZQUNWLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLFlBQVksS0FBSyxDQUFDLElBQUksZ0JBQWdCO2dCQUM5QyxLQUFLLEVBQUUsZ0JBQWdCLFFBQVEsQ0FBQyxFQUFFLEVBQUU7YUFDckMsQ0FBQyxDQUFDOztrQkFDRyxVQUFVLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDO1lBQ3pFLElBQUksS0FBSyxDQUFDLGFBQWEsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNqQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUMvQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUM1RDtpQkFBTTtnQkFDTCxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDOUM7O2tCQUNLLFNBQVMsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDdEUsSUFBSSxTQUFTLElBQUksQ0FBQyxFQUFFO2dCQUNsQixRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN0RTtZQUNELElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckMsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7O0lBRUQsZUFBZSxDQUFDLFFBQW1CLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxRQUFROztjQUNoRSxXQUFXLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQ3BGLElBQUksV0FBVyxJQUFJLENBQUMsRUFBRTtZQUNwQixRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxhQUFhLENBQUM7U0FDaEU7YUFBTTtZQUNMLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN2RDtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Ozs7Ozs7OztJQUVELG1CQUFtQixDQUFDLFFBQW1CLEVBQUUsSUFBUyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUMvRCxPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixHQUFHLENBQU0sSUFBSSxDQUFDLGlCQUFpQixHQUFFLGFBQWEsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFVBQVUsR0FBRyxPQUFPLEVBQUUsSUFBSSxDQUFDO2FBQzFGLElBQUksQ0FDSCxHQUFHOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUU7O2tCQUNKLFVBQVUsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUM7WUFDekUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQzdDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckMsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7Ozs7OztJQUVELGNBQWMsQ0FBQyxXQUFtQixFQUFFLGVBQXVCO1FBQ3pELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDNUUsQ0FBQzs7Ozs7SUFFRCx1QkFBdUIsQ0FBQyxLQUFLO1FBQzNCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUFBLENBQUM7Ozs7O0lBRUYsY0FBYyxDQUFDLEtBQUs7O1lBQ2QsU0FBUyxHQUFHLElBQUk7UUFDcEIsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0IsS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLEVBQUU7Z0JBQ3RCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtvQkFDOUQsU0FBUyxHQUFHLEtBQUssQ0FBQztpQkFDbkI7YUFDRjtTQUNGO2FBQU07WUFDTCxTQUFTLEdBQUcsS0FBSyxDQUFDO1NBQ25CO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDN0MsQ0FBQzs7Ozs7O0lBRUQsY0FBYyxDQUFDLEtBQWEsRUFBRSxXQUFXLEdBQUcsSUFBSTtRQUNoRCwwQ0FBMEM7UUFDMUMsb0NBQW9DO1FBQ3BDLHlCQUF5QjtRQUN6QixvQ0FBb0M7UUFDcEMsb0NBQW9DO1FBQ3BDLHVCQUF1QjtRQUN2QixRQUFRO1FBQ1IsYUFBYTtRQUNiLHlCQUF5QjtRQUN6QixpQ0FBaUM7UUFDakMsdUJBQXVCO1FBQ3ZCLFFBQVE7UUFDUixNQUFNO1FBQ04sNERBQTREO0lBQzVELENBQUM7Ozs7O0lBRUQsV0FBVyxDQUFDLFVBQWtCOztjQUN0QixlQUFlLEdBQUcsWUFBWSxVQUFVLE9BQU87UUFDckQsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQzs7Ozs7SUFFRCxZQUFZLENBQUMsVUFBa0I7O2NBQ3ZCLGdCQUFnQixHQUFHLFlBQVksVUFBVSxRQUFRO1FBQ3ZELE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQzs7Ozs7SUFFRCxlQUFlLENBQUMsVUFBa0I7O2NBQzFCLFdBQVcsR0FBRyxZQUFZLFVBQVUsU0FBUztRQUNuRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOzs7OztJQUVELGtCQUFrQixDQUFDLFVBQWtCOztjQUM3QixpQkFBaUIsR0FBRyxhQUFhLFVBQVUsRUFBRTtRQUNuRCxPQUFPLGlCQUFpQixDQUFDO0lBQzNCLENBQUM7Ozs7Ozs7OztJQUVELFlBQVksQ0FBQyxVQUFrQixFQUFFLE9BQWUsRUFBRSxNQUFjLEVBQUUsQ0FBQyxFQUFFLENBQUM7O2NBQzlELGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25DLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLE9BQU8sRUFBRSxNQUFNO1NBQ2hCLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsSUFBSSxDQUFZLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxZQUFZLEdBQUcsVUFBVSxHQUFHLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJOzs7O1FBQUMsU0FBUyxDQUFDLEVBQUU7WUFDOUgsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7SUFFRCxPQUFPLENBQUMsSUFBcUIsRUFBRSxRQUFtQjs7Y0FDMUMsZUFBZSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxRQUFRO1FBQ3RGLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7O2NBQy9CLFlBQVksR0FBRyxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTzs7OztRQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3hCLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0QsQ0FBQyxFQUFDLENBQUE7UUFFRixJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZDLE9BQU8sUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDaEMsR0FBRzs7OztZQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUNmLFVBQVUsQ0FBQyxNQUFNLENBQUMsbUJBQUEsVUFBVSxFQUFXLENBQUMsQ0FBQztnQkFDekMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRTtvQkFDdEIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLG1CQUFTLEVBQUUsRUFBQSxDQUFDO2lCQUNqQzs7c0JBQ0ssb0JBQW9CLEdBQUcsVUFBVSxDQUFDLEdBQUc7Ozs7Z0JBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ3BELE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7b0JBQ3ZCLE9BQU8sT0FBTyxDQUFDO2dCQUNqQixDQUFDLEVBQUM7Z0JBQ0YsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNwQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDaEIsT0FBTyxRQUFRLENBQUE7WUFDakIsQ0FBQzs7OztZQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDbkIsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO2dCQUM5QyxPQUFPLEdBQUcsQ0FBQztZQUNiLENBQUMsRUFBQyxDQUNILENBQUM7U0FDSDthQUFNO1lBQ0wsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDckI7SUFDSCxDQUFDOzs7OztJQUVELGdCQUFnQixDQUFDLEtBQUs7UUFDcEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FDeEI7WUFDRSxJQUFJLEVBQUUsZ0JBQWdCO1lBQ3RCLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtZQUNsQyxVQUFVLEVBQUUsS0FBSyxDQUFDLElBQUk7U0FDdkIsQ0FDRixDQUFDO0lBQ0osQ0FBQzs7Ozs7SUFFRCxhQUFhLENBQUMsS0FBSztRQUNqQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUN4QjtZQUNFLElBQUksRUFBRSxvQkFBb0I7WUFDMUIsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO1lBQ2xDLFVBQVUsRUFBRSxLQUFLLENBQUMsSUFBSTtTQUN2QixDQUNGLENBQUM7SUFDSixDQUFDOzs7OztJQUVELGtCQUFrQixDQUFDLEtBQUs7O2NBQ2hCLGVBQWUsR0FBRyxFQUFFO1FBQzFCLEtBQUssSUFBSSxTQUFTLEdBQUcsQ0FBQyxFQUFFLFNBQVMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxFQUFFOztrQkFDdkQsYUFBYSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDOztrQkFDaEQsSUFBSSxxQkFBUSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUU7WUFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHO2dCQUNkLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsRUFBRTthQUM5RCxDQUFDO1lBQ0YsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsRUFBRTtnQkFDbkMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDekM7aUJBQU07Z0JBQ0wsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMzQztTQUNGO1FBQ0QsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0MsT0FBTyxlQUFlLENBQUE7SUFDeEIsQ0FBQzs7Ozs7O0lBRUQsVUFBVSxDQUFDLFFBQVEsRUFBRSxRQUFtQjtRQUN0QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsUUFBUSxDQUFDO2FBQ2hHLFNBQVMsRUFBRTthQUNYLElBQUk7OztRQUFDLEdBQUcsRUFBRTtZQUNULE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSzs7OztZQUFFLENBQUMsSUFBVyxFQUFFLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDM0MsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTs7MEJBQ3BCLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTTs7MEJBQ3BCLFVBQVUsR0FBRyxFQUFFO29CQUNyQixLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRTt3QkFDMUIsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQzdCO29CQUNELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7aUJBQ2pEO2dCQUNELElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNwQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDN0MsT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQTtZQUMvQixDQUFDLEVBQUMsQ0FBQztRQUNMLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Ozs7O0lBRUQsV0FBVyxDQUFDLFNBQXdCLEVBQUUsUUFBbUI7O2NBQ2pELFdBQVcsR0FBRyxFQUFFO1FBQ3RCLFNBQVMsQ0FBQyxPQUFPOzs7O1FBQUMsU0FBUyxDQUFDLEVBQUU7WUFDNUIsUUFBUSxxQkFDSCxRQUFRLElBQ1gsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTTs7OztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFDLEdBQzlELENBQUE7WUFDRCxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRSxhQUFhLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUNqSCxDQUFDLEVBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDL0IsR0FBRzs7O1FBQUMsR0FBRyxFQUFFO1lBQ1AsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQzs7OztRQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ1AsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7WUFDaEQsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUMsQ0FDSCxDQUFBO0lBQ0gsQ0FBQzs7Ozs7O0lBRUQsV0FBVyxDQUFDLEtBQUssRUFBRSxRQUFtQjs7Y0FDOUIsV0FBVyxHQUFHLEVBQUU7UUFDdEIsS0FBSyxDQUFDLE9BQU87Ozs7UUFBQyxJQUFJLENBQUMsRUFBRTs7a0JBQ2IsSUFBSSxHQUFHO2dCQUNYLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRTtnQkFDeEIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUN0QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3pCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO2dCQUN2QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzthQUNsQjs7a0JBRUssVUFBVSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNyRSxJQUFJLFVBQVUsSUFBSSxDQUFDLEVBQUU7Z0JBQ25CLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLHFCQUNyQixRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUM3QixXQUFXLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFDeEIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQ3RCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQ2xCLENBQUE7YUFDRjtZQUNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2dCQUM1QixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsS0FBSyxFQUFFLGdCQUFnQixRQUFRLENBQUMsRUFBRSxFQUFFO2FBQ3JDLENBQUMsQ0FBQztZQUNILFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFFLGFBQWEsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekgsQ0FBQyxFQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7YUFDekIsSUFBSSxDQUNILEdBQUc7OztRQUFDLEdBQUcsRUFBRTtZQUNQLE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUM7Ozs7UUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7WUFDOUMsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7Ozs7SUFDRCxTQUFTLENBQUMsUUFBbUI7UUFDM0IsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0IsT0FBTyxFQUFFLENBQUM7U0FDWDs7Y0FFSyxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJOzs7OztRQUFDLENBQUMsQ0FBUSxFQUFFLENBQVEsRUFBRSxFQUFFO1lBQ3ZELElBQUksQ0FBQyxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFO2dCQUM3QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDL0c7WUFDRCxPQUFPLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUNqQyxDQUFDLEVBQUM7UUFFRixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNyQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQy9CO1FBQ0QsUUFBUSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFdkIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7Ozs7O0lBRUQsWUFBWSxDQUFDLElBQUksRUFBRSxLQUFNLEVBQUUsUUFBb0I7UUFDN0MsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNoQyxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN2QjthQUFNLElBQUksUUFBUSxFQUFFO1lBQ25CLElBQUksUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQy9DLEtBQUssR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUNsRCxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7b0JBQ2QsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDakY7YUFDRjtpQkFBTTtnQkFDTCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN6QjtTQUNGO2FBQU07WUFDTCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QjtJQUNILENBQUM7Ozs7OztJQUVELGNBQWMsQ0FBQyxJQUFXLEVBQUUsUUFBbUI7UUFDN0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzlDLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDeEQsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssYUFBYSxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxXQUFXLEVBQUU7d0JBQ3JILElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTOzRCQUNsRSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEtBQUssSUFBSSxDQUFDLElBQUksRUFBRTs0QkFDckQsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7O2tDQUN6RCxZQUFZLHFCQUFRLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFFOzRCQUN2RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLFlBQVksRUFBRSxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJOzs7NEJBQUMsR0FBRyxFQUFFO2dDQUM5RixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzs0QkFDdEMsQ0FBQyxFQUFDLENBQUM7eUJBQ0o7cUJBQ0Y7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQzs7Ozs7SUFFRCxtQkFBbUIsQ0FBQyxnQkFBZ0I7UUFDbEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3pDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDM0QsQ0FBQzs7Ozs7SUFFSyxhQUFhLENBQUMsUUFBbUI7O1lBQ3JDLE9BQU8sSUFBSSxPQUFPOzs7OztZQUFDLENBQU8sT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztzQkFDckMsVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxtQkFBQSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxTQUFTLEVBQUU7Z0JBQ3ZILElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELFVBQVU7OztnQkFBQyxHQUFHLEVBQUU7b0JBQ2QsT0FBTyxFQUFFLENBQUE7Z0JBQ1gsQ0FBQyxHQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ1YsQ0FBQyxDQUFBLEVBQUMsQ0FBQztRQUNMLENBQUM7S0FBQTs7Ozs7SUFFRCxZQUFZLENBQUMsUUFBbUI7UUFDOUIsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ25EO2FBQU0sSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxRQUFRLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1NBQ3pEO2FBQU07WUFDTCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyw0RUFBNEUsQ0FBQyxDQUFBO1NBQ3hHO0lBQ0gsQ0FBQzs7Ozs7SUFFRCxXQUFXLENBQUMsUUFBbUI7O2NBQ3ZCLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDO1FBQ3JGLE9BQU8sUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFBO0lBQy9CLENBQUM7Ozs7O0lBRUQsY0FBYyxDQUFDLFFBQW1COztjQUMxQixhQUFhLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVOztZQUNsRyxVQUFVOztjQUNSLE9BQU8sR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQztRQUMxRCxVQUFVLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFO1lBQzVCLFVBQVUsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDOUQ7UUFDRCxPQUFPLGFBQWEsSUFBSSxVQUFVLENBQUM7SUFDckMsQ0FBQzs7O1lBN3BCRixVQUFVOzs7O1lBMUJGLFVBQVU7WUFDVixNQUFNO1lBRWIsZ0JBQWdCO1lBUWhCLHFCQUFxQjtZQVVkLGVBQWU7WUFDZixtQkFBbUI7WUF2QlAsUUFBUTs7Ozs7OztJQTZCM0IsMkNBQXdDOzs7OztJQUN4Qyx3Q0FBd0I7Ozs7O0lBQ3hCLHNDQUFpQjs7Ozs7SUFDakIseUNBQW9COzs7OztJQUNwQiwyQ0FBc0I7Ozs7O0lBQ3RCLDBDQUE2Qjs7Ozs7SUFDN0IsOENBQThCOzs7OztJQUM5QixtQ0FBNEI7Ozs7O0lBQzVCLDZDQUF5Rjs7Ozs7SUFDekYsd0NBQTJCOzs7OztJQUMzQix1Q0FBMEI7Ozs7O0lBQzFCLCtDQUFrQzs7SUFFbEMsaURBQXNGOztJQUN0RixrREFBdUY7O0lBQ3ZGLCtDQUFnRjs7SUFDaEYsb0RBQWlGOztJQUNqRiwrQ0FBd0U7O0lBQ3hFLCtDQUF3RTs7SUFDeEUsNENBQTZFOztJQUM3RSw4Q0FBMkY7O0lBQzNGLG1EQUFrRjs7SUFDbEYsK0NBQThFOztJQUM5RSw2Q0FBNEU7O0lBQzVFLHFEQUFvRjs7SUFDcEYsa0RBQWlGOztJQUNqRixxREFBb0Y7O0lBQ3BGLDhDQUErRTs7Ozs7SUFHN0Usa0NBQXdCOzs7OztJQUN4QixvQ0FBc0I7Ozs7O0lBQ3RCLDhDQUEwQzs7Ozs7SUFFMUMsMkNBQTRDOzs7OztJQUM1Qyw2Q0FBd0M7Ozs7O0lBQ3hDLDBDQUF5Qzs7Ozs7SUFDekMsc0NBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFJlcXVlc3QgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgXG4gIFRlbXBsYXRlc1NlcnZpY2UsXG4gIElUZW1wbGF0ZSxcbiAgSVRlbXBsYXRlRG9jdW1lbnQsXG4gIElQYWdlLFxuICBJUm9sZSxcbiAgSUZpZWxkLFxuICBPcHRpb25UeXBlLFxuICBGaWVsZFJvbGUsXG4gIFRlbXBsYXRlc0d1YXJkU2VydmljZSxcbiAgVGVtcGxhdGVBY3Rpb25zXG59IGZyb20gJ0B2ZXJkb2NzL3Nkayc7XG4vLyBpbXBvcnQgeyBNYXRTbmFja0JhciwgTWF0U25hY2tCYXJDb25maWcgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9zbmFjay1iYXInO1xuaW1wb3J0IHsgdGhyb3dFcnJvciBhcyBvYnNlcnZhYmxlVGhyb3dFcnJvciwgUmVwbGF5U3ViamVjdCwgT2JzZXJ2YWJsZSwgZnJvbSwgZm9ya0pvaW4sIFN1YmplY3QsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAsIGRlbGF5LCBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBmaW5kSW5kZXgsIHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IG5hbWVUb1JHQkEsIGdldFJHQkEgfSBmcm9tICdAdmVyZG9jcy9zZGsnO1xuaW1wb3J0IHsgU25hY2tiYXJTZXJ2aWNlIH0gZnJvbSAnLi4vc25hY2tiYXIvc25hY2tiYXIuc2VydmljZSc7XG5pbXBvcnQgeyBFdmVudFRyYWNrZXJTZXJ2aWNlIH0gZnJvbSAnQHZlcmRvY3MvZXZlbnQtdHJhY2tlcic7XG5cbmltcG9ydCB7IEVzc2VudGlhbHNDb25maWcsIEVzc2VudGlhbHNDb25maWdUb2tlbiB9IGZyb20gJy4uL2Vzc2VudGlhbHMubW9kdWxlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJ1aWxkZXJEYXRhU2VydmljZSB7XG4gIHByaXZhdGUgX2NvbmZpZ190b2tlbjogRXNzZW50aWFsc0NvbmZpZztcbiAgcHJpdmF0ZSByZWNpcGllbnRzID0gW107XG4gIHByaXZhdGUgdGVtcGxhdGU7XG4gIHByaXZhdGUgdGVtcGxhdGVEb2M7XG4gIHByaXZhdGUgdGVtcGxhdGVQYWdlcztcbiAgcHJpdmF0ZSB0ZW1wbGF0ZU5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSBhY3RpdmVGaWVsZEluZGV4OiBhbnk7XG4gIHByaXZhdGUgcm9sZXM6IElSb2xlW10gPSBbXTtcbiAgcHJpdmF0ZSB0ZW1wbGF0ZVN1YmplY3Q6IFJlcGxheVN1YmplY3Q8SVRlbXBsYXRlPiA9IG5ldyBSZXBsYXlTdWJqZWN0PElUZW1wbGF0ZT4oMSwgNTAwKTtcbiAgcHJpdmF0ZSB0ZW1wbGF0ZUlkOiBzdHJpbmc7XG4gIHByaXZhdGUgaGFzRmllbGRzID0gZmFsc2U7XG4gIHByaXZhdGUgckZvcm1fYmFja2VuZF91cmw6IHN0cmluZztcblxuICBwdWJsaWMgdGVtcGxhdGVOYW1lU3ViamVjdDogUmVwbGF5U3ViamVjdDxzdHJpbmc+ID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nPigxLCA1MDApO1xuICBwdWJsaWMgdGVtcGxhdGVQYWdlc1N1YmplY3Q6IFJlcGxheVN1YmplY3Q8bnVtYmVyPiA9IG5ldyBSZXBsYXlTdWJqZWN0PG51bWJlcj4oMSwgNTAwKTtcbiAgcHVibGljIHJlY2lwaWVudHNTdWJqZWN0OiBSZXBsYXlTdWJqZWN0PElSb2xlW10+ID0gbmV3IFJlcGxheVN1YmplY3Q8SVJvbGVbXT4oKTtcbiAgcHVibGljIGFjdGl2ZVJlY2lwaWVudFN1YmplY3Q6IFJlcGxheVN1YmplY3Q8SVJvbGU+ID0gbmV3IFJlcGxheVN1YmplY3Q8SVJvbGU+KCk7XG4gIHB1YmxpYyBzY3JvbGxJbmZvU3ViamVjdDogUmVwbGF5U3ViamVjdDxhbnk+ID0gbmV3IFJlcGxheVN1YmplY3Q8YW55PigpO1xuICBwdWJsaWMgc2NyZWVuSW5mb1N1YmplY3Q6IFJlcGxheVN1YmplY3Q8YW55PiA9IG5ldyBSZXBsYXlTdWJqZWN0PGFueT4oKTtcbiAgcHVibGljIG5ld1R5cGVTdWJqZWN0OiBTdWJqZWN0PHN0cmluZyB8IG51bGw+ID0gbmV3IFN1YmplY3Q8c3RyaW5nIHwgbnVsbD4oKTtcbiAgcHVibGljIG5ld09wdGlvblN1YmplY3Q6IFJlcGxheVN1YmplY3Q8T3B0aW9uVHlwZT4gPSBuZXcgUmVwbGF5U3ViamVjdDxPcHRpb25UeXBlPigxLCAxMDApO1xuICBwdWJsaWMgZHVwbGljYXRlRmllbGRTdWJqZWN0OiBSZXBsYXlTdWJqZWN0PElGaWVsZD4gPSBuZXcgUmVwbGF5U3ViamVjdDxJRmllbGQ+KCk7XG4gIHB1YmxpYyBzYXZlU3RhdHVzU3ViamVjdDogUmVwbGF5U3ViamVjdDxzdHJpbmc+ID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nPigpO1xuICBwdWJsaWMgcmVuZGVyZWRTdWJqZWN0OiBSZXBsYXlTdWJqZWN0PHN0cmluZz4gPSBuZXcgUmVwbGF5U3ViamVjdDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBhY3RpdmVGaWVsZEluZGV4U3ViamVjdDogUmVwbGF5U3ViamVjdDxhbnk+ID0gbmV3IFJlcGxheVN1YmplY3Q8YW55PigxLCAxMDApO1xuICBwdWJsaWMgbnVtYmVyT2ZSb2xlc1N1YmplY3Q6IFJlcGxheVN1YmplY3Q8bnVtYmVyPiA9IG5ldyBSZXBsYXlTdWJqZWN0PG51bWJlcj4oKTtcbiAgcHVibGljIG51bWJlck9mU2VxdWVuY2VTdWJqZWN0OiBSZXBsYXlTdWJqZWN0PG51bWJlcj4gPSBuZXcgUmVwbGF5U3ViamVjdDxudW1iZXI+KCk7XG4gIHB1YmxpYyBoYXNGaWVsZHNTdWJqZWN0OiBSZXBsYXlTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHRlbXBsYXRlc1NlcnZpY2U6IFRlbXBsYXRlc1NlcnZpY2UsXG4gICAgLy8gcHJpdmF0ZSBzbmFja2JhcjogTWF0U25hY2tCYXIsXG4gICAgcHJpdmF0ZSB0ZW1wbGF0ZUd1YXJkOiBUZW1wbGF0ZXNHdWFyZFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzbmFja2JhclNlcnZpY2U6IFNuYWNrYmFyU2VydmljZSxcbiAgICBwcml2YXRlIGV2ZW50VHJhY2tlcjogRXZlbnRUcmFja2VyU2VydmljZSxcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxuICApIHtcbiAgICB0aGlzLl9jb25maWdfdG9rZW4gPSB0aGlzLmluamVjdG9yLmdldChFc3NlbnRpYWxzQ29uZmlnVG9rZW4pO1xuICAgIHRoaXMuckZvcm1fYmFja2VuZF91cmwgPSB0aGlzLl9jb25maWdfdG9rZW4uckZvcm1fYmFja2VuZF91cmw7XG4gICAgLyogVXNlIE5HUlggdG8gZG8gdGhlIHN1YnNjcmlwdGlvbnMgKi9cbiAgICB0aGlzLnRlbXBsYXRlU3ViamVjdC5zdWJzY3JpYmUodGVtcGxhdGUgPT4ge1xuICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgICAgaWYgKHRlbXBsYXRlICYmIHRlbXBsYXRlLm5hbWUpIHtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZU5hbWVTdWJqZWN0Lm5leHQodGVtcGxhdGUubmFtZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy50ZW1wbGF0ZU5hbWVTdWJqZWN0LnN1YnNjcmliZShuYW1lID0+IHtcbiAgICAgIHRoaXMudGVtcGxhdGVOYW1lID0gbmFtZTtcbiAgICB9KTtcbiAgICAvKiBSZW1vdmUgYWJvdmUgYWZ0ZXIgcmVmYWN0b3JpbmcgKi9cbiAgfVxuXG4gIGNyZWF0ZVRlbXBsYXRlKHRlbXBsYXRlX2JvZHk6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8SVRlbXBsYXRlPih0aGlzLnJGb3JtX2JhY2tlbmRfdXJsICsgJy90ZW1wbGF0ZXMnLCB0ZW1wbGF0ZV9ib2R5KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgocmVzKSA9PiB7XG4gICAgICAgICAgdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dChyZXMpO1xuICAgICAgICAgIHRoaXMucmVjaXBpZW50c1N1YmplY3QubmV4dChbXSk7XG4gICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICB1cGRhdGVMb2NhbFRlbXBsYXRlRGF0YSgpIHtcbiAgICB0aGlzLnRlbXBsYXRlTmFtZSA9IHRoaXMudGVtcGxhdGUubmFtZTtcbiAgICB0aGlzLnRlbXBsYXRlTmFtZVN1YmplY3QubmV4dCh0aGlzLnRlbXBsYXRlTmFtZSk7XG4gICAgdGhpcy50ZW1wbGF0ZVBhZ2VzID0gdGhpcy50ZW1wbGF0ZS5wYWdlcy5sZW5ndGg7XG4gICAgdGhpcy50ZW1wbGF0ZVBhZ2VzU3ViamVjdC5uZXh0KHRoaXMudGVtcGxhdGVQYWdlcyk7XG4gIH1cblxuICB1cGRhdGVUZW1wbGF0ZSh0ZW1wbGF0ZV9ib2R5OiBJVGVtcGxhdGUpIHtcbiAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZXNTZXJ2aWNlLnVwZGF0ZVRlbXBsYXRlT2JzZXJ2YWJsZSh0ZW1wbGF0ZV9ib2R5LmlkLCB0ZW1wbGF0ZV9ib2R5KS5waXBlKFxuICAgICAgbWFwKHRlbXBsYXRlID0+IHRlbXBsYXRlKVxuICAgICk7XG4gIH1cblxuICB1cGRhdGVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIG5hbWUpIHtcbiAgICBpZiAodGVtcGxhdGUgJiYgdGVtcGxhdGUuaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc1NlcnZpY2UudXBkYXRlVGVtcGxhdGVPYnNlcnZhYmxlKHRlbXBsYXRlLmlkLCB7IG5hbWU6IG5hbWUgfSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWFwKHJlcyA9PiB7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5uYW1lID0gcmVzLm5hbWU7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxvY2FsVGVtcGxhdGUodGVtcGxhdGUpO1xuICAgICAgICAgICAgdGhpcy5zYXZlU3RhdHVzU3ViamVjdC5uZXh0KCdzYXZlZCcpO1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVTbmFja0JhcignTmFtZSBDaGFuZ2VkIHRvOiAnICsgbmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzLm5hbWU7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuc2F2ZVN0YXR1c1N1YmplY3QubmV4dCgnRmFpbGVkIHRvIHNhdmUnKTtcbiAgICAgICAgICAgICAgdGhpcy5jcmVhdGVTbmFja0JhcignRmFpbGVkIHRvIGNoYW5nZSBUZW1wbGF0ZSBuYW1lJyk7XG4gICAgICAgICAgICAgIHJldHVybiBlcnI7XG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGVtcGxhdGVOYW1lU3ViamVjdC5uZXh0KG5hbWUpO1xuICAgICAgdGhpcy5zYXZlU3RhdHVzU3ViamVjdC5uZXh0KCdOYW1lIHdpbGwgYmUgdXBkYXRlZCcpO1xuICAgIH1cbiAgfVxuXG4gIGdldFRlbXBsYXRlT2JzZXJ2YWJsZSh0ZW1wbGF0ZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElUZW1wbGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc1NlcnZpY2UuZ2V0VGVtcGxhdGVPYnNlcnZhYmxlKHRlbXBsYXRlSWQpO1xuICB9XG5cbiAgZ2V0VGVtcGxhdGUodGVtcGxhdGVJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMudGVtcGxhdGVzU2VydmljZS5nZXRUZW1wbGF0ZSh0ZW1wbGF0ZUlkKS50b1Byb21pc2UoKS50aGVuKHRlbXBsYXRlID0+IHtcbiAgICAgIHRoaXMudXBkYXRlTG9jYWxUZW1wbGF0ZSh0ZW1wbGF0ZSk7XG4gICAgICB0aGlzLnJlY2lwaWVudHMgPSB0aGlzLnNvcnRSb2xlcyh0aGlzLnRlbXBsYXRlKTtcbiAgICAgIHRoaXMudGVtcGxhdGUucm9sZXMgPSB0aGlzLnJlY2lwaWVudHM7XG4gICAgICB0aGlzLnJvbGVzID0gdGhpcy5yZWNpcGllbnRzO1xuICAgICAgdGhpcy5yZWNpcGllbnRzU3ViamVjdC5uZXh0KHRoaXMucmVjaXBpZW50cyk7XG4gICAgICB0aGlzLmFjdGl2ZVJlY2lwaWVudFN1YmplY3QubmV4dCh0aGlzLnJlY2lwaWVudHNbMF0pO1xuICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGU7XG4gICAgfSlcbiAgfVxuXG4gIHdhdGNoRm9yVXBkYXRlZFRlbXBsYXRlKCkge1xuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlU3ViamVjdC5waXBlKG1hcCh0ZW1wbGF0ZSA9PiB0ZW1wbGF0ZSkpO1xuICB9XG5cbiAgdXBkYXRlTG9jYWxUZW1wbGF0ZSh0ZW1wbGF0ZSkge1xuICAgIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgICAgaWYgKHRoaXMudGVtcGxhdGUgJiYgdGhpcy50ZW1wbGF0ZS5wYWdlcykge1xuICAgICAgICB0aGlzLnRlbXBsYXRlLnBhZ2VzID0gdGhpcy50ZW1wbGF0ZS5wYWdlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGEuc2VxdWVuY2UgLSBiLnNlcXVlbmNlO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnRlbXBsYXRlKSB7XG4gICAgICAgIHRoaXMudXBkYXRlTG9jYWxUZW1wbGF0ZURhdGEoKTtcbiAgICAgICAgdGhpcy5jaGVja0ZvckZpZWxkcyh0aGlzLnRlbXBsYXRlLnJvbGVzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVjaXBpZW50c1N1YmplY3QubmV4dCh0aGlzLnRlbXBsYXRlLnJvbGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgcmV0dXJuIGEuc2VxdWVuY2UgLSBiLnNlcXVlbmNlO1xuICAgICAgfSkpO1xuICAgICAgdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0aGlzLnRlbXBsYXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50ZW1wbGF0ZU5hbWVTdWJqZWN0Lm5leHQobnVsbCk7XG4gICAgICB0aGlzLnRlbXBsYXRlUGFnZXNTdWJqZWN0Lm5leHQobnVsbCk7XG4gICAgICB0aGlzLm51bWJlck9mUm9sZXNTdWJqZWN0Lm5leHQobnVsbCk7XG4gICAgICB0aGlzLm51bWJlck9mU2VxdWVuY2VTdWJqZWN0Lm5leHQobnVsbCk7XG4gICAgICB0aGlzLmhhc0ZpZWxkc1N1YmplY3QubmV4dChmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgdXBsb2FkVGVtcGxhdGVEb2N1bWVudChmaWxlOiBGaWxlLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKSB7XG4gICAgY29uc3QgZm9ybWRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBmb3JtZGF0YS5hcHBlbmQoJ2RvY3VtZW50JywgZmlsZSwgZmlsZS5uYW1lKTtcbiAgICBjb25zdCByZXEgPSBuZXcgSHR0cFJlcXVlc3QoJ1BPU1QnLCB0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL2RvY3VtZW50cycsIGZvcm1kYXRhLCB7XG4gICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZVxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmh0dHAucmVxdWVzdChyZXEpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHJlcyA9PiByZXMpLFxuICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgcmV0dXJuIG9ic2VydmFibGVUaHJvd0Vycm9yKGVycik7XG4gICAgICAgIH0pXG4gICAgICApXG4gIH1cblxuICBnZXRUZW1wbGF0ZURvY3VtZW50KHRlbXBsYXRlSWQpIHtcbiAgICB0aGlzLnRlbXBsYXRlRG9jID0gdGhpcy50ZW1wbGF0ZXNTZXJ2aWNlLmdldEFsbFRlbXBsYXRlRG9jdW1lbnRzT2JzZXJ2YWJsZSh0ZW1wbGF0ZUlkKS5waXBlKFxuICAgICAgbWFwKChkb2NzOiBBcnJheTxJVGVtcGxhdGVEb2N1bWVudD4pID0+IHtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZURvYyA9IGRvY3NbMF07XG4gICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlRG9jXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZURvYztcbiAgfVxuXG4gIGdldFRlbXBsYXRlRG9jdW1lbnRGaWxlKHRlbXBsYXRlSWQsIHRlbXBsYXRlRG9jKSB7XG4gICAgaWYgKHRlbXBsYXRlSWQgJiYgdGVtcGxhdGVEb2MpIHtcbiAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc1NlcnZpY2UuZ2V0VGVtcGxhdGVEb2N1bWVudFBERk9ic2VydmFibGUodGVtcGxhdGVJZCwgdGVtcGxhdGVEb2MpLnBpcGUoXG4gICAgICAgIG1hcChwZGYgPT4ge1xuICAgICAgICAgIGNvbnN0IHBkZlVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwocGRmKTtcbiAgICAgICAgICByZXR1cm4gcGRmVXJsO1xuICAgICAgICB9KSlcbiAgICB9XG4gIH1cblxuICBzZXRUZW1wbGF0ZURvY3VtZW50KHRlbXBsYXRlRG9jdW1lbnQpIHtcbiAgICB0aGlzLnRlbXBsYXRlRG9jID0gdGVtcGxhdGVEb2N1bWVudDtcbiAgfVxuXG4gIGFkZFRlbXBsYXRlUGFnZShkb2N1bWVudCwgcGFnZU51bSwgdGVtcGxhdGVJZCkge1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBzZXF1ZW5jZTogcGFnZU51bSxcbiAgICAgIHBhZ2VfbnVtYmVyOiBwYWdlTnVtLFxuICAgICAgZG9jdW1lbnRfaWQ6IGRvY3VtZW50LmlkXG4gICAgfVxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxJUGFnZT4odGhpcy5yRm9ybV9iYWNrZW5kX3VybCsgYC90ZW1wbGF0ZXMvJHt0ZW1wbGF0ZUlkfS9wYWdlc2AsIGJvZHkpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChyZXM6IElQYWdlKSA9PiByZXMpLFxuICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgcmV0dXJuIG9ic2VydmFibGVUaHJvd0Vycm9yKGVycik7XG4gICAgICAgIH0pXG4gICAgICApXG4gIH1cblxuICBhZGRUZW1wbGF0ZVBhZ2VzKGRvY3VtZW50LCBwYWdlTnVtczogbnVtYmVyW10sIHRlbXBsYXRlSWQ6IHN0cmluZykge1xuICAgIHJldHVybiBmcm9tKHBhZ2VOdW1zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKHBhZ2VOdW0gPT4ge1xuICAgICAgICAgIGNvbnN0IHBhZ2UgPSB7XG4gICAgICAgICAgICBzZXF1ZW5jZTogcGFnZU51bSxcbiAgICAgICAgICAgIHBhZ2VfbnVtYmVyOiBwYWdlTnVtLFxuICAgICAgICAgICAgZG9jdW1lbnRfaWQ6IGRvY3VtZW50LmlkXG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gPE9ic2VydmFibGU8SVBhZ2U+PnRoaXMuaHR0cC5wb3N0KHRoaXMuckZvcm1fYmFja2VuZF91cmwrIGAvdGVtcGxhdGVzLyR7dGVtcGxhdGVJZH0vcGFnZXNgLCBwYWdlKS5waXBlKGRlbGF5KDIwMCkpO1xuICAgICAgICB9KVxuICAgICAgKVxuICB9XG5cbiAgZGVsZXRlVGVtcGxhdGVGaWVsZCh0ZW1wbGF0ZTogSVRlbXBsYXRlLCBmaWVsZE5hbWU6IHN0cmluZywgaSwgaik6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmRlbGV0ZTx2b2lkPih0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL2ZpZWxkcy8nICsgZmllbGROYW1lLnRyaW0oKSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmllbGQgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLCB7IG5hbWU6IGZpZWxkTmFtZSB9KTtcbiAgICAgICAgICBjb25zdCByb2xlSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2ZpZWxkSW5kZXhdLnJvbGVfbmFtZSB9KTtcblxuICAgICAgICAgIGlmIChyb2xlSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgY29uc3Qgcm9sZUZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXNbcm9sZUluZGV4XS5maWVsZHMsIHsgbmFtZTogZmllbGROYW1lIH0pO1xuICAgICAgICAgICAgaWYgKHJvbGVGaWVsZEluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZUluZGV4XS5maWVsZHMuc3BsaWNlKHJvbGVGaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLnNwbGljZShmaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUxvY2FsVGVtcGxhdGUodGVtcGxhdGUpO1xuICAgICAgICAgIHRoaXMuc2F2ZVN0YXR1c1N1YmplY3QubmV4dCgnc2F2ZWQnKTtcbiAgICAgICAgICB0aGlzLmNoZWNrRm9yRmllbGRzKHRlbXBsYXRlLnJvbGVzKTtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgZGVsZXRlVGVtcGxhdGVGaWVsZHMoZmllbGROYW1lczogc3RyaW5nW10sIHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICBpZiAoZmllbGROYW1lcyAmJiBmaWVsZE5hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGVtcGxhdGUucGFnZXM7XG4gICAgICBmb3IgKGNvbnN0IGZpZWxkTmFtZSBvZiBmaWVsZE5hbWVzKSB7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgcGFnZXMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICBjb25zdCBmaWVsZEluZGV4ID0gZmluZEluZGV4KHBhZ2VzW3hdLmZpZWxkcywgeyBuYW1lOiBmaWVsZE5hbWUgfSk7XG4gICAgICAgICAgaWYgKGZpZWxkSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGVtcGxhdGUucGFnZXNbeF0uZmllbGRzLnNwbGljZShmaWVsZEluZGV4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuY2hlY2tGb3JGaWVsZHModGVtcGxhdGUucm9sZXMpO1xuICAgIH1cbiAgfVxuXG4gIGFkZFRlbXBsYXRlRmllbGQobmV3RmllbGQ6IElGaWVsZCwgaSwgaiwgdGVtcGxhdGU6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgbmV3RmllbGQubmFtZSA9IG5ld0ZpZWxkLm5hbWUudHJpbSgpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wb3N0PElGaWVsZD4odGhpcy5yRm9ybV9iYWNrZW5kX3VybCsgJy90ZW1wbGF0ZXMvJyArIG5ld0ZpZWxkLnRlbXBsYXRlX2lkICsgJy9maWVsZHMnLCBuZXdGaWVsZClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmllbGQgPT4ge1xuICAgICAgICAgIHRoaXMuZXZlbnRUcmFja2VyLmNyZWF0ZUV2ZW50KHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiAnZG9jdW1lbnQnLFxuICAgICAgICAgICAgYWN0aW9uOiBgZG9jdW1lbnQgJHtmaWVsZC50eXBlfSBmaWVsZCBhZGRlZGAsXG4gICAgICAgICAgICBsYWJlbDogYGRvY3VtZW50IGlkOiAke25ld0ZpZWxkLnRlbXBsYXRlX2lkfWBcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbal0gPSBmaWVsZDtcbiAgICAgICAgICB0aGlzLmNoZWNrRm9yRmllbGRzKHRlbXBsYXRlLnJvbGVzKTtcbiAgICAgICAgICBjb25zdCByb2xlSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogZmllbGQucm9sZV9uYW1lIH0pO1xuICAgICAgICAgIGlmIChyb2xlSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZUluZGV4XVsnZmllbGRzJ10ucHVzaChmaWVsZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMudGVtcGxhdGVTdWJqZWN0Lm5leHQodGVtcGxhdGUpO1xuICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBnZXRUZW1wbGF0ZU93bmVySW5mbyhpZDogc3RyaW5nKTogUHJvbWlzZTx7IHByb2ZpbGVfaWQ6IHN0cmluZywgZW1haWw6IHN0cmluZywgbmFtZTogc3RyaW5nIH0+IHtcbiAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZXNTZXJ2aWNlLmdldFRlbXBsYXRlT3duZXJJbmZvKGlkKTtcbiAgfVxuXG4gIHVwZGF0ZVRlbXBsYXRlRmllbGQodGVtcGxhdGU6IElUZW1wbGF0ZSwgYm9keTogSUZpZWxkLCBvbGROYW1lLCBpLCBqKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBvbGROYW1lID0gb2xkTmFtZS50cmltKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnB1dDxJRmllbGQ+KHRoaXMuckZvcm1fYmFja2VuZF91cmwrICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvZmllbGRzLycgKyBvbGROYW1lLCBib2R5KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChmaWVsZCA9PiB7XG4gICAgICAgICAgdGhpcy5ldmVudFRyYWNrZXIuY3JlYXRlRXZlbnQoe1xuICAgICAgICAgICAgY2F0ZWdvcnk6ICdkb2N1bWVudCcsXG4gICAgICAgICAgICBhY3Rpb246IGBkb2N1bWVudCAke2ZpZWxkLnR5cGV9IGZpZWxkIHVwZGF0ZWRgLFxuICAgICAgICAgICAgbGFiZWw6IGBkb2N1bWVudCBpZDogJHt0ZW1wbGF0ZS5pZH1gXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgZmllbGRJbmRleCA9IGZpbmRJbmRleCh0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHMsIHsgbmFtZTogb2xkTmFtZSB9KTtcbiAgICAgICAgICBpZiAoZmllbGQucGFnZV9zZXF1ZW5jZSAtIDEgIT09IGkpIHtcbiAgICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkcy5zcGxpY2UoZmllbGRJbmRleCwgMSk7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tmaWVsZC5wYWdlX3NlcXVlbmNlIC0gMV0uZmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbZmllbGRJbmRleF0gPSBmaWVsZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgcm9sZUluZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzLCB7IG5hbWU6IGZpZWxkLnJvbGVfbmFtZSB9KTtcbiAgICAgICAgICBpZiAocm9sZUluZGV4ID49IDApIHtcbiAgICAgICAgICAgIHRlbXBsYXRlID0gdGhpcy51cGRhdGVSb2xlRmllbGQodGVtcGxhdGUsIGZpZWxkLCByb2xlSW5kZXgsIG9sZE5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICB0aGlzLnNhdmVTdGF0dXNTdWJqZWN0Lm5leHQoJ3NhdmVkJyk7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHVwZGF0ZVJvbGVGaWVsZCh0ZW1wbGF0ZTogSVRlbXBsYXRlLCB1cGRhdGVkX2ZpZWxkLCByb2xlX2luZGV4LCBvbGRfbmFtZSkge1xuICAgIGNvbnN0IGZpZWxkX2luZGV4ID0gZmluZEluZGV4KHRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdLmZpZWxkcywgeyBuYW1lOiBvbGRfbmFtZSB9KTtcbiAgICBpZiAoZmllbGRfaW5kZXggPj0gMCkge1xuICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0uZmllbGRzW2ZpZWxkX2luZGV4XSA9IHVwZGF0ZWRfZmllbGQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRlbXBsYXRlLnJvbGVzW3JvbGVfaW5kZXhdLmZpZWxkcy5wdXNoKHVwZGF0ZWRfZmllbGQpO1xuICAgIH1cbiAgICByZXR1cm4gdGVtcGxhdGU7XG4gIH1cblxuICB1cGRhdGVEcm9wZG93bkZpZWxkKHRlbXBsYXRlOiBJVGVtcGxhdGUsIGJvZHk6IGFueSwgb2xkTmFtZSwgaSwgaik6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgb2xkTmFtZSA9IG9sZE5hbWUudHJpbSgpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wdXQ8YW55Pih0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL2ZpZWxkcy8nICsgb2xkTmFtZSwgYm9keSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmllbGQgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkSW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLCB7IG5hbWU6IG9sZE5hbWUgfSk7XG4gICAgICAgICAgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2ZpZWxkSW5kZXhdID0gZmllbGQ7XG4gICAgICAgICAgdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgdGhpcy5zYXZlU3RhdHVzU3ViamVjdC5uZXh0KCdzYXZlZCcpO1xuICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBkZWxldGVTZXF1ZW5jZSh0ZW1wbGF0ZV9pZDogc3RyaW5nLCBzZXF1ZW5jZV9udW1iZXI6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc1NlcnZpY2UuZGVsZXRlU2VxdWVuY2UodGVtcGxhdGVfaWQsIHNlcXVlbmNlX251bWJlcik7XG4gIH1cblxuICBwcmVwYXJlRmllbGREdXBsaWNhdGlvbihmaWVsZCkge1xuICAgIHRoaXMuZHVwbGljYXRlRmllbGRTdWJqZWN0Lm5leHQoZmllbGQpO1xuICB9O1xuXG4gIGNoZWNrRm9yRmllbGRzKHJvbGVzKSB7XG4gICAgbGV0IGhhc0ZpZWxkcyA9IHRydWU7XG4gICAgaWYgKHJvbGVzICYmIHJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZvciAobGV0IHJvbGUgb2Ygcm9sZXMpIHtcbiAgICAgICAgaWYgKHJvbGUgJiYgcm9sZS50eXBlID09PSAnc2lnbmVyJyAmJiByb2xlLmZpZWxkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBoYXNGaWVsZHMgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBoYXNGaWVsZHMgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5oYXNGaWVsZHMgPSBoYXNGaWVsZHM7XG4gICAgdGhpcy5oYXNGaWVsZHNTdWJqZWN0Lm5leHQodGhpcy5oYXNGaWVsZHMpO1xuICB9XG5cbiAgY3JlYXRlU25hY2tCYXIodGl0bGU6IHN0cmluZywgYnV0dG9uVGl0bGUgPSAnT0snKTogdm9pZCB7XG4gIC8vICAgbGV0IHNuYWNrYmFyQ29uZmlnOiBNYXRTbmFja0JhckNvbmZpZ1xuICAvLyAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCA+PSA5MjApIHtcbiAgLy8gICAgIHNuYWNrYmFyQ29uZmlnID0ge1xuICAvLyAgICAgICB2ZXJ0aWNhbFBvc2l0aW9uOiAnYm90dG9tJyxcbiAgLy8gICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uOiAnbGVmdCcsXG4gIC8vICAgICAgIGR1cmF0aW9uOiA1MDAwXG4gIC8vICAgICB9XG4gIC8vICAgfSBlbHNlIHtcbiAgLy8gICAgIHNuYWNrYmFyQ29uZmlnID0ge1xuICAvLyAgICAgICB2ZXJ0aWNhbFBvc2l0aW9uOiAndG9wJyxcbiAgLy8gICAgICAgZHVyYXRpb246IDUwMDBcbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vICAgdGhpcy5zbmFja2Jhci5vcGVuKHRpdGxlLCBidXR0b25UaXRsZSwgc25hY2tiYXJDb25maWcpO1xuICB9XG5cbiAgZWRpdERvY3NVcmwodGVtcGxhdGVJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgZWRpdERvY3NQYWdlVXJsID0gYC9idWlsZGVyLyR7dGVtcGxhdGVJZH0vZG9jc2A7XG4gICAgcmV0dXJuIGVkaXREb2NzUGFnZVVybDtcbiAgfVxuXG4gIGVkaXRSb2xlc1VybCh0ZW1wbGF0ZUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBlZGl0Um9sZXNQYWdlVXJsID0gYC9idWlsZGVyLyR7dGVtcGxhdGVJZH0vcm9sZXNgO1xuICAgIHJldHVybiBlZGl0Um9sZXNQYWdlVXJsO1xuICB9XG5cbiAgZWRpdFRlbXBsYXRlVXJsKHRlbXBsYXRlSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGVkaXRQYWdlVXJsID0gYC9idWlsZGVyLyR7dGVtcGxhdGVJZH0vZmllbGRzYFxuICAgIHJldHVybiBlZGl0UGFnZVVybDtcbiAgfVxuXG4gIHByZXZpZXdUZW1wbGF0ZVVybCh0ZW1wbGF0ZUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXZpZXdUZW1wbGF0ZVVybCA9IGAvZG9jdW1lbnQvJHt0ZW1wbGF0ZUlkfWA7XG4gICAgcmV0dXJuIHJldmlld1RlbXBsYXRlVXJsO1xuICB9XG5cbiAgYWRkRmllbGRSb2xlKHRlbXBsYXRlSWQ6IHN0cmluZywgZmllbGRJZDogc3RyaW5nLCByb2xlSWQ6IHN0cmluZywgaSwgaik6IFByb21pc2U8RmllbGRSb2xlPiB7XG4gICAgY29uc3QgZmllbGRSb2xlSW5mbyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGZpZWxkX2lkOiBmaWVsZElkLFxuICAgICAgcm9sZV9pZDogcm9sZUlkXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8RmllbGRSb2xlPih0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlLycgKyB0ZW1wbGF0ZUlkICsgJy9maWVsZF9yb2xlJywgZmllbGRSb2xlSW5mbykudG9Qcm9taXNlKCkudGhlbihmaWVsZFJvbGUgPT4ge1xuICAgICAgICByZXR1cm4gZmllbGRSb2xlO1xuICAgICAgfSk7XG4gIH1cblxuICBhZGRSb2xlKHJvbGU6IElSb2xlIHwgSVJvbGVbXSwgdGVtcGxhdGU6IElUZW1wbGF0ZSk6IE9ic2VydmFibGU8SVRlbXBsYXRlPiB7XG4gICAgY29uc3QgdGVtcGxhdGVCYWNrZW5kID0gdGhpcy5yRm9ybV9iYWNrZW5kX3VybCsgJy90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlLmlkICsgJy9yb2xlcyc7XG4gICAgdGhpcy5yb2xlcyA9IFtdO1xuICAgIHRoaXMucm9sZXMgPSB0aGlzLnJvbGVzLmNvbmNhdChyb2xlKTtcbiAgICBjb25zdCByb2xlUmVxdWVzdHMgPSBbXTtcbiAgICB0aGlzLnJvbGVzLmZvckVhY2gocm9sZSA9PiB7XG4gICAgICByb2xlUmVxdWVzdHMucHVzaCh0aGlzLmh0dHAucG9zdCh0ZW1wbGF0ZUJhY2tlbmQsIHJvbGUpKTtcbiAgICB9KVxuXG4gICAgaWYgKHRoaXMucm9sZXMgJiYgdGhpcy5yb2xlcy5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gZm9ya0pvaW4ocm9sZVJlcXVlc3RzKS5waXBlKFxuICAgICAgICBtYXAoc2F2ZWRSb2xlcyA9PiB7XG4gICAgICAgICAgc2F2ZWRSb2xlcy5jb25jYXQoc2F2ZWRSb2xlcyBhcyBJUm9sZVtdKTtcbiAgICAgICAgICBpZiAoIXRlbXBsYXRlWydyb2xlcyddKSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZVsncm9sZXMnXSA9IDxJUm9sZVtdPltdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBzYXZlZFJvbGVzV2l0aEZpZWxkcyA9IHNhdmVkUm9sZXMubWFwKG5ld1JvbGUgPT4ge1xuICAgICAgICAgICAgbmV3Um9sZVsnZmllbGRzJ10gPSBbXTtcbiAgICAgICAgICAgIHJldHVybiBuZXdSb2xlO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRlbXBsYXRlWydyb2xlcyddID0gdGVtcGxhdGVbJ3JvbGVzJ10uY29uY2F0KHNhdmVkUm9sZXNXaXRoRmllbGRzKTtcbiAgICAgICAgICB0aGlzLnJlY2lwaWVudHMgPSB0aGlzLnNvcnRSb2xlcyh0ZW1wbGF0ZSk7XG4gICAgICAgICAgdGhpcy5yb2xlcyA9IHRoaXMucmVjaXBpZW50cztcbiAgICAgICAgICB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICB0aGlzLnJlY2lwaWVudHNTdWJqZWN0Lm5leHQodGhpcy5yZWNpcGllbnRzKTtcbiAgICAgICAgICB0aGlzLnJlY2lwaWVudHM7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlXG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignQ291bGRuXFwndCBzYXZlIGFsbCB0aGUgcm9sZXMnKTtcbiAgICAgICAgICByZXR1cm4gZXJyO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG9mKHRlbXBsYXRlKTtcbiAgICB9XG4gIH1cblxuICBhZGRDaGVja2JveEdyb3VwKGZpZWxkKSB7XG4gICAgdGhpcy5uZXdPcHRpb25TdWJqZWN0Lm5leHQoXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdjaGVja2JveF9ncm91cCcsXG4gICAgICAgIHBhZ2Vfc2VxdWVuY2U6IGZpZWxkLnBhZ2Vfc2VxdWVuY2UsXG4gICAgICAgIGZpZWxkX25hbWU6IGZpZWxkLm5hbWUsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFkZFJhZGlvR3JvdXAoZmllbGQpIHtcbiAgICB0aGlzLm5ld09wdGlvblN1YmplY3QubmV4dChcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ3JhZGlvX2J1dHRvbl9ncm91cCcsXG4gICAgICAgIHBhZ2Vfc2VxdWVuY2U6IGZpZWxkLnBhZ2Vfc2VxdWVuY2UsXG4gICAgICAgIGZpZWxkX25hbWU6IGZpZWxkLm5hbWUsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGdldFJvbGVzSW5TZXF1ZW5jZShyb2xlcykge1xuICAgIGNvbnN0IHJvbGVzSW5TZXF1ZW5jZSA9IFtdO1xuICAgIGZvciAobGV0IHJvbGVJbmRleCA9IDA7IHJvbGVJbmRleCA8IHJvbGVzLmxlbmd0aDsgcm9sZUluZGV4KyspIHtcbiAgICAgIGNvbnN0IHNlcXVlbmNlSW5kZXggPSByb2xlc1tyb2xlSW5kZXhdWydzZXF1ZW5jZSddIC0gMTtcbiAgICAgIGNvbnN0IHJvbGUgPSB7IC4uLnJvbGVzW3JvbGVJbmRleF0gfTtcbiAgICAgIHJvbGVbJ3N0eWxlJ10gPSB7XG4gICAgICAgIGJhY2tncm91bmRDb2xvcjogYCR7dGhpcy5nZXRSb2xlQ29sb3Iocm9sZS5uYW1lLCByb2xlSW5kZXgpfWBcbiAgICAgIH07XG4gICAgICBpZiAoIXJvbGVzSW5TZXF1ZW5jZVtzZXF1ZW5jZUluZGV4XSkge1xuICAgICAgICByb2xlc0luU2VxdWVuY2Vbc2VxdWVuY2VJbmRleF0gPSBbcm9sZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByb2xlc0luU2VxdWVuY2Vbc2VxdWVuY2VJbmRleF0ucHVzaChyb2xlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5udW1iZXJPZlNlcXVlbmNlU3ViamVjdC5uZXh0KHJvbGVzSW5TZXF1ZW5jZS5sZW5ndGgpO1xuICAgIHRoaXMubnVtYmVyT2ZSb2xlc1N1YmplY3QubmV4dChyb2xlcy5sZW5ndGgpO1xuICAgIHJldHVybiByb2xlc0luU2VxdWVuY2VcbiAgfVxuXG4gIGRlbGV0ZVJvbGUocm9sZU5hbWUsIHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZSh0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL3JvbGVzLycgKyByb2xlTmFtZSlcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZW1vdmUodGVtcGxhdGUucm9sZXMsIChyb2xlOiBJUm9sZSkgPT4ge1xuICAgICAgICAgIHRoaXMucmVjaXBpZW50cyA9IHRoaXMuc29ydFJvbGVzKHRlbXBsYXRlKTtcbiAgICAgICAgICBpZiAocm9sZS5uYW1lID09PSByb2xlTmFtZSkge1xuICAgICAgICAgICAgY29uc3QgZmllbGRzID0gcm9sZS5maWVsZHM7XG4gICAgICAgICAgICBjb25zdCBmaWVsZE5hbWVzID0gW107XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIGZpZWxkcykge1xuICAgICAgICAgICAgICBmaWVsZE5hbWVzLnB1c2goZmllbGQubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmRlbGV0ZVRlbXBsYXRlRmllbGRzKGZpZWxkTmFtZXMsIHRlbXBsYXRlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy50ZW1wbGF0ZVN1YmplY3QubmV4dCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgdGhpcy5yZWNpcGllbnRzU3ViamVjdC5uZXh0KHRoaXMucmVjaXBpZW50cyk7XG4gICAgICAgICAgcmV0dXJuIHJvbGUubmFtZSA9PT0gcm9sZU5hbWVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGRlbGV0ZVJvbGVzKHJvbGVOYW1lczogQXJyYXk8c3RyaW5nPiwgdGVtcGxhdGU6IElUZW1wbGF0ZSkge1xuICAgIGNvbnN0IGRlbGV0ZUNhbGxzID0gW107XG4gICAgcm9sZU5hbWVzLmZvckVhY2gocm9sZV9uYW1lID0+IHtcbiAgICAgIHRlbXBsYXRlID0ge1xuICAgICAgICAuLi50ZW1wbGF0ZSxcbiAgICAgICAgcm9sZXM6IHRlbXBsYXRlLnJvbGVzLmZpbHRlcihyb2xlID0+IHJvbGUubmFtZSAhPT0gcm9sZV9uYW1lKVxuICAgICAgfVxuICAgICAgZGVsZXRlQ2FsbHMucHVzaCh0aGlzLmh0dHAuZGVsZXRlKHRoaXMuckZvcm1fYmFja2VuZF91cmwrICcvdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZS5pZCArICcvcm9sZXMvJyArIHJvbGVfbmFtZSkpXG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcmtKb2luKGRlbGV0ZUNhbGxzKS5waXBlKFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdDb3VsZG5cXCd0IGRlbGV0ZSBhbGwgdGhlIHJvbGVzJyk7XG4gICAgICAgIHJldHVybiBlcnI7XG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIHVwZGF0ZVJvbGVzKHJvbGVzLCB0ZW1wbGF0ZTogSVRlbXBsYXRlKTogT2JzZXJ2YWJsZTxJVGVtcGxhdGU+IHtcbiAgICBjb25zdCB1cGRhdGVDYWxscyA9IFtdO1xuICAgIHJvbGVzLmZvckVhY2gocm9sZSA9PiB7XG4gICAgICBjb25zdCBib2R5ID0ge1xuICAgICAgICB0ZW1wbGF0ZV9pZDogdGVtcGxhdGUuaWQsXG4gICAgICAgIG5hbWU6IHJvbGUubmFtZS50cmltKCksXG4gICAgICAgIGZ1bGxfbmFtZTogcm9sZS5mdWxsX25hbWUsXG4gICAgICAgIGVtYWlsOiByb2xlLmVtYWlsLFxuICAgICAgICBzZXF1ZW5jZTogcm9sZS5zZXF1ZW5jZSxcbiAgICAgICAgdHlwZTogcm9sZS50eXBlLFxuICAgICAgICBkZWxlZ2F0b3I6IHJvbGUuZGVsZWdhdG9yLFxuICAgICAgICBtZXNzYWdlOiByb2xlLm1lc3NhZ2UsXG4gICAgICAgIHBob25lOiByb2xlLnBob25lXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJvbGVfaW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogcm9sZS5vbGRfbmFtZSB9KTtcbiAgICAgIGlmIChyb2xlX2luZGV4ID49IDApIHtcbiAgICAgICAgdGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0gPSB7XG4gICAgICAgICAgLi4udGVtcGxhdGUucm9sZXNbcm9sZV9pbmRleF0sXG4gICAgICAgICAgdGVtcGxhdGVfaWQ6IHRlbXBsYXRlLmlkLFxuICAgICAgICAgIG5hbWU6IHJvbGUubmFtZS50cmltKCksXG4gICAgICAgICAgZnVsbF9uYW1lOiByb2xlLmZ1bGxfbmFtZSxcbiAgICAgICAgICBlbWFpbDogcm9sZS5lbWFpbCxcbiAgICAgICAgICBzZXF1ZW5jZTogcm9sZS5zZXF1ZW5jZSxcbiAgICAgICAgICB0eXBlOiByb2xlLnR5cGUsXG4gICAgICAgICAgZGVsZWdhdG9yOiByb2xlLmRlbGVnYXRvcixcbiAgICAgICAgICBtZXNzYWdlOiByb2xlLm1lc3NhZ2UsXG4gICAgICAgICAgcGhvbmU6IHJvbGUucGhvbmVcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5ldmVudFRyYWNrZXIuY3JlYXRlRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogJ2RvY3VtZW50JyxcbiAgICAgICAgYWN0aW9uOiAnZG9jdW1lbnQgcm9sZSB1cGRhdGVkJyxcbiAgICAgICAgbGFiZWw6IGBkb2N1bWVudCBpZDogJHt0ZW1wbGF0ZS5pZH1gXG4gICAgICB9KTtcbiAgICAgIHVwZGF0ZUNhbGxzLnB1c2godGhpcy5odHRwLnB1dCh0aGlzLnJGb3JtX2JhY2tlbmRfdXJsKyAnL3RlbXBsYXRlcy8nICsgdGVtcGxhdGUuaWQgKyAnL3JvbGVzLycgKyByb2xlLm9sZF9uYW1lLCBib2R5KSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcmtKb2luKHVwZGF0ZUNhbGxzKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkblxcJ3Qgc2F2ZSBhbGwgdGhlIHJvbGVzJyk7XG4gICAgICAgICAgcmV0dXJuIGVycjtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cbiAgc29ydFJvbGVzKHRlbXBsYXRlOiBJVGVtcGxhdGUpOiBJUm9sZVtdIHtcbiAgICBpZiAodGVtcGxhdGUucm9sZXMubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IHJvbGVzID0gdGVtcGxhdGUucm9sZXMuc29ydCgoYTogSVJvbGUsIGI6IElSb2xlKSA9PiB7XG4gICAgICBpZiAoYS5zZXF1ZW5jZSA9PT0gYi5zZXF1ZW5jZSkge1xuICAgICAgICByZXR1cm4gYS5uYW1lLnRvTG93ZXJDYXNlKCkgPCBiLm5hbWUudG9Mb3dlckNhc2UoKSA/IC0xIDogYS5uYW1lLnRvTG93ZXJDYXNlKCkgPiBiLm5hbWUudG9Mb3dlckNhc2UoKSA/IDEgOiAwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGEuc2VxdWVuY2UgLSBiLnNlcXVlbmNlO1xuICAgIH0pO1xuXG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCByb2xlcy5sZW5ndGg7IHgrKykge1xuICAgICAgcm9sZXNbeF1bJ3JnYmEnXSA9IGdldFJHQkEoeCk7XG4gICAgfVxuICAgIHRlbXBsYXRlLnJvbGVzID0gcm9sZXM7XG5cbiAgICByZXR1cm4gcm9sZXM7XG4gIH1cblxuICBnZXRSb2xlQ29sb3IobmFtZSwgaW5kZXg/LCB0ZW1wbGF0ZT86IElUZW1wbGF0ZSkge1xuICAgIGlmIChpbmRleCAhPT0gbnVsbCAmJiBpbmRleCA+IC0xKSB7XG4gICAgICByZXR1cm4gZ2V0UkdCQShpbmRleCk7XG4gICAgfSBlbHNlIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgaWYgKHRlbXBsYXRlLnJvbGVzICYmIHRlbXBsYXRlLnJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaW5kZXggPSBmaW5kSW5kZXgodGVtcGxhdGUucm9sZXMsIHsgbmFtZTogbmFtZSB9KTtcbiAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucm9sZXNbaW5kZXhdLnJnYmEgPyB0ZW1wbGF0ZS5yb2xlc1tpbmRleF0ucmdiYSA6IGdldFJHQkEoaW5kZXgpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmFtZVRvUkdCQShuYW1lKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5hbWVUb1JHQkEobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlRnVsbE5hbWUocm9sZTogSVJvbGUsIHRlbXBsYXRlOiBJVGVtcGxhdGUpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlbXBsYXRlLnBhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICBpZiAodGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2pdLnR5cGUgPT09ICdwbGFjZWhvbGRlcicgJiYgdGVtcGxhdGUucGFnZXNbaV0uZmllbGRzW2pdLnNldHRpbmdbJ3R5cGUnXSA9PT0gJ2Z1bGxfbmFtZScpIHtcbiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbal0uc2V0dGluZ1sncmVzdWx0J10gIT09IHJvbGUuZnVsbF9uYW1lICYmXG4gICAgICAgICAgICAgIHRlbXBsYXRlLnBhZ2VzW2ldLmZpZWxkc1tqXS5yb2xlX25hbWUgPT09IHJvbGUubmFtZSkge1xuICAgICAgICAgICAgICB0ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbal0uc2V0dGluZ1sncmVzdWx0J10gPSByb2xlLmZ1bGxfbmFtZTtcbiAgICAgICAgICAgICAgY29uc3QgdXBkYXRlZEZpZWxkID0geyAuLi50ZW1wbGF0ZS5wYWdlc1tpXS5maWVsZHNbal0gfTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVUZW1wbGF0ZUZpZWxkKHRlbXBsYXRlLCB1cGRhdGVkRmllbGQsIHVwZGF0ZWRGaWVsZC5uYW1lLCBpLCBqKS50b1Byb21pc2UoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3ViamVjdC5uZXh0KHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2V0QWN0aXZlRmllbGRJbmRleChhY3RpdmVGaWVsZEluZGV4KSB7XG4gICAgdGhpcy5hY3RpdmVGaWVsZEluZGV4ID0gYWN0aXZlRmllbGRJbmRleDtcbiAgICB0aGlzLmFjdGl2ZUZpZWxkSW5kZXhTdWJqZWN0Lm5leHQodGhpcy5hY3RpdmVGaWVsZEluZGV4KTtcbiAgfVxuXG4gIGFzeW5jIGF1dG9BZGRTaWduZXIodGVtcGxhdGU6IElUZW1wbGF0ZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCByZWNpcGllbnRzID0gYXdhaXQgdGhpcy5hZGRSb2xlKHsgbmFtZTogJ1NpZ25lciAxJywgdHlwZTogJ3NpZ25lcicsIHNlcXVlbmNlOiAxIH0gYXMgSVJvbGUsIHRlbXBsYXRlKS50b1Byb21pc2UoKTtcbiAgICAgIHRoaXMuYWN0aXZlUmVjaXBpZW50U3ViamVjdC5uZXh0KHJlY2lwaWVudHNbMF0pO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSwgNTAwKTtcbiAgICB9KTtcbiAgfVxuXG4gIG9wZW5UZW1wbGF0ZSh0ZW1wbGF0ZTogSVRlbXBsYXRlKSB7XG4gICAgaWYgKHRoaXMuY2FuVXNlclByZXZpZXcodGVtcGxhdGUpKSB7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbYGRvY3VtZW50LyR7dGVtcGxhdGUuaWR9YF0pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jYW5Vc2VyRWRpdCh0ZW1wbGF0ZSkpIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtgYnVpbGRlci8ke3RlbXBsYXRlLmlkfS9maWVsZHNgXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc25hY2tiYXJTZXJ2aWNlLm9wZW4oYFRlbXBsYXRlIGlzIGluIGJ1aWxkIG1vZGUsIGFuZCBub3QgcmVhZHkgZm9yIHVzZS4gIFBsZWFzZSBjaGVjayBiYWNrIHNvb24uYClcbiAgICB9XG4gIH1cblxuICBjYW5Vc2VyRWRpdCh0ZW1wbGF0ZTogSVRlbXBsYXRlKSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB0aGlzLnRlbXBsYXRlR3VhcmQuY2FuUGVyZm9ybUFjdGlvbihUZW1wbGF0ZUFjdGlvbnMuV1JJVEUsIHRlbXBsYXRlKTtcbiAgICByZXR1cm4gcmVzcG9uc2VbJ2NhblBlcmZvcm0nXVxuICB9XG5cbiAgY2FuVXNlclByZXZpZXcodGVtcGxhdGU6IElUZW1wbGF0ZSkge1xuICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSAodGhpcy50ZW1wbGF0ZUd1YXJkLmNhblBlcmZvcm1BY3Rpb24oVGVtcGxhdGVBY3Rpb25zLlJFQUQsIHRlbXBsYXRlKSkuY2FuUGVyZm9ybTtcbiAgICBsZXQgY2FuUHJldmlldztcbiAgICBjb25zdCBzaWduZXJzID0gZmlsdGVyKHRlbXBsYXRlLnJvbGVzLCB7IHR5cGU6ICdzaWduZXInIH0pO1xuICAgIGNhblByZXZpZXcgPSBzaWduZXJzICYmIHNpZ25lcnMubGVuZ3RoID4gMDtcbiAgICBmb3IgKGNvbnN0IHNpZ25lciBvZiBzaWduZXJzKSB7XG4gICAgICBjYW5QcmV2aWV3ID0gc2lnbmVyWydmaWVsZHMnXSAmJiBzaWduZXJbJ2ZpZWxkcyddLmxlbmd0aCA+IDA7XG4gICAgfVxuICAgIHJldHVybiBoYXNQZXJtaXNzaW9uICYmIGNhblByZXZpZXc7XG4gIH1cbn1cbiJdfQ==