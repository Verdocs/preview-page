/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { getRGBA, nameToRGBA } from '@verdocs/sdk';
import { findIndex } from 'lodash';
import { getLetterSpacing } from './viewer-fields';
import { getUIFieldStyling } from './conversion';
/**
 * @param {?} pages
 * @param {?} pdfPages
 * @return {?}
 */
export function setRatio(pages, pdfPages) {
    for (let i = 0; i < pages.length; i++) {
        for (let j = 0; j < pages[i].fields.length; j++) {
            if (pages[i].fields[j]) {
                pages[i].fields[j]['ratio'] = {
                    x: pdfPages[i].xRatio,
                    y: pdfPages[i].yRatio
                };
            }
        }
    }
    return pages;
}
/**
 * @param {?} pages
 * @param {?} roles
 * @param {?} pdfPages
 * @param {?} browserType
 * @return {?}
 */
export function constructPages(pages, roles, pdfPages, browserType) {
    if (pages && pages.length > 0) {
        /** @type {?} */
        let fieldPages = new Array(pages.length);
        for (let i = 0; i < pages.length; i++) {
            fieldPages[i] = { fields: [] };
            for (let j = 0; j < pages[i].fields.length; j++) {
                if (pages[i].fields[j]['setting'] && pages[i].fields[j]['setting']['options'] &&
                    pages[i].fields[j]['setting']['options'].length > 0 && (pages[i].fields[j]['type'] === 'checkbox_group') ||
                    pages[i].fields[j]['type'] === 'radio_button_group') {
                    /** @type {?} */
                    const groupFields = constructGroupFields(pages, i, j, roles, pdfPages, fieldPages, browserType);
                    fieldPages[i].fields.concat(groupFields);
                }
                else {
                    /** @type {?} */
                    const fieldCopy = Object.assign({}, pages[i].fields[j]);
                    /** @type {?} */
                    const copyIndex = findIndex(fieldPages[i].fields, { name: fieldCopy.name });
                    fieldCopy['originalIndex'] = j;
                    if (fieldCopy.type !== 'checkbox_group' && fieldCopy.type !== 'radio_button_group') {
                        fieldCopy['initialStyle'] = generateInitialStyle(fieldCopy, roles, browserType);
                        fieldCopy['style'] = generateStyle(fieldCopy, pdfPages);
                    }
                    if (fieldCopy.type === 'checkbox' || fieldCopy.type === 'checkbox_group' || fieldCopy.type === 'radio_button_group') {
                        fieldCopy['checkboxStyle'] = generateGroupLabel(i, fieldCopy.role_name, roles, pdfPages);
                    }
                    if (copyIndex < 0) {
                        fieldPages[i].fields[fieldPages[i].fields.length] = fieldCopy;
                    }
                }
            }
        }
        return fieldPages;
    }
    else {
        return [];
    }
}
/**
 * @param {?} pages
 * @param {?} i
 * @param {?} j
 * @param {?} roles
 * @param {?} pdfPages
 * @param {?} fieldPages
 * @param {?} browserType
 * @return {?}
 */
export function constructGroupFields(pages, i, j, roles, pdfPages, fieldPages, browserType) {
    /** @type {?} */
    let k = 0;
    /** @type {?} */
    const optionsLength = pages[i].fields[j]['setting']['options'].length;
    while (k < optionsLength) {
        /** @type {?} */
        const fieldCopy = Object.assign({}, pages[i].fields[j]);
        /** @type {?} */
        const options = pages[i].fields[j]['setting']['options'][k];
        fieldCopy.setting['x'] = options.x;
        fieldCopy.setting['y'] = options.y;
        if (fieldCopy.type === 'checkbox_group') {
            fieldCopy.setting['checked'] = options.checked;
        }
        else {
            fieldCopy.setting['selected'] = options.selected;
        }
        fieldCopy['initialStyle'] = generateInitialStyle(fieldCopy, roles, browserType);
        fieldCopy['style'] = generateStyle(fieldCopy, pdfPages);
        fieldCopy['checkboxStyle'] = generateGroupLabel(i, fieldCopy.role_name, roles, pdfPages);
        fieldCopy['originalIndex'] = j;
        fieldCopy['optionIndex'] = k;
        fieldCopy['optionId'] = options.id;
        /** @type {?} */
        const copyIndex = findIndex(fieldPages[i].fields, { optionIndex: fieldCopy.optionIndex, name: fieldCopy.name });
        if (copyIndex < 0) {
            fieldPages[i].fields[fieldPages[i].fields.length] = fieldCopy;
        }
        k++;
    }
    return fieldPages;
}
/**
 * @param {?} field
 * @param {?} roles
 * @param {?} browserType
 * @return {?}
 */
export function generateInitialStyle(field, roles, browserType) {
    /** @type {?} */
    const fontSize = 9.5;
    /** @type {?} */
    const setting = field.setting;
    /** @type {?} */
    const role_name = field.role_name;
    /** @type {?} */
    const initialStyle = {
        height: '100%',
        width: '100%',
        backgroundColor: getRoleColor(role_name, roles),
        letterSpacing: null,
        fontSize: null
    };
    field['initialStyle'] = initialStyle;
    switch (field.type) {
        case 'textbox':
        case 'textarea':
            field['initialStyle']['letterSpacing'] = convertToUIRatio(getLetterSpacing(browserType), field['ratio'].x) + 'px';
        case 'signature':
        case 'initial':
        case 'date':
        case 'dropdown':
            field['initialStyle']['fontSize'] = convertToUIRatio(fontSize, field['ratio'].x) + 'px';
            break;
        case 'timestamp':
            field['initialStyle']['fontSize'] = convertToUIRatio(8.5, field['ratio'].x) + 'px';
            break;
        case 'attachment':
        case 'payment':
            field['initialStyle']['height'] = '24px';
            field['initialStyle']['mat-icon'] = {
                position: 'absolute',
                top: 0,
                left: 0,
                height: '24px',
                width: '24px',
                lineHeight: '24px',
                fontSize: '18px'
            };
            break;
        default:
            break;
    }
    if (setting.leading && setting.leading > 0) {
        field.initialStyle['line-height'] = convertToUIRatio(setting.leading + .11395, field['ratio'].y) + 'px';
    }
    return field.initialStyle;
}
/**
 * @param {?} field
 * @param {?} pdfPages
 * @return {?}
 */
export function generateStyle(field, pdfPages) {
    return getUIFieldStyling(field);
}
/**
 * @param {?} i
 * @param {?} role_name
 * @param {?} roles
 * @param {?} pdfPages
 * @return {?}
 */
export function generateGroupLabel(i, role_name, roles, pdfPages) {
    return {
        position: 'absolute',
        top: 0,
        left: 0,
        height: '13.5px',
        width: '13.5px',
        backgroundColor: getRoleColor(role_name, roles),
        border: '2px solid #777'
    };
}
/**
 * @param {?} name
 * @param {?} roles
 * @param {?=} index
 * @return {?}
 */
export function getRoleColor(name, roles, index) {
    if (index) {
        return getRGBA(index);
    }
    else if (roles && roles.length > 0) {
        index = findIndex(roles, { name: name });
        if (index >= 0) {
            return roles[index].rgba ? roles[index].rgba : getRGBA(index);
        }
        else {
            return nameToRGBA(name);
        }
    }
    else {
        return nameToRGBA(name);
    }
}
/**
 * @param {?} value
 * @param {?} ratio
 * @return {?}
 */
export function convertToUIRatio(value, ratio) {
    return value * ratio;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci1maWVsZHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdmVyZG9jcy9lc3NlbnRpYWxzLyIsInNvdXJjZXMiOlsibGliL2Z1bmN0aW9ucy9idWlsZGVyLWZpZWxkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNuQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxjQUFjLENBQUM7Ozs7OztBQUVqRCxNQUFNLFVBQVUsUUFBUSxDQUFDLEtBQUssRUFBRSxRQUFRO0lBQ3RDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMvQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RCLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUc7b0JBQzVCLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTtvQkFDckIsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNO2lCQUN0QixDQUFDO2FBQ0g7U0FDRjtLQUNGO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDOzs7Ozs7OztBQUVELE1BQU0sVUFBVSxjQUFjLENBQUMsS0FBSyxFQUFFLEtBQUssRUFB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QyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMvRDthQUFNO1lBQ0wsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekI7S0FDRjtTQUFNO1FBQ0wsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekI7QUFDSCxDQUFDOzs7Ozs7QUFFRCxNQUFNLFVBQVUsZ0JBQWdCLENBQUMsS0FBYSxFQUFFLEtBQUs7SUFDbkQsT0FBTyxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRSR0JBLCBuYW1lVG9SR0JBIH0gZnJvbSAnQHZlcmRvY3Mvc2RrJztcbmltcG9ydCB7IGZpbmRJbmRleCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBnZXRMZXR0ZXJTcGFjaW5nIH0gZnJvbSAnLi92aWV3ZXItZmllbGRzJztcbmltcG9ydCB7IGdldFVJRmllbGRTdHlsaW5nIH0gZnJvbSAnLi9jb252ZXJzaW9uJztcblxuZXhwb3J0IGZ1bmN0aW9uIHNldFJhdGlvKHBhZ2VzLCBwZGZQYWdlcykge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCBwYWdlc1tpXS5maWVsZHMubGVuZ3RoOyBqKyspIHtcbiAgICAgIGlmIChwYWdlc1tpXS5maWVsZHNbal0pIHtcbiAgICAgICAgcGFnZXNbaV0uZmllbGRzW2pdWydyYXRpbyddID0ge1xuICAgICAgICAgIHg6IHBkZlBhZ2VzW2ldLnhSYXRpbyxcbiAgICAgICAgICB5OiBwZGZQYWdlc1tpXS55UmF0aW9cbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhZ2VzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3RydWN0UGFnZXMocGFnZXMsIHJvbGVzLCBwZGZQYWdlcywgYnJvd3NlclR5cGUpIHtcbiAgaWYgKHBhZ2VzICYmIHBhZ2VzLmxlbmd0aCA+IDApIHtcbiAgICBsZXQgZmllbGRQYWdlcyA9IG5ldyBBcnJheShwYWdlcy5sZW5ndGgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZpZWxkUGFnZXNbaV0gPSB7IGZpZWxkczogW10gfVxuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwYWdlc1tpXS5maWVsZHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgaWYgKHBhZ2VzW2ldLmZpZWxkc1tqXVsnc2V0dGluZyddICYmIHBhZ2VzW2ldLmZpZWxkc1tqXVsnc2V0dGluZyddWydvcHRpb25zJ10gJiZcbiAgICAgICAgICBwYWdlc1tpXS5maWVsZHNbal1bJ3NldHRpbmcnXVsnb3B0aW9ucyddLmxlbmd0aCA+IDAgJiYgKHBhZ2VzW2ldLmZpZWxkc1tqXVsndHlwZSddID09PSAnY2hlY2tib3hfZ3JvdXAnKSB8fFxuICAgICAgICAgIHBhZ2VzW2ldLmZpZWxkc1tqXVsndHlwZSddID09PSAncmFkaW9fYnV0dG9uX2dyb3VwJykge1xuICAgICAgICAgIGNvbnN0IGdyb3VwRmllbGRzID0gY29uc3RydWN0R3JvdXBGaWVsZHMocGFnZXMsIGksIGosIHJvbGVzLCBwZGZQYWdlcywgZmllbGRQYWdlcywgYnJvd3NlclR5cGUpO1xuICAgICAgICAgIGZpZWxkUGFnZXNbaV0uZmllbGRzLmNvbmNhdChncm91cEZpZWxkcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgZmllbGRDb3B5ID0geyAuLi5wYWdlc1tpXS5maWVsZHNbal0gfTtcbiAgICAgICAgICBjb25zdCBjb3B5SW5kZXggPSBmaW5kSW5kZXgoZmllbGRQYWdlc1tpXS5maWVsZHMsIHsgbmFtZTogZmllbGRDb3B5Lm5hbWUgfSk7XG4gICAgICAgICAgZmllbGRDb3B5WydvcmlnaW5hbEluZGV4J10gPSBqO1xuICAgICAgICAgIGlmIChmaWVsZENvcHkudHlwZSAhPT0gJ2NoZWNrYm94X2dyb3VwJyAmJiBmaWVsZENvcHkudHlwZSAhPT0gJ3JhZGlvX2J1dHRvbl9ncm91cCcpIHtcbiAgICAgICAgICAgIGZpZWxkQ29weVsnaW5pdGlhbFN0eWxlJ10gPSBnZW5lcmF0ZUluaXRpYWxTdHlsZShmaWVsZENvcHksIHJvbGVzLCBicm93c2VyVHlwZSk7XG4gICAgICAgICAgICBmaWVsZENvcHlbJ3N0eWxlJ10gPSBnZW5lcmF0ZVN0eWxlKGZpZWxkQ29weSwgcGRmUGFnZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZmllbGRDb3B5LnR5cGUgPT09ICdjaGVja2JveCcgfHwgZmllbGRDb3B5LnR5cGUgPT09ICdjaGVja2JveF9ncm91cCcgfHwgZmllbGRDb3B5LnR5cGUgPT09ICdyYWRpb19idXR0b25fZ3JvdXAnKSB7XG4gICAgICAgICAgICBmaWVsZENvcHlbJ2NoZWNrYm94U3R5bGUnXSA9IGdlbmVyYXRlR3JvdXBMYWJlbChpLCBmaWVsZENvcHkucm9sZV9uYW1lLCByb2xlcywgcGRmUGFnZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY29weUluZGV4IDwgMCkge1xuICAgICAgICAgICAgZmllbGRQYWdlc1tpXS5maWVsZHNbZmllbGRQYWdlc1tpXS5maWVsZHMubGVuZ3RoXSA9IGZpZWxkQ29weTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZpZWxkUGFnZXM7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdHJ1Y3RHcm91cEZpZWxkcyhwYWdlcywgaSwgaiwgcm9sZXMsIHBkZlBhZ2VzLCBmaWVsZFBhZ2VzLCBicm93c2VyVHlwZSkge1xuICBsZXQgayA9IDA7XG4gIGNvbnN0IG9wdGlvbnNMZW5ndGggPSBwYWdlc1tpXS5maWVsZHNbal1bJ3NldHRpbmcnXVsnb3B0aW9ucyddLmxlbmd0aFxuICB3aGlsZSAoayA8IG9wdGlvbnNMZW5ndGgpIHtcbiAgICBjb25zdCBmaWVsZENvcHkgPSB7IC4uLnBhZ2VzW2ldLmZpZWxkc1tqXSB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSBwYWdlc1tpXS5maWVsZHNbal1bJ3NldHRpbmcnXVsnb3B0aW9ucyddW2tdO1xuICAgIGZpZWxkQ29weS5zZXR0aW5nWyd4J10gPSBvcHRpb25zLng7XG4gICAgZmllbGRDb3B5LnNldHRpbmdbJ3knXSA9IG9wdGlvbnMueTtcbiAgICBpZiAoZmllbGRDb3B5LnR5cGUgPT09ICdjaGVja2JveF9ncm91cCcpIHtcbiAgICAgIGZpZWxkQ29weS5zZXR0aW5nWydjaGVja2VkJ10gPSBvcHRpb25zLmNoZWNrZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpZWxkQ29weS5zZXR0aW5nWydzZWxlY3RlZCddID0gb3B0aW9ucy5zZWxlY3RlZDtcbiAgICB9XG4gICAgZmllbGRDb3B5Wydpbml0aWFsU3R5bGUnXSA9IGdlbmVyYXRlSW5pdGlhbFN0eWxlKGZpZWxkQ29weSwgcm9sZXMsIGJyb3dzZXJUeXBlKTtcbiAgICBmaWVsZENvcHlbJ3N0eWxlJ10gPSBnZW5lcmF0ZVN0eWxlKGZpZWxkQ29weSwgcGRmUGFnZXMpO1xuICAgIGZpZWxkQ29weVsnY2hlY2tib3hTdHlsZSddID0gZ2VuZXJhdGVHcm91cExhYmVsKGksIGZpZWxkQ29weS5yb2xlX25hbWUsIHJvbGVzLCBwZGZQYWdlcyk7XG4gICAgZmllbGRDb3B5WydvcmlnaW5hbEluZGV4J10gPSBqO1xuICAgIGZpZWxkQ29weVsnb3B0aW9uSW5kZXgnXSA9IGs7XG4gICAgZmllbGRDb3B5WydvcHRpb25JZCddID0gb3B0aW9ucy5pZDtcbiAgICBjb25zdCBjb3B5SW5kZXggPSBmaW5kSW5kZXgoZmllbGRQYWdlc1tpXS5maWVsZHMsIHsgb3B0aW9uSW5kZXg6IGZpZWxkQ29weS5vcHRpb25JbmRleCwgbmFtZTogZmllbGRDb3B5Lm5hbWUgfSk7XG4gICAgaWYgKGNvcHlJbmRleCA8IDApIHtcbiAgICAgIGZpZWxkUGFnZXNbaV0uZmllbGRzW2ZpZWxkUGFnZXNbaV0uZmllbGRzLmxlbmd0aF0gPSBmaWVsZENvcHk7XG4gICAgfVxuICAgIGsrKztcbiAgfVxuICByZXR1cm4gZmllbGRQYWdlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlSW5pdGlhbFN0eWxlKGZpZWxkLCByb2xlcywgYnJvd3NlclR5cGUpIHtcbiAgY29uc3QgZm9udFNpemUgPSA5LjU7XG4gIGNvbnN0IHNldHRpbmcgPSBmaWVsZC5zZXR0aW5nO1xuICBjb25zdCByb2xlX25hbWUgPSBmaWVsZC5yb2xlX25hbWU7XG4gIGNvbnN0IGluaXRpYWxTdHlsZSA9IHtcbiAgICBoZWlnaHQ6ICcxMDAlJyxcbiAgICB3aWR0aDogJzEwMCUnLFxuICAgIGJhY2tncm91bmRDb2xvcjogZ2V0Um9sZUNvbG9yKHJvbGVfbmFtZSwgcm9sZXMpLFxuICAgIGxldHRlclNwYWNpbmc6IG51bGwsXG4gICAgZm9udFNpemU6IG51bGxcbiAgfTtcbiAgZmllbGRbJ2luaXRpYWxTdHlsZSddID0gaW5pdGlhbFN0eWxlO1xuICBzd2l0Y2ggKGZpZWxkLnR5cGUpIHtcbiAgICBjYXNlICd0ZXh0Ym94JzpcbiAgICBjYXNlICd0ZXh0YXJlYSc6XG4gICAgICBmaWVsZFsnaW5pdGlhbFN0eWxlJ11bJ2xldHRlclNwYWNpbmcnXSA9IGNvbnZlcnRUb1VJUmF0aW8oZ2V0TGV0dGVyU3BhY2luZyhicm93c2VyVHlwZSksIGZpZWxkWydyYXRpbyddLngpICsgJ3B4JztcbiAgICBjYXNlICdzaWduYXR1cmUnOlxuICAgIGNhc2UgJ2luaXRpYWwnOlxuICAgIGNhc2UgJ2RhdGUnOlxuICAgIGNhc2UgJ2Ryb3Bkb3duJzpcbiAgICAgIGZpZWxkWydpbml0aWFsU3R5bGUnXVsnZm9udFNpemUnXSA9IGNvbnZlcnRUb1VJUmF0aW8oZm9udFNpemUsIGZpZWxkWydyYXRpbyddLngpICsgJ3B4JztcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3RpbWVzdGFtcCc6XG4gICAgICAgIGZpZWxkWydpbml0aWFsU3R5bGUnXVsnZm9udFNpemUnXSA9IGNvbnZlcnRUb1VJUmF0aW8oOC41LCBmaWVsZFsncmF0aW8nXS54KSArICdweCc7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdhdHRhY2htZW50JzpcbiAgICBjYXNlICdwYXltZW50JzpcbiAgICAgIGZpZWxkWydpbml0aWFsU3R5bGUnXVsnaGVpZ2h0J10gPSAnMjRweCc7XG4gICAgICBmaWVsZFsnaW5pdGlhbFN0eWxlJ11bJ21hdC1pY29uJ10gPSB7XG4gICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuICAgICAgICB0b3A6IDAsXG4gICAgICAgIGxlZnQ6IDAsXG4gICAgICAgIGhlaWdodDogJzI0cHgnLFxuICAgICAgICB3aWR0aDogJzI0cHgnLFxuICAgICAgICBsaW5lSGVpZ2h0OiAnMjRweCcsXG4gICAgICAgIGZvbnRTaXplOiAnMThweCdcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBicmVhaztcbiAgfVxuXG4gIGlmIChzZXR0aW5nLmxlYWRpbmcgJiYgc2V0dGluZy5sZWFkaW5nID4gMCkge1xuICAgIGZpZWxkLmluaXRpYWxTdHlsZVsnbGluZS1oZWlnaHQnXSA9IGNvbnZlcnRUb1VJUmF0aW8oc2V0dGluZy5sZWFkaW5nICsgLjExMzk1LCBmaWVsZFsncmF0aW8nXS55KSArICdweCc7XG4gIH1cbiAgcmV0dXJuIGZpZWxkLmluaXRpYWxTdHlsZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlU3R5bGUoZmllbGQsIHBkZlBhZ2VzKSB7XG4gIHJldHVybiBnZXRVSUZpZWxkU3R5bGluZyhmaWVsZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUdyb3VwTGFiZWwoaSwgcm9sZV9uYW1lLCByb2xlcywgcGRmUGFnZXMpIHtcbiAgcmV0dXJuIHtcbiAgICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgICB0b3A6IDAsXG4gICAgbGVmdDogMCxcbiAgICBoZWlnaHQ6ICcxMy41cHgnLFxuICAgIHdpZHRoOiAnMTMuNXB4JyxcbiAgICBiYWNrZ3JvdW5kQ29sb3I6IGdldFJvbGVDb2xvcihyb2xlX25hbWUsIHJvbGVzKSxcbiAgICBib3JkZXI6ICcycHggc29saWQgIzc3NydcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um9sZUNvbG9yKG5hbWUsIHJvbGVzLCBpbmRleD8pIHtcbiAgaWYgKGluZGV4KSB7XG4gICAgcmV0dXJuIGdldFJHQkEoaW5kZXgpO1xuICB9IGVsc2UgaWYgKHJvbGVzICYmIHJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICBpbmRleCA9IGZpbmRJbmRleChyb2xlcywgeyBuYW1lOiBuYW1lIH0pO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICByZXR1cm4gcm9sZXNbaW5kZXhdLnJnYmEgPyByb2xlc1tpbmRleF0ucmdiYSA6IGdldFJHQkEoaW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmFtZVRvUkdCQShuYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5hbWVUb1JHQkEobmFtZSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnZlcnRUb1VJUmF0aW8odmFsdWU6IG51bWJlciwgcmF0aW8pIHtcbiAgcmV0dXJuIHZhbHVlICogcmF0aW87XG59XG4iXX0=