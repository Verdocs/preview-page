/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { getRGBA, nameToRGBA } from '@verdocs/sdk';
import { findIndex } from 'lodash';
import { getLetterSpacing } from './viewer-fields';
import { getUIFieldStyling } from './conversion';
/**
 * @param {?} pages
 * @param {?} pdfPages
 * @return {?}
 */
export function setRatio(pages, pdfPages) {
    for (var i = 0; i < pages.length; i++) {
        for (var j = 0; j < pages[i].fields.length; j++) {
            if (pages[i].fields[j]) {
                pages[i].fields[j]['ratio'] = {
                    x: pdfPages[i].xRatio,
                    y: pdfPages[i].yRatio
                };
            }
        }
    }
    return pages;
}
/**
 * @param {?} pages
 * @param {?} roles
 * @param {?} pdfPages
 * @param {?} browserType
 * @return {?}
 */
export function constructPages(pages, roles, pdfPages, browserType) {
    if (pages && pages.length > 0) {
        /** @type {?} */
        var fieldPages = new Array(pages.length);
        for (var i = 0; i < pages.length; i++) {
            fieldPages[i] = { fields: [] };
            for (var j = 0; j < pages[i].fields.length; j++) {
                if (pages[i].fields[j]['setting'] && pages[i].fields[j]['setting']['options'] &&
                    pages[i].fields[j]['setting']['options'].length > 0 && (pages[i].fields[j]['type'] === 'checkbox_group') ||
                    pages[i].fields[j]['type'] === 'radio_button_group') {
                    /** @type {?} */
                    var groupFields = constructGroupFields(pages, i, j, roles, pdfPages, fieldPages, browserType);
                    fieldPages[i].fields.concat(groupFields);
                }
                else {
                    /** @type {?} */
                    var fieldCopy = tslib_1.__assign({}, pages[i].fields[j]);
                    /** @type {?} */
                    var copyIndex = findIndex(fieldPages[i].fields, { name: fieldCopy.name });
                    fieldCopy['originalIndex'] = j;
                    if (fieldCopy.type !== 'checkbox_group' && fieldCopy.type !== 'radio_button_group') {
                        fieldCopy['initialStyle'] = generateInitialStyle(fieldCopy, roles, browserType);
                        fieldCopy['style'] = generateStyle(fieldCopy, pdfPages);
                    }
                    if (fieldCopy.type === 'checkbox' || fieldCopy.type === 'checkbox_group' || fieldCopy.type === 'radio_button_group') {
                        fieldCopy['checkboxStyle'] = generateGroupLabel(i, fieldCopy.role_name, roles, pdfPages);
                    }
                    if (copyIndex < 0) {
                        fieldPages[i].fields[fieldPages[i].fields.length] = fieldCopy;
                    }
                }
            }
        }
        return fieldPages;
    }
    else {
        return [];
    }
}
/**
 * @param {?} pages
 * @param {?} i
 * @param {?} j
 * @param {?} roles
 * @param {?} pdfPages
 * @param {?} fieldPages
 * @param {?} browserType
 * @return {?}
 */
export function constructGroupFields(pages, i, j, roles, pdfPages, fieldPages, browserType) {
    /** @type {?} */
    var k = 0;
    /** @type {?} */
    var optionsLength = pages[i].fields[j]['setting']['options'].length;
    while (k < optionsLength) {
        /** @type {?} */
        var fieldCopy = tslib_1.__assign({}, pages[i].fields[j]);
        /** @type {?} */
        var options = pages[i].fields[j]['setting']['options'][k];
        fieldCopy.setting['x'] = options.x;
        fieldCopy.setting['y'] = options.y;
        if (fieldCopy.type === 'checkbox_group') {
            fieldCopy.setting['checked'] = options.checked;
        }
        else {
            fieldCopy.setting['selected'] = options.selected;
        }
        fieldCopy['initialStyle'] = generateInitialStyle(fieldCopy, roles, browserType);
        fieldCopy['style'] = generateStyle(fieldCopy, pdfPages);
        fieldCopy['checkboxStyle'] = generateGroupLabel(i, fieldCopy.role_name, roles, pdfPages);
        fieldCopy['originalIndex'] = j;
        fieldCopy['optionIndex'] = k;
        fieldCopy['optionId'] = options.id;
        /** @type {?} */
        var copyIndex = findIndex(fieldPages[i].fields, { optionIndex: fieldCopy.optionIndex, name: fieldCopy.name });
        if (copyIndex < 0) {
            fieldPages[i].fields[fieldPages[i].fields.length] = fieldCopy;
        }
        k++;
    }
    return fieldPages;
}
/**
 * @param {?} field
 * @param {?} roles
 * @param {?} browserType
 * @return {?}
 */
export function generateInitialStyle(field, roles, browserType) {
    /** @type {?} */
    var fontSize = 9.5;
    /** @type {?} */
    var setting = field.setting;
    /** @type {?} */
    var role_name = field.role_name;
    /** @type {?} */
    var initialStyle = {
        height: '100%',
        width: '100%',
        backgroundColor: getRoleColor(role_name, roles),
        letterSpacing: null,
        fontSize: null
    };
    field['initialStyle'] = initialStyle;
    switch (field.type) {
        case 'textbox':
        case 'textarea':
            field['initialStyle']['letterSpacing'] = convertToUIRatio(getLetterSpacing(browserType), field['ratio'].x) + 'px';
        case 'signature':
        case 'initial':
        case 'date':
        case 'dropdown':
            field['initialStyle']['fontSize'] = convertToUIRatio(fontSize, field['ratio'].x) + 'px';
            break;
        case 'timestamp':
            field['initialStyle']['fontSize'] = convertToUIRatio(8.5, field['ratio'].x) + 'px';
            break;
        case 'attachment':
        case 'payment':
            field['initialStyle']['height'] = '24px';
            field['initialStyle']['mat-icon'] = {
                position: 'absolute',
                top: 0,
                left: 0,
                height: '24px',
                width: '24px',
                lineHeight: '24px',
                fontSize: '18px'
            };
            break;
        default:
            break;
    }
    if (setting.leading && setting.leading > 0) {
        field.initialStyle['line-height'] = convertToUIRatio(setting.leading + .11395, field['ratio'].y) + 'px';
    }
    return field.initialStyle;
}
/**
 * @param {?} field
 * @param {?} pdfPages
 * @return {?}
 */
export function generateStyle(field, pdfPages) {
    return getUIFieldStyling(field);
}
/**
 * @param {?} i
 * @param {?} role_name
 * @param {?} roles
 * @param {?} pdfPages
 * @return {?}
 */
export function generateGroupLabel(i, role_name, roles, pdfPages) {
    return {
        position: 'absolute',
        top: 0,
        left: 0,
        height: '13.5px',
        width: '13.5px',
        backgroundColor: getRoleColor(role_name, roles),
        border: '2px solid #777'
    };
}
/**
 * @param {?} name
 * @param {?} roles
 * @param {?=} index
 * @return {?}
 */
export function getRoleColor(name, roles, index) {
    if (index) {
        return getRGBA(index);
    }
    else if (roles && roles.length > 0) {
        index = findIndex(roles, { name: name });
        if (index >= 0) {
            return roles[index].rgba ? roles[index].rgba : getRGBA(index);
        }
        else {
            return nameToRGBA(name);
        }
    }
    else {
        return nameToRGBA(name);
    }
}
/**
 * @param {?} value
 * @param {?} ratio
 * @return {?}
 */
export function convertToUIRatio(value, ratio) {
    return value * ratio;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci1maWVsZHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdmVyZG9jcy9lc3NlbnRpYWxzLyIsInNvdXJjZXMiOlsibGliL2Z1bmN0aW9ucy9idWlsZGVyLWZpZWxkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDbkMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sY0FBYyxDQUFDOzs7Ozs7QUFFakQsTUFBTSxVQUFVLFFBQVEsQ0FBQyxLQUFLLEVBQUUsUUFBUTtJQUN0QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNyQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN0QixLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHO29CQUM1QixDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU07b0JBQ3JCLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTtpQkFDdEIsQ0FBQzthQUNIO1NBQ0Y7S0FDRjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQzs7Ozs7Ozs7QUFFRCxNQUFNLFVBQVUsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLEVB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QUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNMLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3pCO0tBQ0Y7U0FBTTtRQUNMLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3pCO0FBQ0gsQ0FBQzs7Ozs7O0FBRUQsTUFBTSxVQUFVLGdCQUFnQixDQUFDLEtBQWEsRUFBRSxLQUFLO0lBQ25ELE9BQU8sS0FBSyxHQUFHLEtBQUssQ0FBQztBQUN2QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0UkdCQSwgbmFtZVRvUkdCQSB9IGZyb20gJ0B2ZXJkb2NzL3Nkayc7XG5pbXBvcnQgeyBmaW5kSW5kZXggfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0TGV0dGVyU3BhY2luZyB9IGZyb20gJy4vdmlld2VyLWZpZWxkcyc7XG5pbXBvcnQgeyBnZXRVSUZpZWxkU3R5bGluZyB9IGZyb20gJy4vY29udmVyc2lvbic7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRSYXRpbyhwYWdlcywgcGRmUGFnZXMpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWdlcy5sZW5ndGg7IGkrKykge1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcGFnZXNbaV0uZmllbGRzLmxlbmd0aDsgaisrKSB7XG4gICAgICBpZiAocGFnZXNbaV0uZmllbGRzW2pdKSB7XG4gICAgICAgIHBhZ2VzW2ldLmZpZWxkc1tqXVsncmF0aW8nXSA9IHtcbiAgICAgICAgICB4OiBwZGZQYWdlc1tpXS54UmF0aW8sXG4gICAgICAgICAgeTogcGRmUGFnZXNbaV0ueVJhdGlvXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBwYWdlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN0cnVjdFBhZ2VzKHBhZ2VzLCByb2xlcywgcGRmUGFnZXMsIGJyb3dzZXJUeXBlKSB7XG4gIGlmIChwYWdlcyAmJiBwYWdlcy5sZW5ndGggPiAwKSB7XG4gICAgbGV0IGZpZWxkUGFnZXMgPSBuZXcgQXJyYXkocGFnZXMubGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBmaWVsZFBhZ2VzW2ldID0geyBmaWVsZHM6IFtdIH1cbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcGFnZXNbaV0uZmllbGRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGlmIChwYWdlc1tpXS5maWVsZHNbal1bJ3NldHRpbmcnXSAmJiBwYWdlc1tpXS5maWVsZHNbal1bJ3NldHRpbmcnXVsnb3B0aW9ucyddICYmXG4gICAgICAgICAgcGFnZXNbaV0uZmllbGRzW2pdWydzZXR0aW5nJ11bJ29wdGlvbnMnXS5sZW5ndGggPiAwICYmIChwYWdlc1tpXS5maWVsZHNbal1bJ3R5cGUnXSA9PT0gJ2NoZWNrYm94X2dyb3VwJykgfHxcbiAgICAgICAgICBwYWdlc1tpXS5maWVsZHNbal1bJ3R5cGUnXSA9PT0gJ3JhZGlvX2J1dHRvbl9ncm91cCcpIHtcbiAgICAgICAgICBjb25zdCBncm91cEZpZWxkcyA9IGNvbnN0cnVjdEdyb3VwRmllbGRzKHBhZ2VzLCBpLCBqLCByb2xlcywgcGRmUGFnZXMsIGZpZWxkUGFnZXMsIGJyb3dzZXJUeXBlKTtcbiAgICAgICAgICBmaWVsZFBhZ2VzW2ldLmZpZWxkcy5jb25jYXQoZ3JvdXBGaWVsZHMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGZpZWxkQ29weSA9IHsgLi4ucGFnZXNbaV0uZmllbGRzW2pdIH07XG4gICAgICAgICAgY29uc3QgY29weUluZGV4ID0gZmluZEluZGV4KGZpZWxkUGFnZXNbaV0uZmllbGRzLCB7IG5hbWU6IGZpZWxkQ29weS5uYW1lIH0pO1xuICAgICAgICAgIGZpZWxkQ29weVsnb3JpZ2luYWxJbmRleCddID0gajtcbiAgICAgICAgICBpZiAoZmllbGRDb3B5LnR5cGUgIT09ICdjaGVja2JveF9ncm91cCcgJiYgZmllbGRDb3B5LnR5cGUgIT09ICdyYWRpb19idXR0b25fZ3JvdXAnKSB7XG4gICAgICAgICAgICBmaWVsZENvcHlbJ2luaXRpYWxTdHlsZSddID0gZ2VuZXJhdGVJbml0aWFsU3R5bGUoZmllbGRDb3B5LCByb2xlcywgYnJvd3NlclR5cGUpO1xuICAgICAgICAgICAgZmllbGRDb3B5WydzdHlsZSddID0gZ2VuZXJhdGVTdHlsZShmaWVsZENvcHksIHBkZlBhZ2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGZpZWxkQ29weS50eXBlID09PSAnY2hlY2tib3gnIHx8IGZpZWxkQ29weS50eXBlID09PSAnY2hlY2tib3hfZ3JvdXAnIHx8IGZpZWxkQ29weS50eXBlID09PSAncmFkaW9fYnV0dG9uX2dyb3VwJykge1xuICAgICAgICAgICAgZmllbGRDb3B5WydjaGVja2JveFN0eWxlJ10gPSBnZW5lcmF0ZUdyb3VwTGFiZWwoaSwgZmllbGRDb3B5LnJvbGVfbmFtZSwgcm9sZXMsIHBkZlBhZ2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGNvcHlJbmRleCA8IDApIHtcbiAgICAgICAgICAgIGZpZWxkUGFnZXNbaV0uZmllbGRzW2ZpZWxkUGFnZXNbaV0uZmllbGRzLmxlbmd0aF0gPSBmaWVsZENvcHk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmaWVsZFBhZ2VzO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBbXTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3RydWN0R3JvdXBGaWVsZHMocGFnZXMsIGksIGosIHJvbGVzLCBwZGZQYWdlcywgZmllbGRQYWdlcywgYnJvd3NlclR5cGUpIHtcbiAgbGV0IGsgPSAwO1xuICBjb25zdCBvcHRpb25zTGVuZ3RoID0gcGFnZXNbaV0uZmllbGRzW2pdWydzZXR0aW5nJ11bJ29wdGlvbnMnXS5sZW5ndGhcbiAgd2hpbGUgKGsgPCBvcHRpb25zTGVuZ3RoKSB7XG4gICAgY29uc3QgZmllbGRDb3B5ID0geyAuLi5wYWdlc1tpXS5maWVsZHNbal0gfTtcbiAgICBjb25zdCBvcHRpb25zID0gcGFnZXNbaV0uZmllbGRzW2pdWydzZXR0aW5nJ11bJ29wdGlvbnMnXVtrXTtcbiAgICBmaWVsZENvcHkuc2V0dGluZ1sneCddID0gb3B0aW9ucy54O1xuICAgIGZpZWxkQ29weS5zZXR0aW5nWyd5J10gPSBvcHRpb25zLnk7XG4gICAgaWYgKGZpZWxkQ29weS50eXBlID09PSAnY2hlY2tib3hfZ3JvdXAnKSB7XG4gICAgICBmaWVsZENvcHkuc2V0dGluZ1snY2hlY2tlZCddID0gb3B0aW9ucy5jaGVja2VkO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWVsZENvcHkuc2V0dGluZ1snc2VsZWN0ZWQnXSA9IG9wdGlvbnMuc2VsZWN0ZWQ7XG4gICAgfVxuICAgIGZpZWxkQ29weVsnaW5pdGlhbFN0eWxlJ10gPSBnZW5lcmF0ZUluaXRpYWxTdHlsZShmaWVsZENvcHksIHJvbGVzLCBicm93c2VyVHlwZSk7XG4gICAgZmllbGRDb3B5WydzdHlsZSddID0gZ2VuZXJhdGVTdHlsZShmaWVsZENvcHksIHBkZlBhZ2VzKTtcbiAgICBmaWVsZENvcHlbJ2NoZWNrYm94U3R5bGUnXSA9IGdlbmVyYXRlR3JvdXBMYWJlbChpLCBmaWVsZENvcHkucm9sZV9uYW1lLCByb2xlcywgcGRmUGFnZXMpO1xuICAgIGZpZWxkQ29weVsnb3JpZ2luYWxJbmRleCddID0gajtcbiAgICBmaWVsZENvcHlbJ29wdGlvbkluZGV4J10gPSBrO1xuICAgIGZpZWxkQ29weVsnb3B0aW9uSWQnXSA9IG9wdGlvbnMuaWQ7XG4gICAgY29uc3QgY29weUluZGV4ID0gZmluZEluZGV4KGZpZWxkUGFnZXNbaV0uZmllbGRzLCB7IG9wdGlvbkluZGV4OiBmaWVsZENvcHkub3B0aW9uSW5kZXgsIG5hbWU6IGZpZWxkQ29weS5uYW1lIH0pO1xuICAgIGlmIChjb3B5SW5kZXggPCAwKSB7XG4gICAgICBmaWVsZFBhZ2VzW2ldLmZpZWxkc1tmaWVsZFBhZ2VzW2ldLmZpZWxkcy5sZW5ndGhdID0gZmllbGRDb3B5O1xuICAgIH1cbiAgICBrKys7XG4gIH1cbiAgcmV0dXJuIGZpZWxkUGFnZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUluaXRpYWxTdHlsZShmaWVsZCwgcm9sZXMsIGJyb3dzZXJUeXBlKSB7XG4gIGNvbnN0IGZvbnRTaXplID0gOS41O1xuICBjb25zdCBzZXR0aW5nID0gZmllbGQuc2V0dGluZztcbiAgY29uc3Qgcm9sZV9uYW1lID0gZmllbGQucm9sZV9uYW1lO1xuICBjb25zdCBpbml0aWFsU3R5bGUgPSB7XG4gICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgd2lkdGg6ICcxMDAlJyxcbiAgICBiYWNrZ3JvdW5kQ29sb3I6IGdldFJvbGVDb2xvcihyb2xlX25hbWUsIHJvbGVzKSxcbiAgICBsZXR0ZXJTcGFjaW5nOiBudWxsLFxuICAgIGZvbnRTaXplOiBudWxsXG4gIH07XG4gIGZpZWxkWydpbml0aWFsU3R5bGUnXSA9IGluaXRpYWxTdHlsZTtcbiAgc3dpdGNoIChmaWVsZC50eXBlKSB7XG4gICAgY2FzZSAndGV4dGJveCc6XG4gICAgY2FzZSAndGV4dGFyZWEnOlxuICAgICAgZmllbGRbJ2luaXRpYWxTdHlsZSddWydsZXR0ZXJTcGFjaW5nJ10gPSBjb252ZXJ0VG9VSVJhdGlvKGdldExldHRlclNwYWNpbmcoYnJvd3NlclR5cGUpLCBmaWVsZFsncmF0aW8nXS54KSArICdweCc7XG4gICAgY2FzZSAnc2lnbmF0dXJlJzpcbiAgICBjYXNlICdpbml0aWFsJzpcbiAgICBjYXNlICdkYXRlJzpcbiAgICBjYXNlICdkcm9wZG93bic6XG4gICAgICBmaWVsZFsnaW5pdGlhbFN0eWxlJ11bJ2ZvbnRTaXplJ10gPSBjb252ZXJ0VG9VSVJhdGlvKGZvbnRTaXplLCBmaWVsZFsncmF0aW8nXS54KSArICdweCc7XG4gICAgICBicmVhaztcbiAgICBjYXNlICd0aW1lc3RhbXAnOlxuICAgICAgICBmaWVsZFsnaW5pdGlhbFN0eWxlJ11bJ2ZvbnRTaXplJ10gPSBjb252ZXJ0VG9VSVJhdGlvKDguNSwgZmllbGRbJ3JhdGlvJ10ueCkgKyAncHgnO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnYXR0YWNobWVudCc6XG4gICAgY2FzZSAncGF5bWVudCc6XG4gICAgICBmaWVsZFsnaW5pdGlhbFN0eWxlJ11bJ2hlaWdodCddID0gJzI0cHgnO1xuICAgICAgZmllbGRbJ2luaXRpYWxTdHlsZSddWydtYXQtaWNvbiddID0ge1xuICAgICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgICAgICAgdG9wOiAwLFxuICAgICAgICBsZWZ0OiAwLFxuICAgICAgICBoZWlnaHQ6ICcyNHB4JyxcbiAgICAgICAgd2lkdGg6ICcyNHB4JyxcbiAgICAgICAgbGluZUhlaWdodDogJzI0cHgnLFxuICAgICAgICBmb250U2l6ZTogJzE4cHgnXG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgYnJlYWs7XG4gIH1cblxuICBpZiAoc2V0dGluZy5sZWFkaW5nICYmIHNldHRpbmcubGVhZGluZyA+IDApIHtcbiAgICBmaWVsZC5pbml0aWFsU3R5bGVbJ2xpbmUtaGVpZ2h0J10gPSBjb252ZXJ0VG9VSVJhdGlvKHNldHRpbmcubGVhZGluZyArIC4xMTM5NSwgZmllbGRbJ3JhdGlvJ10ueSkgKyAncHgnO1xuICB9XG4gIHJldHVybiBmaWVsZC5pbml0aWFsU3R5bGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVN0eWxlKGZpZWxkLCBwZGZQYWdlcykge1xuICByZXR1cm4gZ2V0VUlGaWVsZFN0eWxpbmcoZmllbGQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVHcm91cExhYmVsKGksIHJvbGVfbmFtZSwgcm9sZXMsIHBkZlBhZ2VzKSB7XG4gIHJldHVybiB7XG4gICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgdG9wOiAwLFxuICAgIGxlZnQ6IDAsXG4gICAgaGVpZ2h0OiAnMTMuNXB4JyxcbiAgICB3aWR0aDogJzEzLjVweCcsXG4gICAgYmFja2dyb3VuZENvbG9yOiBnZXRSb2xlQ29sb3Iocm9sZV9uYW1lLCByb2xlcyksXG4gICAgYm9yZGVyOiAnMnB4IHNvbGlkICM3NzcnXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJvbGVDb2xvcihuYW1lLCByb2xlcywgaW5kZXg/KSB7XG4gIGlmIChpbmRleCkge1xuICAgIHJldHVybiBnZXRSR0JBKGluZGV4KTtcbiAgfSBlbHNlIGlmIChyb2xlcyAmJiByb2xlcy5sZW5ndGggPiAwKSB7XG4gICAgaW5kZXggPSBmaW5kSW5kZXgocm9sZXMsIHsgbmFtZTogbmFtZSB9KTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgcmV0dXJuIHJvbGVzW2luZGV4XS5yZ2JhID8gcm9sZXNbaW5kZXhdLnJnYmEgOiBnZXRSR0JBKGluZGV4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5hbWVUb1JHQkEobmFtZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBuYW1lVG9SR0JBKG5hbWUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0VG9VSVJhdGlvKHZhbHVlOiBudW1iZXIsIHJhdGlvKSB7XG4gIHJldHVybiB2YWx1ZSAqIHJhdGlvO1xufVxuIl19